import{r as mt,g as yt}from"./phaser-DFK5Ua9d.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();var wt=mt();const te=yt(wt);const St=n=>{const e=new Map;e.set("web",{name:"web"});const t=n.CapacitorPlatforms||{currentPlatform:{name:"web"},platforms:e},s=(r,o)=>{t.platforms.set(r,o)},i=r=>{t.platforms.has(r)&&(t.currentPlatform=t.platforms.get(r))};return t.addPlatform=s,t.setPlatform=i,t},vt=n=>n.CapacitorPlatforms=St(n),Je=vt(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{});Je.addPlatform;Je.setPlatform;var J;(function(n){n.Unimplemented="UNIMPLEMENTED",n.Unavailable="UNAVAILABLE"})(J||(J={}));class ye extends Error{constructor(e,t,s){super(e),this.message=e,this.code=t,this.data=s}}const bt=n=>{var e,t;return n?.androidBridge?"android":!((t=(e=n?.webkit)===null||e===void 0?void 0:e.messageHandlers)===null||t===void 0)&&t.bridge?"ios":"web"},Ct=n=>{var e,t,s,i,r;const o=n.CapacitorCustomPlatform||null,a=n.Capacitor||{},l=a.Plugins=a.Plugins||{},h=n.CapacitorPlatforms,c=()=>o!==null?o.name:bt(n),d=((e=h?.currentPlatform)===null||e===void 0?void 0:e.getPlatform)||c,u=()=>d()!=="web",f=((t=h?.currentPlatform)===null||t===void 0?void 0:t.isNativePlatform)||u,p=v=>{const b=S.get(v);return!!(b?.platforms.has(d())||y(v))},C=((s=h?.currentPlatform)===null||s===void 0?void 0:s.isPluginAvailable)||p,x=v=>{var b;return(b=a.PluginHeaders)===null||b===void 0?void 0:b.find(X=>X.name===v)},y=((i=h?.currentPlatform)===null||i===void 0?void 0:i.getPluginHeader)||x,T=v=>n.console.error(v),w=(v,b,X)=>Promise.reject(`${X} does not have an implementation of "${b}".`),S=new Map,F=(v,b={})=>{const X=S.get(v);if(X)return console.warn(`Capacitor plugin "${v}" already registered. Cannot register plugins twice.`),X.proxy;const G=d(),K=y(v);let U;const ft=async()=>(!U&&G in b?U=typeof b[G]=="function"?U=await b[G]():U=b[G]:o!==null&&!U&&"web"in b&&(U=typeof b.web=="function"?U=await b.web():U=b.web),U),pt=(P,R)=>{var L,H;if(K){const N=K?.methods.find(_=>R===_.name);if(N)return N.rtype==="promise"?_=>a.nativePromise(v,R.toString(),_):(_,ne)=>a.nativeCallback(v,R.toString(),_,ne);if(P)return(L=P[R])===null||L===void 0?void 0:L.bind(P)}else{if(P)return(H=P[R])===null||H===void 0?void 0:H.bind(P);throw new ye(`"${v}" plugin is not implemented on ${G}`,J.Unimplemented)}},ge=P=>{let R;const L=(...H)=>{const N=ft().then(_=>{const ne=pt(_,P);if(ne){const oe=ne(...H);return R=oe?.remove,oe}else throw new ye(`"${v}.${P}()" is not implemented on ${G}`,J.Unimplemented)});return P==="addListener"&&(N.remove=async()=>R()),N};return L.toString=()=>`${P.toString()}() { [capacitor code] }`,Object.defineProperty(L,"name",{value:P,writable:!1,configurable:!1}),L},Ae=ge("addListener"),Le=ge("removeListener"),gt=(P,R)=>{const L=Ae({eventName:P},R),H=async()=>{const _=await L;Le({eventName:P,callbackId:_},R)},N=new Promise(_=>L.then(()=>_({remove:H})));return N.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await H()},N},me=new Proxy({},{get(P,R){switch(R){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return K?gt:Ae;case"removeListener":return Le;default:return ge(R)}}});return l[v]=me,S.set(v,{name:v,proxy:me,platforms:new Set([...Object.keys(b),...K?[G]:[]])}),me},M=((r=h?.currentPlatform)===null||r===void 0?void 0:r.registerPlugin)||F;return a.convertFileSrc||(a.convertFileSrc=v=>v),a.getPlatform=d,a.handleError=T,a.isNativePlatform=f,a.isPluginAvailable=C,a.pluginMethodNoop=w,a.registerPlugin=M,a.Exception=ye,a.DEBUG=!!a.DEBUG,a.isLoggingEnabled=!!a.isLoggingEnabled,a.platform=a.getPlatform(),a.isNative=a.isNativePlatform(),a},xt=n=>n.Capacitor=Ct(n),ie=xt(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),Ye=ie.registerPlugin;ie.Plugins;class Qe{constructor(e){this.listeners={},this.windowListeners={},e&&(console.warn(`Capacitor WebPlugin "${e.name}" config object was deprecated in v3 and will be removed in v4.`),this.config=e)}addListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t);const i=this.windowListeners[e];i&&!i.registered&&this.addWindowListener(i);const r=async()=>this.removeListener(e,t),o=Promise.resolve({remove:r});return Object.defineProperty(o,"remove",{value:async()=>{console.warn("Using addListener() without 'await' is deprecated."),await r()}}),o}async removeAllListeners(){this.listeners={};for(const e in this.windowListeners)this.removeWindowListener(this.windowListeners[e]);this.windowListeners={}}notifyListeners(e,t){const s=this.listeners[e];s&&s.forEach(i=>i(t))}hasListeners(e){return!!this.listeners[e].length}registerWindowListener(e,t){this.windowListeners[t]={registered:!1,windowEventName:e,pluginEventName:t,handler:s=>{this.notifyListeners(t,s)}}}unimplemented(e="not implemented"){return new ie.Exception(e,J.Unimplemented)}unavailable(e="not available"){return new ie.Exception(e,J.Unavailable)}async removeListener(e,t){const s=this.listeners[e];if(!s)return;const i=s.indexOf(t);this.listeners[e].splice(i,1),this.listeners[e].length||this.removeWindowListener(this.windowListeners[e])}addWindowListener(e){window.addEventListener(e.windowEventName,e.handler),e.registered=!0}removeWindowListener(e){e&&(window.removeEventListener(e.windowEventName,e.handler),e.registered=!1)}}const Oe=n=>encodeURIComponent(n).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),De=n=>n.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class Tt extends Qe{async getCookies(){const e=document.cookie,t={};return e.split(";").forEach(s=>{if(s.length<=0)return;let[i,r]=s.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");i=De(i).trim(),r=De(r).trim(),t[i]=r}),t}async setCookie(e){try{const t=Oe(e.key),s=Oe(e.value),i=`; expires=${(e.expires||"").replace("expires=","")}`,r=(e.path||"/").replace("path=",""),o=e.url!=null&&e.url.length>0?`domain=${e.url}`:"";document.cookie=`${t}=${s||""}${i}; path=${r}; ${o};`}catch(t){return Promise.reject(t)}}async deleteCookie(e){try{document.cookie=`${e.key}=; Max-Age=0`}catch(t){return Promise.reject(t)}}async clearCookies(){try{const e=document.cookie.split(";")||[];for(const t of e)document.cookie=t.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(e){return Promise.reject(e)}}async clearAllCookies(){try{await this.clearCookies()}catch(e){return Promise.reject(e)}}}Ye("CapacitorCookies",{web:()=>new Tt});const kt=async n=>new Promise((e,t)=>{const s=new FileReader;s.onload=()=>{const i=s.result;e(i.indexOf(",")>=0?i.split(",")[1]:i)},s.onerror=i=>t(i),s.readAsDataURL(n)}),Pt=(n={})=>{const e=Object.keys(n);return Object.keys(n).map(i=>i.toLocaleLowerCase()).reduce((i,r,o)=>(i[r]=n[e[o]],i),{})},Rt=(n,e=!0)=>n?Object.entries(n).reduce((s,i)=>{const[r,o]=i;let a,l;return Array.isArray(o)?(l="",o.forEach(h=>{a=e?encodeURIComponent(h):h,l+=`${r}=${a}&`}),l.slice(0,-1)):(a=e?encodeURIComponent(o):o,l=`${r}=${a}`),`${s}&${l}`},"").substr(1):null,Mt=(n,e={})=>{const t=Object.assign({method:n.method||"GET",headers:n.headers},e),i=Pt(n.headers)["content-type"]||"";if(typeof n.data=="string")t.body=n.data;else if(i.includes("application/x-www-form-urlencoded")){const r=new URLSearchParams;for(const[o,a]of Object.entries(n.data||{}))r.set(o,a);t.body=r.toString()}else if(i.includes("multipart/form-data")||n.data instanceof FormData){const r=new FormData;if(n.data instanceof FormData)n.data.forEach((a,l)=>{r.append(l,a)});else for(const a of Object.keys(n.data))r.append(a,n.data[a]);t.body=r;const o=new Headers(t.headers);o.delete("content-type"),t.headers=o}else(i.includes("application/json")||typeof n.data=="object")&&(t.body=JSON.stringify(n.data));return t};class Et extends Qe{async request(e){const t=Mt(e,e.webFetchExtra),s=Rt(e.params,e.shouldEncodeUrlParams),i=s?`${e.url}?${s}`:e.url,r=await fetch(i,t),o=r.headers.get("content-type")||"";let{responseType:a="text"}=r.ok?e:{};o.includes("application/json")&&(a="json");let l,h;switch(a){case"arraybuffer":case"blob":h=await r.blob(),l=await kt(h);break;case"json":l=await r.json();break;case"document":case"text":default:l=await r.text()}const c={};return r.headers.forEach((d,u)=>{c[u]=d}),{data:l,headers:c,status:r.status,url:r.url}}async get(e){return this.request(Object.assign(Object.assign({},e),{method:"GET"}))}async post(e){return this.request(Object.assign(Object.assign({},e),{method:"POST"}))}async put(e){return this.request(Object.assign(Object.assign({},e),{method:"PUT"}))}async patch(e){return this.request(Object.assign(Object.assign({},e),{method:"PATCH"}))}async delete(e){return this.request(Object.assign(Object.assign({},e),{method:"DELETE"}))}}Ye("CapacitorHttp",{web:()=>new Et});class W{static instance;maps=new Map;constructor(){}static getInstance(){return W.instance||(W.instance=new W),W.instance}async loadAllMaps(){let e=[];try{const s=await fetch("maps/index.json");s.ok?(e=(await s.json()).maps||[],console.log(`Found ${e.length} maps in index`)):(console.warn("maps/index.json not found, using fallback list"),e=["classic","spiral","zigzag"])}catch(s){console.error("Error loading maps index:",s),e=["classic","spiral","zigzag"]}const t=e.map(async s=>{try{const i=await fetch(`maps/${s}.json`);if(!i.ok){console.warn(`Failed to load map: ${s}`);return}const r=await i.json();this.maps.set(s,r),console.log(`Loaded map: ${s}`)}catch(i){console.error(`Error loading map ${s}:`,i)}});await Promise.all(t)}getMap(e){return this.maps.get(e)}getAllMaps(){return Array.from(this.maps.entries()).map(([e,t])=>({id:e,config:t}))}hasMap(e){return this.maps.has(e)}getMapCount(){return this.maps.size}}function Ze(n){let e;try{e="./"}catch{e=void 0}e||(typeof document<"u"&&document.baseURI?e=document.baseURI:typeof window<"u"&&window.location?e=window.location.href:e="/");try{const t=new URL(e),s=t.pathname||"",i=s.split("/").filter(Boolean),r=i.length?i[i.length-1]:"";!s.endsWith("/")&&r&&!r.includes(".")&&(t.pathname=s+"/");const o=new URL(".",t.toString()).toString();return new URL(n,o).toString()}catch{return typeof e=="string"?e.endsWith("/")?e+n:e+"/"+n:n}}class m{static instance;config;loaded=!1;constructor(){}static getInstance(){return m.instance||(m.instance=new m),m.instance}async load(){if(!this.loaded)try{const e=Ze("config.json"),t=await fetch(e);if(!t.ok)throw new Error(`Failed to load config: ${t.statusText}`);this.config=await t.json(),this.loaded=!0,console.log("Game configuration loaded successfully")}catch(e){throw console.error("Failed to load game configuration:",e),e}}getConfig(){if(!this.loaded)throw new Error("Configuration not loaded. Call load() first.");return this.config}getTowerConfig(e){return this.config.towers[e]}getEnemyConfig(e){return this.config.enemies[e]}getWaveConfig(){return this.config.waves}getGameConfig(){return this.config.game}getResearchConfig(){return this.config.research}getUpgradeConfig(){return this.config.towerUpgrades}isLoaded(){return this.loaded}isSoundEnabled(){return!!(this.config&&this.config.audio&&this.config.audio.enabled!==!1)}isMusicEnabled(){return!!(this.config&&this.config.audio&&this.config.audio.musicEnabled!==!1)}setSoundEnabled(e){this.config&&(this.config.audio||(this.config.audio={}),this.config.audio.enabled=!!e)}setMusicEnabled(e){this.config&&(this.config.audio||(this.config.audio={}),this.config.audio.musicEnabled=!!e)}}class Bt extends Phaser.Scene{particles;mapRegistry;constructor(){super({key:"PreloaderScene"}),this.mapRegistry=W.getInstance()}preload(){const e=this.cameras.main.width,t=this.cameras.main.height,s=this.add.graphics();s.fillGradientStyle(657930,657930,1710638,1710638,1),s.fillRect(0,0,e,t),this.particles=[];for(let f=0;f<20;f++){const p=this.add.graphics();p.fillStyle(65280,.3),p.fillCircle(0,0,Math.random()*3+1),p.x=Math.random()*e,p.y=Math.random()*t,this.particles.push(p),this.tweens.add({targets:p,y:p.y+Math.random()*200-100,x:p.x+Math.random()*100-50,alpha:{from:.3,to:0},duration:2e3+Math.random()*1e3,repeat:-1,yoyo:!0})}const i=this.add.text(e/2,t/3,"OPEN TD",{font:"bold 72px Arial",color:"#00ff00"});i.setOrigin(.5),i.setStroke("#003300",8),this.tweens.add({targets:i,scale:{from:1,to:1.05},duration:1e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});const r=this.add.text(e/2,t/3+60,"Tower Defense",{font:"24px Arial",color:"#00aa00"});r.setOrigin(.5),r.setAlpha(0),this.tweens.add({targets:r,alpha:1,duration:800,delay:300});const o=this.add.graphics();o.lineStyle(3,65280,.8),o.strokeRoundedRect(e/2-165,t/2+50,330,40,10),o.fillStyle(0,.5),o.fillRoundedRect(e/2-165,t/2+50,330,40,10);const a=this.add.graphics(),l=this.add.text(e/2,t/2+20,"L√§dt...",{font:"20px Arial",color:"#00ff00"});l.setOrigin(.5);let h=0;this.time.addEvent({delay:500,callback:()=>{h=(h+1)%4,l.setText("L√§dt"+".".repeat(h))},loop:!0});const c=this.add.text(e/2,t/2+70,"0%",{font:"bold 20px Arial",color:"#ffffff"});c.setOrigin(.5),this.load.on("progress",f=>{a.clear(),a.fillGradientStyle(65280,65280,43520,43520,1),a.fillRoundedRect(e/2-160,t/2+55,320*f,30,8),a.lineStyle(2,65280,.5),a.strokeRoundedRect(e/2-160,t/2+55,320*f,30,8),c.setText(`${Math.floor(f*100)}%`),this.tweens.add({targets:c,scale:{from:1,to:1.1},duration:100,yoyo:!0})});const d=m.getInstance();(d.isLoaded()?d.isSoundEnabled():!1)&&(this.load.audio("click","assets/sounds/click.mp3"),this.load.audio("music","assets/music/menu.mp3"),this.load.audio("tower_basic","assets/sounds/tower_basic.mp3"),this.load.audio("tower_fast","assets/sounds/tower_fast.mp3"),this.load.audio("tower_fire","assets/sounds/tower_fire.mp3"),this.load.audio("tower_frost","assets/sounds/tower_frost.mp3"),this.load.audio("tower_sniper","assets/sounds/tower_sniper.mp3"),this.load.audio("tower_splash","assets/sounds/tower_splash.mp3"),this.load.audio("tower_strong","assets/sounds/tower_strong.mp3")),this.load.once("complete",()=>{this.time.delayedCall(800,()=>{this.tweens.add({targets:[a,o,l,c,i,r],alpha:0,duration:500}),this.particles.forEach(f=>{this.tweens.add({targets:f,alpha:0,duration:500})})})})}async create(){if(console.log("Loading maps..."),await this.mapRegistry.loadAllMaps(),console.log(`Loaded ${this.mapRegistry.getMapCount()} maps`),this.load.totalToLoad===0){let e=0;const t=setInterval(()=>{e+=.1,e>=1&&(e=1,clearInterval(t),this.load.emit("complete"),this.time.delayedCall(1500,()=>{this.cameras.main.fadeOut(300),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("LoginScene")})})),this.load.emit("progress",e)},100)}else this.load.once("complete",()=>{this.time.delayedCall(1500,()=>{this.cameras.main.fadeOut(300),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("LoginScene")})})})}}class B{static instance;storageMode="hybrid";serverUrl=null;storagePrefix="opentd_";constructor(){this.detectStorageMode()}static getInstance(){return B.instance||(B.instance=new B),B.instance}detectStorageMode(){const e=localStorage.getItem(this.storagePrefix+"serverUrl");e?(this.serverUrl=e,this.storageMode="hybrid"):this.storageMode="local",console.log(`üíæ Storage mode: ${this.storageMode}`)}setServerUrl(e){this.serverUrl=e,localStorage.setItem(this.storagePrefix+"serverUrl",e),this.storageMode="hybrid",console.log(`üåê Server URL set: ${e}`)}getServerUrl(){return this.serverUrl}setStorageMode(e){this.storageMode=e,console.log(`üíæ Storage mode changed to: ${e}`)}setLocal(e,t){try{const s=JSON.stringify(t);localStorage.setItem(this.storagePrefix+e,s)}catch(s){console.error("‚ùå Failed to save to localStorage:",s)}}getLocal(e){try{const t=localStorage.getItem(this.storagePrefix+e);return t===null?null:JSON.parse(t)}catch(t){return console.error("‚ùå Failed to read from localStorage:",t),null}}removeLocal(e){localStorage.removeItem(this.storagePrefix+e)}clearLocal(){const e=[];for(let t=0;t<localStorage.length;t++){const s=localStorage.key(t);s&&s.startsWith(this.storagePrefix)&&e.push(s)}e.forEach(t=>localStorage.removeItem(t)),console.log("üóëÔ∏è Local storage cleared")}async saveToServer(e,t,s){if(!this.serverUrl||this.storageMode==="local")return!1;try{const{resolveUrl:i}=require("../client/UrlManager"),r=i(`${this.serverUrl.replace(/\/$/,"")}/storage/save`);return(await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({key:e,value:t})})).ok?(console.log(`‚òÅÔ∏è Saved to server: ${e}`),!0):!1}catch(i){return console.error("‚ùå Failed to save to server:",i),!1}}async loadFromServer(e,t){if(!this.serverUrl||this.storageMode==="local")return null;try{const{resolveUrl:s}=require("../client/UrlManager"),i=s(`${this.serverUrl.replace(/\/$/,"")}/storage/load?key=${encodeURIComponent(e)}`),r=await fetch(i,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(r.ok){const o=await r.json();return console.log(`‚òÅÔ∏è Loaded from server: ${e}`),o.value}return null}catch(s){return console.error("‚ùå Failed to load from server:",s),null}}async save(e,t,s){this.setLocal(e,t),(this.storageMode==="hybrid"||this.storageMode==="server")&&s&&await this.saveToServer(e,t,s)}async load(e,t){if((this.storageMode==="hybrid"||this.storageMode==="server")&&t){const s=await this.loadFromServer(e,t);if(s!==null)return this.setLocal(e,s),s}return this.getLocal(e)}async saveGameProgress(e,t){await this.save("gameProgress",e,t)}async loadGameProgress(e){return await this.load("gameProgress",e)}saveSettings(e){this.setLocal("settings",e)}loadSettings(){return this.getLocal("settings")}async updateStatistics(e,t){await this.save("statistics",e,t)}async loadStatistics(e){return await this.load("statistics",e)}async clearAllData(e){if(this.clearLocal(),(this.storageMode==="hybrid"||this.storageMode==="server")&&e){const{resolveUrl:t}=require("../client/UrlManager"),s=t(`${this.serverUrl.replace(/\/$/,"")}/storage/clear`);await fetch(s,{method:"POST",headers:{Authorization:`Bearer ${e}`}})}}}class q{static instance;currentUser=null;authToken=null;persistence;constructor(){this.persistence=B.getInstance(),this.loadSession()}static getInstance(){return q.instance||(q.instance=new q),q.instance}loadSession(){const e=this.persistence.getLocal("authToken"),t=this.persistence.getLocal("currentUser");e&&t&&(this.authToken=e,this.currentUser=t,console.log("‚úÖ Session restored:",t.username))}saveSession(){this.authToken&&this.currentUser&&(this.persistence.setLocal("authToken",this.authToken),this.persistence.setLocal("currentUser",this.currentUser))}async register(e,t,s){try{const o=this.persistence.getServerUrl();if(o){const a=await fetch(`${o}/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t,email:s})});if(a.ok){const l=await a.json();return this.authToken=l.token,this.currentUser=l.user,this.saveSession(),console.log("‚úÖ Registered on server:",e),{success:!0,user:l.user,token:l.token}}}}catch{console.log("‚ö†Ô∏è Server registration failed, using local storage")}const i=this.persistence.getLocal("users")||{};if(i[e])return{success:!1,message:"Benutzername bereits vergeben"};const r={userId:this.generateUserId(),username:e,email:s,level:1,xp:0,createdAt:new Date().toISOString(),lastLogin:new Date().toISOString(),passwordHash:await this.hashPassword(t)};return i[e]={...r},this.persistence.setLocal("users",i),this.authToken=this.generateToken(r.userId),this.currentUser=r,this.saveSession(),console.log("‚úÖ Registered locally:",e),{success:!0,user:r,token:this.authToken}}async login(e,t){try{const r=this.persistence.getServerUrl();if(r){const o=await fetch(`${r}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})});if(o.ok){const a=await o.json();return this.authToken=a.token,this.currentUser=a.user,this.currentUser&&(this.currentUser.lastLogin=new Date().toISOString()),this.saveSession(),console.log("‚úÖ Logged in via server:",e),{success:!0,user:a.user,token:a.token}}}}catch{console.log("‚ö†Ô∏è Server login failed, using local storage")}const s=this.persistence.getLocal("users")||{},i=s[e];return i?i.passwordHash!==await this.hashPassword(t)?{success:!1,message:"Falsches Passwort"}:(i.lastLogin=new Date().toISOString(),s[e]=i,this.persistence.setLocal("users",s),this.authToken=this.generateToken(i.userId),this.currentUser={userId:i.userId,username:i.username,email:i.email,level:i.level,xp:i.xp,createdAt:i.createdAt,lastLogin:i.lastLogin,passwordHash:i.passwordHash},this.saveSession(),console.log("‚úÖ Logged in locally:",e),{success:!0,user:this.currentUser,token:this.authToken}):{success:!1,message:"Benutzer nicht gefunden"}}logout(){this.currentUser=null,this.authToken=null,this.persistence.removeLocal("authToken"),this.persistence.removeLocal("currentUser"),console.log("üëã Logged out")}isLoggedIn(){return this.currentUser!==null&&this.authToken!==null}getCurrentUser(){return this.currentUser}getAuthToken(){return this.authToken}async updateUserProgress(e,t){if(!this.currentUser)return;this.currentUser.xp+=e,t&&this.currentUser.level&&(this.currentUser.level+=1),this.saveSession();try{const i=this.persistence.getServerUrl();i&&this.authToken&&await fetch(`${i}/auth/progress`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.authToken}`},body:JSON.stringify({xp:this.currentUser.xp,level:this.currentUser.level})})}catch{console.log("‚ö†Ô∏è Could not sync progress with server")}const s=this.persistence.getLocal("users")||{};s[this.currentUser.username]&&(s[this.currentUser.username].xp=this.currentUser.xp,s[this.currentUser.username].level=this.currentUser.level,this.persistence.setLocal("users",s))}generateUserId(){return"user_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}generateToken(e){return btoa(e+":"+Date.now()+":"+Math.random().toString(36).substr(2,16))}async hashPassword(e){let t=this.persistence.getLocal("passwordSalt");if(!t){const l=new Uint8Array(128);crypto.getRandomValues(l),t=btoa(String.fromCharCode(...l)),this.persistence.setLocal("passwordSalt",t)}const s=new TextEncoder,i=await crypto.subtle.importKey("raw",s.encode(e),"PBKDF2",!1,["deriveBits"]),r=new Uint8Array([...atob(t)].map(l=>l.charCodeAt(0))),o=await crypto.subtle.deriveBits({name:"PBKDF2",salt:r,iterations:1e3,hash:"SHA-512"},i,512),a=new Uint8Array(o);return Array.from(a,l=>l.toString(16).padStart(2,"0")).join("")}}class ze{constructor(e){this.scene=e}createGradientBackground(e,t){const s=this.scene.add.graphics();s.fillGradientStyle(657930,657930,1451079,2048104,1),s.fillRect(0,0,e,t)}createParticles(e,t,s=30){for(let i=0;i<s;i++){const r=this.scene.add.graphics();r.fillStyle(65280,.1+Math.random()*.2),r.fillCircle(0,0,Math.random()*4+2),r.x=Math.random()*e,r.y=Math.random()*t,this.scene.tweens.add({targets:r,y:r.y+Math.random()*300-150,x:r.x+Math.random()*200-100,alpha:{from:r.alpha,to:0},scale:{from:1,to:0},duration:3e3+Math.random()*2e3,repeat:-1,delay:Math.random()*2e3})}}}class _t extends Phaser.Scene{authManager;isRegistering=!1;constructor(){super({key:"LoginScene"}),this.authManager=q.getInstance()}create(){const e=this.cameras.main.width,t=this.cameras.main.height;if(this.authManager.isLoggedIn()){console.log("Already logged in, going to main menu"),this.scene.start("MainMenuScene");return}this.cameras.main.fadeIn(500);const s=new ze(this);s.createGradientBackground(e,t),s.createParticles(e,t,20);const i=this.add.text(e/2,120,"OPEN TD",{fontSize:"64px",fontFamily:"Arial Black",color:"#ffffff",stroke:"#000000",strokeThickness:6});i.setOrigin(.5),i.setAlpha(0),this.tweens.add({targets:i,alpha:1,scale:{from:.8,to:1},duration:800,ease:"Back.easeOut"}),this.createLoginForm(e,t)}createLoginForm(e,t){const s=e/2,i=t/2-80,r=this.add.graphics();r.fillStyle(0,.7),r.fillRoundedRect(s-200,i-40,400,380,15),r.lineStyle(3,65280,.8),r.strokeRoundedRect(s-200,i-40,400,380,15);const o=this.add.text(s,i,"ANMELDEN",{fontSize:"32px",fontFamily:"Arial",color:"#00ff00"});o.setOrigin(.5),this.add.text(s-150,i+60,"Benutzername:",{fontSize:"18px",color:"#ffffff"});const a=this.createInput(s-150,i+90,300,"username");this.add.text(s-150,i+140,"Passwort:",{fontSize:"18px",color:"#ffffff"});const l=this.createInput(s-150,i+170,300,"password"),h=this.add.text(s-150,i+220,"E-Mail (optional):",{fontSize:"18px",color:"#ffffff"});h.setVisible(!1);const c=this.createInput(s-150,i+250,300,"email");c.style.display="none";const d=this.add.text(s,i+290,"ANMELDEN",{fontSize:"24px",fontFamily:"Arial",color:"#ffffff",backgroundColor:"#00aa00",padding:{x:30,y:10}});d.setOrigin(.5),d.setInteractive({useHandCursor:!0}),d.on("pointerover",()=>{d.setStyle({backgroundColor:"#00ff00"})}),d.on("pointerout",()=>{d.setStyle({backgroundColor:"#00aa00"})}),d.on("pointerdown",async()=>{const p=a.value.trim(),C=l.value.trim(),x=c.value.trim();if(!p||!C){this.showMessage("Bitte alle Felder ausf√ºllen!","#ff0000");return}if(d.disableInteractive(),this.isRegistering){const y=await this.authManager.register(p,C,x||void 0);y.success?(this.showMessage("Registrierung erfolgreich!","#00ff00"),this.time.delayedCall(1e3,()=>{this.cameras.main.fadeOut(500),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("MainMenuScene")})})):(this.showMessage(y.message||"Registrierung fehlgeschlagen","#ff0000"),d.setInteractive())}else{const y=await this.authManager.login(p,C);y.success?(this.showMessage("Anmeldung erfolgreich!","#00ff00"),this.time.delayedCall(1e3,()=>{this.cameras.main.fadeOut(500),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("MainMenuScene")})})):(this.showMessage(y.message||"Anmeldung fehlgeschlagen","#ff0000"),d.setInteractive())}});const u=this.add.text(s,i+270,"Noch kein Account? Registrieren",{fontSize:"16px",color:"#aaaaaa"});u.setOrigin(.5),u.setInteractive({useHandCursor:!0}),u.on("pointerover",()=>{u.setStyle({color:"#ffffff"})}),u.on("pointerout",()=>{u.setStyle({color:"#aaaaaa"})}),u.on("pointerdown",()=>{this.isRegistering=!this.isRegistering,this.isRegistering?(o.setText("REGISTRIEREN"),d.setText("REGISTRIEREN"),u.setText("Bereits registriert? Anmelden"),h.setVisible(!0),c.style.display="block"):(o.setText("ANMELDEN"),d.setText("ANMELDEN"),u.setText("Noch kein Account? Registrieren"),h.setVisible(!1),c.style.display="none")});const f=this.add.text(e-20,t-20,"Als Gast fortfahren ‚Üí",{fontSize:"14px",color:"#666666"});f.setOrigin(1,1),f.setInteractive({useHandCursor:!0}),f.on("pointerover",()=>{f.setStyle({color:"#aaaaaa"})}),f.on("pointerout",()=>{f.setStyle({color:"#666666"})}),f.on("pointerdown",()=>{this.cameras.main.fadeOut(500),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("MainMenuScene")})})}createInput(e,t,s,i){const r=document.createElement("input");r.type=i==="password"?"password":i==="email"?"email":"text",r.placeholder=i==="username"?"Benutzername":i==="password"?"Passwort":"E-Mail",r.style.position="absolute",r.style.width=s+"px",r.style.height="35px",r.style.fontSize="16px",r.style.padding="5px 10px",r.style.backgroundColor="#333333",r.style.color="#ffffff",r.style.border="2px solid #00aa00",r.style.borderRadius="5px",r.style.outline="none",r.style.fontFamily="Arial",r.style.boxSizing="border-box";const a=this.game.canvas.getBoundingClientRect(),l=a.width/this.cameras.main.width,h=a.height/this.cameras.main.height;return r.style.left=a.left+e*l+"px",r.style.top=a.top+t*h+"px",r.style.width=s*l+"px",r.style.height=35*h+"px",document.body.appendChild(r),this.events.once("shutdown",()=>{r.remove()}),r}showMessage(e,t){const s=this.cameras.main.width,i=this.cameras.main.height,r=this.add.text(s/2,i/2+200,e,{fontSize:"20px",color:t,backgroundColor:"#000000",padding:{x:20,y:10}});r.setOrigin(.5),r.setAlpha(0),this.tweens.add({targets:r,alpha:1,duration:300}),this.time.delayedCall(3e3,()=>{this.tweens.add({targets:r,alpha:0,duration:300,onComplete:()=>r.destroy()})})}}class It{constructor(e){this.scene=e}createAnimatedTitle(e,t,s,i){const r=this.scene.add.text(e,t-20,s,{font:"bold 80px Arial",color:"#00ff00"});if(r.setOrigin(.5),r.setStroke("#003300",10),r.setShadow(0,0,"#00ff00",20,!1,!0),r.setScale(0),r.setAlpha(0),this.scene.tweens.add({targets:r,scale:1,alpha:1,duration:800,ease:"Back.easeOut"}),this.scene.tweens.add({targets:r,scale:{from:1,to:1.05},duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),i){const o=this.scene.add.text(e,t+70,"",{font:"28px Arial",color:"#00cc00"});o.setOrigin(.5);let a=0;this.scene.time.addEvent({delay:100,callback:()=>{a<i.length&&(o.setText(i.substring(0,a+1)),a++)},repeat:i.length-1})}}}class At{constructor(e){this.scene=e}lightenColor(e,t){const s=parseInt(e.replace("#",""),16),i=Math.round(2.55*t),r=Math.min(255,(s>>16&255)+i),o=Math.min(255,(s>>8&255)+i),a=Math.min(255,(s&255)+i);return"#"+((1<<24)+(r<<16)+(o<<8)+a).toString(16).slice(1)}createButton(e,t,s,i,r){const o=this.scene.add.text(e,t,s,{font:"bold 28px Arial",color:"#ffffff",backgroundColor:i,padding:{x:30,y:12}});return o.setOrigin(.5),o.setInteractive({useHandCursor:!0}),o.on("pointerover",()=>{o.setScale(1.1),o.setStyle({backgroundColor:this.lightenColor(i,30),shadow:{blur:15,color:i,fill:!0}}),this.scene.tweens.add({targets:o,scale:1.1,duration:200,ease:"Back.easeOut"})}),o.on("pointerout",()=>{o.setStyle({backgroundColor:i,shadow:{blur:0,color:"#000000",fill:!1}}),this.scene.tweens.add({targets:o,scale:1,duration:200})}),o.on("pointerdown",()=>{this.scene.tweens.add({targets:o,scale:.95,duration:100,yoyo:!0,onComplete:r})}),o}createMainMenuButtons(e,t,s,i){const r=this.createButton(e,t,"Einzelspieler","#00aa00",i.onSingleplayer),o=this.createButton(e,t+s,"Mehrspieler","#e67e22",i.onMultiplayer),a=this.createButton(e,t+s*2,"Optionen","#0066cc",i.onOptions),l=this.createButton(e,t+s*3,"Credits","#666666",i.onCredits);return[r,o,a,l]}animateButtonsEntrance(e,t=800){e.forEach((s,i)=>{s.setAlpha(0),s.setY(s.y+50),this.scene.tweens.add({targets:s,alpha:1,y:s.y-50,duration:500,delay:t+i*150,ease:"Back.easeOut"})})}}class Lt{constructor(e){this.scene=e,this.mapRegistry=W.getInstance()}elements=[];mapRegistry;show(e,t,s,i){const r=e/2,o=t/2,a=this.scene.add.rectangle(0,0,e,t,0,.8);a.setOrigin(0),a.setInteractive();const l=this.mapRegistry.getAllMaps(),h=Math.min(700,200+l.length*220),d=this.scene.add.rectangle(r,o,h,400,1710638);d.setStrokeStyle(3,65280);const u=this.scene.add.text(r,o-150,"W√§hle eine Karte",{font:"bold 32px Arial",color:"#00ff00"});u.setOrigin(.5),this.elements=[a,d,u];const f=l.map((T,w)=>{const S=["#0088ff","#ff8800","#8800ff","#00ff88","#ff0088","#88ff00"];return{id:T.id,name:T.config.name,description:T.config.description,color:S[w%S.length]}}),p=180,C=220,x=r-(f.length-1)*C/2;f.forEach((T,w)=>{const S=x+w*C,F=o-20,M=this.scene.add.rectangle(S,F,p,120,2969622);M.setStrokeStyle(3,parseInt(T.color.replace("#","0x"))),M.setInteractive({useHandCursor:!0});const v=this.scene.add.text(S,F-10,T.name,{font:"bold 20px Arial",color:T.color});v.setOrigin(.5);const b=this.scene.add.text(S,F+20,T.description,{font:"14px Arial",color:"#cccccc",align:"center",wordWrap:{width:p-20}});b.setOrigin(.5),M.on("pointerover",()=>{M.setFillStyle(4022310),this.scene.tweens.add({targets:M,scaleX:1.05,scaleY:1.05,duration:200})}),M.on("pointerout",()=>{M.setFillStyle(2969622),this.scene.tweens.add({targets:M,scaleX:1,scaleY:1,duration:200})}),M.on("pointerdown",()=>{s(T.id)}),this.elements.push(M,v,b)});const y=this.scene.add.text(r,o+140,"Zur√ºck",{font:"bold 20px Arial",color:"#ffffff",backgroundColor:"#666666",padding:{x:20,y:8}});y.setOrigin(.5),y.setInteractive({useHandCursor:!0}),y.on("pointerover",()=>{y.setStyle({backgroundColor:"#888888"})}),y.on("pointerout",()=>{y.setStyle({backgroundColor:"#666666"})}),y.on("pointerdown",()=>{this.hide(),i()}),this.elements.push(y),this.elements.forEach((T,w)=>{"setAlpha"in T&&T.setAlpha(0),this.scene.tweens.add({targets:T,alpha:1,duration:300,delay:w*30})})}hide(){this.elements.forEach(e=>{this.scene.tweens.add({targets:e,alpha:0,duration:300,onComplete:()=>e.destroy()})}),this.elements=[]}}class Ot{constructor(e){this.scene=e}elements=[];show(e,t,s){const i=e/2,r=t/2,o=this.scene.add.rectangle(0,0,e,t,0,.8);o.setOrigin(0),o.setInteractive();const a=this.scene.add.rectangle(i,r,500,300,1710638);a.setStrokeStyle(3,65280);const l=this.scene.add.text(i,r-100,"Credits",{font:"bold 32px Arial",color:"#00ff00"});l.setOrigin(.5);const h=this.scene.add.text(i,r-20,`Entwickelt mit Phaser 3

Game Engine: Phaser.io
Build Tool: Vite
Mobile: Capacitor

Ein Open Source Projekt`,{font:"18px Arial",color:"#ffffff",align:"center"});h.setOrigin(.5);const c=this.scene.add.text(i,r+110,"Schlie√üen",{font:"bold 20px Arial",color:"#ffffff",backgroundColor:"#00aa00",padding:{x:20,y:8}});c.setOrigin(.5),c.setInteractive({useHandCursor:!0}),c.on("pointerdown",()=>{this.hide(),s()}),this.elements=[o,a,l,h,c],this.elements.forEach(d=>{"setAlpha"in d&&d.setAlpha(0),this.scene.tweens.add({targets:d,alpha:1,duration:300})})}hide(){this.elements.forEach(e=>{this.scene.tweens.add({targets:e,alpha:0,duration:300,onComplete:()=>e.destroy()})}),this.elements=[]}}class Dt extends Phaser.Scene{levelSelection;creditsOverlay;authManager;constructor(){super({key:"MainMenuScene"}),this.authManager=q.getInstance()}create(){const e=this.cameras.main.width,t=this.cameras.main.height;this.cameras.main.fadeIn(500);const s=new ze(this);s.createGradientBackground(e,t),s.createParticles(e,t,30),new It(this).createAnimatedTitle(e/2,t/3,"OPEN TD","Tower Defense");const r=t/2+80,o=80,a=new At(this),l=a.createMainMenuButtons(e/2,r,o,{onSingleplayer:()=>this.handleSingleplayer(),onMultiplayer:()=>this.handleMultiplayer(),onOptions:()=>this.handleOptions(),onCredits:()=>this.handleCredits()});a.animateButtonsEntrance(l,800);const h=this.add.text(e/2,t-80,"üéÆ Platziere strategisch T√ºrme und verteidige deine Basis!",{font:"18px Arial",color:"#888888"});h.setOrigin(.5),h.setAlpha(0),this.tweens.add({targets:h,alpha:1,duration:1e3,delay:1500}),this.add.text(e-10,t-10,"v1.0.0",{font:"14px Arial",color:"#444444"}).setOrigin(1,1),this.createUserInfo(e)}createUserInfo(e){const t=this.authManager.getCurrentUser();if(t){const s=this.add.graphics();s.fillStyle(0,.7),s.fillRoundedRect(e-250,10,240,80,10),s.lineStyle(2,43520,.8),s.strokeRoundedRect(e-250,10,240,80,10),this.add.text(e-130,25,t.username,{fontSize:"20px",fontFamily:"Arial",color:"#00ff00",fontStyle:"bold"}).setOrigin(.5,0),this.add.text(e-130,50,`Level ${t.level} | ${t.xp} XP`,{fontSize:"14px",color:"#ffffff"}).setOrigin(.5,0);const o=this.add.text(e-130,70,"üö™ Abmelden",{fontSize:"12px",color:"#ff6666"});o.setOrigin(.5,0),o.setInteractive({useHandCursor:!0}),o.on("pointerover",()=>{o.setStyle({color:"#ff0000"})}),o.on("pointerout",()=>{o.setStyle({color:"#ff6666"})}),o.on("pointerdown",()=>{this.authManager.logout(),this.cameras.main.fadeOut(300),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("LoginScene")})})}else this.add.text(e-20,20,"Gast-Modus",{fontSize:"16px",color:"#666666"}).setOrigin(1,0)}handleSingleplayer(){this.levelSelection=new Lt(this),this.levelSelection.show(this.cameras.main.width,this.cameras.main.height,e=>{this.cameras.main.fadeOut(300),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("GameScene",{levelType:e})})},()=>{})}handleMultiplayer(){this.cameras.main.fadeOut(500),this.time.delayedCall(500,()=>{this.scene.start("MultiplayerScene")})}handleOptions(){this.scene.launch("OptionsScene"),this.scene.pause()}handleCredits(){this.creditsOverlay=new Ot(this),this.creditsOverlay.show(this.cameras.main.width,this.cameras.main.height,()=>{})}}class Ue{constructor(e,t,s,i,r){this.scene=e,this.onChange=r,this.enabled=i,this.container=e.add.container(t,s),this.bg=e.add.rectangle(0,0,80,36,i?43520:6710886),this.bg.setStrokeStyle(2,16777215,.5),this.toggleCircle=e.add.circle(i?20:-20,0,14,16777215),this.label=e.add.text(0,0,i?"AN":"AUS",{font:"bold 16px Arial",color:"#000000"}),this.label.setOrigin(.5),this.container.add([this.bg,this.toggleCircle,this.label]),this.container.setSize(80,36),this.container.setInteractive(new Phaser.Geom.Rectangle(-40,-18,80,36),Phaser.Geom.Rectangle.Contains),this.container.on("pointerdown",()=>this.handleToggle())}container;bg;toggleCircle;label;enabled;handleToggle(){this.enabled=!this.enabled,this.bg.setFillStyle(this.enabled?43520:6710886),this.scene.tweens.add({targets:this.toggleCircle,x:this.enabled?20:-20,duration:300,ease:"Back.easeOut"}),this.label.setText(this.enabled?"AN":"AUS"),this.onChange(this.enabled)}getContainer(){return this.container}}class Ut{constructor(e,t){this.scene=e,this.onChange=t,this.currentDifficulty="normal"}buttons=[];currentDifficulty;create(e,t,s){this.currentDifficulty=s;const i=this.scene.add.text(e-150,t+50,"Schwierigkeit:",{font:"24px Arial",color:"#ffffff"}),r=[{value:"easy",label:"Leicht",color:43520},{value:"normal",label:"Normal",color:26316},{value:"hard",label:"Schwer",color:13369344}];return r.forEach((o,a)=>{const l=this.scene.add.text(e-120+a*120,t+100,o.label,{font:"20px Arial",color:"#ffffff",backgroundColor:this.currentDifficulty===o.value?`#${o.color.toString(16).padStart(6,"0")}`:"#333333",padding:{x:15,y:8}});l.setOrigin(.5),l.setInteractive({useHandCursor:!0}),l.on("pointerover",()=>{this.currentDifficulty!==o.value&&l.setStyle({backgroundColor:"#555555"})}),l.on("pointerout",()=>{this.currentDifficulty!==o.value&&l.setStyle({backgroundColor:"#333333"})}),l.on("pointerdown",()=>{this.currentDifficulty=o.value,this.onChange(o.value),this.buttons.forEach((h,c)=>{const d=r[c];h.setStyle({backgroundColor:this.currentDifficulty===d.value?`#${d.color.toString(16).padStart(6,"0")}`:"#333333"})})}),this.buttons.push(l)}),{label:i,buttons:this.buttons}}getDifficultyInfo(){switch(this.currentDifficulty){case"easy":return"Weniger Gegner, mehr Startgold";case"normal":return"Ausbalanciertes Spielerlebnis";case"hard":return"Mehr Gegner, weniger Ressourcen";default:return""}}}class Z{static defaultSettings={soundEnabled:!0,musicEnabled:!0,difficulty:"normal"};static save(e){B.getInstance().saveSettings(e)}static load(){const e=B.getInstance().loadSettings();if(e)try{return{...this.defaultSettings,...e}}catch(t){console.error("Failed to load settings:",t)}return{...this.defaultSettings}}static getSettings(){return this.load()}}class V{static instance;scene=null;music=null;soundEnabled=!1;musicEnabled=!1;constructor(){}static getInstance(){return V.instance||(V.instance=new V),V.instance}init(e,t,s){this.scene=e;const i=m.getInstance();this.soundEnabled=i.isLoaded()?i.isSoundEnabled():t??!1,this.musicEnabled=i.isLoaded()?i.isMusicEnabled():s??!1,this.loadAssets()}loadAssets(){if(!this.scene)return;const e=m.getInstance();if(e.isLoaded()&&!e.isSoundEnabled())return;const t=[["click","assets/sounds/click.mp3"],["music","assets/music/menu.mp3"],["tower_basic","assets/sounds/tower_basic.mp3"],["tower_fast","assets/sounds/tower_fast.mp3"],["tower_fire","assets/sounds/tower_fire.mp3"],["tower_frost","assets/sounds/tower_frost.mp3"],["tower_sniper","assets/sounds/tower_sniper.mp3"],["tower_splash","assets/sounds/tower_splash.mp3"],["tower_strong","assets/sounds/tower_strong.mp3"]];for(const[s,i]of t)this.scene.cache.audio.has(s)||this.scene.load.audio(s,Ze(i));this.scene.load.start()}playTower(e){const t=m.getInstance();if(!this.soundEnabled||!this.scene||!this.scene.sound||t.isLoaded()&&!t.isSoundEnabled())return;const i={basic:"tower_basic",fast:"tower_fast",fire:"tower_fire",frost:"tower_frost",sniper:"tower_sniper",splash:"tower_splash",strong:"tower_strong"}[e]||"click";this.scene.sound.play(i,{volume:.5})}playClick(){const e=m.getInstance();this.soundEnabled&&this.scene&&this.scene.sound&&(!e.isLoaded()||e.isSoundEnabled())&&this.scene.sound.play("click",{volume:.5})}playMusic(){const e=m.getInstance();this.musicEnabled&&this.scene&&this.scene.sound&&(!e.isLoaded()||e.isMusicEnabled())&&(!this.music||!this.music.isPlaying)&&(this.music=this.scene.sound.add("music",{loop:!0,volume:.3}),this.music.play())}stopMusic(){this.music&&this.music.isPlaying&&this.music.stop()}setSoundEnabled(e){this.soundEnabled=e}setMusicEnabled(e){this.musicEnabled=e,e?this.playMusic():this.stopMusic()}}class Re extends Phaser.Scene{settings;constructor(){super({key:"OptionsScene"}),this.settings=Z.load()}create(){const e=V.getInstance(),t=this.cameras.main.width,s=this.cameras.main.height,i=this.add.rectangle(0,0,t,s,0,.85);i.setOrigin(0),i.setInteractive();const a=this.add.rectangle(t/2,s/2,600,500,1710638);a.setStrokeStyle(4,65280);const l=this.add.text(t/2,s/2-200,"Optionen",{font:"bold 48px Arial",color:"#00ff00"});l.setOrigin(.5);const h=this.add.text(t/2-150,s/2-100,"Sound:",{font:"24px Arial",color:"#ffffff"}),c=new Ue(this,t/2+100,s/2-100,this.settings.soundEnabled,w=>{this.settings.soundEnabled=w,Z.save(this.settings),e.setSoundEnabled(w),w&&e.playClick()}),d=this.add.text(t/2-150,s/2-30,"Musik:",{font:"24px Arial",color:"#ffffff"}),u=new Ue(this,t/2+100,s/2-30,this.settings.musicEnabled,w=>{this.settings.musicEnabled=w,Z.save(this.settings),e.setMusicEnabled(w)}),f=new Ut(this,w=>{this.settings.difficulty=w,Z.save(this.settings),x.setText(f.getDifficultyInfo())}),{label:p,buttons:C}=f.create(t/2,s/2,this.settings.difficulty),x=this.add.text(t/2,s/2+150,f.getDifficultyInfo(),{font:"16px Arial",color:"#888888",align:"center"});x.setOrigin(.5);const y=this.add.text(t/2,s/2+200,"Zur√ºck",{font:"bold 24px Arial",color:"#ffffff",backgroundColor:"#00aa00",padding:{x:30,y:10}});y.setOrigin(.5),y.setInteractive({useHandCursor:!0}),y.on("pointerover",()=>{y.setScale(1.1)}),y.on("pointerout",()=>{y.setScale(1)}),y.on("pointerdown",()=>{this.scene.resume("MainMenuScene"),this.scene.stop()}),[i,a,l,h,c.getContainer(),d,u.getContainer(),p,...C,x,y].forEach((w,S)=>{w.setAlpha(0),this.tweens.add({targets:w,alpha:1,duration:300,delay:S*30})}),e.init(this,this.settings.soundEnabled,this.settings.musicEnabled),this.settings.musicEnabled?e.playMusic():e.stopMusic()}static getSettings(){return Z.getSettings()}}class Ht{scene;goldText;livesText;waveText;xpText;levelText;roomCodeText;constructor(e,t,s,i,r,o,a){this.scene=e;const l=20;this.goldText=e.add.text(l,l,`Gold: ${t}`,{font:"24px Arial",color:"#ffd700"}),this.livesText=e.add.text(l,l+35,`Leben: ${s}`,{font:"24px Arial",color:"#ff0000"}),this.waveText=e.add.text(l,l+70,`Welle: ${i}`,{font:"24px Arial",color:"#00ff00"}),this.levelText=e.add.text(l,l+105,`Level: ${r}`,{font:"20px Arial",color:"#00ffff"}),this.xpText=e.add.text(l,l+135,`XP: ${o}/${a}`,{font:"18px Arial",color:"#aaffff"})}updateGold(e){this.goldText.setText(`Gold: ${e}`)}updateLives(e){this.livesText.setText(`Leben: ${e}`)}updateWave(e){this.waveText.setText(`Welle: ${e}`)}updateXP(e,t,s){this.levelText.setText(`Level: ${t}`),this.xpText.setText(`XP: ${e}/${s}`)}showRoomCode(e){const t=this.scene.cameras.main.width,s=20;this.roomCodeText=this.scene.add.text(t-s,s+140,`üéÆ Raum: ${e}`,{font:"bold 20px Arial",color:"#ffffff",backgroundColor:"#4a90e2",padding:{x:12,y:8}}),this.roomCodeText.setOrigin(1,0),this.roomCodeText.setInteractive({useHandCursor:!0}),this.roomCodeText.on("pointerdown",i=>{i.event.stopPropagation(),navigator.clipboard.writeText(e).then(()=>{const r=this.roomCodeText.text;this.roomCodeText.setText("‚úì Kopiert!"),this.roomCodeText.setStyle({backgroundColor:"#00aa00"}),this.scene.time.delayedCall(1500,()=>{this.roomCodeText&&(this.roomCodeText.setText(r),this.roomCodeText.setStyle({backgroundColor:"#4a90e2"}))})})}),this.roomCodeText.on("pointerover",()=>{this.roomCodeText.setStyle({backgroundColor:"#5aa0f2"})}),this.roomCodeText.on("pointerout",()=>{this.roomCodeText.setStyle({backgroundColor:"#4a90e2"})})}hideRoomCode(){this.roomCodeText&&(this.roomCodeText.destroy(),this.roomCodeText=void 0)}}class Nt{scene;buttons=[];gold;researchManager;onTowerSelect;constructor(e,t,s,i){this.scene=e,this.gold=t,this.researchManager=s,this.onTowerSelect=i,this.createButtons()}createButtons(){const e=this.scene.cameras.main.height-80,t=20,s=120,i=m.getInstance().getConfig();[{type:"basic",label:i.towers.basic.name,cost:i.towers.basic.cost},{type:"fast",label:i.towers.fast.name,cost:i.towers.fast.cost},{type:"strong",label:i.towers.strong.name,cost:i.towers.strong.cost},{type:"splash",label:i.towers.splash.name,cost:i.towers.splash.cost},{type:"sniper",label:i.towers.sniper.name,cost:i.towers.sniper.cost},{type:"frost",label:i.towers.frost.name,cost:i.towers.frost.cost,requiresResearch:i.towers.frost.requiresResearch,researchId:"frost_tower"},{type:"fire",label:i.towers.fire.name,cost:i.towers.fire.cost,requiresResearch:i.towers.fire.requiresResearch,researchId:"fire_tower"}].forEach((o,a)=>{if(o.requiresResearch&&o.researchId&&!this.researchManager.isResearched(o.researchId))return;const l=this.scene.add.text(t+a*s,e,`${o.label}
${o.cost}G`,{font:"16px Arial",color:"#ffffff",backgroundColor:"#333333",padding:{x:10,y:5},align:"center"});l.setInteractive({useHandCursor:!0}),l.setData("towerType",o.type),l.setData("cost",o.cost),l.on("pointerdown",h=>{h.event.stopPropagation(),this.gold>=o.cost&&this.onTowerSelect(o.type,o.cost)}),this.buttons.push(l)})}updateGold(e){this.gold=e,this.updateStyles()}updateStyles(e){this.buttons.forEach(t=>{const s=t.getData("towerType"),i=t.getData("cost");s===e?t.setStyle({backgroundColor:"#00aa00"}):this.gold>=i?t.setStyle({backgroundColor:"#333333"}):t.setStyle({backgroundColor:"#333333"})})}recreate(){this.buttons.forEach(e=>e.destroy()),this.buttons=[],this.createButtons()}getButtons(){return this.buttons}}class Wt{startButton;pauseButton;autoWaveButton;isPaused=!1;autoWaveEnabled=!1;constructor(e,t,s,i){const r=e.cameras.main.width,o=e.cameras.main.height,a=20;this.startButton=e.add.text(r/2,o/2,"Welle Starten",{font:"bold 32px Arial",color:"#ffffff",backgroundColor:"#00aa00",padding:{x:30,y:15}}),this.startButton.setOrigin(.5),this.startButton.setInteractive({useHandCursor:!0}),this.startButton.on("pointerover",()=>{this.startButton.setStyle({backgroundColor:"#00ff00"})}),this.startButton.on("pointerout",()=>{this.startButton.setStyle({backgroundColor:"#00aa00"})}),this.startButton.on("pointerdown",l=>{l.event.stopPropagation(),t()}),this.pauseButton=e.add.text(r-a,a,"‚è∏ Pause",{font:"bold 20px Arial",color:"#ffffff",backgroundColor:"#666666",padding:{x:15,y:8}}),this.pauseButton.setOrigin(1,0),this.pauseButton.setInteractive({useHandCursor:!0}),this.pauseButton.on("pointerover",()=>{this.pauseButton.setStyle({backgroundColor:"#888888"})}),this.pauseButton.on("pointerout",()=>{const l=this.isPaused?"#ff6600":"#666666";this.pauseButton.setStyle({backgroundColor:l})}),this.pauseButton.on("pointerdown",l=>{l.event.stopPropagation(),s()}),this.autoWaveButton=e.add.text(r-a,a+45,"‚ö° Auto-Welle: AUS",{font:"bold 18px Arial",color:"#ffffff",backgroundColor:"#444444",padding:{x:12,y:6}}),this.autoWaveButton.setOrigin(1,0),this.autoWaveButton.setInteractive({useHandCursor:!0}),this.autoWaveButton.on("pointerover",()=>{this.autoWaveButton.setStyle({backgroundColor:"#666666"})}),this.autoWaveButton.on("pointerout",()=>{const l=this.autoWaveEnabled?"#00aa00":"#444444";this.autoWaveButton.setStyle({backgroundColor:l})}),this.autoWaveButton.on("pointerdown",l=>{l.event.stopPropagation(),i()})}showStartButton(e="Welle Starten"){this.startButton.setText(e),this.startButton.setVisible(!0),this.startButton.setInteractive({useHandCursor:!0})}hideStartButton(){this.startButton.setVisible(!1),this.startButton.disableInteractive()}setPaused(e){this.isPaused=e,this.pauseButton.setText(e?"‚ñ∂ Weiter":"‚è∏ Pause"),this.pauseButton.setStyle({backgroundColor:e?"#ff6600":"#666666"})}setAutoWave(e){this.autoWaveEnabled=e,this.autoWaveButton.setText(e?"‚ö° Auto-Welle: AN":"‚ö° Auto-Welle: AUS"),this.autoWaveButton.setStyle({backgroundColor:e?"#00aa00":"#444444"})}getButtons(){return[this.startButton,this.pauseButton,this.autoWaveButton]}}class $t{upgradeButton;sellButton;towerInfoText;gold;constructor(e,t,s,i){this.gold=t;const r=e.cameras.main.width,o=e.cameras.main.height;this.towerInfoText=e.add.text(r/2,o-220,"",{font:"20px Arial",color:"#ffffff",backgroundColor:"#333333",padding:{x:20,y:10},align:"center"}),this.towerInfoText.setOrigin(.5),this.towerInfoText.setVisible(!1),this.upgradeButton=e.add.text(r/2,o-160,`Upgrade-Turm
(W√§hle einen Turm)`,{font:"18px Arial",color:"#ffffff",backgroundColor:"#ff9900",padding:{x:15,y:10},align:"center"}),this.upgradeButton.setOrigin(.5),this.upgradeButton.setInteractive({useHandCursor:!0}),this.upgradeButton.setVisible(!1),this.upgradeButton.on("pointerover",()=>{this.upgradeButton.setStyle({backgroundColor:"#ffaa00"})}),this.upgradeButton.on("pointerout",()=>{this.upgradeButton.setStyle({backgroundColor:"#ff9900"})}),this.upgradeButton.on("pointerdown",a=>{a.event.stopPropagation(),s()}),this.sellButton=e.add.text(r/2+150,o-160,`Verkaufen
(90% zur√ºck)`,{font:"18px Arial",color:"#ffffff",backgroundColor:"#cc0000",padding:{x:15,y:10},align:"center"}),this.sellButton.setOrigin(.5),this.sellButton.setInteractive({useHandCursor:!0}),this.sellButton.setVisible(!1),this.sellButton.on("pointerover",()=>{this.sellButton.setStyle({backgroundColor:"#ff0000"})}),this.sellButton.on("pointerout",()=>{this.sellButton.setStyle({backgroundColor:"#cc0000"})}),this.sellButton.on("pointerdown",a=>{a.event.stopPropagation(),i()})}updateGold(e){this.gold=e}updateForTower(e){if(!e){this.upgradeButton.setVisible(!1),this.sellButton.setVisible(!1),this.towerInfoText.setVisible(!1);return}const t=e.getType(),s=this.getTowerDisplayName(t),i=e.getUpgradeLevel(),r=Math.round(e.getDamage()),o=Math.round(e.getRange());this.towerInfoText.setText(`${s} (Level ${i})
Schaden: ${r} | Reichweite: ${o}`),this.towerInfoText.setVisible(!0);const a=e.getSellValue();if(this.sellButton.setText(`Verkaufen
${a}G
(90% zur√ºck)`),this.sellButton.setVisible(!0),!e.canUpgrade()){this.upgradeButton.setVisible(!1);return}const l=e.getUpgradeCost();this.upgradeButton.setText(`Upgrade Turm
Level ${i} ‚Üí ${i+1}
Kosten: ${l}G`),this.upgradeButton.setVisible(!0),this.gold>=l?this.upgradeButton.setStyle({backgroundColor:"#ff9900"}):this.upgradeButton.setStyle({backgroundColor:"#666666"})}getButtons(){return[this.upgradeButton,this.sellButton]}getTowerDisplayName(e){return{basic:"Basis-Turm",fast:"Schnell-Turm",strong:"Stark-Turm",sniper:"Sniper-Turm",splash:"Splash-Turm",frost:"Frost-Turm",fire:"Feuer-Turm"}[e]||e}}class Ft{scene;button;notificationBadge;pulseTween;constructor(e,t){this.scene=e;const s=e.cameras.main.width,i=20;this.button=e.add.text(s-i,i+95,"üî¨ Forschung",{font:"bold 18px Arial",color:"#ffffff",backgroundColor:"#9900ff",padding:{x:12,y:6}}),this.button.setOrigin(1,0),this.button.setInteractive({useHandCursor:!0}),this.button.on("pointerover",()=>{this.button.setStyle({backgroundColor:"#bb44ff"})}),this.button.on("pointerout",()=>{this.button.setStyle({backgroundColor:"#9900ff"})}),this.button.on("pointerdown",r=>{r.event.stopPropagation(),this.hidePulse(),t()}),this.notificationBadge=e.add.graphics(),this.notificationBadge.setDepth(100),this.notificationBadge.setVisible(!1)}showPulse(){this.pulseTween&&this.pulseTween.stop();const s=this.scene.cameras.main.width-20-10,i=108;this.notificationBadge.clear(),this.notificationBadge.fillStyle(16711680,1),this.notificationBadge.fillCircle(s,i,8),this.notificationBadge.lineStyle(2,16777215,1),this.notificationBadge.strokeCircle(s,i,8),this.notificationBadge.setVisible(!0),this.pulseTween=this.scene.tweens.add({targets:this.button,scaleX:{from:1,to:1.1},scaleY:{from:1,to:1.1},duration:600,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.scene.tweens.add({targets:this.notificationBadge,alpha:{from:1,to:.3},duration:500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}hidePulse(){this.pulseTween&&(this.pulseTween.stop(),this.pulseTween=void 0),this.button.setScale(1),this.notificationBadge.setVisible(!1),this.notificationBadge.clear()}getButton(){return this.button}}class Gt{scene;researchManager;container;gold;onGoldSpent;onResearchComplete;constructor(e,t,s,i,r){this.scene=e,this.researchManager=t,this.gold=s,this.onGoldSpent=i,this.onResearchComplete=r}updateGold(e){this.gold=e}isOpen(){return this.container!==void 0}toggle(){this.isOpen()?this.close():this.show()}show(){const e=this.scene.cameras.main.width,t=this.scene.cameras.main.height;this.container=this.scene.add.container(0,0),this.container.setDepth(1e3);const s=this.scene.add.rectangle(0,0,e,t,0,.8);s.setOrigin(0),s.setInteractive(),this.container.add(s);const i=600,r=500,o=this.scene.add.rectangle(e/2,t/2,i,r,2236962);this.container.add(o);const a=this.scene.add.text(e/2,t/2-r/2+40,"Forschung",{font:"bold 32px Arial",color:"#ffffff"});a.setOrigin(.5),this.container.add(a);const l=this.researchManager.getAvailableResearches(),h=t/2-r/2+100,c=100;if(l.forEach((u,f)=>{const p=h+f*c,C=this.scene.add.rectangle(e/2,p,i-60,c-10,3355443);this.container.add(C);const x=this.scene.add.text(e/2-250,p-20,u.name,{font:"bold 20px Arial",color:"#ffff00"});this.container.add(x);const y=this.scene.add.text(e/2-250,p+5,u.description,{font:"16px Arial",color:"#cccccc"});this.container.add(y);const T=this.scene.add.text(e/2-250,p+30,`Kosten: ${u.goldCost} Gold | ${u.xpRequired} XP`,{font:"14px Arial",color:"#aaaaaa"});this.container.add(T);const w=this.researchManager.canResearch(u.id,this.gold),S=this.scene.add.text(e/2+180,p,"Erforschen",{font:"bold 18px Arial",color:"#ffffff",backgroundColor:w?"#00aa00":"#666666",padding:{x:15,y:8}});S.setOrigin(.5),w&&(S.setInteractive({useHandCursor:!0}),S.on("pointerover",()=>{S.setStyle({backgroundColor:"#00ff00"})}),S.on("pointerout",()=>{S.setStyle({backgroundColor:"#00aa00"})}),S.on("pointerdown",F=>{F.event.stopPropagation(),this.handleResearch(u.id)})),this.container.add(S)}),l.length===0){const u=this.scene.add.text(e/2,t/2,"Keine Forschungen verf√ºgbar",{font:"20px Arial",color:"#888888"});u.setOrigin(.5),this.container.add(u);const f=this.scene.add.text(e/2,t/2+40,"Sammle mehr XP, um neue Forschungen freizuschalten!",{font:"16px Arial",color:"#666666"});f.setOrigin(.5),this.container.add(f)}const d=this.scene.add.text(e/2,t/2+r/2-40,"Schlie√üen",{font:"bold 20px Arial",color:"#ffffff",backgroundColor:"#ff0000",padding:{x:20,y:10}});d.setOrigin(.5),d.setInteractive({useHandCursor:!0}),d.on("pointerover",()=>{d.setStyle({backgroundColor:"#ff4444"})}),d.on("pointerout",()=>{d.setStyle({backgroundColor:"#ff0000"})}),d.on("pointerdown",u=>{u.event.stopPropagation(),this.close()}),this.container.add(d)}close(){this.container&&(this.container.destroy(),this.container=void 0)}handleResearch(e){const t=this.researchManager.getResearch(e);t&&this.researchManager.canResearch(e,this.gold)&&(this.researchManager.research(e),this.onGoldSpent(t.goldCost),this.onResearchComplete(e),this.close(),this.show())}}class qt{scene;gold;lives;wave;researchManager;statsDisplay;towerButtons;controlButtons;towerActionButtons;researchButton;researchOverlay;constructor(e,t,s,i){this.scene=e,this.gold=t,this.lives=s,this.wave=0,this.researchManager=i}create(e,t,s,i,r,o,a){this.statsDisplay=new Ht(this.scene,this.gold,this.lives,this.wave,this.researchManager.getLevel(),this.researchManager.getXP(),this.researchManager.getXPForNextLevel()),this.towerButtons=new Nt(this.scene,this.gold,this.researchManager,t),this.controlButtons=new Wt(this.scene,e,s,i),this.towerActionButtons=new $t(this.scene,this.gold,o,a),this.researchButton=new Ft(this.scene,r),this.researchOverlay=new Gt(this.scene,this.researchManager,this.gold,l=>{this.gold-=l,this.updateGold(this.gold)},l=>{(l==="frost_tower"||l==="fire_tower")&&this.towerButtons.recreate()})}updateGold(e){this.gold=e,this.statsDisplay.updateGold(e),this.towerButtons.updateGold(e),this.towerActionButtons.updateGold(e),this.researchOverlay.updateGold(e)}updateLives(e){this.lives=e,this.statsDisplay.updateLives(e)}updateWave(e){this.wave=e,this.statsDisplay.updateWave(e)}updateXP(e,t){this.statsDisplay.updateXP(e,t,this.researchManager.getXPForNextLevel())}showStartButton(e="Welle Starten"){this.controlButtons.showStartButton(e)}hideStartButton(){this.controlButtons.hideStartButton()}updateButtonStyles(e){this.towerButtons.updateStyles(e)}updateUpgradeButton(e){this.towerActionButtons.updateForTower(e)}getButtons(){return[...this.towerButtons.getButtons(),...this.controlButtons.getButtons(),...this.towerActionButtons.getButtons(),this.researchButton.getButton()]}setPaused(e){this.controlButtons.setPaused(e)}setAutoWave(e){this.controlButtons.setAutoWave(e)}toggleResearchOverlay(){this.researchOverlay.toggle()}showResearchButtonPulse(){this.researchButton.showPulse()}hideResearchButtonPulse(){this.researchButton.hidePulse()}getGold(){return this.gold}getLives(){return this.lives}getWave(){return this.wave}showRoomCode(e){this.statsDisplay.showRoomCode(e)}hideRoomCode(){this.statsDisplay.hideRoomCode()}}class Vt{sprite;follower;path;health;maxHealth;speed;baseSpeed;goldReward;xpReward;healthBar;slowEffect=0;slowDuration=0;constructor(e,t,s,i=1,r="normal",o=1){this.path=t,this.follower={t:0,vec:new Phaser.Math.Vector2};const a=this.getTypeStats(r,s,o,i);this.maxHealth=a.health,this.health=this.maxHealth;const h=m.getInstance().getConfig().enemies.baseSpeed;switch(this.baseSpeed=h*a.speedMultiplier,this.speed=this.baseSpeed,this.goldReward=a.gold,this.xpReward=a.xp,this.sprite=e.add.graphics(),r){case"fast":this.createGhostSprite(a.color,a.size);break;case"tank":this.createHeavyMonsterSprite(a.color,a.size);break;case"normal":default:this.createMonsterSprite(a.color,a.size);break}this.healthBar=e.add.graphics(),this.updatePosition(),this.updateHealthBar()}getTypeStats(e,t,s=1,i=1){const r=m.getInstance().getConfig(),o=r.enemies[e],a=r.enemies.healthScaling,l=Math.pow(a.waveMultiplier,Math.floor(t/a.waveInterval)),h=Math.pow(a.levelMultiplier,s-1);let c=1;if(i>1){const u=r.multiplayer;c=1+(i-1)*u.enemyScaling.healthPerPlayer}const d=l*h*c;return{health:Math.round(o.baseHealth*d),speedMultiplier:o.speedMultiplier,gold:o.baseGold+t*o.goldPerWave,xp:o.xpReward,color:parseInt(o.color),size:o.size}}createMonsterSprite(e,t){const s=Phaser.Display.Color.IntegerToColor(e),i=Phaser.Display.Color.GetColor(Math.min(255,Math.floor(s.red*1.3)),Math.min(255,Math.floor(s.green*1.3)),Math.min(255,Math.floor(s.blue*1.3))),r=Phaser.Display.Color.GetColor(Math.floor(s.red*.6),Math.floor(s.green*.6),Math.floor(s.blue*.6));this.sprite.fillStyle(0,.3),this.sprite.fillEllipse(0,t*1.2,t*1.3,t*.5),this.sprite.fillStyle(e,1),this.sprite.fillCircle(0,0,t),this.sprite.fillEllipse(0,t*.3,t*.9,t*.8),this.sprite.fillStyle(i,.7),this.sprite.fillCircle(-t*.3,-t*.4,t*.5),this.sprite.fillStyle(16776960,1),this.sprite.fillCircle(-t*.3,-t*.2,t*.35),this.sprite.fillCircle(t*.3,-t*.2,t*.35),this.sprite.fillStyle(16711680,1),this.sprite.fillCircle(-t*.3,-t*.15,t*.2),this.sprite.fillCircle(t*.3,-t*.15,t*.2),this.sprite.fillStyle(16777215,.8),this.sprite.fillCircle(-t*.25,-t*.25,t*.1),this.sprite.fillCircle(t*.35,-t*.25,t*.1),this.sprite.fillStyle(0,1),this.sprite.fillEllipse(0,t*.4,t*.5,t*.3),this.sprite.fillStyle(16777215,1),this.sprite.fillRect(-t*.2,t*.25,t*.15,t*.25),this.sprite.fillRect(t*.05,t*.25,t*.15,t*.25),this.sprite.fillStyle(r,1),this.sprite.beginPath(),this.sprite.moveTo(-t*.7,-t*.3),this.sprite.lineTo(-t*.5,-t*.8),this.sprite.lineTo(-t*.3,-t*.4),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(t*.7,-t*.3),this.sprite.lineTo(t*.5,-t*.8),this.sprite.lineTo(t*.3,-t*.4),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.lineStyle(2,0,1),this.sprite.strokeCircle(0,0,t)}createGhostSprite(e,t){this.sprite.fillStyle(0,.2),this.sprite.fillEllipse(0,t*1.2,t*1,t*.4),this.sprite.fillStyle(e,.8),this.sprite.beginPath(),this.sprite.arc(0,0,t,0,Math.PI,!0),this.sprite.lineTo(t*.6,t*.9),this.sprite.lineTo(t*.3,t*.6),this.sprite.lineTo(0,t*.9),this.sprite.lineTo(-t*.3,t*.6),this.sprite.lineTo(-t*.6,t*.9),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.fillStyle(16777215,.4),this.sprite.fillCircle(-t*.3,-t*.3,t*.6),this.sprite.fillStyle(0,1),this.sprite.fillCircle(-t*.3,-t*.1,t*.3),this.sprite.fillCircle(t*.3,-t*.1,t*.3),this.sprite.fillStyle(e,.6),this.sprite.fillCircle(-t*.3,-t*.1,t*.15),this.sprite.fillCircle(t*.3,-t*.1,t*.15),this.sprite.fillStyle(0,1),this.sprite.fillCircle(0,t*.3,t*.25),this.sprite.lineStyle(2,0,.6),this.sprite.strokeCircle(0,-t*.2,t*.9)}createHeavyMonsterSprite(e,t){const s=Phaser.Display.Color.IntegerToColor(e),i=Phaser.Display.Color.GetColor(Math.floor(s.red*.5),Math.floor(s.green*.5),Math.floor(s.blue*.5));this.sprite.fillStyle(0,.4),this.sprite.fillEllipse(0,t*1.3,t*1.6,t*.6),this.sprite.fillStyle(e,1),this.sprite.fillEllipse(0,t*.2,t*1.2,t*1),this.sprite.fillCircle(0,-t*.3,t*.9),this.sprite.fillStyle(i,1),this.sprite.fillRect(-t*.8,-t*.2,t*.3,t*.8),this.sprite.fillRect(t*.5,-t*.2,t*.3,t*.8),this.sprite.fillRect(-t*.4,t*.5,t*.8,t*.3),this.sprite.fillStyle(4473924,1),this.sprite.beginPath(),this.sprite.moveTo(-t*1,-t*.5),this.sprite.lineTo(-t*.8,-t*1),this.sprite.lineTo(-t*.6,-t*.5),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(t*1,-t*.5),this.sprite.lineTo(t*.8,-t*1),this.sprite.lineTo(t*.6,-t*.5),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.fillStyle(16711680,1),this.sprite.fillRect(-t*.45,-t*.4,t*.3,t*.15),this.sprite.fillRect(t*.15,-t*.4,t*.3,t*.15),this.sprite.fillStyle(16737792,.6),this.sprite.fillRect(-t*.5,-t*.45,t*.4,t*.25),this.sprite.fillRect(t*.1,-t*.45,t*.4,t*.25),this.sprite.fillStyle(15658734,1),this.sprite.beginPath(),this.sprite.moveTo(-t*.4,-t*.1),this.sprite.lineTo(-t*.5,t*.4),this.sprite.lineTo(-t*.3,t*.1),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(t*.4,-t*.1),this.sprite.lineTo(t*.5,t*.4),this.sprite.lineTo(t*.3,t*.1),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.lineStyle(3,0,1),this.sprite.strokeEllipse(0,t*.2,t*1.2,t*1),this.sprite.strokeCircle(0,-t*.3,t*.9)}update(e){this.slowDuration>0&&(this.slowDuration-=e,this.slowDuration<=0&&(this.slowEffect=0,this.speed=this.baseSpeed));const t=this;t.burnEffect&&(t.burnEffect.update()?t.burnIndicator&&(t.burnIndicator.clear(),t.burnIndicator.fillStyle(16737792,.6),t.burnIndicator.fillCircle(this.sprite.x,this.sprite.y,12)):(t.burnEffect=null,t.burnIndicator&&(t.burnIndicator.destroy(),t.burnIndicator=null))),this.follower.t+=this.speed*e,this.follower.t>=1&&(this.follower.t=1),this.updatePosition()}updatePosition(){this.path.getPoint(this.follower.t,this.follower.vec),this.sprite.x=this.follower.vec.x,this.sprite.y=this.follower.vec.y,this.updateHealthBar()}updateHealthBar(){this.healthBar.clear();const e=30,t=4,s=this.sprite.x-e/2,i=this.sprite.y-25;this.healthBar.fillStyle(0,.5),this.healthBar.fillRect(s,i,e,t);const r=this.health/this.maxHealth*e,o=this.health>this.maxHealth*.5?65280:16711680;this.healthBar.fillStyle(o,1),this.healthBar.fillRect(s,i,r,t)}takeDamage(e){this.health-=e,this.updateHealthBar(),this.health<=0&&(this.health=0)}isDead(){return this.health<=0}reachedEnd(){return this.follower.t>=1}getGoldReward(){return this.goldReward}getHealth(){return this.health}getXPReward(){return this.xpReward}getPosition(){return this.follower.vec}getProgress(){return this.follower.t}get x(){return this.follower.vec.x}get y(){return this.follower.vec.y}applySlow(e,t){e>this.slowEffect&&(this.slowEffect=e,this.slowDuration=t,this.speed=this.baseSpeed*(1-this.slowEffect))}destroy(){this.sprite.destroy(),this.healthBar.destroy();const e=this;e.burnIndicator&&(e.burnIndicator.destroy(),e.burnIndicator=null),e.burnEffect=null}}class jt extends Vt{constructor(e,t,s,i=1,r=1){super(e,t,s,r,"normal",i);const o=m.getInstance().getConfig(),a=o.enemies.boss,l=o.enemies.healthScaling,h=Math.pow(l.waveMultiplier,Math.floor(s/l.waveInterval)),c=Math.pow(l.levelMultiplier,i-1);let d=1;if(r>1){const f=o.multiplayer;d=1+(r-1)*f.enemyScaling.healthPerPlayer}const u=h*c*d;this.maxHealth=Math.round(a.baseHealth*u),this.health=this.maxHealth,this.goldReward=a.baseGold+s*a.goldPerWave,this.xpReward=a.baseXp+s*a.xpPerWave,this.baseSpeed=this.baseSpeed*a.speedMultiplier,this.speed=this.baseSpeed,this.sprite.destroy(),this.sprite=e.add.graphics(),this.createBossSprite(),this.updatePosition(),this.updateHealthBar()}createBossSprite(){this.sprite.fillStyle(0,.5),this.sprite.fillEllipse(0,32*1.5,64,32*.8),this.sprite.fillStyle(6684825,1),this.sprite.fillEllipse(0,32*.5,32*1.5,32*1.3),this.sprite.fillStyle(7798954,1),this.sprite.fillCircle(0,-32*.2,32*1.1),this.sprite.fillStyle(8913100,1),this.sprite.fillCircle(0,-32*.8,32*.7),this.sprite.fillStyle(4456550,1),this.sprite.fillRect(-32*1.3,-32*.5,32*.6,32*1.2),this.sprite.fillRect(32*.7,-32*.5,32*.6,32*1.2),this.sprite.fillStyle(3355443,1);for(let t=-1;t<=1;t++)this.sprite.fillRect(t*32*.4-32*.3,-32*.1,32*.5,32*.15);this.sprite.fillStyle(2236962,1);for(let t=0;t<3;t++){const s=(t-1)*32*.3;this.sprite.beginPath(),this.sprite.moveTo(-32*1.5+s,-32*.3),this.sprite.lineTo(-32*1.3+s,-32*1.2),this.sprite.lineTo(-32*1.1+s,-32*.3),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(32*1.5-s,-32*.3),this.sprite.lineTo(32*1.3-s,-32*1.2),this.sprite.lineTo(32*1.1-s,-32*.3),this.sprite.closePath(),this.sprite.fillPath()}this.sprite.fillStyle(16755200,1),this.sprite.beginPath(),this.sprite.moveTo(-32*.6,-32*1.1),this.sprite.lineTo(-32*.4,-32*1.7),this.sprite.lineTo(-32*.2,-32),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(32*.6,-32*1.1),this.sprite.lineTo(32*.4,-32*1.7),this.sprite.lineTo(32*.2,-32),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(-32*.15,-32*1.2),this.sprite.lineTo(0,-32*1.9),this.sprite.lineTo(32*.15,-32*1.2),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.fillStyle(16711680,1),this.sprite.fillCircle(-32*.25,-32*.8,32*.25),this.sprite.fillCircle(32*.25,-32*.8,32*.25),this.sprite.fillStyle(16737792,.8),this.sprite.fillCircle(-32*.25,-32*.8,32*.35),this.sprite.fillCircle(32*.25,-32*.8,32*.35),this.sprite.fillStyle(16776960,.9),this.sprite.fillCircle(-32*.25,-32*.8,32*.15),this.sprite.fillCircle(32*.25,-32*.8,32*.15),this.sprite.fillStyle(16777215,1);for(let t=0;t<4;t++){const s=(t-1.5)*32*.25;this.sprite.beginPath(),this.sprite.moveTo(s-32*.08,-32*.3),this.sprite.lineTo(s,32*.2),this.sprite.lineTo(s+32*.08,-32*.3),this.sprite.closePath(),this.sprite.fillPath()}this.sprite.lineStyle(4,16711935,.3),this.sprite.strokeCircle(0,0,32*1.6),this.sprite.lineStyle(2,16711935,.5),this.sprite.strokeCircle(0,0,32*1.7),this.sprite.lineStyle(3,0,1),this.sprite.strokeCircle(0,0,32),this.sprite.lineStyle(2,16776960,.4),this.sprite.strokeCircle(0,0,32*1.1),this.sprite.lineStyle(1,16746496,.3),this.sprite.strokeCircle(0,0,32*1.2)}updateHealthBar(){this.healthBar.clear();const e=50,t=6,s=this.sprite.x-e/2,i=this.sprite.y-35;this.healthBar.fillStyle(0,.8),this.healthBar.fillRect(s,i,e,t);const r=this.health/this.maxHealth*e,o=this.health>this.maxHealth*.5?16737792:16711680;this.healthBar.fillStyle(o,1),this.healthBar.fillRect(s,i,r,t),this.healthBar.lineStyle(1,16776960,1),this.healthBar.strokeRect(s,i,e,t)}}class Y{sprite;scene;follower;path;health;maxHealth;speed;baseSpeed;goldReward;xpReward;healthBar;slowEffect=0;slowDuration=0;wave;playerCount;constructor(e,t,s,i=1,r=1){this.scene=e,this.path=t,this.wave=s,this.playerCount=i,this.follower={t:0,vec:new Phaser.Math.Vector2};const o=this.calculateStats(s,r,i);this.maxHealth=o.health,this.health=this.maxHealth;const l=m.getInstance().getConfig().enemies.baseSpeed;this.baseSpeed=l*o.speedMultiplier,this.speed=this.baseSpeed,this.goldReward=o.gold,this.xpReward=o.xp,this.sprite=e.add.graphics(),this.createSprite(o.color,o.size),this.healthBar=e.add.graphics(),this.updatePosition(),this.updateHealthBar()}onUpdate(e,t){}onTakeDamage(e){return e}onDeath(){return[]}calculateStats(e,t=1,s=1){const i=m.getInstance().getConfig(),r=this.getEnemyConfig(),o=i.enemies.healthScaling,a=Math.pow(o.waveMultiplier,Math.floor(e/o.waveInterval)),l=Math.pow(o.levelMultiplier,t-1);let h=1;if(s>1){const d=i.multiplayer;h=1+(s-1)*d.enemyScaling.healthPerPlayer}const c=a*l*h;return{health:Math.round(r.baseHealth*c),speedMultiplier:r.speedMultiplier,gold:r.baseGold+e*r.goldPerWave,xp:r.xpReward,color:parseInt(r.color),size:r.size}}update(e,t){this.slowDuration>0&&(this.slowDuration-=e,this.slowDuration<=0&&(this.slowEffect=0,this.speed=this.baseSpeed));const s=this;s.burnEffect&&(s.burnEffect.update()?s.burnIndicator&&(s.burnIndicator.clear(),s.burnIndicator.fillStyle(16737792,.6),s.burnIndicator.fillCircle(this.sprite.x,this.sprite.y,12)):(s.burnEffect=null,s.burnIndicator&&(s.burnIndicator.destroy(),s.burnIndicator=null))),this.onUpdate(e,t),this.follower.t+=this.speed*e,this.follower.t>=1&&(this.follower.t=1),this.updatePosition()}updatePosition(){this.path.getPoint(this.follower.t,this.follower.vec),this.sprite.x=this.follower.vec.x,this.sprite.y=this.follower.vec.y,this.updateHealthBar()}updateHealthBar(){this.healthBar.clear();const e=30,t=4,s=this.sprite.x-e/2,i=this.sprite.y-25;this.healthBar.fillStyle(0,.5),this.healthBar.fillRect(s,i,e,t);const r=this.health/this.maxHealth*e,o=this.health>this.maxHealth*.5?65280:16711680;this.healthBar.fillStyle(o,1),this.healthBar.fillRect(s,i,r,t)}takeDamage(e){const t=this.onTakeDamage(e);return this.health-=t,this.updateHealthBar(),this.showFloatingDamage(t),this.sprite.setAlpha&&this.sprite.setAlpha(.5),this.scene.tweens?.add&&this.scene.tweens.add({targets:this.sprite,alpha:1,duration:100,ease:"Power2"}),this.health<=0?(this.health=0,this.playDeathAnimation(),this.onDeath()):[]}showFloatingDamage(e){if(!this.scene.add.text||!this.scene.tweens?.add)return;const t=this.scene.add.text(this.sprite.x,this.sprite.y-20,Math.round(e).toString(),{fontSize:"16px",color:"#ff4444",fontStyle:"bold",stroke:"#000000",strokeThickness:3});t.setOrigin(.5),t.setDepth&&t.setDepth(100),this.scene.tweens.add({targets:t,y:t.y-30,alpha:0,duration:800,ease:"Power2",onComplete:()=>t.destroy()})}playDeathAnimation(){if(!this.scene.tweens?.add)return;const e=this.calculateStats(this.wave,1,this.playerCount);for(let t=0;t<15;t++){const s=this.scene.add.graphics(),i=2+Math.random()*4;s.fillStyle(e.color,.8),s.fillCircle(0,0,i),s.x=this.sprite.x,s.y=this.sprite.y,s.setDepth&&s.setDepth(95);const r=Math.random()*Math.PI*2,o=20+Math.random()*40;this.scene.tweens.add({targets:s,x:s.x+Math.cos(r)*o,y:s.y+Math.sin(r)*o,alpha:0,scale:.2,duration:400+Math.random()*400,ease:"Power2",onComplete:()=>s.destroy()})}this.sprite.clear(),this.sprite.fillStyle(16777215,.8),this.sprite.fillCircle(0,0,e.size),this.scene.tweens.add({targets:this.sprite,alpha:0,scale:1.5,duration:300,ease:"Power2"})}isDead(){return this.health<=0}reachedEnd(){return this.follower.t>=1}getGoldReward(){return this.goldReward}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}getXPReward(){return this.xpReward}getPosition(){return this.follower.vec}getProgress(){return this.follower.t}get x(){return this.follower.vec.x}get y(){return this.follower.vec.y}applySlow(e,t){e>this.slowEffect&&(this.slowEffect=e,this.slowDuration=t,this.speed=this.baseSpeed*(1-this.slowEffect))}destroy(){this.sprite.destroy(),this.healthBar.destroy();const e=this;e.burnIndicator&&(e.burnIndicator.destroy(),e.burnIndicator=null),e.burnEffect=null}}class He extends Y{getEnemyConfig(){return m.getInstance().getConfig().enemies.normal}createSprite(e,t){const s=Phaser.Display.Color.IntegerToColor(e),i=Phaser.Display.Color.GetColor(Math.min(255,Math.floor(s.red*1.3)),Math.min(255,Math.floor(s.green*1.3)),Math.min(255,Math.floor(s.blue*1.3))),r=Phaser.Display.Color.GetColor(Math.floor(s.red*.6),Math.floor(s.green*.6),Math.floor(s.blue*.6));this.sprite.fillStyle(0,.3),this.sprite.fillEllipse(0,t*1.2,t*1.3,t*.5),this.sprite.fillStyle(e,1),this.sprite.fillCircle(0,0,t),this.sprite.fillEllipse(0,t*.3,t*.9,t*.8),this.sprite.fillStyle(i,.7),this.sprite.fillCircle(-t*.3,-t*.4,t*.5),this.sprite.fillStyle(16776960,1),this.sprite.fillCircle(-t*.3,-t*.2,t*.35),this.sprite.fillCircle(t*.3,-t*.2,t*.35),this.sprite.fillStyle(16711680,1),this.sprite.fillCircle(-t*.3,-t*.15,t*.2),this.sprite.fillCircle(t*.3,-t*.15,t*.2),this.sprite.fillStyle(16777215,.8),this.sprite.fillCircle(-t*.25,-t*.25,t*.1),this.sprite.fillCircle(t*.35,-t*.25,t*.1),this.sprite.fillStyle(0,1),this.sprite.fillEllipse(0,t*.4,t*.5,t*.3),this.sprite.fillStyle(16777215,1),this.sprite.fillRect(-t*.2,t*.25,t*.15,t*.25),this.sprite.fillRect(t*.05,t*.25,t*.15,t*.25),this.sprite.fillStyle(r,1),this.sprite.beginPath(),this.sprite.moveTo(-t*.7,-t*.3),this.sprite.lineTo(-t*.5,-t*.8),this.sprite.lineTo(-t*.3,-t*.4),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(t*.7,-t*.3),this.sprite.lineTo(t*.5,-t*.8),this.sprite.lineTo(t*.3,-t*.4),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.lineStyle(2,0,1),this.sprite.strokeCircle(0,0,t)}}class Xt extends Y{getEnemyConfig(){return m.getInstance().getConfig().enemies.fast}createSprite(e,t){this.sprite.fillStyle(0,.2),this.sprite.fillEllipse(0,t*1.2,t*1,t*.4),this.sprite.fillStyle(e,.8),this.sprite.beginPath(),this.sprite.arc(0,0,t,0,Math.PI,!0),this.sprite.lineTo(t*.6,t*.9),this.sprite.lineTo(t*.3,t*.6),this.sprite.lineTo(0,t*.9),this.sprite.lineTo(-t*.3,t*.6),this.sprite.lineTo(-t*.6,t*.9),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.fillStyle(16777215,.4),this.sprite.fillCircle(-t*.3,-t*.3,t*.6),this.sprite.fillStyle(0,1),this.sprite.fillCircle(-t*.3,-t*.1,t*.3),this.sprite.fillCircle(t*.3,-t*.1,t*.3),this.sprite.fillStyle(e,.6),this.sprite.fillCircle(-t*.3,-t*.1,t*.15),this.sprite.fillCircle(t*.3,-t*.1,t*.15),this.sprite.fillStyle(0,1),this.sprite.fillCircle(0,t*.3,t*.25),this.sprite.lineStyle(2,0,.6),this.sprite.strokeCircle(0,-t*.2,t*.9)}}class Kt extends Y{getEnemyConfig(){return m.getInstance().getConfig().enemies.tank}createSprite(e,t){const s=Phaser.Display.Color.IntegerToColor(e),i=Phaser.Display.Color.GetColor(Math.floor(s.red*.5),Math.floor(s.green*.5),Math.floor(s.blue*.5));this.sprite.fillStyle(0,.4),this.sprite.fillEllipse(0,t*1.3,t*1.6,t*.6),this.sprite.fillStyle(e,1),this.sprite.fillEllipse(0,t*.2,t*1.2,t*1),this.sprite.fillCircle(0,-t*.3,t*.9),this.sprite.fillStyle(i,1),this.sprite.fillRect(-t*.8,-t*.2,t*.3,t*.8),this.sprite.fillRect(t*.5,-t*.2,t*.3,t*.8),this.sprite.fillRect(-t*.4,t*.5,t*.8,t*.3),this.sprite.fillStyle(4473924,1),this.sprite.beginPath(),this.sprite.moveTo(-t*1,-t*.5),this.sprite.lineTo(-t*.8,-t*1),this.sprite.lineTo(-t*.6,-t*.5),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(t*1,-t*.5),this.sprite.lineTo(t*.8,-t*1),this.sprite.lineTo(t*.6,-t*.5),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.fillStyle(16711680,1),this.sprite.fillRect(-t*.45,-t*.4,t*.3,t*.15),this.sprite.fillRect(t*.15,-t*.4,t*.3,t*.15),this.sprite.fillStyle(16737792,.6),this.sprite.fillRect(-t*.5,-t*.45,t*.4,t*.25),this.sprite.fillRect(t*.1,-t*.45,t*.4,t*.25),this.sprite.fillStyle(15658734,1),this.sprite.beginPath(),this.sprite.moveTo(-t*.4,-t*.1),this.sprite.lineTo(-t*.5,t*.4),this.sprite.lineTo(-t*.3,t*.1),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(t*.4,-t*.1),this.sprite.lineTo(t*.5,t*.4),this.sprite.lineTo(t*.3,t*.1),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.lineStyle(3,0,1),this.sprite.strokeEllipse(0,t*.2,t*1.2,t*1),this.sprite.strokeCircle(0,-t*.3,t*.9)}}class Jt extends Y{shield;maxShield;shieldRegenDelay=3e3;lastDamageTime=0;shieldIndicator=null;constructor(e,t,s,i=1,r=1){super(e,t,s,i,r),this.maxShield=Math.round(this.maxHealth*.5),this.shield=this.maxShield,this.shieldIndicator=e.add.graphics(),this.updateShieldIndicator()}getEnemyConfig(){return{baseHealth:60,speedMultiplier:1,baseGold:12,goldPerWave:2,xpReward:12,color:"0x4dabf7",size:12}}createSprite(e,t){this.sprite.fillStyle(0,.3),this.sprite.fillEllipse(0,t*1.2,t*1.3,t*.5),this.sprite.fillStyle(e,1),this.sprite.fillCircle(0,0,t*.8),this.sprite.fillStyle(7651580,1),this.sprite.fillCircle(0,-t,t*.3),this.sprite.fillCircle(0,t,t*.3),this.sprite.fillCircle(-t,0,t*.3),this.sprite.fillCircle(t,0,t*.3),this.sprite.lineStyle(2,10868991,.8),this.sprite.beginPath(),this.sprite.moveTo(0,-t),this.sprite.lineTo(t,0),this.sprite.lineTo(0,t),this.sprite.lineTo(-t,0),this.sprite.closePath(),this.sprite.strokePath(),this.sprite.fillStyle(1667522,1),this.sprite.fillCircle(0,0,t*.4),this.sprite.fillStyle(16777215,.6),this.sprite.fillCircle(0,0,t*.2),this.sprite.lineStyle(2,820633,1),this.sprite.strokeCircle(0,0,t*.8)}onUpdate(e,t){const s=Date.now();this.shield<this.maxShield&&s-this.lastDamageTime>this.shieldRegenDelay&&(this.shield=Math.min(this.maxShield,this.shield+this.maxShield*.1*(e/1e3))),this.updateShieldIndicator()}onTakeDamage(e){if(this.lastDamageTime=Date.now(),this.shield>0){const t=Math.min(this.shield,e);this.shield-=t;const s=e-t;return this.shieldIndicator&&this.scene.tweens.add({targets:this.shieldIndicator,alpha:.3,duration:100,yoyo:!0}),s}return e}updateShieldIndicator(){if(this.shieldIndicator&&(this.shieldIndicator.clear(),this.shield>0)){const t=this.shield/this.maxShield;this.shieldIndicator.lineStyle(2,5090295,.6*t),this.shieldIndicator.strokeCircle(this.sprite.x,this.sprite.y,16);const s=[];for(let i=0;i<6;i++){const r=Math.PI/3*i-Math.PI/2,o=this.sprite.x+Math.cos(r)*16*t,a=this.sprite.y+Math.sin(r)*16*t;s.push(o,a)}this.shieldIndicator.fillStyle(5090295,.2*t),this.shieldIndicator.fillPoints(s,!0)}}updateHealthBar(){if(super.updateHealthBar(),this.shield>0){const s=this.sprite.x-15,i=this.sprite.y-30,r=this.shield/this.maxShield*30;this.healthBar.fillStyle(5090295,.8),this.healthBar.fillRect(s,i,r,3)}}destroy(){this.shieldIndicator&&(this.shieldIndicator.destroy(),this.shieldIndicator=null),super.destroy()}}class Yt extends Y{damageReduction=.5;armorPlating=null;constructor(e,t,s,i=1,r=1){super(e,t,s,i,r),this.armorPlating=e.add.graphics(),this.updateArmorIndicator()}getEnemyConfig(){return{baseHealth:80,speedMultiplier:.7,baseGold:15,goldPerWave:3,xpReward:15,color:"0x868e96",size:14}}createSprite(e,t){this.sprite.fillStyle(0,.4),this.sprite.fillEllipse(0,t*1.3,t*1.4,t*.6),this.sprite.fillStyle(e,1),this.sprite.fillCircle(0,0,t);const s=4804695,i=11384253,r=3422784;this.sprite.fillStyle(s,1),this.sprite.fillRect(-t*.7,-t*.5,t*1.4,t),this.sprite.fillStyle(r,1);for(let o=-1;o<=1;o++)for(let a=-1;a<=1;a++)this.sprite.fillCircle(o*t*.5,a*t*.3,t*.1);this.sprite.fillStyle(s,1),this.sprite.fillRect(-t*1.1,-t*.7,t*.5,t*.8),this.sprite.fillRect(t*.6,-t*.7,t*.5,t*.8),this.sprite.fillStyle(i,.6),this.sprite.fillRect(-t*.6,-t*.4,t*.3,t*.2),this.sprite.fillRect(t*.3,-t*.4,t*.3,t*.2),this.sprite.fillStyle(16739179,1),this.sprite.fillRect(-t*.45,-t*.2,t*.3,t*.15),this.sprite.fillRect(t*.15,-t*.2,t*.3,t*.15),this.sprite.fillStyle(16746375,.5),this.sprite.fillRect(-t*.5,-t*.25,t*.4,t*.25),this.sprite.fillRect(t*.1,-t*.25,t*.4,t*.25),this.sprite.lineStyle(3,2172201,1),this.sprite.strokeCircle(0,0,t),this.sprite.strokeRect(-t*.7,-t*.5,t*1.4,t)}onTakeDamage(e){const t=e*(1-this.damageReduction);if(this.scene){const s=this.scene.add.graphics();s.fillStyle(16766011,1),s.fillCircle(this.sprite.x,this.sprite.y-10,3),this.scene.tweens.add({targets:s,alpha:0,y:s.y-20,duration:300,onComplete:()=>s.destroy()})}return t}updateArmorIndicator(){if(!this.armorPlating)return;this.armorPlating.clear();const e=this.sprite.x,t=this.sprite.y-22,s=4;this.armorPlating.fillStyle(8818326,.8),this.armorPlating.beginPath(),this.armorPlating.moveTo(e,t-s),this.armorPlating.lineTo(e-s,t),this.armorPlating.lineTo(e-s,t+s),this.armorPlating.lineTo(e+s,t+s),this.armorPlating.lineTo(e+s,t),this.armorPlating.closePath(),this.armorPlating.fillPath()}updatePosition(){super.updatePosition(),this.updateArmorIndicator()}destroy(){this.armorPlating&&(this.armorPlating.destroy(),this.armorPlating=null),super.destroy()}}class Qt extends Y{healRadius=100;healAmount=5;healCooldown=1e3;lastHealTime=0;healIndicator=null;pulseAnimation=0;constructor(e,t,s,i=1,r=1){super(e,t,s,i,r),this.healIndicator=e.add.graphics()}getEnemyConfig(){return{baseHealth:40,speedMultiplier:.8,baseGold:20,goldPerWave:4,xpReward:20,color:"0x51cf66",size:11}}createSprite(e,t){this.sprite.fillStyle(0,.3),this.sprite.fillEllipse(0,t*1.2,t*1.3,t*.5),this.sprite.fillStyle(e,1),this.sprite.fillCircle(0,0,t),this.sprite.fillStyle(9234842,.7),this.sprite.fillCircle(-t*.3,-t*.3,t*.6);const s=16777215,i=t*.3,r=t*.8;this.sprite.fillStyle(s,1),this.sprite.fillRect(-i/2,-r/2,i,r),this.sprite.fillRect(-r/2,-i/2,r,i),this.sprite.fillStyle(16739179,1),this.sprite.fillRect(-i/4,-r/2.5,i/2,r/1.5),this.sprite.fillRect(-r/2.5,-i/4,r/1.5,i/2),this.sprite.fillStyle(3120708,1),this.sprite.fillCircle(-t*.4,-t*.1,t*.2),this.sprite.fillCircle(t*.4,-t*.1,t*.2),this.sprite.fillStyle(16777215,.8),this.sprite.fillCircle(-t*.35,-t*.15,t*.1),this.sprite.fillCircle(t*.45,-t*.15,t*.1),this.sprite.lineStyle(2,3120708,1),this.sprite.beginPath(),this.sprite.arc(0,t*.3,t*.4,0,Math.PI,!1),this.sprite.strokePath(),this.sprite.lineStyle(2,2853438,1),this.sprite.strokeCircle(0,0,t)}onUpdate(e,t){const s=Date.now();this.pulseAnimation+=e*.003,this.pulseAnimation>Math.PI*2&&(this.pulseAnimation-=Math.PI*2),this.updateHealIndicator(),s-this.lastHealTime>this.healCooldown&&t&&(this.lastHealTime=s,this.healNearbyAllies(t,e))}healNearbyAllies(e,t){let s=0;for(const i of e){if(i===this||i.isDead())continue;if(Phaser.Math.Distance.Between(this.x,this.y,i.x,i.y)<=this.healRadius){const o=i.getHealth(),a=i.getMaxHealth();if(o<a){const l=Math.min(this.healAmount,a-o);i.health=Math.min(a,o+l),i.updateHealthBar(),this.createHealParticle(i.x,i.y),s++}}}s>0&&this.createHealWave()}createHealParticle(e,t){if(!this.scene)return;const s=this.scene.add.graphics();s.fillStyle(5361510,.8),s.fillCircle(0,0,3),s.setPosition(this.sprite.x,this.sprite.y),this.scene.tweens.add({targets:s,x:e,y:t,alpha:0,duration:400,ease:"Cubic.Out",onComplete:()=>s.destroy()})}createHealWave(){if(!this.scene)return;const e=this.scene.add.graphics();e.lineStyle(2,5361510,.6),e.strokeCircle(this.sprite.x,this.sprite.y,5),this.scene.tweens.add({targets:e,alpha:0,duration:600,onUpdate:()=>{e.clear(),e.lineStyle(2,5361510,e.alpha*.6);const t=5+(1-e.alpha)*this.healRadius;e.strokeCircle(this.sprite.x,this.sprite.y,t)},onComplete:()=>e.destroy()})}updateHealIndicator(){if(!this.healIndicator)return;this.healIndicator.clear();const e=5+Math.sin(this.pulseAnimation)*2;this.healIndicator.lineStyle(1,5361510,.3+Math.sin(this.pulseAnimation)*.2),this.healIndicator.strokeCircle(this.sprite.x,this.sprite.y,this.healRadius*.3);const t=this.sprite.x,s=this.sprite.y-22;this.healIndicator.fillStyle(5361510,.8),this.healIndicator.fillRect(t-e,s-1,e*2,2),this.healIndicator.fillRect(t-1,s-e,2,e*2)}updatePosition(){super.updatePosition()}destroy(){this.healIndicator&&(this.healIndicator.destroy(),this.healIndicator=null),super.destroy()}}class Ne{static createEnemy(e,t,s,i,r=1,o=1){switch(s){case"normal":return new He(e,t,i,r,o);case"fast":return new Xt(e,t,i,r,o);case"tank":return new Kt(e,t,i,r,o);case"shielded":return new Jt(e,t,i,r,o);case"armored":return new Yt(e,t,i,r,o);case"healing":return new Qt(e,t,i,r,o);default:return console.warn(`Unknown enemy type: ${s}, defaulting to normal`),new He(e,t,i,r,o)}}static getRandomType(e){if(e<=3)return Math.random()<.7?"normal":"fast";if(e<=7){const s=Math.random();return s<.5?"normal":s<.75?"fast":"tank"}if(e<=12){const s=Math.random();return s<.35?"normal":s<.6?"fast":s<.8?"tank":"shielded"}if(e<=18){const s=Math.random();return s<.25?"normal":s<.45?"fast":s<.65?"tank":s<.85?"shielded":"armored"}const t=Math.random();return t<.2?"normal":t<.35?"fast":t<.5?"tank":t<.65?"shielded":t<.8?"armored":"healing"}static getWaveComposition(e,t){const s=[];if(e%10===0){for(let i=0;i<t;i++)s.push("normal");return s}if(e%5===0&&e>5&&e>=19){const i=Math.min(2,Math.floor(t*.15));for(let r=0;r<i;r++)s.push("healing");for(let r=i;r<t;r++)s.push(Math.random()<.5?"tank":"armored");return s}for(let i=0;i<t;i++)s.push(this.getRandomType(e));return s}}class Zt{scene;path;enemies=[];wave=0;isSpawning=!1;waveComplete=!1;playerLevel=1;playerCount=1;constructor(e,t,s="classic"){this.scene=e,this.path=t}setPlayerCount(e){this.playerCount=Math.max(1,e)}setPlayerLevel(e){this.playerLevel=e}startWave(){if(this.isSpawning)return;this.isSpawning=!0,this.waveComplete=!1,this.wave++;const e=m.getInstance().getConfig().waves;if(this.wave%e.bossInterval===0){let s=Math.max(1,Math.floor(this.wave/e.bossInterval));if(this.playerCount>1){const r=m.getInstance().getConfig().multiplayer,o=1+(this.playerCount-1)*r.enemyScaling.countPerPlayer;s=Math.max(1,Math.round(s*o))}const i=e.bossSpawnDelay;for(let r=0;r<s;r++)this.scene.time.delayedCall(r*i,()=>{const o=new jt(this.scene,this.path,this.wave,this.playerLevel,this.playerCount);this.enemies.push(o)});this.scene.time.delayedCall((s-1)*i+100,()=>{this.isSpawning=!1})}else{const s=Re.getSettings(),i=e.difficulty[s.difficulty]||e.difficulty.normal,r=i.baseEnemies,o=i.enemyMultiplier;let a=r+this.wave*o;if(this.playerCount>1){const c=m.getInstance().getConfig().multiplayer,d=1+(this.playerCount-1)*c.enemyScaling.countPerPlayer;a=Math.round(a*d)}const l=Math.max(e.spawnDelay.minimum,e.spawnDelay.base-this.wave*e.spawnDelay.reduction),h=Ne.getWaveComposition(this.wave,a);for(let c=0;c<a;c++)this.scene.time.delayedCall(c*l,()=>{const d=h[c]||"normal",u=Ne.createEnemy(this.scene,this.path,d,this.wave,this.playerCount,this.playerLevel);this.enemies.push(u)});this.scene.time.delayedCall((a-1)*l+100,()=>{this.isSpawning=!1})}}update(e,t,s,i){const r=[];this.enemies=this.enemies.filter(o=>{if(o.update(e,this.enemies),o.isDead()){t(o.getGoldReward(),o.getXPReward());const a=o.takeDamage(0);return r.push(...a),o.destroy(),!1}return o.reachedEnd()?(s(),o.destroy(),!1):!0}),this.enemies.push(...r),this.enemies.length===0&&this.wave>0&&!this.waveComplete&&!this.isSpawning&&(this.waveComplete=!0,i&&i(this.wave))}getEnemies(){return this.enemies}getWave(){return this.wave}isWaveComplete(){return this.waveComplete}isSpawningEnemies(){return this.isSpawning}resetWaveComplete(){this.waveComplete=!1}markWaveComplete(){this.waveComplete=!0}cleanup(){this.enemies.forEach(e=>e.destroy()),this.enemies=[]}}class j{id;towerType;sprite;scene;rangeCircle;showRange=!1;upgradeLevelText;x;y;range;damage;fireRate;baseDamage;baseFireRate;upgradeLevel=1;buildCost;totalInvested;lastFired=0;currentRotation=0;targetRotation=0;constructor(e,t,s,i,r){this.scene=e,this.x=t,this.y=s,this.towerType=i,this.buildCost=r,this.totalInvested=r;const o=m.getInstance().getTowerConfig(i);if(!o)throw new Error(`Tower config not found for type: ${i}`);this.range=o.range,this.baseDamage=o.damage,this.baseFireRate=o.fireRate,this.damage=this.baseDamage,this.fireRate=this.baseFireRate,this.createSprite(),this.upgradeLevelText=this.scene.add.text(this.x,this.y-30,"1",{fontSize:"14px",color:"#ffffff",backgroundColor:"#000000",padding:{x:4,y:2}}).setOrigin(.5).setDepth(100),this.rangeCircle=e.add.graphics(),this.updateRangeCircle(),this.sprite.setInteractive(new Phaser.Geom.Circle(0,0,20),Phaser.Geom.Circle.Contains),this.sprite.on("pointerover",()=>{this.showRange=!0,this.updateRangeCircle()}),this.sprite.on("pointerout",()=>{this.showRange=!1,this.updateRangeCircle()})}findTarget(e){let t=null,s=-1;for(const i of e){if(i.isDead())continue;if(Phaser.Math.Distance.Between(this.x,this.y,i.x,i.y)<=this.range){const o=this.calculateTargetValue(i);o>s&&(s=o,t=i)}}return t}calculateTargetValue(e){return e.getProgress()}update(e,t){if(Math.abs(this.targetRotation-this.currentRotation)>.01){const i=this.targetRotation-this.currentRotation;this.currentRotation+=i*.15,this.sprite.setRotation&&this.sprite.setRotation(this.currentRotation)}if(e-this.lastFired<this.fireRate)return null;const s=this.findTarget(t);if(s){this.targetRotation=Math.atan2(s.y-this.y,s.x-this.x)+Math.PI/2,this.createMuzzleFlash(),V.getInstance().playTower(this.towerType);const i=this.fireAtTarget(s,t);return this.lastFired=e,i}return null}createMuzzleFlash(){if(!this.scene.tweens?.add)return;const e=this.scene.add.graphics();e.fillStyle(16776960,.8),e.fillCircle(0,0,8),e.x=this.x,e.y=this.y-15,e.setDepth&&e.setDepth(99),this.scene.tweens.add({targets:e,alpha:0,scale:1.5,duration:150,ease:"Power2",onComplete:()=>e.destroy()});for(let t=0;t<3;t++){const s=this.scene.add.graphics();s.fillStyle(16746496,.6),s.fillCircle(0,0,3),s.x=this.x,s.y=this.y-15,s.setDepth&&s.setDepth(99);const i=Math.random()*Math.PI*2,r=20+Math.random()*30;this.scene.tweens.add({targets:s,x:s.x+Math.cos(i)*r,y:s.y+Math.sin(i)*r,alpha:0,scale:.5,duration:200+Math.random()*200,ease:"Power2",onComplete:()=>s.destroy()})}}upgrade(){const e=this.getUpgradeCost();return this.upgradeLevel++,this.totalInvested+=e,this.damage=Math.round(this.baseDamage*Math.pow(1.2,this.upgradeLevel-1)),this.fireRate=Math.round(this.baseFireRate*Math.pow(.9,this.upgradeLevel-1)),this.upgradeLevelText.setText(this.upgradeLevel.toString()),e}canUpgrade(){return this.upgradeLevel<5}getUpgradeCost(){return Math.round(this.buildCost*Math.pow(1.5,this.upgradeLevel-1))}getSellValue(){return Math.round(this.totalInvested*.7)}updateRangeCircle(){this.rangeCircle.clear(),this.showRange&&(this.rangeCircle.lineStyle(2,16777215,.5),this.rangeCircle.strokeCircle(this.x,this.y,this.range),this.rangeCircle.fillStyle(16777215,.1),this.rangeCircle.fillCircle(this.x,this.y,this.range))}setShowRange(e){this.showRange=e,this.updateRangeCircle()}destroy(){this.sprite.destroy(),this.rangeCircle.destroy(),this.upgradeLevelText.destroy()}getSprite(){return this.sprite}getRange(){return this.range}getDamage(){return this.damage}getUpgradeLevel(){return this.upgradeLevel}getType(){return this.towerType}getTotalInvested(){return this.totalInvested}}class re{sprite;scene;target;damage;speed=.3;x;y;rotation=0;hasHit=!1;isFrost=!1;slowAmount=0;slowDuration=0;splashRadius=0;allEnemies=[];trailParticles=[];constructor(e,t,s,i,r,o=!1,a=0,l=0,h=0,c=[]){if(this.scene=e,this.x=t,this.y=s,this.target=i,this.damage=r,this.isFrost=o,this.slowAmount=a,this.slowDuration=l,this.splashRadius=h,this.allEnemies=c,this.sprite=e.add.graphics(),o){this.sprite.fillStyle(8978431,.3),this.sprite.fillCircle(0,0,8),this.sprite.fillStyle(65535,.6),this.sprite.fillCircle(0,0,6),this.sprite.fillStyle(16777215,1),this.sprite.fillCircle(0,0,4),this.sprite.lineStyle(2,16777215,.8);for(let d=0;d<6;d++){const u=d/6*Math.PI*2,f=Math.cos(u)*6,p=Math.sin(u)*6;this.sprite.lineBetween(0,0,f,p)}}else this.sprite.fillStyle(16746496,.3),this.sprite.fillCircle(0,0,10),this.sprite.fillStyle(16755200,.6),this.sprite.fillCircle(0,0,7),this.sprite.fillStyle(16776960,1),this.sprite.beginPath?(this.sprite.beginPath(),this.sprite.moveTo(8,0),this.sprite.lineTo(-4,-4),this.sprite.lineTo(-2,0),this.sprite.lineTo(-4,4),this.sprite.closePath(),this.sprite.fillPath()):this.sprite.fillCircle(0,0,5),this.sprite.fillStyle(16777215,.9),this.sprite.fillCircle(0,0,3),this.sprite.fillStyle(16777215,.6),this.sprite.fillCircle(4,0,2);this.sprite.x=t,this.sprite.y=s}update(e){if(this.hasHit||this.target.isDead()){this.hasHit=!0;return}const t=this.target.x,s=this.target.y,i=Math.atan2(s-this.y,t-this.x);this.rotation=i;const r=Math.cos(i)*this.speed*e,o=Math.sin(i)*this.speed*e;if(this.x+=r,this.y+=o,this.sprite.x=this.x,this.sprite.y=this.y,this.sprite.setRotation&&this.sprite.setRotation(this.rotation),Math.random()<.6&&this.scene.tweens?.add){const l=this.scene.add.graphics(),h=this.isFrost?65535:16755200,c=this.isFrost?4:5;l.fillStyle(h,.6),l.fillCircle(0,0,c),l.fillStyle(h,.3),l.fillCircle(0,0,c*1.5),l.x=this.x,l.y=this.y,l.setRotation&&l.setRotation(this.rotation),l.setDepth&&l.setDepth(90),this.trailParticles.push(l),this.scene.tweens.add({targets:l,alpha:0,scaleX:.3,scaleY:.8,duration:400,ease:"Power2",onComplete:()=>{const d=this.trailParticles.indexOf(l);d>-1&&this.trailParticles.splice(d,1),l.destroy()}})}Phaser.Math.Distance.Between(this.x,this.y,t,s)<10&&(this.target.takeDamage(this.damage),this.isFrost&&this.target.applySlow(this.slowAmount,this.slowDuration),this.splashRadius>0&&this.applySplashDamage(this.x,this.y),this.hasHit=!0)}applySplashDamage(e,t){if(this.scene.cameras?.main?.shake&&this.scene.cameras.main.shake(150,.003),this.scene.tweens?.add){const s=this.scene.add.graphics();s.fillStyle(16746496,.8),s.fillCircle(0,0,this.splashRadius*.6),s.fillStyle(16737792,.6),s.fillCircle(0,0,this.splashRadius),s.lineStyle(3,16755200,.9),s.strokeCircle(0,0,this.splashRadius),s.x=e,s.y=t,this.scene.tweens.add({targets:s,alpha:0,scale:1.5,duration:400,ease:"Power2",onComplete:()=>s.destroy()});for(let i=0;i<12;i++){const r=this.scene.add.graphics(),o=3+Math.random()*4;r.fillStyle(i%2===0?16737792:16746496,.8),r.fillCircle(0,0,o),r.x=e,r.y=t,r.setDepth&&r.setDepth(98);const a=i/12*Math.PI*2+Math.random()*.3,l=this.splashRadius*(.8+Math.random()*.6);this.scene.tweens.add({targets:r,x:e+Math.cos(a)*l,y:t+Math.sin(a)*l,alpha:0,scale:.3,duration:300+Math.random()*300,ease:"Power2",onComplete:()=>r.destroy()})}}for(const s of this.allEnemies){if(s===this.target||s.isDead())continue;Phaser.Math.Distance.Between(e,t,s.x,s.y)<=this.splashRadius&&s.takeDamage(this.damage)}}shouldDestroy(){return this.hasHit||this.target.isDead()}destroy(){this.sprite.destroy();for(const e of this.trailParticles)e.destroy();this.trailParticles=[]}}class We extends j{constructor(e,t,s,i){super(e,t,s,"basic",i)}createSprite(){this.sprite=this.scene.add.graphics(),this.sprite.fillStyle(4868682,1),this.sprite.fillRoundedRect(-18,10,36,8,2),this.sprite.fillStyle(255,1),this.sprite.fillRoundedRect(-12,-8,24,18,3),this.sprite.fillStyle(153,1),this.sprite.fillRect(8,-8,4,18),this.sprite.fillStyle(2763306,1),this.sprite.fillRoundedRect(-8,-15,16,7,2),this.sprite.fillStyle(3815994,1),this.sprite.fillRect(-3,-18,6,8),this.sprite.fillStyle(16776960,.8),this.sprite.fillCircle(0,0,4),this.sprite.lineStyle(1,16777215,.6),this.sprite.strokeCircle(0,0,4),this.sprite.fillStyle(6710886,1),[-8,8].forEach(e=>{[-4,4].forEach(t=>{this.sprite.fillCircle(e,t,1.5)})}),this.sprite.lineStyle(2,16777215,.3),this.sprite.strokeRoundedRect(-12,-8,24,18,3),this.sprite.x=this.x,this.sprite.y=this.y}fireAtTarget(e,t){return new re(this.scene,this.x,this.y,e,this.damage,!1)}}class zt extends j{constructor(e,t,s,i){super(e,t,s,"fast",i)}createSprite(){this.sprite=this.scene.add.graphics(),this.sprite.fillStyle(3815994,1),this.sprite.fillRoundedRect(-18,10,36,8,2),this.sprite.fillStyle(5597999,1),this.sprite.fillRoundedRect(-14,-6,28,16,2),this.sprite.fillStyle(4017951,1),this.sprite.fillRect(10,-6,4,16),this.sprite.fillStyle(9139029,1),this.sprite.fillRoundedRect(-16,0,6,8,1),this.sprite.lineStyle(1,0,.5),this.sprite.strokeRoundedRect(-16,0,6,8,1),this.sprite.fillStyle(2763306,1),this.sprite.fillRect(-3,-18,2,14),this.sprite.fillRect(1,-18,2,14),this.sprite.fillStyle(16737792,.3),this.sprite.fillCircle(-2,-18,3),this.sprite.fillCircle(2,-18,3),this.sprite.fillStyle(2763306,1),this.sprite.fillRect(-2,-6,4,6),this.sprite.fillStyle(65280,.6),this.sprite.fillCircle(-10,-2,2),this.sprite.fillCircle(10,-2,2),this.sprite.fillStyle(6710886,1),[-10,10].forEach(e=>{this.sprite.fillCircle(e,4,1.5)}),this.sprite.fillStyle(1710618,1),this.sprite.fillRoundedRect(8,-2,4,6,1),this.sprite.x=this.x,this.sprite.y=this.y}fireAtTarget(e,t){return new re(this.scene,this.x,this.y,e,this.damage,!1)}}class es extends j{constructor(e,t,s,i){super(e,t,s,"strong",i)}createSprite(){this.sprite=this.scene.add.graphics(),this.sprite.fillStyle(4868682,1),this.sprite.fillRoundedRect(-18,10,36,8,2),this.sprite.fillStyle(16711935,1),this.sprite.fillRoundedRect(-12,-8,24,18,3),this.sprite.fillStyle(11141290,1),this.sprite.fillRect(8,-8,4,18),this.sprite.fillStyle(2763306,1),this.sprite.fillRoundedRect(-8,-15,16,7,2),this.sprite.fillStyle(3815994,1),this.sprite.fillRect(-3,-18,6,8),this.sprite.fillStyle(16776960,.8),this.sprite.fillCircle(0,0,4),this.sprite.lineStyle(1,16777215,.6),this.sprite.strokeCircle(0,0,4),this.sprite.fillStyle(6710886,1),[-8,8].forEach(e=>{[-4,4].forEach(t=>{this.sprite.fillCircle(e,t,1.5)})}),this.sprite.lineStyle(2,16777215,.3),this.sprite.strokeRoundedRect(-12,-8,24,18,3),this.sprite.x=this.x,this.sprite.y=this.y}fireAtTarget(e,t){return new re(this.scene,this.x,this.y,e,this.damage,!1)}}class ts extends j{constructor(e,t,s,i){super(e,t,s,"frost",i)}createSprite(){this.sprite=this.scene.add.graphics(),this.sprite.fillStyle(4868682,1),this.sprite.fillRoundedRect(-18,10,36,8,2),this.sprite.fillStyle(56831,1),this.sprite.fillRoundedRect(-12,-8,24,18,3),this.sprite.fillStyle(39355,1),this.sprite.fillRect(8,-8,4,18),this.sprite.fillStyle(2763306,1),this.sprite.fillRoundedRect(-8,-15,16,7,2),this.sprite.fillStyle(3815994,1),this.sprite.fillRect(-3,-18,6,8),this.sprite.fillStyle(16776960,.8),this.sprite.fillCircle(0,0,4),this.sprite.lineStyle(1,16777215,.6),this.sprite.strokeCircle(0,0,4),this.sprite.fillStyle(6710886,1),[-8,8].forEach(e=>{[-4,4].forEach(t=>{this.sprite.fillCircle(e,t,1.5)})}),this.sprite.lineStyle(2,16777215,.3),this.sprite.strokeRoundedRect(-12,-8,24,18,3),this.sprite.x=this.x,this.sprite.y=this.y}fireAtTarget(e,t){return new re(this.scene,this.x,this.y,e,this.damage,!0)}}class ss{enemy;damagePerSecond;duration;startTime;lastDamageTick;constructor(e,t,s){this.enemy=e,this.damagePerSecond=t,this.duration=s,this.startTime=Date.now(),this.lastDamageTick=this.startTime}update(){const e=Date.now();return e-this.startTime>=this.duration?!1:(e-this.lastDamageTick>=1e3&&(this.enemy.takeDamage(this.damagePerSecond),this.lastDamageTick=e),!0)}getTimeRemaining(){const e=Date.now()-this.startTime;return Math.max(0,this.duration-e)}getDamagePerSecond(){return this.damagePerSecond}refresh(){this.startTime=Date.now(),this.lastDamageTick=this.startTime}}class is extends j{burnDamagePerSecond;burnDuration;constructor(e,t,s,i){super(e,t,s,"fire",i);const r=m.getInstance().getConfig().towers.fire;this.burnDamagePerSecond=r.burnDamagePerSecond||5,this.burnDuration=r.burnDuration||5e3}createSprite(){this.sprite=this.scene.add.graphics(),this.sprite.fillStyle(4868682,1),this.sprite.fillRoundedRect(-18,10,36,8,2),this.sprite.fillStyle(16737792,1),this.sprite.fillRoundedRect(-12,-8,24,18,3),this.sprite.fillStyle(13386752,1),this.sprite.fillRect(8,-8,4,18),this.sprite.fillStyle(2763306,1),this.sprite.fillRoundedRect(-8,-15,16,7,2),this.sprite.fillStyle(3815994,1),this.sprite.fillRect(-3,-18,6,8),this.sprite.fillStyle(16729088,.8),this.sprite.fillCircle(0,0,4),this.sprite.lineStyle(1,16755200,.8),this.sprite.strokeCircle(0,0,4),this.sprite.fillStyle(6710886,1),[-8,8].forEach(e=>{[-4,4].forEach(t=>{this.sprite.fillCircle(e,t,1.5)})}),this.sprite.lineStyle(2,16746496,.5),this.sprite.strokeRoundedRect(-12,-8,24,18,3),this.sprite.x=this.x,this.sprite.y=this.y}fireAtTarget(e,t){if(e.isDead())return null;this.applyBurn(e);const s=this.scene.add.graphics();return s.fillStyle(16737792,.8),s.fillCircle(this.x,this.y,8),this.scene.tweens.add({targets:s,alpha:0,scale:2,duration:300,onComplete:()=>s.destroy()}),null}applyBurn(e){new ss(e,this.burnDamagePerSecond,this.burnDuration)}upgrade(){const e=super.upgrade();return this.burnDamagePerSecond=Math.round(this.burnDamagePerSecond*1.3),e}}class rs extends j{splashRadius;constructor(e,t,s,i){super(e,t,s,"splash",i);const r=m.getInstance().getConfig().towers.splash;this.splashRadius=r.splashRadius||50}createSprite(){this.sprite=this.scene.add.graphics(),this.sprite.fillStyle(4868682,1),this.sprite.fillRoundedRect(-20,10,40,8,2),this.sprite.fillStyle(9139029,1),this.sprite.fillEllipse(0,0,28,24),this.sprite.fillStyle(7033669,1),this.sprite.fillEllipse(6,0,10,24),this.sprite.fillStyle(2763306,1),this.sprite.fillEllipse(0,-12,16,8),this.sprite.fillStyle(16737792,1),this.sprite.fillTriangle(-8,4,0,-4,8,4),this.sprite.lineStyle(2,0,.8),this.sprite.strokeEllipse(0,0,28,24),this.sprite.fillStyle(6710886,1),[-10,10].forEach(e=>{this.sprite.fillCircle(e,8,2)}),this.sprite.x=this.x,this.sprite.y=this.y}fireAtTarget(e,t){return e.isDead()?null:new re(this.scene,this.x,this.y,e,this.damage,!1,0,0,this.splashRadius,t)}upgrade(){const e=super.upgrade();return this.splashRadius=Math.round(this.splashRadius*1.1),e}}class ns extends j{armorPenetration;constructor(e,t,s,i){super(e,t,s,"sniper",i);const r=m.getInstance().getConfig().towers.sniper;this.armorPenetration=r.armorPenetration||.5}createSprite(){this.sprite=this.scene.add.graphics(),this.sprite.fillStyle(3815994,1),this.sprite.fillRoundedRect(-18,10,36,8,2),this.sprite.fillStyle(2969375,1),this.sprite.fillRoundedRect(-10,-6,20,16,2),this.sprite.fillStyle(1710618,1),this.sprite.fillRect(-4,-14,8,8),this.sprite.fillStyle(4474111,.7),this.sprite.fillCircle(0,-10,4),this.sprite.lineStyle(1,16777215,.5),this.sprite.strokeCircle(0,-10,4),this.sprite.fillStyle(2763306,1),this.sprite.fillRect(-2,-24,4,12),this.sprite.fillStyle(1710618,1),this.sprite.fillCircle(0,-24,3),this.sprite.lineStyle(1,16711680,.6),this.sprite.beginPath(),this.sprite.moveTo(-6,0),this.sprite.lineTo(6,0),this.sprite.moveTo(0,-6),this.sprite.lineTo(0,6),this.sprite.strokePath(),this.sprite.fillStyle(3815994,1),this.sprite.fillRect(-12,8,3,4),this.sprite.fillRect(9,8,3,4),this.sprite.x=this.x,this.sprite.y=this.y}calculateTargetValue(e){return e.getHealth()}fireAtTarget(e,t){if(e.isDead())return null;const s=this.damage*(1+this.armorPenetration);e.takeDamage(s);const i=this.scene.add.graphics();i.lineStyle(2,16776960,.8),i.beginPath(),i.moveTo(this.x,this.y),i.lineTo(e.x,e.y),i.strokePath();const r=this.scene.add.graphics();return r.fillStyle(16776960,.9),r.fillCircle(this.x,this.y-20,6),this.scene.tweens.add({targets:[i,r],alpha:0,duration:150,onComplete:()=>{i.destroy(),r.destroy()}}),null}upgrade(){const e=super.upgrade();return this.armorPenetration=Math.min(.9,this.armorPenetration+.1),e}}class $e{static createTower(e,t,s,i,r){switch(i){case"basic":return new We(e,t,s,r);case"fast":return new zt(e,t,s,r);case"strong":return new es(e,t,s,r);case"frost":return new ts(e,t,s,r);case"fire":return new is(e,t,s,r);case"splash":return new rs(e,t,s,r);case"sniper":return new ns(e,t,s,r);default:return console.warn(`Unknown tower type: ${i}, creating basic tower`),new We(e,t,s,r)}}}class os{scene;path;towers=[];preview=null;selectedType=null;selectedCost=0;selectedTower=null;constructor(e,t){this.scene=e,this.path=t,this.scene.input.on("pointerdown",s=>{this.handleTowerClick(s)})}selectTower(e,t){this.selectedType===e?(this.selectedType=null,this.selectedCost=0,this.clearPreview()):(this.selectedType=e,this.selectedCost=t)}deselectTower(){this.selectedType=null,this.selectedCost=0,this.clearPreview()}updatePreview(e){if(!this.selectedType){this.clearPreview();return}this.preview||(this.preview=this.scene.add.graphics()),this.preview.clear();const s=this.isValidPosition(e.x,e.y)?65280:16711680,i=.5;this.preview.fillStyle(s,i),this.preview.fillRect(e.x-15,e.y-15,30,30),this.preview.lineStyle(2,16777215,i),this.preview.strokeRect(e.x-15,e.y-15,30,30);const r=this.getTowerRange(this.selectedType);this.preview.lineStyle(2,s,i*.5),this.preview.strokeCircle(e.x,e.y,r)}tryPlaceTower(e,t,s){if(!this.selectedType||s<this.selectedCost)return{success:!1,cost:0};if(!this.isValidPosition(e,t))return{success:!1,cost:0};const i=$e.createTower(this.scene,e,t,this.selectedType,this.selectedCost);this.towers.push(i);const r=this.selectedCost;return this.selectedType=null,this.selectedCost=0,this.clearPreview(),{success:!0,cost:r}}update(e,t){const s=[];return this.towers.forEach(i=>{const r=i.update(e,t);r&&s.push(r)}),s}isValidPosition(e,t){const s=this.path.getPoints(100);for(const i of s)if(Phaser.Math.Distance.Between(e,t,i.x,i.y)<45)return!1;for(const i of this.towers)if(Phaser.Math.Distance.Between(e,t,i.x,i.y)<65)return!1;return!0}getTowerRange(e){switch(e){case"fast":return 120;case"strong":return 180;case"frost":return 140;case"splash":return 120;case"sniper":return 250;default:return 150}}clearPreview(){this.preview&&(this.preview.destroy(),this.preview=null)}getSelectedType(){return this.selectedType}addTowerFromServer(e,t,s,i,r){const a=m.getInstance().getConfig().towers[s],l=a?a.cost:0,h=$e.createTower(this.scene,e,t,s,l);r&&(h.id=r);for(let c=1;c<i;c++)h.upgrade();this.towers.push(h)}handleTowerClick(e){if(!this.selectedType){for(const t of this.towers)if(Phaser.Math.Distance.Between(e.x,e.y,t.x,t.y)<25){this.selectedTower=t;return}this.selectedTower=null}}tryUpgradeTower(e){if(!this.selectedTower||!this.selectedTower.canUpgrade())return{success:!1,cost:0};const t=this.selectedTower.getUpgradeCost();return e<t?{success:!1,cost:0}:(this.selectedTower.upgrade(),{success:!0,cost:t})}trySellTower(){if(!this.selectedTower)return{success:!1,refund:0};const e=this.selectedTower.getSellValue(),t=this.towers.indexOf(this.selectedTower);return t>-1&&this.towers.splice(t,1),this.selectedTower.destroy(),this.selectedTower=null,{success:!0,refund:e}}getSelectedTower(){return this.selectedTower}upgradeTowerById(e,t){const s=this.towers.find(i=>i.id===e);if(s)for(console.log(`üîß Upgrading tower ${e} to level ${t}`);s.getUpgradeLevel()<t&&s.canUpgrade();)s.upgrade();else console.error(`‚ùå Tower ${e} not found for upgrade`),console.log("Available towers:",this.towers.map(i=>({id:i.id,x:i.x,y:i.y})))}sellTowerById(e){const t=this.towers.find(s=>s.id===e);if(t){const s=this.towers.indexOf(t);s>-1&&this.towers.splice(s,1),t.destroy()}}cleanup(){this.towers.forEach(e=>e.destroy()),this.towers=[],this.clearPreview(),this.selectedTower=null}}class Fe{scene;path;mapConfig;mapName;mapRegistry;placedDecorations=[];constructor(e,t="classic"){this.scene=e,this.mapName=t,this.mapRegistry=W.getInstance()}async loadMap(){const e=this.mapRegistry.getMap(this.mapName);if(!e)throw new Error(`Map not found in registry: ${this.mapName}`);this.mapConfig=e}create(){if(!this.mapConfig)throw new Error("Map not loaded. Call loadMap() first.");const e=this.scene.cameras.main.width,t=this.scene.cameras.main.height;this.createBackground(e,t),this.createPathFromWaypoints(e,t),this.addTerrainDecorations(e,t),this.drawPathWithDepth(),this.addVegetationDecorations(e,t)}createPathFromWaypoints(e,t){const s=this.mapConfig.path.waypoints;if(s.length===0)throw new Error("No waypoints defined in map");const i=this.convertWaypoint(s[0],e,t);this.path=new Phaser.Curves.Path(i.x,i.y);for(let r=1;r<s.length;r++){const o=this.convertWaypoint(s[r],e,t);this.path.lineTo(o.x,o.y)}}convertWaypoint(e,t,s){let i=e.x,r=e.y;return i<0&&(i=t+i),r<0&&(r=s+r),typeof r=="number"&&r>0&&r<=1&&(r=s*r),typeof i=="number"&&i>0&&i<=1&&(i=t*i),{x:i,y:r}}createBackground(e,t){const s=this.scene.add.graphics(),i=this.mapConfig.background,r=t*i.skyHeight;for(let h=0;h<r;h++){const c=h/r,d=Phaser.Display.Color.Interpolate.ColorWithColor(Phaser.Display.Color.HexStringToColor(i.skyColorTop),Phaser.Display.Color.HexStringToColor(i.skyColorBottom),100,c*100);s.fillStyle(Phaser.Display.Color.GetColor(d.r,d.g,d.b),1),s.fillRect(0,h,e,2)}const a=Phaser.Display.Color.HexStringToColor(i.grassColor).color,l=40;for(let h=0;h<e;h+=l)for(let c=r;c<t;c+=l){const d=(Math.random()-.5)*20,u=Phaser.Display.Color.ValueToColor(a);u.darken(d),s.fillStyle(u.color,1);const f=l+Math.random()*10,p=l+Math.random()*10;s.fillRect(h,c,f,p)}for(let h=0;h<80;h++){const c=Math.random()*e,d=r+Math.random()*(t-r),u=3+Math.random()*4;s.fillStyle(1728282,.2+Math.random()*.2),s.fillCircle(c,d,u)}}addTerrainDecorations(e,t){const s=this.mapConfig.decorations;s.water&&s.water.forEach(i=>{const r=i.x*e,o=i.y*t,a=Math.max(i.width,i.height)/2;this.canPlaceDecoration(r,o,a,i.safeDistance)&&(this.drawSteampunkWater(r,o,i.width,i.height),this.registerDecoration(r,o,a))}),s.mountains&&s.mountains.forEach(i=>{const r=i.x*e,o=i.y*t,a=Phaser.Display.Color.HexStringToColor(i.color),l=Math.max(i.width,i.height)/2;this.canPlaceDecoration(r,o,l,i.safeDistance)&&(this.drawMountain(r,o,i.width,i.height,a.color),this.registerDecoration(r,o,l))}),s.gears&&s.gears.forEach(i=>{const r=i.x*e,o=i.y*t,a=Phaser.Display.Color.HexStringToColor(i.color);this.canPlaceDecoration(r,o,i.radius,i.safeDistance)&&(this.drawSteampunkGear(r,o,i.radius,a.color),this.registerDecoration(r,o,i.radius))}),s.pipes&&s.pipes.forEach(i=>{const r=i.x*e,o=i.y*t,a=30;this.canPlaceDecoration(r,o,a,i.safeDistance)&&(this.drawSteampunkPipes(r,o),this.registerDecoration(r,o,a))})}addVegetationDecorations(e,t){const s=this.mapConfig.decorations;s.trees&&s.trees.forEach(i=>{const r=i.x*e,o=i.y*t,a=Phaser.Display.Color.HexStringToColor(i.color),l=i.size*.6;this.canPlaceDecoration(r,o,l,i.safeDistance)&&(this.drawComicTree(r,o,i.size,a.color),this.registerDecoration(r,o,l))}),s.bushes&&s.bushes.forEach(i=>{const r=i.x*e,o=i.y*t,a=Phaser.Display.Color.HexStringToColor(i.color),l=i.size*.8;this.canPlaceDecoration(r,o,l,i.safeDistance)&&(this.drawBush(r,o,i.size,a.color),this.registerDecoration(r,o,l))}),s.lamps&&s.lamps.forEach(i=>{const r=i.x*e,o=i.y*t,a=20;this.canPlaceDecoration(r,o,a,i.safeDistance)&&(this.drawSteampunkLamp(r,o),this.registerDecoration(r,o,a))})}isOnPath(e,t,s){const i=this.path.getPoints(100);for(const r of i)if(Phaser.Math.Distance.Between(e,t,r.x,r.y)<s)return!0;return!1}canPlaceDecoration(e,t,s,i){if(this.isOnPath(e,t,i))return!1;for(const r of this.placedDecorations){const o=Phaser.Math.Distance.Between(e,t,r.x,r.y),a=s+r.radius+10;if(o<a)return!1}return!0}registerDecoration(e,t,s){this.placedDecorations.push({x:e,y:t,radius:s})}drawPathWithDepth(){const e=this.scene.add.graphics(),t=this.path.getPoints(200);for(let s=0;s<t.length-1;s++){const i=t[s],r=t[s+1],o=r.x-i.x,a=r.y-i.y,l=Math.sqrt(o*o+a*a);if(l===0)continue;const h=-a/l,c=o/l,d=22,u=Math.sin(s*.3)*2,f=d+u;e.fillStyle(7036239,1),e.fillTriangle(i.x-h*f,i.y-c*f,i.x+h*f,i.y+c*f,r.x-h*f,r.y-c*f),e.fillTriangle(r.x+h*f,r.y+c*f,r.x-h*f,r.y-c*f,i.x+h*f,i.y+c*f)}e.lineStyle(2,4864554,.4);for(let s=0;s<t.length-1;s++){const i=t[s],r=t[Math.min(s+1,t.length-1)].x-i.x,o=t[Math.min(s+1,t.length-1)].y-i.y,a=Math.sqrt(r*r+o*o);if(a===0)continue;const l=-o/a,h=r/a,c=24;e.beginPath(),e.moveTo(i.x-l*c,i.y-h*c),e.lineTo(t[Math.min(s+1,t.length-1)].x-l*c,t[Math.min(s+1,t.length-1)].y-h*c),e.strokePath(),e.beginPath(),e.moveTo(i.x+l*c,i.y+h*c),e.lineTo(t[Math.min(s+1,t.length-1)].x+l*c,t[Math.min(s+1,t.length-1)].y+h*c),e.strokePath()}for(let s=0;s<t.length;s+=5){const i=t[s];if(Math.random()>.6){const r=(Math.random()-.5)*30,o=(Math.random()-.5)*30,a=3+Math.random()*4;e.fillStyle(9075306,.5+Math.random()*.3),e.fillCircle(i.x+r,i.y+o,a),e.fillStyle(11184810,.3),e.fillCircle(i.x+r-1,i.y+o-1,a*.4)}if(Math.random()>.8){e.lineStyle(1,5917242,.3);const r=5+Math.random()*10,o=Math.random()*Math.PI*2;e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(i.x+Math.cos(o)*r,i.y+Math.sin(o)*r),e.strokePath()}}for(let s=0;s<t.length;s+=8){const i=t[s],r=Math.min(s+1,t.length-1),o=t[r].x-i.x,a=t[r].y-i.y,l=Math.sqrt(o*o+a*a);if(l===0)continue;const h=-a/l,c=o/l;for(const d of[-1,1]){const u=26+Math.random()*8,f=i.x+h*u*d,p=i.y+c*u*d,C=3+Math.floor(Math.random()*3);for(let x=0;x<C;x++){const y=(Math.random()-.5)*.4,T=4+Math.random()*4,w=f+(Math.random()-.5)*3,S=p+(Math.random()-.5)*3;e.lineStyle(1,2969622,.6+Math.random()*.2),e.beginPath(),e.moveTo(w,S),e.lineTo(w+Math.sin(y)*2,S-T),e.strokePath()}}}}drawSteampunkWater(e,t,s,i){const r=this.scene.add.graphics();r.fillStyle(4620980,.7),r.fillEllipse(e,t,s,i),r.lineStyle(3,9139029,1),r.strokeEllipse(e,t,s,i);for(let o=0;o<8;o++){const a=o/8*Math.PI*2,l=e+Math.cos(a)*(s/2),h=t+Math.sin(a)*(i/2);r.fillStyle(6908265,1),r.fillCircle(l,h,3)}}drawMountain(e,t,s,i,r){const o=this.scene.add.graphics();o.fillStyle(r,1),o.beginPath(),o.moveTo(e-s/2,t+i/2),o.lineTo(e-s/4,t-i/4),o.lineTo(e,t-i/2),o.lineTo(e+s/4,t-i/4),o.lineTo(e+s/2,t+i/2),o.closePath(),o.fillPath(),o.fillStyle(16775930,1),o.beginPath(),o.moveTo(e-s/8,t-i/4),o.lineTo(e,t-i/2),o.lineTo(e+s/8,t-i/4),o.closePath(),o.fillPath(),o.lineStyle(3,0,1),o.beginPath(),o.moveTo(e-s/2,t+i/2),o.lineTo(e,t-i/2),o.lineTo(e+s/2,t+i/2),o.strokePath()}drawSteampunkGear(e,t,s,i){const r=this.scene.add.graphics();r.fillStyle(i,1),r.fillCircle(e,t,s),r.fillStyle(i,1);const o=8;for(let a=0;a<o;a++){const l=a/o*Math.PI*2,h=e+Math.cos(l)*s,c=t+Math.sin(l)*s;r.fillRect(h-3,c-5,6,10)}r.fillStyle(3355443,1),r.fillCircle(e,t,s*.4),r.fillStyle(6908265,1);for(let a=0;a<4;a++){const l=a/4*Math.PI*2+Math.PI/4,h=e+Math.cos(l)*s*.6,c=t+Math.sin(l)*s*.6;r.fillCircle(h,c,3)}r.lineStyle(2,0,1),r.strokeCircle(e,t,s)}drawSteampunkPipes(e,t){const s=this.scene.add.graphics();s.fillStyle(9139029,1),s.fillRect(e-8,t-60,16,120);for(let i=0;i<3;i++){const r=t-40+i*40;s.lineStyle(2,6636321,1),s.lineTo(e-8,r),s.lineTo(e+8,r),s.strokePath(),s.fillStyle(6908265,1),s.fillCircle(e-6,r,2),s.fillCircle(e+6,r,2)}s.fillStyle(13467442,1),s.fillCircle(e+15,t,8),s.lineStyle(3,6636321,1),s.lineTo(e+8,t),s.lineTo(e+22,t),s.strokePath()}drawComicTree(e,t,s,i){const r=this.scene.add.graphics();r.fillStyle(6636321,1),r.fillRect(e-s*.15,t,s*.3,s*.8),r.lineStyle(2,0,1),r.strokeRect(e-s*.15,t,s*.3,s*.8),r.fillStyle(i,1),r.fillCircle(e,t-s*.2,s*.5),r.fillCircle(e-s*.3,t,s*.4),r.fillCircle(e+s*.3,t,s*.4),r.lineStyle(2,0,1),r.strokeCircle(e,t-s*.2,s*.5),r.strokeCircle(e-s*.3,t,s*.4),r.strokeCircle(e+s*.3,t,s*.4),r.fillStyle(16777215,.3),r.fillCircle(e-s*.1,t-s*.3,s*.15)}drawBush(e,t,s,i){const r=this.scene.add.graphics();r.fillStyle(i,1),r.fillCircle(e,t,s),r.fillCircle(e-s*.5,t+s*.2,s*.7),r.fillCircle(e+s*.5,t+s*.2,s*.7),r.lineStyle(2,0,1),r.strokeCircle(e,t,s),r.strokeCircle(e-s*.5,t+s*.2,s*.7),r.strokeCircle(e+s*.5,t+s*.2,s*.7),r.fillStyle(16777215,.2),r.fillCircle(e-s*.2,t-s*.2,s*.3)}drawSteampunkLamp(e,t){const s=this.scene.add.graphics();s.fillStyle(9139029,1),s.fillRect(e-4,t,8,80);for(let i=0;i<4;i++){const r=t+i*20;s.fillStyle(6908265,1),s.fillCircle(e-4,r,2),s.fillCircle(e+4,r,2)}s.fillStyle(13467442,1),s.fillRect(e-12,t-20,24,20),s.fillStyle(16777113,.8),s.fillRect(e-8,t-16,16,12),s.fillStyle(9139029,1),s.beginPath(),s.moveTo(e-14,t-20),s.lineTo(e,t-28),s.lineTo(e+14,t-20),s.closePath(),s.fillPath(),s.lineStyle(2,0,1),s.strokeRect(e-12,t-20,24,20),s.strokeRect(e-4,t,8,80)}getPath(){return this.path}getMapConfig(){return this.mapConfig}}class as{xp=0;level=1;researches;constructor(){this.researches=new Map,this.initializeResearches(),this.checkUnlocks()}initializeResearches(){this.researches.set("basic_tower_upgrade",{id:"basic_tower_upgrade",name:"Basis-Turm Upgrade",description:"Verbessert Basis-T√ºrme: +20% Schaden, +10% Reichweite",goldCost:150,xpRequired:0,unlocked:!0,researched:!1}),this.researches.set("frost_tower",{id:"frost_tower",name:"Frost-Turm",description:"Schaltet den Frost-Turm frei, der Gegner verlangsamt",goldCost:300,xpRequired:0,unlocked:!1,researched:!1}),this.researches.set("fire_tower",{id:"fire_tower",name:"Feuer-Turm",description:"Schaltet den Feuer-Turm frei, der Gegner verbrennt (8 Schaden/Sek f√ºr 5 Sek)",goldCost:350,xpRequired:0,unlocked:!1,researched:!1}),this.researches.set("tower_damage_1",{id:"tower_damage_1",name:"Verst√§rkter Schaden I",description:"+10% Schaden f√ºr alle T√ºrme",goldCost:200,xpRequired:0,unlocked:!1,researched:!1}),this.researches.set("tower_range_1",{id:"tower_range_1",name:"Erweiterte Reichweite I",description:"+10% Reichweite f√ºr alle T√ºrme",goldCost:200,xpRequired:0,unlocked:!1,researched:!1})}addXP(e){this.xp+=e;let t=!1;const s=[];for(;this.xp>=this.getXPForLevel(this.level+1);){this.level++,t=!0;const i=this.checkUnlocks();s.push(...i)}return t?{levelUp:!0,newLevel:this.level,newResearchUnlocked:s}:{levelUp:!1,newLevel:this.level,newResearchUnlocked:[]}}getXPForLevel(e){return e*100}checkUnlocks(){const e=[];if(console.log("Checking unlocks, current level:",this.level),this.level>=3){const t=this.researches.get("frost_tower");console.log("Frost tower before unlock:",t?.unlocked),t&&!t.unlocked&&(t.unlocked=!0,e.push(t.name),console.log("Frost tower unlocked!"))}if(this.level>=4){const t=this.researches.get("fire_tower");t&&!t.unlocked&&(t.unlocked=!0,e.push(t.name));const s=this.researches.get("tower_damage_1");s&&!s.unlocked&&(s.unlocked=!0,e.push(s.name));const i=this.researches.get("tower_range_1");i&&!i.unlocked&&(i.unlocked=!0,e.push(i.name))}return e}canResearch(e,t){const s=this.researches.get(e);return s?s.unlocked&&!s.researched&&t>=s.goldCost:!1}research(e){const t=this.researches.get(e);return!t||!t.unlocked||t.researched?!1:(t.researched=!0,!0)}isResearched(e){const t=this.researches.get(e);return t?t.researched:!1}getAvailableResearches(){const e=Array.from(this.researches.values()).filter(t=>t.unlocked&&!t.researched);return console.log("Available researches:",e.map(t=>({name:t.name,unlocked:t.unlocked,researched:t.researched}))),console.log("Current level:",this.level,"XP:",this.xp),e}getResearch(e){return this.researches.get(e)}getXP(){return this.xp}getLevel(){return this.level}getXPForNextLevel(){return this.getXPForLevel(this.level+1)}getXPProgress(){const e=this.level>1?this.getXPForLevel(this.level):0,t=this.getXPForLevel(this.level+1),s=this.xp-e,i=t-e;return s/i}}class ls{projectiles=[];addProjectile(e){this.projectiles.push(e)}update(e){for(const t of this.projectiles)t.update(e);this.projectiles=this.projectiles.filter(t=>t.shouldDestroy()?(t.destroy(),!1):!0)}getCount(){return this.projectiles.length}clear(){for(const e of this.projectiles)e.destroy();this.projectiles=[]}}class hs{constructor(e){this.scene=e}showLevelUp(e){const t=this.scene.cameras.main.width,s=this.scene.cameras.main.height,i=this.scene.add.container(t/2,s/3),r=this.scene.add.rectangle(0,0,300,100,0,.8),o=this.scene.add.text(0,-20,"Level Up!",{font:"bold 32px Arial",color:"#ffff00"}).setOrigin(.5),a=this.scene.add.text(0,20,`Level ${e}`,{font:"24px Arial",color:"#ffffff"}).setOrigin(.5);i.add([r,o,a]),i.setDepth(1e3),this.scene.tweens.add({targets:i,alpha:{from:1,to:0},y:s/3-50,duration:2e3,ease:"Power2",onComplete:()=>i.destroy()})}showTowerUpgrade(){const e=this.scene.cameras.main.width,t=this.scene.cameras.main.height,s=this.scene.add.container(e/2,t/2),i=this.scene.add.rectangle(0,0,250,80,0,.8),r=this.scene.add.text(0,0,"Turm Verbessert!",{font:"bold 28px Arial",color:"#ff9900"}).setOrigin(.5);s.add([i,r]),s.setDepth(1e3),this.scene.tweens.add({targets:s,alpha:{from:1,to:0},y:t/2-50,duration:1500,ease:"Power2",onComplete:()=>s.destroy()})}showTowerSold(e){const t=this.scene.cameras.main.width,s=this.scene.cameras.main.height,i=this.scene.add.container(t/2,s/2),r=this.scene.add.rectangle(0,0,280,100,0,.8),o=this.scene.add.text(0,-15,"Turm Verkauft!",{font:"bold 28px Arial",color:"#cc0000"}).setOrigin(.5),a=this.scene.add.text(0,20,`+${e} Gold`,{font:"22px Arial",color:"#ffff00"}).setOrigin(.5);i.add([r,o,a]),i.setDepth(1e3),this.scene.tweens.add({targets:i,alpha:{from:1,to:0},y:s/2-50,duration:1500,ease:"Power2",onComplete:()=>i.destroy()})}showResearchUnlocked(e){const t=this.scene.cameras.main.width,s=this.scene.cameras.main.height,i=this.scene.add.container(t/2,s/2),r=this.scene.add.rectangle(0,0,400,120,0,.9);r.setStrokeStyle(3,10027263,1);const o=this.scene.add.text(0,-30,"üî¨",{font:"bold 40px Arial"}).setOrigin(.5),a=this.scene.add.text(0,10,"Neue Forschung verf√ºgbar!",{font:"bold 24px Arial",color:"#ff00ff"}).setOrigin(.5),l=this.scene.add.text(0,40,e,{font:"20px Arial",color:"#ffff00"}).setOrigin(.5);i.add([r,o,a,l]),i.setDepth(1001),i.setScale(.5),this.scene.tweens.add({targets:i,scale:{from:.5,to:1},duration:300,ease:"Back.easeOut"}),this.scene.tweens.add({targets:r,scaleX:{from:1,to:1.05},scaleY:{from:1,to:1.05},duration:800,yoyo:!0,repeat:2}),this.scene.tweens.add({targets:i,alpha:{from:1,to:0},y:s/2-80,delay:3e3,duration:1e3,ease:"Power2",onComplete:()=>i.destroy()})}}class cs{constructor(e,t,s){this.researchManager=e,this.ui=t,this.onLevelUp=s}awardXP(e,t){const s=this.researchManager.addXP(e);this.ui.updateXP(this.researchManager.getXP(),this.researchManager.getLevel()),t&&t.setPlayerLevel(this.researchManager.getLevel()),s.levelUp&&this.onLevelUp(s.newLevel,s.newResearchUnlocked)}checkAvailableResearches(e){const t=this.researchManager.getAvailableResearches();return t.length===0?!1:t.some(i=>this.researchManager.canResearch(i.id,e))||t.length>0}}class ds{constructor(e,t,s,i,r){this.waveManager=e,this.xpHandler=t,this.onGoldChange=s,this.onLifeLost=i,this.onWaveComplete=r}handleEnemyKilled(e,t){this.onGoldChange(e),this.xpHandler.awardXP(t,this.waveManager)}handleEnemyEscaped(){this.onLifeLost()}handleWaveCompleted(e){const t=50+e*10,s=(20+e*5)*2;this.onGoldChange(t),this.xpHandler.awardXP(s,this.waveManager),this.onWaveComplete(e)}}class us{constructor(e,t,s,i){this.towerManager=e,this.ui=t,this.onGoldChange=s,this.onNotification=i}selectTower(e,t){this.towerManager.selectTower(e,t),this.ui.updateButtonStyles(this.towerManager.getSelectedType()||void 0)}tryPlaceTower(e,t,s){const i=this.towerManager.tryPlaceTower(e,t,s);return i.success?(this.onGoldChange(-i.cost),this.ui.updateButtonStyles(),!0):!1}tryUpgradeTower(e){const t=this.towerManager.tryUpgradeTower(e);return t.success?(this.onGoldChange(-t.cost),this.onNotification("upgrade"),!0):!1}trySellTower(){const e=this.towerManager.trySellTower();return e.success?(this.onGoldChange(e.refund),this.onNotification("sell",e.refund),!0):!1}getSelectedTower(){return this.towerManager.getSelectedTower()}deselectTower(){this.towerManager.deselectTower()}}const D=Object.create(null);D.open="0";D.close="1";D.ping="2";D.pong="3";D.message="4";D.upgrade="5";D.noop="6";const he=Object.create(null);Object.keys(D).forEach(n=>{he[D[n]]=n});const be={type:"error",data:"parser error"},et=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",tt=typeof ArrayBuffer=="function",st=n=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(n):n&&n.buffer instanceof ArrayBuffer,Me=({type:n,data:e},t,s)=>et&&e instanceof Blob?t?s(e):Ge(e,s):tt&&(e instanceof ArrayBuffer||st(e))?t?s(e):Ge(new Blob([e]),s):s(D[n]+(e||"")),Ge=(n,e)=>{const t=new FileReader;return t.onload=function(){const s=t.result.split(",")[1];e("b"+(s||""))},t.readAsDataURL(n)};function qe(n){return n instanceof Uint8Array?n:n instanceof ArrayBuffer?new Uint8Array(n):new Uint8Array(n.buffer,n.byteOffset,n.byteLength)}let we;function fs(n,e){if(et&&n.data instanceof Blob)return n.data.arrayBuffer().then(qe).then(e);if(tt&&(n.data instanceof ArrayBuffer||st(n.data)))return e(qe(n.data));Me(n,!1,t=>{we||(we=new TextEncoder),e(we.encode(t))})}const Ve="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",ee=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let n=0;n<Ve.length;n++)ee[Ve.charCodeAt(n)]=n;const ps=n=>{let e=n.length*.75,t=n.length,s,i=0,r,o,a,l;n[n.length-1]==="="&&(e--,n[n.length-2]==="="&&e--);const h=new ArrayBuffer(e),c=new Uint8Array(h);for(s=0;s<t;s+=4)r=ee[n.charCodeAt(s)],o=ee[n.charCodeAt(s+1)],a=ee[n.charCodeAt(s+2)],l=ee[n.charCodeAt(s+3)],c[i++]=r<<2|o>>4,c[i++]=(o&15)<<4|a>>2,c[i++]=(a&3)<<6|l&63;return h},gs=typeof ArrayBuffer=="function",Ee=(n,e)=>{if(typeof n!="string")return{type:"message",data:it(n,e)};const t=n.charAt(0);return t==="b"?{type:"message",data:ms(n.substring(1),e)}:he[t]?n.length>1?{type:he[t],data:n.substring(1)}:{type:he[t]}:be},ms=(n,e)=>{if(gs){const t=ps(n);return it(t,e)}else return{base64:!0,data:n}},it=(n,e)=>{switch(e){case"blob":return n instanceof Blob?n:new Blob([n]);case"arraybuffer":default:return n instanceof ArrayBuffer?n:n.buffer}},rt="",ys=(n,e)=>{const t=n.length,s=new Array(t);let i=0;n.forEach((r,o)=>{Me(r,!1,a=>{s[o]=a,++i===t&&e(s.join(rt))})})},ws=(n,e)=>{const t=n.split(rt),s=[];for(let i=0;i<t.length;i++){const r=Ee(t[i],e);if(s.push(r),r.type==="error")break}return s};function Ss(){return new TransformStream({transform(n,e){fs(n,t=>{const s=t.length;let i;if(s<126)i=new Uint8Array(1),new DataView(i.buffer).setUint8(0,s);else if(s<65536){i=new Uint8Array(3);const r=new DataView(i.buffer);r.setUint8(0,126),r.setUint16(1,s)}else{i=new Uint8Array(9);const r=new DataView(i.buffer);r.setUint8(0,127),r.setBigUint64(1,BigInt(s))}n.data&&typeof n.data!="string"&&(i[0]|=128),e.enqueue(i),e.enqueue(t)})}})}let Se;function ae(n){return n.reduce((e,t)=>e+t.length,0)}function le(n,e){if(n[0].length===e)return n.shift();const t=new Uint8Array(e);let s=0;for(let i=0;i<e;i++)t[i]=n[0][s++],s===n[0].length&&(n.shift(),s=0);return n.length&&s<n[0].length&&(n[0]=n[0].slice(s)),t}function vs(n,e){Se||(Se=new TextDecoder);const t=[];let s=0,i=-1,r=!1;return new TransformStream({transform(o,a){for(t.push(o);;){if(s===0){if(ae(t)<1)break;const l=le(t,1);r=(l[0]&128)===128,i=l[0]&127,i<126?s=3:i===126?s=1:s=2}else if(s===1){if(ae(t)<2)break;const l=le(t,2);i=new DataView(l.buffer,l.byteOffset,l.length).getUint16(0),s=3}else if(s===2){if(ae(t)<8)break;const l=le(t,8),h=new DataView(l.buffer,l.byteOffset,l.length),c=h.getUint32(0);if(c>Math.pow(2,21)-1){a.enqueue(be);break}i=c*Math.pow(2,32)+h.getUint32(4),s=3}else{if(ae(t)<i)break;const l=le(t,i);a.enqueue(Ee(r?l:Se.decode(l),e)),s=0}if(i===0||i>n){a.enqueue(be);break}}}})}const nt=4;function k(n){if(n)return bs(n)}function bs(n){for(var e in k.prototype)n[e]=k.prototype[e];return n}k.prototype.on=k.prototype.addEventListener=function(n,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+n]=this._callbacks["$"+n]||[]).push(e),this};k.prototype.once=function(n,e){function t(){this.off(n,t),e.apply(this,arguments)}return t.fn=e,this.on(n,t),this};k.prototype.off=k.prototype.removeListener=k.prototype.removeAllListeners=k.prototype.removeEventListener=function(n,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+n];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+n],this;for(var s,i=0;i<t.length;i++)if(s=t[i],s===e||s.fn===e){t.splice(i,1);break}return t.length===0&&delete this._callbacks["$"+n],this};k.prototype.emit=function(n){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+n],s=1;s<arguments.length;s++)e[s-1]=arguments[s];if(t){t=t.slice(0);for(var s=0,i=t.length;s<i;++s)t[s].apply(this,e)}return this};k.prototype.emitReserved=k.prototype.emit;k.prototype.listeners=function(n){return this._callbacks=this._callbacks||{},this._callbacks["$"+n]||[]};k.prototype.hasListeners=function(n){return!!this.listeners(n).length};const fe=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0),E=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),Cs="arraybuffer";function ot(n,...e){return e.reduce((t,s)=>(n.hasOwnProperty(s)&&(t[s]=n[s]),t),{})}const xs=E.setTimeout,Ts=E.clearTimeout;function pe(n,e){e.useNativeTimers?(n.setTimeoutFn=xs.bind(E),n.clearTimeoutFn=Ts.bind(E)):(n.setTimeoutFn=E.setTimeout.bind(E),n.clearTimeoutFn=E.clearTimeout.bind(E))}const ks=1.33;function Ps(n){return typeof n=="string"?Rs(n):Math.ceil((n.byteLength||n.size)*ks)}function Rs(n){let e=0,t=0;for(let s=0,i=n.length;s<i;s++)e=n.charCodeAt(s),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(s++,t+=4);return t}function at(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function Ms(n){let e="";for(let t in n)n.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(n[t]));return e}function Es(n){let e={},t=n.split("&");for(let s=0,i=t.length;s<i;s++){let r=t[s].split("=");e[decodeURIComponent(r[0])]=decodeURIComponent(r[1])}return e}class Bs extends Error{constructor(e,t,s){super(e),this.description=t,this.context=s,this.type="TransportError"}}class Be extends k{constructor(e){super(),this.writable=!1,pe(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,s){return super.emitReserved("error",new Bs(e,t,s)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=Ee(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const t=Ms(e);return t.length?"?"+t:""}}class _s extends Be{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let s=0;this._polling&&(s++,this.once("pollComplete",function(){--s||t()})),this.writable||(s++,this.once("drain",function(){--s||t()}))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=s=>{if(this.readyState==="opening"&&s.type==="open"&&this.onOpen(),s.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(s)};ws(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,ys(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return this.opts.timestampRequests!==!1&&(t[this.opts.timestampParam]=at()),!this.supportsBinary&&!t.sid&&(t.b64=1),this.createUri(e,t)}}let lt=!1;try{lt=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const Is=lt;function As(){}class Ls extends _s{constructor(e){if(super(e),typeof location<"u"){const t=location.protocol==="https:";let s=location.port;s||(s=t?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||s!==e.port}}doWrite(e,t){const s=this.request({method:"POST",data:e});s.on("success",t),s.on("error",(i,r)=>{this.onError("xhr post error",i,r)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,s)=>{this.onError("xhr poll error",t,s)}),this.pollXhr=e}}class O extends k{constructor(e,t,s){super(),this.createRequest=e,pe(this,s),this._opts=s,this._method=s.method||"GET",this._uri=t,this._data=s.data!==void 0?s.data:null,this._create()}_create(){var e;const t=ot(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const s=this._xhr=this.createRequest(t);try{s.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){s.setDisableHeaderCheck&&s.setDisableHeaderCheck(!0);for(let i in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(i)&&s.setRequestHeader(i,this._opts.extraHeaders[i])}}catch{}if(this._method==="POST")try{s.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{s.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(s),"withCredentials"in s&&(s.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(s.timeout=this._opts.requestTimeout),s.onreadystatechange=()=>{var i;s.readyState===3&&((i=this._opts.cookieJar)===null||i===void 0||i.parseCookies(s.getResponseHeader("set-cookie"))),s.readyState===4&&(s.status===200||s.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof s.status=="number"?s.status:0)},0))},s.send(this._data)}catch(i){this.setTimeoutFn(()=>{this._onError(i)},0);return}typeof document<"u"&&(this._index=O.requestsCount++,O.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=As,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete O.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}O.requestsCount=0;O.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",je);else if(typeof addEventListener=="function"){const n="onpagehide"in E?"pagehide":"unload";addEventListener(n,je,!1)}}function je(){for(let n in O.requests)O.requests.hasOwnProperty(n)&&O.requests[n].abort()}const Os=(function(){const n=ht({xdomain:!1});return n&&n.responseType!==null})();class Ds extends Ls{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=Os&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new O(ht,this.uri(),e)}}function ht(n){const e=n.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||Is))return new XMLHttpRequest}catch{}if(!e)try{return new E[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const ct=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class Us extends Be{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,s=ct?{}:ot(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(s.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,s)}catch(i){return this.emitReserved("error",i)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const s=e[t],i=t===e.length-1;Me(s,this.supportsBinary,r=>{try{this.doWrite(s,r)}catch{}i&&fe(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=at()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const ve=E.WebSocket||E.MozWebSocket;class Hs extends Us{createSocket(e,t,s){return ct?new ve(e,t,s):t?new ve(e,t):new ve(e)}doWrite(e,t){this.ws.send(t)}}class Ns extends Be{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const t=vs(Number.MAX_SAFE_INTEGER,this.socket.binaryType),s=e.readable.pipeThrough(t).getReader(),i=Ss();i.readable.pipeTo(e.writable),this._writer=i.writable.getWriter();const r=()=>{s.read().then(({done:a,value:l})=>{a||(this.onPacket(l),r())}).catch(a=>{})};r();const o={type:"open"};this.query.sid&&(o.data=`{"sid":"${this.query.sid}"}`),this._writer.write(o).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const s=e[t],i=t===e.length-1;this._writer.write(s).then(()=>{i&&fe(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const Ws={websocket:Hs,webtransport:Ns,polling:Ds},$s=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Fs=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Ce(n){if(n.length>8e3)throw"URI too long";const e=n,t=n.indexOf("["),s=n.indexOf("]");t!=-1&&s!=-1&&(n=n.substring(0,t)+n.substring(t,s).replace(/:/g,";")+n.substring(s,n.length));let i=$s.exec(n||""),r={},o=14;for(;o--;)r[Fs[o]]=i[o]||"";return t!=-1&&s!=-1&&(r.source=e,r.host=r.host.substring(1,r.host.length-1).replace(/;/g,":"),r.authority=r.authority.replace("[","").replace("]","").replace(/;/g,":"),r.ipv6uri=!0),r.pathNames=Gs(r,r.path),r.queryKey=qs(r,r.query),r}function Gs(n,e){const t=/\/{2,9}/g,s=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&s.splice(0,1),e.slice(-1)=="/"&&s.splice(s.length-1,1),s}function qs(n,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(s,i,r){i&&(t[i]=r)}),t}const xe=typeof addEventListener=="function"&&typeof removeEventListener=="function",ce=[];xe&&addEventListener("offline",()=>{ce.forEach(n=>n())},!1);class $ extends k{constructor(e,t){if(super(),this.binaryType=Cs,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(t=e,e=null),e){const s=Ce(e);t.hostname=s.host,t.secure=s.protocol==="https"||s.protocol==="wss",t.port=s.port,s.query&&(t.query=s.query)}else t.host&&(t.hostname=Ce(t.host).host);pe(this,t),this.secure=t.secure!=null?t.secure:typeof location<"u"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=t.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach(s=>{const i=s.prototype.name;this.transports.push(i),this._transportsByName[i]=s}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Es(this.opts.query)),xe&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},ce.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=nt,t.transport=e,this.id&&(t.sid=this.id);const s=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](s)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&$.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",t=>this._onClose("transport close",t))}onOpen(){this.readyState="open",$.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let s=0;s<this.writeBuffer.length;s++){const i=this.writeBuffer[s].data;if(i&&(t+=Ps(i)),s>0&&t>this._maxPayload)return this.writeBuffer.slice(0,s);t+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,fe(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,t,s){return this._sendPacket("message",e,t,s),this}send(e,t,s){return this._sendPacket("message",e,t,s),this}_sendPacket(e,t,s,i){if(typeof t=="function"&&(i=t,t=void 0),typeof s=="function"&&(i=s,s=null),this.readyState==="closing"||this.readyState==="closed")return;s=s||{},s.compress=s.compress!==!1;const r={type:e,data:t,options:s};this.emitReserved("packetCreate",r),this.writeBuffer.push(r),i&&this.once("flush",i),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},s=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?s():e()}):this.upgrading?s():e()),this}_onError(e){if($.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),xe&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const s=ce.indexOf(this._offlineEventListener);s!==-1&&ce.splice(s,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}$.protocol=nt;class Vs extends ${constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),s=!1;$.priorWebsocketSuccess=!1;const i=()=>{s||(t.send([{type:"ping",data:"probe"}]),t.once("packet",d=>{if(!s)if(d.type==="pong"&&d.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;$.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{s||this.readyState!=="closed"&&(c(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const u=new Error("probe error");u.transport=t.name,this.emitReserved("upgradeError",u)}}))};function r(){s||(s=!0,c(),t.close(),t=null)}const o=d=>{const u=new Error("probe error: "+d);u.transport=t.name,r(),this.emitReserved("upgradeError",u)};function a(){o("transport closed")}function l(){o("socket closed")}function h(d){t&&d.name!==t.name&&r()}const c=()=>{t.removeListener("open",i),t.removeListener("error",o),t.removeListener("close",a),this.off("close",l),this.off("upgrading",h)};t.once("open",i),t.once("error",o),t.once("close",a),this.once("close",l),this.once("upgrading",h),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{s||t.open()},200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let s=0;s<e.length;s++)~this.transports.indexOf(e[s])&&t.push(e[s]);return t}}let js=class extends Vs{constructor(e,t={}){const s=typeof e=="object"?e:t;(!s.transports||s.transports&&typeof s.transports[0]=="string")&&(s.transports=(s.transports||["polling","websocket","webtransport"]).map(i=>Ws[i]).filter(i=>!!i)),super(e,s)}};function Xs(n,e="",t){let s=n;t=t||typeof location<"u"&&location,n==null&&(n=t.protocol+"//"+t.host),typeof n=="string"&&(n.charAt(0)==="/"&&(n.charAt(1)==="/"?n=t.protocol+n:n=t.host+n),/^(https?|wss?):\/\//.test(n)||(typeof t<"u"?n=t.protocol+"//"+n:n="https://"+n),s=Ce(n)),s.port||(/^(http|ws)$/.test(s.protocol)?s.port="80":/^(http|ws)s$/.test(s.protocol)&&(s.port="443")),s.path=s.path||"/";const r=s.host.indexOf(":")!==-1?"["+s.host+"]":s.host;return s.id=s.protocol+"://"+r+":"+s.port+e,s.href=s.protocol+"://"+r+(t&&t.port===s.port?"":":"+s.port),s}const Ks=typeof ArrayBuffer=="function",Js=n=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(n):n.buffer instanceof ArrayBuffer,dt=Object.prototype.toString,Ys=typeof Blob=="function"||typeof Blob<"u"&&dt.call(Blob)==="[object BlobConstructor]",Qs=typeof File=="function"||typeof File<"u"&&dt.call(File)==="[object FileConstructor]";function _e(n){return Ks&&(n instanceof ArrayBuffer||Js(n))||Ys&&n instanceof Blob||Qs&&n instanceof File}function de(n,e){if(!n||typeof n!="object")return!1;if(Array.isArray(n)){for(let t=0,s=n.length;t<s;t++)if(de(n[t]))return!0;return!1}if(_e(n))return!0;if(n.toJSON&&typeof n.toJSON=="function"&&arguments.length===1)return de(n.toJSON(),!0);for(const t in n)if(Object.prototype.hasOwnProperty.call(n,t)&&de(n[t]))return!0;return!1}function Zs(n){const e=[],t=n.data,s=n;return s.data=Te(t,e),s.attachments=e.length,{packet:s,buffers:e}}function Te(n,e){if(!n)return n;if(_e(n)){const t={_placeholder:!0,num:e.length};return e.push(n),t}else if(Array.isArray(n)){const t=new Array(n.length);for(let s=0;s<n.length;s++)t[s]=Te(n[s],e);return t}else if(typeof n=="object"&&!(n instanceof Date)){const t={};for(const s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=Te(n[s],e));return t}return n}function zs(n,e){return n.data=ke(n.data,e),delete n.attachments,n}function ke(n,e){if(!n)return n;if(n&&n._placeholder===!0){if(typeof n.num=="number"&&n.num>=0&&n.num<e.length)return e[n.num];throw new Error("illegal attachments")}else if(Array.isArray(n))for(let t=0;t<n.length;t++)n[t]=ke(n[t],e);else if(typeof n=="object")for(const t in n)Object.prototype.hasOwnProperty.call(n,t)&&(n[t]=ke(n[t],e));return n}const ei=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],ti=5;var g;(function(n){n[n.CONNECT=0]="CONNECT",n[n.DISCONNECT=1]="DISCONNECT",n[n.EVENT=2]="EVENT",n[n.ACK=3]="ACK",n[n.CONNECT_ERROR=4]="CONNECT_ERROR",n[n.BINARY_EVENT=5]="BINARY_EVENT",n[n.BINARY_ACK=6]="BINARY_ACK"})(g||(g={}));class si{constructor(e){this.replacer=e}encode(e){return(e.type===g.EVENT||e.type===g.ACK)&&de(e)?this.encodeAsBinary({type:e.type===g.EVENT?g.BINARY_EVENT:g.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===g.BINARY_EVENT||e.type===g.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=Zs(e),s=this.encodeAsString(t.packet),i=t.buffers;return i.unshift(s),i}}function Xe(n){return Object.prototype.toString.call(n)==="[object Object]"}class Ie extends k{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const s=t.type===g.BINARY_EVENT;s||t.type===g.BINARY_ACK?(t.type=s?g.EVENT:g.ACK,this.reconstructor=new ii(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(_e(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const s={type:Number(e.charAt(0))};if(g[s.type]===void 0)throw new Error("unknown packet type "+s.type);if(s.type===g.BINARY_EVENT||s.type===g.BINARY_ACK){const r=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const o=e.substring(r,t);if(o!=Number(o)||e.charAt(t)!=="-")throw new Error("Illegal attachments");s.attachments=Number(o)}if(e.charAt(t+1)==="/"){const r=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););s.nsp=e.substring(r,t)}else s.nsp="/";const i=e.charAt(t+1);if(i!==""&&Number(i)==i){const r=t+1;for(;++t;){const o=e.charAt(t);if(o==null||Number(o)!=o){--t;break}if(t===e.length)break}s.id=Number(e.substring(r,t+1))}if(e.charAt(++t)){const r=this.tryParse(e.substr(t));if(Ie.isPayloadValid(s.type,r))s.data=r;else throw new Error("invalid payload")}return s}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,t){switch(e){case g.CONNECT:return Xe(t);case g.DISCONNECT:return t===void 0;case g.CONNECT_ERROR:return typeof t=="string"||Xe(t);case g.EVENT:case g.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&ei.indexOf(t[0])===-1);case g.ACK:case g.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class ii{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=zs(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const ri=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Ie,Encoder:si,get PacketType(){return g},protocol:ti},Symbol.toStringTag,{value:"Module"}));function I(n,e,t){return n.on(e,t),function(){n.off(e,t)}}const ni=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class ut extends k{constructor(e,t,s){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,s&&s.auth&&(this.auth=s.auth),this._opts=Object.assign({},s),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[I(e,"open",this.onopen.bind(this)),I(e,"packet",this.onpacket.bind(this)),I(e,"error",this.onerror.bind(this)),I(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var s,i,r;if(ni.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const o={type:g.EVENT,data:t};if(o.options={},o.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const c=this.ids++,d=t.pop();this._registerAckCallback(c,d),o.id=c}const a=(i=(s=this.io.engine)===null||s===void 0?void 0:s.transport)===null||i===void 0?void 0:i.writable,l=this.connected&&!(!((r=this.io.engine)===null||r===void 0)&&r._hasPingExpired());return this.flags.volatile&&!a||(l?(this.notifyOutgoingListeners(o),this.packet(o)):this.sendBuffer.push(o)),this.flags={},this}_registerAckCallback(e,t){var s;const i=(s=this.flags.timeout)!==null&&s!==void 0?s:this._opts.ackTimeout;if(i===void 0){this.acks[e]=t;return}const r=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let a=0;a<this.sendBuffer.length;a++)this.sendBuffer[a].id===e&&this.sendBuffer.splice(a,1);t.call(this,new Error("operation has timed out"))},i),o=(...a)=>{this.io.clearTimeoutFn(r),t.apply(this,a)};o.withError=!0,this.acks[e]=o}emitWithAck(e,...t){return new Promise((s,i)=>{const r=(o,a)=>o?i(o):s(a);r.withError=!0,t.push(r),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const s={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((i,...r)=>s!==this._queue[0]?void 0:(i!==null?s.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(i)):(this._queue.shift(),t&&t(null,...r)),s.pending=!1,this._drainQueue())),this._queue.push(s),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:g.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(s=>String(s.id)===e)){const s=this.acks[e];delete this.acks[e],s.withError&&s.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case g.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case g.EVENT:case g.BINARY_EVENT:this.onevent(e);break;case g.ACK:case g.BINARY_ACK:this.onack(e);break;case g.DISCONNECT:this.ondisconnect();break;case g.CONNECT_ERROR:this.destroy();const s=new Error(e.data.message);s.data=e.data.data,this.emitReserved("connect_error",s);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const s of t)s.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let s=!1;return function(...i){s||(s=!0,t.packet({type:g.ACK,id:e,data:i}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:g.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let s=0;s<t.length;s++)if(e===t[s])return t.splice(s,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let s=0;s<t.length;s++)if(e===t[s])return t.splice(s,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const s of t)s.apply(this,e.data)}}}function Q(n){n=n||{},this.ms=n.min||100,this.max=n.max||1e4,this.factor=n.factor||2,this.jitter=n.jitter>0&&n.jitter<=1?n.jitter:0,this.attempts=0}Q.prototype.duration=function(){var n=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*n);n=(Math.floor(e*10)&1)==0?n-t:n+t}return Math.min(n,this.max)|0};Q.prototype.reset=function(){this.attempts=0};Q.prototype.setMin=function(n){this.ms=n};Q.prototype.setMax=function(n){this.max=n};Q.prototype.setJitter=function(n){this.jitter=n};class Pe extends k{constructor(e,t){var s;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,pe(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((s=t.randomizationFactor)!==null&&s!==void 0?s:.5),this.backoff=new Q({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const i=t.parser||ri;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new js(this.uri,this.opts);const t=this.engine,s=this;this._readyState="opening",this.skipReconnect=!1;const i=I(t,"open",function(){s.onopen(),e&&e()}),r=a=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",a),e?e(a):this.maybeReconnectOnOpen()},o=I(t,"error",r);if(this._timeout!==!1){const a=this._timeout,l=this.setTimeoutFn(()=>{i(),r(new Error("timeout")),t.close()},a);this.opts.autoUnref&&l.unref(),this.subs.push(()=>{this.clearTimeoutFn(l)})}return this.subs.push(i),this.subs.push(o),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(I(e,"ping",this.onping.bind(this)),I(e,"data",this.ondata.bind(this)),I(e,"error",this.onerror.bind(this)),I(e,"close",this.onclose.bind(this)),I(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){fe(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let s=this.nsps[e];return s?this._autoConnect&&!s.active&&s.connect():(s=new ut(this,e,t),this.nsps[e]=s),s}_destroy(e){const t=Object.keys(this.nsps);for(const s of t)if(this.nsps[s].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let s=0;s<t.length;s++)this.engine.write(t[s],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var s;this.cleanup(),(s=this.engine)===null||s===void 0||s.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const s=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(i=>{i?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",i)):e.onreconnect()}))},t);this.opts.autoUnref&&s.unref(),this.subs.push(()=>{this.clearTimeoutFn(s)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const z={};function ue(n,e){typeof n=="object"&&(e=n,n=void 0),e=e||{};const t=Xs(n,e.path||"/socket.io"),s=t.source,i=t.id,r=t.path,o=z[i]&&r in z[i].nsps,a=e.forceNew||e["force new connection"]||e.multiplex===!1||o;let l;return a?l=new Pe(s,e):(z[i]||(z[i]=new Pe(s,e)),l=z[i]),t.query&&!e.query&&(e.query=t.queryKey),l.socket(t.path,e)}Object.assign(ue,{Manager:Pe,Socket:ut,io:ue,connect:ue});class A{static instance;socket=null;connected=!1;currentRoom=null;isHost=!1;eventHandlers=new Map;constructor(){}static getInstance(){return A.instance||(A.instance=new A),A.instance}connect(e){return new Promise((t,s)=>{if(this.connected&&this.socket){t();return}this.socket=ue(e,{transports:["websocket"],reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:5}),this.socket.on("connect",()=>{console.log("‚úÖ Connected to game server"),this.connected=!0,this.setupSocketListeners(),t()}),this.socket.on("connect_error",i=>{console.error("‚ùå Connection error:",i),s(i)}),this.socket.on("disconnect",()=>{console.log("‚ùå Disconnected from server"),this.connected=!1,this.trigger("disconnect")})})}setupSocketListeners(){this.socket&&(this.onSocket("room:created",e=>{this.currentRoom=e,this.trigger("room:created",e)}),this.onSocket("room:joined",e=>{this.currentRoom=e.code,this.isHost=e.isHost,this.trigger("room:joined",e)}),["room:playerJoined","room:playerLeft","room:playerReady"].forEach(e=>{this.onSocket(e,t=>this.trigger(e,t))}),this.onSocket("room:error",e=>this.trigger("room:error",e)),this.onSocket("game:started",()=>this.trigger("game:started")),this.onSocket("game:stateUpdate",e=>this.trigger("game:stateUpdate",e)),this.onSocket("game:towerPlaced",e=>this.trigger("game:towerPlaced",e)),this.onSocket("game:towerUpgraded",(e,t)=>this.trigger("game:towerUpgraded",{towerId:e,level:t})),this.onSocket("game:towerSold",(e,t)=>this.trigger("game:towerSold",{towerId:e,refund:t})),this.onSocket("game:enemySpawned",e=>this.trigger("game:enemySpawned",e)),this.onSocket("game:enemyDied",(e,t,s)=>this.trigger("game:enemyDied",{enemyId:e,gold:t,xp:s})),this.onSocket("game:waveStarted",e=>this.trigger("game:waveStarted",e)),this.onSocket("game:waveCompleted",(e,t)=>this.trigger("game:waveCompleted",{wave:e,bonus:t})),this.onSocket("game:levelUp",e=>this.trigger("game:levelUp",e)),this.onSocket("game:over",e=>this.trigger("game:over",e)))}onSocket(e,t){this.socket&&this.socket.on(e,(...s)=>t(...s))}on(e,t){this.eventHandlers.has(e)||this.eventHandlers.set(e,[]),this.eventHandlers.get(e).push(t)}off(e,t){const s=this.eventHandlers.get(e);if(s){const i=s.indexOf(t);i>-1&&s.splice(i,1)}}trigger(e,t){const s=this.eventHandlers.get(e);s&&s.forEach(i=>i(t))}createRoom(e){return new Promise((t,s)=>{if(!this.socket){s(new Error("Not connected to server"));return}this.socket.emit("room:create",e,i=>{i.success&&i.code?t(i.code):s(new Error(i.error||"Failed to create room"))})})}joinRoom(e,t){return new Promise((s,i)=>{if(!this.socket){i(new Error("Not connected to server"));return}this.socket.emit("room:join",e,t,r=>{r.success?s():i(new Error(r.error||"Failed to join room"))})})}leaveRoom(){this.socket&&(this.socket.emit("room:leave"),this.currentRoom=null,this.isHost=!1)}setReady(e){this.socket&&this.socket.emit("room:ready",e)}startGame(){this.socket&&this.isHost&&this.socket.emit("room:startGame")}saveData(e,t){this.socket&&this.socket.emit("storage:saveData",{key:e,value:t})}loadData(e,t){this.socket&&this.socket.emit("storage:loadData",e,t)}placeTower(e,t,s){this.socket?(console.log(`üì§ Sending tower placement: type=${e}, x=${t}, y=${s}`),this.socket.emit("game:placeTower",{type:e,x:t,y:s})):console.log("‚ùå Cannot place tower: socket not connected")}upgradeTower(e){this.socket&&this.socket.emit("game:upgradeTower",e)}sellTower(e){this.socket&&this.socket.emit("game:sellTower",e)}startWave(){this.socket&&this.socket.emit("game:startWave")}unlockResearch(e){this.socket&&this.socket.emit("game:researchUnlock",e)}isConnected(){return this.connected}getCurrentRoom(){return this.currentRoom}getIsHost(){return this.isHost}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null,this.connected=!1,this.currentRoom=null,this.isHost=!1,this.eventHandlers.clear())}}class oi{scene;networkManager;onStateUpdate;constructor(e,t){this.scene=e,this.networkManager=A.getInstance(),this.onStateUpdate=t,this.setupListeners()}setupListeners(){this.networkManager.on("game:stateUpdate",e=>{this.handleStateUpdate(e)}),this.networkManager.on("game:over",e=>{this.handleGameOver(e)})}handleStateUpdate(e){this.onStateUpdate(e)}handleGameOver(e){console.log(`Game Over! ${e?"Victory!":"Defeat!"}`),this.scene.events.emit("gameOver",e)}cleanup(){this.networkManager.off("game:stateUpdate",this.handleStateUpdate),this.networkManager.off("game:over",this.handleGameOver)}}class ai{networkManager;onTowerPlaced;onTowerUpgraded;onTowerSold;constructor(e,t,s){this.networkManager=A.getInstance(),this.onTowerPlaced=e,this.onTowerUpgraded=t,this.onTowerSold=s,this.setupListeners()}setupListeners(){this.networkManager.on("game:towerPlaced",e=>{this.onTowerPlaced(e)}),this.networkManager.on("game:towerUpgraded",e=>{this.onTowerUpgraded(e.towerId,e.level)}),this.networkManager.on("game:towerSold",e=>{this.onTowerSold(e.towerId,e.refund)})}requestPlaceTower(e,t,s){this.networkManager.placeTower(e,t,s)}requestUpgradeTower(e){this.networkManager.upgradeTower(e)}requestSellTower(e){this.networkManager.sellTower(e)}cleanup(){}}class li{networkManager;onEnemySpawned;onEnemyDied;constructor(e,t){this.networkManager=A.getInstance(),this.onEnemySpawned=e,this.onEnemyDied=t,this.setupListeners()}setupListeners(){this.networkManager.on("game:enemySpawned",e=>{this.onEnemySpawned(e)}),this.networkManager.on("game:enemyDied",e=>{this.onEnemyDied(e.enemyId,e.gold,e.xp)})}cleanup(){}}class hi{networkManager;onWaveStarted;onWaveCompleted;constructor(e,t){this.networkManager=A.getInstance(),this.onWaveStarted=e,this.onWaveCompleted=t,this.setupListeners()}setupListeners(){this.networkManager.on("game:waveStarted",e=>{this.onWaveStarted(e)}),this.networkManager.on("game:waveCompleted",e=>{this.onWaveCompleted(e.wave,e.bonus)}),this.networkManager.on("game:levelUp",e=>{console.log(`Level Up! Now level ${e}`)})}requestStartWave(){this.networkManager.startWave()}cleanup(){}}class ci{networkManager;gameStateSync;towerSync;enemySync;waveSync;isMultiplayer;constructor(e,t){this.networkManager=A.getInstance(),this.isMultiplayer=this.networkManager.isConnected()&&this.networkManager.getCurrentRoom()!==null,this.isMultiplayer&&(this.gameStateSync=new oi(e,t.onStateUpdate),this.towerSync=new ai(t.onTowerPlaced,t.onTowerUpgraded,t.onTowerSold),this.enemySync=new li(t.onEnemySpawned,t.onEnemyDied),this.waveSync=new hi(t.onWaveStarted,t.onWaveCompleted))}isInMultiplayerMode(){return this.isMultiplayer}placeTower(e,t,s){this.isMultiplayer&&this.towerSync&&this.towerSync.requestPlaceTower(e,t,s)}upgradeTower(e){this.isMultiplayer&&this.towerSync&&this.towerSync.requestUpgradeTower(e)}sellTower(e){this.isMultiplayer&&this.towerSync&&this.towerSync.requestSellTower(e)}startWave(){this.isMultiplayer&&this.waveSync&&this.waveSync.requestStartWave()}unlockResearch(e){this.isMultiplayer&&this.networkManager.unlockResearch(e)}cleanup(){this.isMultiplayer&&(this.gameStateSync?.cleanup(),this.towerSync?.cleanup(),this.enemySync?.cleanup(),this.waveSync?.cleanup())}}class di{constructor(e,t,s,i,r,o,a,l){this.scene=e,this.waveManager=t,this.towerManager=s,this.ui=i,this.xpHandler=r,this.onStateUpdate=o,this.onGoldChange=a,this.onGameStarted=l}coordinator;setup(){this.coordinator=new ci(this.scene,{onStateUpdate:e=>this.handleStateUpdate(e),onTowerPlaced:e=>this.handleTowerPlaced(e),onTowerUpgraded:(e,t)=>this.handleTowerUpgraded(e,t),onTowerSold:(e,t)=>this.handleTowerSold(e,t),onEnemySpawned:e=>this.handleEnemySpawned(e),onEnemyDied:(e,t,s)=>this.handleEnemyDied(e,t,s),onWaveStarted:e=>this.handleWaveStarted(e),onWaveCompleted:(e,t)=>this.handleWaveCompleted(e,t)}),this.scene.events.on("gameOver",e=>{e||this.scene.events.emit("triggerGameOver")})}startWave(){this.coordinator?.startWave()}placeTower(e,t,s){console.log(`üéØ Requesting tower placement: ${e} at (${t}, ${s})`),this.coordinator?.placeTower(e,t,s)}upgradeTower(e){console.log(`üîß Requesting tower upgrade: ${e}`),this.coordinator?.upgradeTower(e)}sellTower(e){this.coordinator?.sellTower(e)}handleStateUpdate(e){this.onStateUpdate(e.gold,e.lives),this.ui.updateWave(e.wave),this.ui.updateXP(e.xp,e.playerLevel),this.waveManager.setPlayerLevel(e.playerLevel),this.waveManager.setPlayerCount(e.playerCount)}handleTowerPlaced(e){console.log(`‚úÖ Tower placed by server: ${e.type} at (${e.x}, ${e.y}), level ${e.level}, id=${e.id}`),this.towerManager.addTowerFromServer(e.x,e.y,e.type,e.level,e.id)}handleTowerUpgraded(e,t){console.log(`‚úÖ Tower ${e} upgraded to level ${t} by server`),this.towerManager.upgradeTowerById(e,t)}handleTowerSold(e,t){console.log(`üí∞ Tower ${e} sold for ${t} gold by server`),this.towerManager.sellTowerById(e)}handleEnemySpawned(e){console.log(`Enemy spawned: ${e.type} (${e.id})`)}handleEnemyDied(e,t,s){console.log(`üíÄ Enemy ${e} died. Rewarded: ${t} gold, ${s} xp`),this.onGoldChange(t),this.xpHandler.awardXP(s,this.waveManager)}handleWaveStarted(e){console.log(`Wave ${e} started`),this.onGameStarted(),this.ui.hideStartButton(),this.ui.updateWave(e),this.waveManager.resetWaveComplete(),this.waveManager.startWave()}handleWaveCompleted(e,t){console.log(`üéâ Wave ${e} completed. Bonus: ${t} gold`),this.onGoldChange(t);const s=(20+e*5)*2;this.xpHandler.awardXP(s,this.waveManager),this.waveManager.markWaveComplete(),this.ui.showStartButton()}}class ui{constructor(e){this.scene=e}show(e,t){const s=this.scene.cameras.main.width,i=this.scene.cameras.main.height;this.scene.add.rectangle(0,0,s,i,0,.7).setOrigin(0),this.scene.add.text(s/2,i/2-50,"Game Over",{font:"bold 64px Arial",color:"#ff0000"}).setOrigin(.5),this.scene.add.text(s/2,i/2+20,`Du hast Welle ${e} erreicht!`,{font:"32px Arial",color:"#ffffff"}).setOrigin(.5);const a=this.scene.add.text(s/2,i/2+100,"Neustart",{font:"28px Arial",color:"#ffffff",backgroundColor:"#333333",padding:{x:20,y:10}});a.setOrigin(.5),a.setInteractive({useHandCursor:!0}),a.on("pointerover",()=>{a.setStyle({backgroundColor:"#555555"})}),a.on("pointerout",()=>{a.setStyle({backgroundColor:"#333333"})}),a.on("pointerdown",l=>{l.event.stopPropagation(),t()})}}class fi extends Phaser.Scene{ui;waveManager;towerManager;mapManager;researchManager;projectileManager;notifications;xpHandler;waveHandler;towerHandler;multiplayerHandler;gameOverScreen;gameStarted=!1;isReady=!1;gold=0;lives=0;isPaused=!1;autoWaveEnabled=!1;autoWaveTimer;config=m.getInstance().getConfig();levelType="classic";isMultiplayer=!1;roomCode;constructor(){super({key:"GameScene"})}init(e){const t=Re.getSettings(),s=this.config.game;if(this.isMultiplayer=e.multiplayer||!1,this.roomCode=e.roomCode,this.levelType=e.levelType||"classic",this.gold=s.startGold,this.lives=s.startLives,!this.isMultiplayer)switch(t.difficulty){case"easy":this.gold=s.startGold*2,this.lives=Math.round(s.startLives*1.5);break;case"normal":this.gold=s.startGold,this.lives=s.startLives;break;case"hard":this.gold=Math.round(s.startGold*.75),this.lives=Math.round(s.startLives*.75);break}this.gameStarted=!1,this.isReady=!1}async create(){this.mapManager=new Fe(this,this.levelType);try{await this.mapManager.loadMap(),this.mapManager.create()}catch(e){console.error("Failed to load map:",e),this.mapManager=new Fe(this,"classic"),await this.mapManager.loadMap(),this.mapManager.create()}this.waveManager=new Zt(this,this.mapManager.getPath(),this.levelType),this.towerManager=new os(this,this.mapManager.getPath()),this.researchManager=new as,this.projectileManager=new ls,this.notifications=new hs(this),this.gameOverScreen=new ui(this),this.ui=new qt(this,this.gold,this.lives,this.researchManager),this.xpHandler=new cs(this.researchManager,this.ui,(e,t)=>{this.notifications.showLevelUp(e),t.forEach(s=>{this.notifications.showResearchUnlocked(s)}),this.ui.showResearchButtonPulse()}),this.waveHandler=new ds(this.waveManager,this.xpHandler,e=>this.changeGold(e),()=>this.handleLifeLost(),()=>this.checkResearchAvailability()),this.towerHandler=new us(this.towerManager,this.ui,e=>this.changeGold(e),(e,t)=>{e==="upgrade"?this.notifications.showTowerUpgrade():e==="sell"&&t&&this.notifications.showTowerSold(t)}),this.isMultiplayer&&(this.multiplayerHandler=new di(this,this.waveManager,this.towerManager,this.ui,this.xpHandler,(e,t)=>{this.gold=e,this.lives=t,this.ui.updateGold(e),this.ui.updateLives(t)},e=>{this.gold+=e,this.ui.updateGold(this.gold)},()=>{this.gameStarted=!0}),this.multiplayerHandler.setup(),this.events.on("triggerGameOver",()=>this.gameOver())),this.ui.create(()=>this.handleStartWave(),(e,t)=>this.handleTowerSelect(e,t),()=>this.handlePauseToggle(),()=>this.handleAutoWaveToggle(),()=>this.handleResearchToggle(),()=>this.handleUpgradeTower(),()=>this.handleSellTower()),this.isMultiplayer&&this.roomCode&&this.ui.showRoomCode(this.roomCode),this.checkAndShowResearchNotification(),this.input.on("pointerdown",e=>{this.handlePointerDown(e)}),this.input.on("pointermove",e=>{this.towerManager.updatePreview(e)}),this.isReady=!0}update(e,t){if(!this.isReady||this.isPaused)return;const s=this.towerManager.getSelectedTower();this.ui.updateUpgradeButton(s),this.waveManager.update(t,(r,o)=>this.waveHandler.handleEnemyKilled(r,o),()=>this.waveHandler.handleEnemyEscaped(),r=>this.waveHandler.handleWaveCompleted(r)),this.towerManager.update(e,this.waveManager.getEnemies()).forEach(r=>this.projectileManager.addProjectile(r)),this.projectileManager.update(t),this.waveManager.isWaveComplete()&&this.gameStarted&&(this.autoWaveEnabled?this.autoWaveTimer||(this.autoWaveTimer=this.time.delayedCall(5e3,()=>{this.handleStartWave(),this.autoWaveTimer=void 0})):this.ui.showStartButton("N√§chste Welle"))}handleStartWave(){if(this.isMultiplayer&&this.multiplayerHandler){this.multiplayerHandler.startWave();return}this.waveManager.isSpawningEnemies()||(this.gameStarted||(this.gameStarted=!0),this.autoWaveTimer&&(this.autoWaveTimer.destroy(),this.autoWaveTimer=void 0),this.waveManager.resetWaveComplete(),this.ui.hideStartButton(),this.waveManager.startWave(),this.ui.updateWave(this.waveManager.getWave()))}handleTowerSelect(e,t){this.towerHandler.selectTower(e,t)}handleUpgradeTower(){if(this.isMultiplayer&&this.multiplayerHandler){const e=this.towerHandler.getSelectedTower();if(e){const t=e.id;if(!t){console.error("‚ùå Selected tower has no ID! Cannot upgrade in multiplayer.");return}console.log(`üéØ Upgrade button clicked for tower: ${t}`),this.multiplayerHandler.upgradeTower(t)}else console.error("‚ùå No tower selected for upgrade");return}this.towerHandler.tryUpgradeTower(this.gold)}handleSellTower(){if(this.isMultiplayer&&this.multiplayerHandler){const e=this.towerHandler.getSelectedTower();if(e){const t=e.id||"unknown";this.multiplayerHandler.sellTower(t)}return}this.towerHandler.trySellTower()}handlePauseToggle(){this.isPaused=!this.isPaused,this.isPaused?this.physics.pause():this.physics.resume(),this.ui.setPaused(this.isPaused)}handleAutoWaveToggle(){this.autoWaveEnabled=!this.autoWaveEnabled,this.ui.setAutoWave(this.autoWaveEnabled),this.autoWaveEnabled&&this.waveManager.isWaveComplete()&&!this.autoWaveTimer&&(this.autoWaveTimer=this.time.delayedCall(5e3,()=>{this.handleStartWave(),this.autoWaveTimer=void 0})),!this.autoWaveEnabled&&this.autoWaveTimer&&(this.autoWaveTimer.destroy(),this.autoWaveTimer=void 0,this.ui.showStartButton("N√§chste Welle"))}handleResearchToggle(){this.ui.toggleResearchOverlay()}changeGold(e){this.gold+=e,this.ui.updateGold(this.gold)}handleLifeLost(){this.lives--,this.ui.updateLives(this.lives),this.lives<=0&&this.gameOver()}checkAndShowResearchNotification(){this.xpHandler.checkAvailableResearches(this.gold)&&this.ui.showResearchButtonPulse()}checkResearchAvailability(){this.xpHandler.checkAvailableResearches(this.gold)&&this.ui.showResearchButtonPulse()}handlePointerDown(e){if(!this.ui.getButtons().some(i=>i.visible?i.getBounds().contains(e.x,e.y):!1)){if(this.isMultiplayer&&this.multiplayerHandler){const i=this.towerManager.getSelectedType();i&&(console.log(`üéØ Requesting tower placement: ${i} at (${e.x}, ${e.y})`),this.multiplayerHandler.placeTower(i,e.x,e.y),this.towerHandler.deselectTower());return}this.towerHandler.tryPlaceTower(e.x,e.y,this.gold)}}gameOver(){this.physics.pause(),this.waveManager.cleanup(),this.towerManager.cleanup(),this.time.removeAllEvents(),this.input.off("pointerdown"),this.input.off("pointermove"),this.gameOverScreen.show(this.waveManager.getWave(),()=>this.scene.restart())}}class pi{constructor(e){this.scene=e}playerListText=null;show(e,t,s,i,r,o,a){const h=this.scene.add.graphics();h.fillStyle(2899536,1),h.fillRoundedRect(e-300,130,600,100,10),h.lineStyle(3,2600544,1),h.strokeRoundedRect(e-300,130,600,100,10),this.scene.add.text(e,155,"Raum-Code:",{fontSize:"20px",color:"#bdc3c7"}).setOrigin(.5),this.scene.add.text(e,190,t,{fontSize:"36px",color:"#27ae60",fontStyle:"bold"}).setOrigin(.5);const c=260,d=this.scene.add.graphics();d.fillStyle(2899536,1),d.fillRoundedRect(e-300,c,600,220,10),d.lineStyle(2,3426654,1),d.strokeRoundedRect(e-300,c,600,220,10),this.scene.add.text(e,c+25,"üë• Spieler",{fontSize:"24px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.playerListText=this.scene.add.text(e,c+70,"Lade Spielerliste...",{fontSize:"20px",color:"#ecf0f1",align:"center",lineSpacing:12}).setOrigin(.5,0);const u=520,f=s?e-160:e,p=this.scene.add.text(f,u,i?"‚úì Bereit":"Bereit?",{fontSize:"24px",color:"#ffffff",backgroundColor:i?"#27ae60":"#95a5a6",padding:{x:35,y:15}}).setOrigin(.5).setInteractive();if(p.on("pointerdown",r),p.on("pointerover",()=>{p.setBackgroundColor(i?"#229954":"#7f8c8d")}),p.on("pointerout",()=>{p.setBackgroundColor(i?"#27ae60":"#95a5a6")}),s){const x=this.scene.add.text(e+160,u,"Starten",{fontSize:"24px",color:"#ffffff",backgroundColor:"#f39c12",padding:{x:35,y:15}}).setOrigin(.5).setInteractive();x.on("pointerdown",o),x.on("pointerover",()=>x.setBackgroundColor("#e67e22")),x.on("pointerout",()=>x.setBackgroundColor("#f39c12"))}const C=this.scene.add.text(e,u+80,"‚Üê Verlassen",{fontSize:"20px",color:"#ffffff",backgroundColor:"#e74c3c",padding:{x:30,y:12}}).setOrigin(.5).setInteractive();return C.on("pointerdown",a),C.on("pointerover",()=>C.setBackgroundColor("#c0392b")),C.on("pointerout",()=>C.setBackgroundColor("#e74c3c")),{playerListText:this.playerListText,readyButton:p}}updatePlayerList(e){if(!this.playerListText)return;if(e.size===0){this.playerListText.setText("Keine Spieler im Raum");return}const t=Array.from(e.values()).map(s=>{const i=s.ready?"‚úì":"‚óã",r=s.isHost?" üëë":"";return`${i} ${s.name}${r}`}).join(`
`);this.playerListText.setText(t)}}class se{static create(e,t,s,i,r){const o=document.createElement("input");return o.type="text",o.placeholder=r,o.autocomplete="on",o.style.position="absolute",o.style.left=`${e}px`,o.style.top=`${t}px`,o.style.width=`${s}px`,o.style.height=`${i}px`,o.style.fontSize="18px",o.style.padding="10px 15px",o.style.border="2px solid #3498db",o.style.borderRadius="8px",o.style.backgroundColor="#34495e",o.style.color="#ecf0f1",o.style.boxSizing="border-box",o.style.textAlign="center",o.style.fontFamily="Arial, sans-serif",o.style.outline="none",o.style.transition="all 0.3s",o.addEventListener("focus",()=>{o.style.border="2px solid #3498db",o.style.backgroundColor="#2c3e50"}),o.addEventListener("blur",()=>{o.style.border="2px solid #3498db",o.style.backgroundColor="#34495e"}),document.body.appendChild(o),o}static removeAll(e){e.forEach(t=>{t&&t.parentNode&&t.parentNode.removeChild(t)})}}class gi{constructor(e){this.scene=e}playerNameInput=null;show(e,t,s){const i=this.scene.add.graphics();i.fillStyle(2899536,1),i.fillRoundedRect(e-250,t,500,200,10),i.lineStyle(2,3426654,1),i.strokeRoundedRect(e-250,t,500,200,10),this.scene.add.text(e,t+25,"üéÆ Neuen Raum Erstellen",{fontSize:"26px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.scene.add.text(e,t+50,"Spielername:",{fontSize:"18px",color:"#ecf0f1"}).setOrigin(.5),this.playerNameInput=se.create(e-120,t+140,440,45,"Dein Name");const r=B.getInstance().getLocal("playerName");r&&(this.playerNameInput.value=r);const o=this.scene.add.text(e,t+160,"Raum Erstellen",{fontSize:"22px",color:"#ffffff",backgroundColor:"#27ae60",padding:{x:40,y:12}}).setOrigin(.5).setInteractive();return o.on("pointerdown",()=>{const a=this.playerNameInput?.value.trim()||"";s(a)}),o.on("pointerover",()=>o.setBackgroundColor("#229954")),o.on("pointerout",()=>o.setBackgroundColor("#27ae60")),this.playerNameInput}cleanup(){this.playerNameInput&&(se.removeAll([this.playerNameInput]),this.playerNameInput=null)}}class mi{constructor(e){this.scene=e}playerNameInput=null;roomCodeInput=null;show(e,t,s){const i=this.scene.add.graphics();i.fillStyle(2899536,1),i.fillRoundedRect(e-250,t,500,240,10),i.lineStyle(2,3426654,1),i.strokeRoundedRect(e-250,t,500,240,10),this.scene.add.text(e,t+25,"üö™ Raum Beitreten",{fontSize:"26px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.scene.add.text(e,t+60,"Spielername:",{fontSize:"18px",color:"#ecf0f1"}).setOrigin(.5),this.playerNameInput=se.create(e-120,t+160,440,45,"Dein Name");const r=B.getInstance().getLocal("playerName");r&&(this.playerNameInput.value=r),this.scene.add.text(e,t+100,"Raum-Code: (z.B. bear-lamp)",{fontSize:"18px",color:"#ecf0f1"}).setOrigin(.5),this.roomCodeInput=se.create(e-110,t+260,440,45,"Raum-Code eingeben");const o=this.scene.add.text(e,t+200,"Beitreten",{fontSize:"22px",color:"#ffffff",backgroundColor:"#3498db",padding:{x:40,y:12}}).setOrigin(.5).setInteractive();return o.on("pointerdown",()=>{const a=this.playerNameInput?.value.trim()||"",l=this.roomCodeInput?.value.trim().toLowerCase()||"";s(a,l)}),o.on("pointerover",()=>o.setBackgroundColor("#2980b9")),o.on("pointerout",()=>o.setBackgroundColor("#3498db")),{playerNameInput:this.playerNameInput,roomCodeInput:this.roomCodeInput}}cleanup(){const e=[];this.playerNameInput&&e.push(this.playerNameInput),this.roomCodeInput&&e.push(this.roomCodeInput),e.length>0&&se.removeAll(e),this.playerNameInput=null,this.roomCodeInput=null}}class yi{constructor(e,t,s,i,r,o,a,l){this.networkManager=e,this.onRoomJoined=t,this.onPlayerJoined=s,this.onPlayerReady=i,this.onPlayerLeft=r,this.onGameStarted=o,this.onError=a,this.onDisconnect=l}setup(){this.networkManager.on("room:joined",e=>{this.onRoomJoined(e.code,e.players)}),this.networkManager.on("room:playerJoined",e=>{this.onPlayerJoined(e)}),this.networkManager.on("room:playerReady",e=>{this.onPlayerReady(e.playerId,e.isReady,e.name)}),this.networkManager.on("room:playerLeft",e=>{this.onPlayerLeft(e,"Spieler")}),this.networkManager.on("room:error",e=>{this.onError(e)}),this.networkManager.on("game:started",()=>{this.onGameStarted(this.networkManager.getCurrentRoom()||"")}),this.networkManager.on("disconnect",()=>{this.onDisconnect()})}}class wi{constructor(e,t,s,i){this.networkManager=e,this.onSuccess=t,this.onError=s,this.onLoading=i}async createRoom(e){if(!this.validatePlayerName(e))return null;B.getInstance().setLocal("playerName",e),this.onLoading("Erstelle Raum...");try{const t=await this.networkManager.createRoom(e);return this.onSuccess(`Raum erstellt: ${t}`),t}catch(t){return this.onError(`Fehler: ${t.message}`),null}}async joinRoom(e,t){if(!this.validatePlayerName(e)||!this.validateRoomCode(t))return!1;B.getInstance().setLocal("playerName",e),this.onLoading("Trete Raum bei...");try{return await this.networkManager.joinRoom(t,e),this.onSuccess(`Raum beigetreten: ${t}`),!0}catch(s){return this.onError(`Fehler: ${s.message}`),!1}}leaveRoom(){this.networkManager.leaveRoom()}setReady(e){this.networkManager.setReady(e)}startGame(){return console.log("Starting game..."),this.networkManager.startGame(),!0}validateGameStart(e){const t=Array.from(e.values()),s=t.every(i=>i.isReady||i.isHost);return console.log("Players:",t.map(i=>({name:i.name,isHost:i.isHost,isReady:i.isReady}))),console.log("All ready?",s),s?e.size<1?{canStart:!1,message:"Mindestens 1 Spieler ben√∂tigt!"}:{canStart:!0}:{canStart:!1,message:"Nicht alle Spieler sind bereit!"}}validatePlayerName(e){return e?e.length<2||e.length>20?(this.onError("Name muss 2-20 Zeichen lang sein!"),!1):!0:(this.onError("Bitte gib einen Namen ein!"),!1)}validateRoomCode(e){return e?/^[a-z]{2,4}-[a-z]{2,4}$/.test(e)?!0:(this.onError("Raum-Code Format: wort-wort (z.B. bear-lamp)"),!1):(this.onError("Bitte gib einen Raum-Code ein!"),!1)}}class Si extends te.Scene{networkManager;config;roomLobbyUI;roomCreationUI;roomJoinUI;networkEventSetup;roomActionHandler;statusText=null;readyButton=null;players=new Map;isReady=!1;currentRoomCode=null;constructor(){super({key:"MultiplayerScene"}),this.networkManager=A.getInstance()}init(){this.cleanupComponents()}create(){this.config=m.getInstance().getConfig();const e=this.cameras.main.centerX;this.add.text(e,50,"Multiplayer Lobby",{fontSize:"48px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.networkManager.isConnected()?this.showLobbyUI():this.connectToServer()}async connectToServer(){const e=this.cameras.main.centerX,t=this.cameras.main.centerY,s=this.add.text(e,t,"Verbinde mit Server...",{fontSize:"24px",color:"#ffff00"}).setOrigin(.5);try{const i=`http://localhost:${this.config.multiplayer.serverPort}`;await this.networkManager.connect(i),s.destroy(),this.showLobbyUI()}catch{s.setText(`‚ùå Server nicht erreichbar!

Starte Server mit: pnpm server`),s.setColor("#ff0000");const r=this.add.text(e,t+100,"< Zur√ºck zum Men√º",{fontSize:"24px",color:"#ffffff",backgroundColor:"#333333",padding:{x:20,y:10}}).setOrigin(.5).setInteractive();r.on("pointerdown",()=>{this.cleanupComponents(),this.scene.start("MainMenuScene")}),r.on("pointerover",()=>{r.setBackgroundColor("#555555")}),r.on("pointerout",()=>{r.setBackgroundColor("#333333")})}}showLobbyUI(){const e=this.cameras.main.width,t=this.cameras.main.height,s=e/2;if(this.networkManager.getCurrentRoom()){this.showRoomUI();return}this.roomActionHandler=new wi(this.networkManager,r=>this.showStatus(r,"#2ecc71"),r=>this.showStatus(r,"#e74c3c"),r=>this.showStatus(r,"#ffff00"));const i=this.add.text(30,30,"‚óÄ Zur√ºck",{fontSize:"20px",color:"#ffffff",backgroundColor:"#333333",padding:{x:15,y:10}}).setInteractive();i.on("pointerdown",()=>{this.networkManager.disconnect(),this.scene.start("MainMenuScene")}),i.on("pointerover",()=>i.setBackgroundColor("#555555")),i.on("pointerout",()=>i.setBackgroundColor("#333333")),this.roomCreationUI=new gi(this),this.roomCreationUI.show(s,150,async r=>{const o=await this.roomActionHandler.createRoom(r);o&&(this.currentRoomCode=o)}),this.add.text(s,380,"oder",{fontSize:"18px",color:"#7f8c8d",fontStyle:"italic"}).setOrigin(.5),this.roomJoinUI=new mi(this),this.roomJoinUI.show(s,420,async(r,o)=>{await this.roomActionHandler.joinRoom(r,o)&&(this.currentRoomCode=o)}),this.statusText=this.add.text(s,t-40,"",{fontSize:"18px",color:"#e74c3c",align:"center",fontStyle:"bold"}).setOrigin(.5),this.setupNetworkListeners()}showRoomUI(){this.cleanupComponents(),this.children.removeAll();const e=this.cameras.main.width,t=this.cameras.main.height,s=e/2;this.add.text(s,50,"Multiplayer Lobby",{fontSize:"48px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.roomLobbyUI=new pi(this);const{readyButton:i}=this.roomLobbyUI.show(s,this.currentRoomCode||"",this.networkManager.getIsHost(),this.isReady,()=>this.toggleReady(),()=>this.handleStartGame(),()=>this.handleLeaveRoom());this.readyButton=i,this.statusText=this.add.text(s,t-40,"",{fontSize:"18px",color:"#e74c3c",align:"center",fontStyle:"bold"}).setOrigin(.5),this.updatePlayerList()}setupNetworkListeners(){this.networkEventSetup=new yi(this.networkManager,(e,t)=>{this.currentRoomCode=e,this.players.clear(),t.forEach(s=>{this.players.set(s.id,s)}),this.showRoomUI()},e=>{this.players.set(e.id,e),this.updatePlayerList(),this.showStatus(`${e.name} ist beigetreten!`,"#2ecc71")},(e,t,s)=>{const i=this.players.get(e);i&&(i.isReady=t,this.updatePlayerList(),console.log(`Player ${s} ready status: ${t}`))},(e,t)=>{this.players.delete(e),this.updatePlayerList(),this.showStatus(`${t} hat den Raum verlassen.`,"#e74c3c")},e=>{this.showStatus("Spiel startet...","#2ecc71"),this.time.delayedCall(1e3,()=>{this.cleanupComponents(),this.scene.start("GameScene",{multiplayer:!0,roomCode:this.currentRoomCode})})},e=>{this.showStatus(`Fehler: ${e}`,"#e74c3c")},()=>{this.showStatus("Verbindung zum Server verloren!","#e74c3c"),this.time.delayedCall(3e3,()=>{this.cleanupComponents(),this.scene.start("MainMenuScene")})}),this.networkEventSetup.setup()}handleLeaveRoom(){this.roomActionHandler?.leaveRoom(),this.players.clear(),this.currentRoomCode=null,this.isReady=!1,this.cleanupComponents(),this.children.removeAll(),this.create()}toggleReady(){this.isReady=!this.isReady,console.log("Toggle ready:",this.isReady),this.roomActionHandler?.setReady(this.isReady),this.readyButton&&(this.readyButton.setText(this.isReady?"‚úì Bereit":"Bereit?"),this.readyButton.setBackgroundColor(this.isReady?"#27ae60":"#95a5a6"))}handleStartGame(){if(!this.roomActionHandler)return;const e=this.roomActionHandler.validateGameStart(this.players);if(!e.canStart){this.showStatus(e.message,"#e74c3c");return}this.roomActionHandler.startGame()}updatePlayerList(){this.roomLobbyUI&&this.roomLobbyUI.updatePlayerList(this.players)}showStatus(e,t){this.statusText&&(this.statusText.setText(e),this.statusText.setColor(t))}cleanupComponents(){this.roomCreationUI&&(this.roomCreationUI.cleanup(),this.roomCreationUI=void 0),this.roomJoinUI&&(this.roomJoinUI.cleanup(),this.roomJoinUI=void 0),this.roomLobbyUI=void 0}shutdown(){this.cleanupComponents()}}const vi={type:te.AUTO,parent:"game-container",backgroundColor:"#2d2d2d",scale:{mode:te.Scale.FIT,autoCenter:te.Scale.CENTER_BOTH,width:1280,height:720},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scene:[Bt,_t,Dt,fi,Re,Si]};async function Ke(){try{await m.getInstance().load(),new te.Game(vi)}catch(n){console.error("Failed to initialize game:",n),document.body.innerHTML='<div style="color: white; text-align: center; padding: 50px;">Failed to load game configuration. Please refresh the page.</div>'}}ie.isNativePlatform()?document.addEventListener("deviceready",()=>{Ke()}):window.addEventListener("load",()=>{Ke()});
