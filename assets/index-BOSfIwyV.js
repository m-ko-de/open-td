import{r as Yi,g as Ki}from"./phaser-DFK5Ua9d.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();var Zi=Yi();const et=Ki(Zi);const Ji=o=>{const e=new Map;e.set("web",{name:"web"});const t=o.CapacitorPlatforms||{currentPlatform:{name:"web"},platforms:e},s=(r,n)=>{t.platforms.set(r,n)},i=r=>{t.platforms.has(r)&&(t.currentPlatform=t.platforms.get(r))};return t.addPlatform=s,t.setPlatform=i,t},Qi=o=>o.CapacitorPlatforms=Ji(o),fi=Qi(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{});fi.addPlatform;fi.setPlatform;var Ne;(function(o){o.Unimplemented="UNIMPLEMENTED",o.Unavailable="UNAVAILABLE"})(Ne||(Ne={}));class qt extends Error{constructor(e,t,s){super(e),this.message=e,this.code=t,this.data=s}}const zi=o=>{var e,t;return o?.androidBridge?"android":!((t=(e=o?.webkit)===null||e===void 0?void 0:e.messageHandlers)===null||t===void 0)&&t.bridge?"ios":"web"},er=o=>{var e,t,s,i,r;const n=o.CapacitorCustomPlatform||null,a=o.Capacitor||{},l=a.Plugins=a.Plugins||{},h=o.CapacitorPlatforms,d=()=>n!==null?n.name:zi(o),u=((e=h?.currentPlatform)===null||e===void 0?void 0:e.getPlatform)||d,f=()=>u()!=="web",p=((t=h?.currentPlatform)===null||t===void 0?void 0:t.isNativePlatform)||f,w=_=>{const U=b.get(_);return!!(U?.platforms.has(u())||v(_))},C=((s=h?.currentPlatform)===null||s===void 0?void 0:s.isPluginAvailable)||w,I=_=>{var U;return(U=a.PluginHeaders)===null||U===void 0?void 0:U.find(H=>H.name===_)},v=((i=h?.currentPlatform)===null||i===void 0?void 0:i.getPluginHeader)||I,k=_=>o.console.error(_),O=(_,U,H)=>Promise.reject(`${H} does not have an implementation of "${U}".`),b=new Map,D=(_,U={})=>{const H=b.get(_);if(H)return console.warn(`Capacitor plugin "${_}" already registered. Cannot register plugins twice.`),H.proxy;const z=u(),W=v(_);let ee;const We=async()=>(!ee&&z in U?ee=typeof U[z]=="function"?ee=await U[z]():ee=U[z]:n!==null&&!ee&&"web"in U&&(ee=typeof U.web=="function"?ee=await U.web():ee=U.web),ee),Fe=(q,P)=>{var te,N;if(W){const ne=W?.methods.find(M=>P===M.name);if(ne)return ne.rtype==="promise"?M=>a.nativePromise(_,P.toString(),M):(M,ce)=>a.nativeCallback(_,P.toString(),M,ce);if(q)return(te=q[P])===null||te===void 0?void 0:te.bind(q)}else{if(q)return(N=q[P])===null||N===void 0?void 0:N.bind(q);throw new qt(`"${_}" plugin is not implemented on ${z}`,Ne.Unimplemented)}},Ge=q=>{let P;const te=(...N)=>{const ne=We().then(M=>{const ce=Fe(M,q);if(ce){const Se=ce(...N);return P=Se?.remove,Se}else throw new qt(`"${_}.${q}()" is not implemented on ${z}`,Ne.Unimplemented)});return q==="addListener"&&(ne.remove=async()=>P()),ne};return te.toString=()=>`${q.toString()}() { [capacitor code] }`,Object.defineProperty(te,"name",{value:q,writable:!1,configurable:!1}),te},nt=Ge("addListener"),ot=Ge("removeListener"),at=(q,P)=>{const te=nt({eventName:q},P),N=async()=>{const M=await te;ot({eventName:q,callbackId:M},P)},ne=new Promise(M=>te.then(()=>M({remove:N})));return ne.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await N()},ne},qe=new Proxy({},{get(q,P){switch(P){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return W?at:nt;case"removeListener":return ot;default:return Ge(P)}}});return l[_]=qe,b.set(_,{name:_,proxy:qe,platforms:new Set([...Object.keys(U),...W?[z]:[]])}),qe},A=((r=h?.currentPlatform)===null||r===void 0?void 0:r.registerPlugin)||D;return a.convertFileSrc||(a.convertFileSrc=_=>_),a.getPlatform=u,a.handleError=k,a.isNativePlatform=p,a.isPluginAvailable=C,a.pluginMethodNoop=O,a.registerPlugin=A,a.Exception=qt,a.DEBUG=!!a.DEBUG,a.isLoggingEnabled=!!a.isLoggingEnabled,a.platform=a.getPlatform(),a.isNative=a.isNativePlatform(),a},tr=o=>o.Capacitor=er(o),it=tr(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),gi=it.registerPlugin;it.Plugins;class mi{constructor(e){this.listeners={},this.windowListeners={},e&&(console.warn(`Capacitor WebPlugin "${e.name}" config object was deprecated in v3 and will be removed in v4.`),this.config=e)}addListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t);const i=this.windowListeners[e];i&&!i.registered&&this.addWindowListener(i);const r=async()=>this.removeListener(e,t),n=Promise.resolve({remove:r});return Object.defineProperty(n,"remove",{value:async()=>{console.warn("Using addListener() without 'await' is deprecated."),await r()}}),n}async removeAllListeners(){this.listeners={};for(const e in this.windowListeners)this.removeWindowListener(this.windowListeners[e]);this.windowListeners={}}notifyListeners(e,t){const s=this.listeners[e];s&&s.forEach(i=>i(t))}hasListeners(e){return!!this.listeners[e].length}registerWindowListener(e,t){this.windowListeners[t]={registered:!1,windowEventName:e,pluginEventName:t,handler:s=>{this.notifyListeners(t,s)}}}unimplemented(e="not implemented"){return new it.Exception(e,Ne.Unimplemented)}unavailable(e="not available"){return new it.Exception(e,Ne.Unavailable)}async removeListener(e,t){const s=this.listeners[e];if(!s)return;const i=s.indexOf(t);this.listeners[e].splice(i,1),this.listeners[e].length||this.removeWindowListener(this.windowListeners[e])}addWindowListener(e){window.addEventListener(e.windowEventName,e.handler),e.registered=!0}removeWindowListener(e){e&&(window.removeEventListener(e.windowEventName,e.handler),e.registered=!1)}}const Ws=o=>encodeURIComponent(o).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),Fs=o=>o.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class sr extends mi{async getCookies(){const e=document.cookie,t={};return e.split(";").forEach(s=>{if(s.length<=0)return;let[i,r]=s.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");i=Fs(i).trim(),r=Fs(r).trim(),t[i]=r}),t}async setCookie(e){try{const t=Ws(e.key),s=Ws(e.value),i=`; expires=${(e.expires||"").replace("expires=","")}`,r=(e.path||"/").replace("path=",""),n=e.url!=null&&e.url.length>0?`domain=${e.url}`:"";document.cookie=`${t}=${s||""}${i}; path=${r}; ${n};`}catch(t){return Promise.reject(t)}}async deleteCookie(e){try{document.cookie=`${e.key}=; Max-Age=0`}catch(t){return Promise.reject(t)}}async clearCookies(){try{const e=document.cookie.split(";")||[];for(const t of e)document.cookie=t.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(e){return Promise.reject(e)}}async clearAllCookies(){try{await this.clearCookies()}catch(e){return Promise.reject(e)}}}gi("CapacitorCookies",{web:()=>new sr});const ir=async o=>new Promise((e,t)=>{const s=new FileReader;s.onload=()=>{const i=s.result;e(i.indexOf(",")>=0?i.split(",")[1]:i)},s.onerror=i=>t(i),s.readAsDataURL(o)}),rr=(o={})=>{const e=Object.keys(o);return Object.keys(o).map(i=>i.toLocaleLowerCase()).reduce((i,r,n)=>(i[r]=o[e[n]],i),{})},nr=(o,e=!0)=>o?Object.entries(o).reduce((s,i)=>{const[r,n]=i;let a,l;return Array.isArray(n)?(l="",n.forEach(h=>{a=e?encodeURIComponent(h):h,l+=`${r}=${a}&`}),l.slice(0,-1)):(a=e?encodeURIComponent(n):n,l=`${r}=${a}`),`${s}&${l}`},"").substr(1):null,or=(o,e={})=>{const t=Object.assign({method:o.method||"GET",headers:o.headers},e),i=rr(o.headers)["content-type"]||"";if(typeof o.data=="string")t.body=o.data;else if(i.includes("application/x-www-form-urlencoded")){const r=new URLSearchParams;for(const[n,a]of Object.entries(o.data||{}))r.set(n,a);t.body=r.toString()}else if(i.includes("multipart/form-data")||o.data instanceof FormData){const r=new FormData;if(o.data instanceof FormData)o.data.forEach((a,l)=>{r.append(l,a)});else for(const a of Object.keys(o.data))r.append(a,o.data[a]);t.body=r;const n=new Headers(t.headers);n.delete("content-type"),t.headers=n}else(i.includes("application/json")||typeof o.data=="object")&&(t.body=JSON.stringify(o.data));return t};class ar extends mi{async request(e){const t=or(e,e.webFetchExtra),s=nr(e.params,e.shouldEncodeUrlParams),i=s?`${e.url}?${s}`:e.url,r=await fetch(i,t),n=r.headers.get("content-type")||"";let{responseType:a="text"}=r.ok?e:{};n.includes("application/json")&&(a="json");let l,h;switch(a){case"arraybuffer":case"blob":h=await r.blob(),l=await ir(h);break;case"json":l=await r.json();break;case"document":case"text":default:l=await r.text()}const d={};return r.headers.forEach((u,f)=>{d[f]=u}),{data:l,headers:d,status:r.status,url:r.url}}async get(e){return this.request(Object.assign(Object.assign({},e),{method:"GET"}))}async post(e){return this.request(Object.assign(Object.assign({},e),{method:"POST"}))}async put(e){return this.request(Object.assign(Object.assign({},e),{method:"PUT"}))}async patch(e){return this.request(Object.assign(Object.assign({},e),{method:"PATCH"}))}async delete(e){return this.request(Object.assign(Object.assign({},e),{method:"DELETE"}))}}gi("CapacitorHttp",{web:()=>new ar});class ve{static instance;maps=new Map;constructor(){}static getInstance(){return ve.instance||(ve.instance=new ve),ve.instance}async loadAllMaps(){let e=[];try{const s=await fetch("maps/index.json");s.ok?(e=(await s.json()).maps||[],console.log(`Found ${e.length} maps in index`)):(console.warn("maps/index.json not found, using fallback list"),e=["classic","spiral","zigzag"])}catch(s){console.error("Error loading maps index:",s),e=["classic","spiral","zigzag"]}const t=e.map(async s=>{try{const i=await fetch(`maps/${s}.json`);if(!i.ok){console.warn(`Failed to load map: ${s}`);return}const r=await i.json();this.maps.set(s,r),console.log(`Loaded map: ${s}`)}catch(i){console.error(`Error loading map ${s}:`,i)}});await Promise.all(t)}getMap(e){return this.maps.get(e)}getAllMaps(){return Array.from(this.maps.entries()).map(([e,t])=>({id:e,config:t}))}hasMap(e){return this.maps.has(e)}getMapCount(){return this.maps.size}}function tt(o){let e;try{e="./"}catch{e=void 0}e||(typeof document<"u"&&document.baseURI?e=document.baseURI:typeof window<"u"&&window.location?e=window.location.href:e="/");try{const t=new URL(e),s=t.pathname||"",i=s.split("/").filter(Boolean),r=i.length?i[i.length-1]:"";!s.endsWith("/")&&r&&!r.includes(".")&&(t.pathname=s+"/");const n=new URL(".",t.toString()).toString();return new URL(o,n).toString()}catch{return typeof e=="string"?e.endsWith("/")?e+o:e+"/"+o:o}}class E{static instance;config;loaded=!1;constructor(){}static getInstance(){return E.instance||(E.instance=new E),E.instance}async load(){if(!this.loaded)try{const e=tt("config.json"),t=await fetch(e);if(!t.ok)throw new Error(`Failed to load config: ${t.statusText}`);this.config=await t.json(),this.loaded=!0,console.log("Game configuration loaded successfully")}catch(e){throw console.error("Failed to load game configuration:",e),e}}getConfig(){if(!this.loaded)throw new Error("Configuration not loaded. Call load() first.");return this.config}getTowerConfig(e){return this.config.towers[e]}getEnemyConfig(e){return this.config.enemies[e]}getWaveConfig(){return this.config.waves}getGameConfig(){return this.config.game}getResearchConfig(){return this.config.research}getUpgradeConfig(){return this.config.towerUpgrades}isLoaded(){return this.loaded}isSoundEnabled(){return!!(this.config&&this.config.audio&&this.config.audio.enabled!==!1)}isMusicEnabled(){return!!(this.config&&this.config.audio&&this.config.audio.musicEnabled!==!1)}setSoundEnabled(e){this.config&&(this.config.audio||(this.config.audio={}),this.config.audio.enabled=!!e)}setMusicEnabled(e){this.config&&(this.config.audio||(this.config.audio={}),this.config.audio.musicEnabled=!!e)}}class lr extends Phaser.Scene{particles;mapRegistry;constructor(){super({key:"PreloaderScene"}),this.mapRegistry=ve.getInstance()}preload(){const e=this.cameras.main.width,t=this.cameras.main.height,s=this.add.graphics();s.fillGradientStyle(657930,657930,1710638,1710638,1),s.fillRect(0,0,e,t),this.particles=[];for(let p=0;p<20;p++){const w=this.add.graphics();w.fillStyle(65280,.3),w.fillCircle(0,0,Math.random()*3+1),w.x=Math.random()*e,w.y=Math.random()*t,this.particles.push(w),this.tweens.add({targets:w,y:w.y+Math.random()*200-100,x:w.x+Math.random()*100-50,alpha:{from:.3,to:0},duration:2e3+Math.random()*1e3,repeat:-1,yoyo:!0})}const i=this.add.text(e/2,t/3,"OPEN TD",{font:"bold 72px Arial",color:"#00ff00"});i.setOrigin(.5),i.setStroke("#003300",8),this.tweens.add({targets:i,scale:{from:1,to:1.05},duration:1e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});const r=this.add.text(e/2,t/3+60,"Tower Defense",{font:"24px Arial",color:"#00aa00"});r.setOrigin(.5),r.setAlpha(0),this.tweens.add({targets:r,alpha:1,duration:800,delay:300});const n=this.add.graphics();n.lineStyle(3,65280,.8),n.strokeRoundedRect(e/2-165,t/2+50,330,40,10),n.fillStyle(0,.5),n.fillRoundedRect(e/2-165,t/2+50,330,40,10);const a=this.add.graphics(),l=this.add.text(e/2,t/2+20,"L√§dt...",{font:"20px Arial",color:"#00ff00"});l.setOrigin(.5);let h=0;this.time.addEvent({delay:500,callback:()=>{h=(h+1)%4,l.setText("L√§dt"+".".repeat(h))},loop:!0});const d=this.add.text(e/2,t/2+70,"0%",{font:"bold 20px Arial",color:"#ffffff"});d.setOrigin(.5),this.load.on("progress",p=>{a.clear(),a.fillGradientStyle(65280,65280,43520,43520,1),a.fillRoundedRect(e/2-160,t/2+55,320*p,30,8),a.lineStyle(2,65280,.5),a.strokeRoundedRect(e/2-160,t/2+55,320*p,30,8),d.setText(`${Math.floor(p*100)}%`),this.tweens.add({targets:d,scale:{from:1,to:1.1},duration:100,yoyo:!0})});const u=E.getInstance();(u.isLoaded()?u.isSoundEnabled():!1)&&(this.load.audio("click","assets/sounds/click.mp3"),this.load.audio("music","assets/music/menu.mp3"),this.load.audio("tower_basic","assets/sounds/tower_basic.mp3"),this.load.audio("tower_fast","assets/sounds/tower_fast.mp3"),this.load.audio("tower_fire","assets/sounds/tower_fire.mp3"),this.load.audio("tower_frost","assets/sounds/tower_frost.mp3"),this.load.audio("tower_sniper","assets/sounds/tower_sniper.mp3"),this.load.audio("tower_splash","assets/sounds/tower_splash.mp3"),this.load.audio("tower_strong","assets/sounds/tower_strong.mp3")),this.load.once("complete",()=>{this.time.delayedCall(800,()=>{this.tweens.add({targets:[a,n,l,d,i,r],alpha:0,duration:500}),this.particles.forEach(p=>{this.tweens.add({targets:p,alpha:0,duration:500})})})})}async create(){if(console.log("Loading maps..."),await this.mapRegistry.loadAllMaps(),console.log(`Loaded ${this.mapRegistry.getMapCount()} maps`),this.load.totalToLoad===0){let e=0;const t=setInterval(()=>{e+=.1,e>=1&&(e=1,clearInterval(t),this.load.emit("complete"),this.time.delayedCall(1500,()=>{this.cameras.main.fadeOut(300),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("LoginScene")})})),this.load.emit("progress",e)},100)}else this.load.once("complete",()=>{this.time.delayedCall(1500,()=>{this.cameras.main.fadeOut(300),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("LoginScene")})})})}}class se{static instance;storageMode="hybrid";serverUrl=null;storagePrefix="opentd_";constructor(){this.detectStorageMode()}async saveErrorReport(e,t){try{const s=this.getLocal("errorReports")||[];s.push(e),this.setLocal("errorReports",s),(this.storageMode==="hybrid"||this.storageMode==="server")&&t&&await this.saveToServer("errorReports",s,t)}catch(s){console.error("‚ùå Failed to save error report:",s)}}getErrorReports(){return this.getLocal("errorReports")||[]}clearErrorReports(){this.removeLocal("errorReports")}static getInstance(){return se.instance||(se.instance=new se),se.instance}detectStorageMode(){const e=localStorage.getItem(this.storagePrefix+"serverUrl");e?(this.serverUrl=e,this.storageMode="hybrid"):this.storageMode="local",console.log(`üíæ Storage mode: ${this.storageMode}`)}setServerUrl(e){this.serverUrl=e,localStorage.setItem(this.storagePrefix+"serverUrl",e),this.storageMode="hybrid",console.log(`üåê Server URL set: ${e}`)}getServerUrl(){return this.serverUrl}setStorageMode(e){this.storageMode=e,console.log(`üíæ Storage mode changed to: ${e}`)}setLocal(e,t){try{const s=JSON.stringify(t);localStorage.setItem(this.storagePrefix+e,s)}catch(s){console.error("‚ùå Failed to save to localStorage:",s)}}getLocal(e){try{const t=localStorage.getItem(this.storagePrefix+e);return t===null?null:JSON.parse(t)}catch(t){return console.error("‚ùå Failed to read from localStorage:",t),null}}removeLocal(e){localStorage.removeItem(this.storagePrefix+e)}clearLocal(){const e=[];for(let t=0;t<localStorage.length;t++){const s=localStorage.key(t);s&&s.startsWith(this.storagePrefix)&&e.push(s)}e.forEach(t=>localStorage.removeItem(t)),console.log("üóëÔ∏è Local storage cleared")}async saveToServer(e,t,s){if(!this.serverUrl||this.storageMode==="local")return!1;try{const i=tt(`${this.serverUrl.replace(/\/$/,"")}/storage/save`);return(await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({key:e,value:t})})).ok?(console.log(`‚òÅÔ∏è Saved to server: ${e}`),!0):!1}catch(i){return console.error("‚ùå Failed to save to server:",i),!1}}async loadFromServer(e,t){if(!this.serverUrl||this.storageMode==="local")return null;try{const s=tt(`${this.serverUrl.replace(/\/$/,"")}/storage/load?key=${encodeURIComponent(e)}`),i=await fetch(s,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(i.ok){const r=await i.json();return console.log(`‚òÅÔ∏è Loaded from server: ${e}`),r.value}return null}catch(s){return console.error("‚ùå Failed to load from server:",s),null}}async save(e,t,s){this.setLocal(e,t),(this.storageMode==="hybrid"||this.storageMode==="server")&&s&&await this.saveToServer(e,t,s)}async load(e,t){if((this.storageMode==="hybrid"||this.storageMode==="server")&&t){const s=await this.loadFromServer(e,t);if(s!==null)return this.setLocal(e,s),s}return this.getLocal(e)}async saveGameProgress(e,t){await this.save("gameProgress",e,t)}async loadGameProgress(e){return await this.load("gameProgress",e)}saveSettings(e){this.setLocal("settings",e)}loadSettings(){return this.getLocal("settings")}async updateStatistics(e,t){await this.save("statistics",e,t)}async loadStatistics(e){return await this.load("statistics",e)}async clearAllData(e){if(this.clearLocal(),(this.storageMode==="hybrid"||this.storageMode==="server")&&e){const t=tt(`${this.serverUrl.replace(/\/$/,"")}/storage/clear`);await fetch(t,{method:"POST",headers:{Authorization:`Bearer ${e}`}})}}}class de{static instance;currentUser=null;authToken=null;persistence;constructor(){this.persistence=se.getInstance(),this.loadSession()}static getInstance(){return de.instance||(de.instance=new de),de.instance}loadSession(){const e=this.persistence.getLocal("authToken"),t=this.persistence.getLocal("currentUser");e&&t&&(this.authToken=e,this.currentUser=t,console.log("‚úÖ Session restored:",t.username))}saveSession(){this.authToken&&this.currentUser&&(this.persistence.setLocal("authToken",this.authToken),this.persistence.setLocal("currentUser",this.currentUser))}async register(e,t,s){try{const n=this.persistence.getServerUrl();if(n){const a=await fetch(`${n}/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t,email:s})});if(a.ok){const l=await a.json();return this.authToken=l.token,this.currentUser=l.user,this.saveSession(),console.log("‚úÖ Registered on server:",e),{success:!0,user:l.user,token:l.token}}}}catch{console.log("‚ö†Ô∏è Server registration failed, using local storage")}const i=this.persistence.getLocal("users")||{};if(i[e])return{success:!1,message:"Benutzername bereits vergeben"};const r={userId:this.generateUserId(),username:e,email:s,level:1,xp:0,createdAt:new Date().toISOString(),lastLogin:new Date().toISOString(),passwordHash:await this.hashPassword(t)};return i[e]={...r},this.persistence.setLocal("users",i),this.authToken=this.generateToken(r.userId),this.currentUser=r,this.saveSession(),console.log("‚úÖ Registered locally:",e),{success:!0,user:r,token:this.authToken}}async login(e,t){try{const r=this.persistence.getServerUrl();if(r){const n=await fetch(`${r}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})});if(n.ok){const a=await n.json();return this.authToken=a.token,this.currentUser=a.user,this.currentUser&&(this.currentUser.lastLogin=new Date().toISOString()),this.saveSession(),console.log("‚úÖ Logged in via server:",e),{success:!0,user:a.user,token:a.token}}}}catch{console.log("‚ö†Ô∏è Server login failed, using local storage")}const s=this.persistence.getLocal("users")||{},i=s[e];return i?i.passwordHash!==await this.hashPassword(t)?{success:!1,message:"Falsches Passwort"}:(i.lastLogin=new Date().toISOString(),s[e]=i,this.persistence.setLocal("users",s),this.authToken=this.generateToken(i.userId),this.currentUser={userId:i.userId,username:i.username,email:i.email,level:i.level,xp:i.xp,createdAt:i.createdAt,lastLogin:i.lastLogin,passwordHash:i.passwordHash},this.saveSession(),console.log("‚úÖ Logged in locally:",e),{success:!0,user:this.currentUser,token:this.authToken}):{success:!1,message:"Benutzer nicht gefunden"}}logout(){this.currentUser=null,this.authToken=null,this.persistence.removeLocal("authToken"),this.persistence.removeLocal("currentUser"),console.log("üëã Logged out")}isLoggedIn(){return this.currentUser!==null&&this.authToken!==null}getCurrentUser(){return this.currentUser}getAuthToken(){return this.authToken}async updateUserProgress(e,t){if(!this.currentUser)return;this.currentUser.xp+=e,t&&this.currentUser.level&&(this.currentUser.level+=1),this.saveSession();try{const i=this.persistence.getServerUrl();i&&this.authToken&&await fetch(`${i}/auth/progress`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.authToken}`},body:JSON.stringify({xp:this.currentUser.xp,level:this.currentUser.level})})}catch{console.log("‚ö†Ô∏è Could not sync progress with server")}const s=this.persistence.getLocal("users")||{};s[this.currentUser.username]&&(s[this.currentUser.username].xp=this.currentUser.xp,s[this.currentUser.username].level=this.currentUser.level,this.persistence.setLocal("users",s))}generateUserId(){return"user_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}generateToken(e){return btoa(e+":"+Date.now()+":"+Math.random().toString(36).substr(2,16))}async hashPassword(e){let t=this.persistence.getLocal("passwordSalt");if(!t){const l=new Uint8Array(128);crypto.getRandomValues(l),t=btoa(String.fromCharCode(...l)),this.persistence.setLocal("passwordSalt",t)}const s=new TextEncoder,i=await crypto.subtle.importKey("raw",s.encode(e),"PBKDF2",!1,["deriveBits"]),r=new Uint8Array([...atob(t)].map(l=>l.charCodeAt(0))),n=await crypto.subtle.deriveBits({name:"PBKDF2",salt:r,iterations:1e3,hash:"SHA-512"},i,512),a=new Uint8Array(n);return Array.from(a,l=>l.toString(16).padStart(2,"0")).join("")}}class yi{constructor(e){this.scene=e}createGradientBackground(e,t){const s=this.scene.add.graphics();s.fillGradientStyle(657930,657930,1451079,2048104,1),s.fillRect(0,0,e,t)}createParticles(e,t,s=30){for(let i=0;i<s;i++){const r=this.scene.add.graphics();r.fillStyle(65280,.1+Math.random()*.2),r.fillCircle(0,0,Math.random()*4+2),r.x=Math.random()*e,r.y=Math.random()*t,this.scene.tweens.add({targets:r,y:r.y+Math.random()*300-150,x:r.x+Math.random()*200-100,alpha:{from:r.alpha,to:0},scale:{from:1,to:0},duration:3e3+Math.random()*2e3,repeat:-1,delay:Math.random()*2e3})}}}class cr extends Phaser.Scene{authManager;isRegistering=!1;constructor(){super({key:"LoginScene"}),this.authManager=de.getInstance()}create(){const e=this.cameras.main.width,t=this.cameras.main.height;if(this.authManager.isLoggedIn()){console.log("Already logged in, going to main menu"),this.scene.start("MainMenuScene");return}this.cameras.main.fadeIn(500);const s=new yi(this);s.createGradientBackground(e,t),s.createParticles(e,t,20);const i=this.add.text(e/2,120,"OPEN TD",{fontSize:"64px",fontFamily:"Arial Black",color:"#ffffff",stroke:"#000000",strokeThickness:6});i.setOrigin(.5),i.setAlpha(0),this.tweens.add({targets:i,alpha:1,scale:{from:.8,to:1},duration:800,ease:"Back.easeOut"}),this.createLoginForm(e,t)}createLoginForm(e,t){const s=e/2,i=t/2-80,r=this.add.graphics();r.fillStyle(0,.7),r.fillRoundedRect(s-200,i-40,400,380,15),r.lineStyle(3,65280,.8),r.strokeRoundedRect(s-200,i-40,400,380,15);const n=this.add.text(s,i,"ANMELDEN",{fontSize:"32px",fontFamily:"Arial",color:"#00ff00"});n.setOrigin(.5),this.add.text(s-150,i+60,"Benutzername:",{fontSize:"18px",color:"#ffffff"});const a=this.createInput(s-150,i+90,300,"username");this.add.text(s-150,i+140,"Passwort:",{fontSize:"18px",color:"#ffffff"});const l=this.createInput(s-150,i+170,300,"password"),h=this.add.text(s-150,i+220,"E-Mail (optional):",{fontSize:"18px",color:"#ffffff"});h.setVisible(!1);const d=this.createInput(s-150,i+250,300,"email");d.style.display="none";const u=this.add.text(s,i+290,"ANMELDEN",{fontSize:"24px",fontFamily:"Arial",color:"#ffffff",backgroundColor:"#00aa00",padding:{x:30,y:10}});u.setOrigin(.5),u.setInteractive({useHandCursor:!0}),u.on("pointerover",()=>{u.setStyle({backgroundColor:"#00ff00"})}),u.on("pointerout",()=>{u.setStyle({backgroundColor:"#00aa00"})}),u.on("pointerdown",async()=>{const w=a.value.trim(),C=l.value.trim(),I=d.value.trim();if(!w||!C){this.showMessage("Bitte alle Felder ausf√ºllen!","#ff0000");return}if(u.disableInteractive(),this.isRegistering){const v=await this.authManager.register(w,C,I||void 0);v.success?(this.showMessage("Registrierung erfolgreich!","#00ff00"),this.time.delayedCall(1e3,()=>{this.cameras.main.fadeOut(500),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("MainMenuScene")})})):(this.showMessage(v.message||"Registrierung fehlgeschlagen","#ff0000"),u.setInteractive())}else{const v=await this.authManager.login(w,C);v.success?(this.showMessage("Anmeldung erfolgreich!","#00ff00"),this.time.delayedCall(1e3,()=>{this.cameras.main.fadeOut(500),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("MainMenuScene")})})):(this.showMessage(v.message||"Anmeldung fehlgeschlagen","#ff0000"),u.setInteractive())}});const f=this.add.text(s,i+270,"Noch kein Account? Registrieren",{fontSize:"16px",color:"#aaaaaa"});f.setOrigin(.5),f.setInteractive({useHandCursor:!0}),f.on("pointerover",()=>{f.setStyle({color:"#ffffff"})}),f.on("pointerout",()=>{f.setStyle({color:"#aaaaaa"})}),f.on("pointerdown",()=>{this.isRegistering=!this.isRegistering,this.isRegistering?(n.setText("REGISTRIEREN"),u.setText("REGISTRIEREN"),f.setText("Bereits registriert? Anmelden"),h.setVisible(!0),d.style.display="block"):(n.setText("ANMELDEN"),u.setText("ANMELDEN"),f.setText("Noch kein Account? Registrieren"),h.setVisible(!1),d.style.display="none")});const p=this.add.text(e-20,t-20,"Als Gast fortfahren ‚Üí",{fontSize:"14px",color:"#666666"});p.setOrigin(1,1),p.setInteractive({useHandCursor:!0}),p.on("pointerover",()=>{p.setStyle({color:"#aaaaaa"})}),p.on("pointerout",()=>{p.setStyle({color:"#666666"})}),p.on("pointerdown",()=>{this.cameras.main.fadeOut(500),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("MainMenuScene")})})}createInput(e,t,s,i){const r=document.createElement("input");r.type=i==="password"?"password":i==="email"?"email":"text",r.placeholder=i==="username"?"Benutzername":i==="password"?"Passwort":"E-Mail",r.style.position="absolute",r.style.width=s+"px",r.style.height="35px",r.style.fontSize="16px",r.style.padding="5px 10px",r.style.backgroundColor="#333333",r.style.color="#ffffff",r.style.border="2px solid #00aa00",r.style.borderRadius="5px",r.style.outline="none",r.style.fontFamily="Arial",r.style.boxSizing="border-box";const a=this.game.canvas.getBoundingClientRect(),l=a.width/this.cameras.main.width,h=a.height/this.cameras.main.height;return r.style.left=a.left+e*l+"px",r.style.top=a.top+t*h+"px",r.style.width=s*l+"px",r.style.height=35*h+"px",document.body.appendChild(r),this.events.once("shutdown",()=>{r.remove()}),r}showMessage(e,t){const s=this.cameras.main.width,i=this.cameras.main.height,r=this.add.text(s/2,i/2+200,e,{fontSize:"20px",color:t,backgroundColor:"#000000",padding:{x:20,y:10}});r.setOrigin(.5),r.setAlpha(0),this.tweens.add({targets:r,alpha:1,duration:300}),this.time.delayedCall(3e3,()=>{this.tweens.add({targets:r,alpha:0,duration:300,onComplete:()=>r.destroy()})})}}class hr{constructor(e){this.scene=e}createAnimatedTitle(e,t,s,i){const r=this.scene.add.text(e,t-20,s,{font:"bold 80px Arial",color:"#00ff00"});if(r.setOrigin(.5),r.setStroke("#003300",10),r.setShadow(0,0,"#00ff00",20,!1,!0),r.setScale(0),r.setAlpha(0),this.scene.tweens.add({targets:r,scale:1,alpha:1,duration:800,ease:"Back.easeOut"}),this.scene.tweens.add({targets:r,scale:{from:1,to:1.05},duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),i){const n=this.scene.add.text(e,t+70,"",{font:"28px Arial",color:"#00cc00"});n.setOrigin(.5);let a=0;this.scene.time.addEvent({delay:100,callback:()=>{a<i.length&&(n.setText(i.substring(0,a+1)),a++)},repeat:i.length-1})}}}class dr{constructor(e){this.scene=e}lightenColor(e,t){const s=parseInt(e.replace("#",""),16),i=Math.round(2.55*t),r=Math.min(255,(s>>16&255)+i),n=Math.min(255,(s>>8&255)+i),a=Math.min(255,(s&255)+i);return"#"+((1<<24)+(r<<16)+(n<<8)+a).toString(16).slice(1)}createButton(e,t,s,i,r){const n=this.scene.add.text(e,t,s,{font:"bold 28px Arial",color:"#ffffff",backgroundColor:i,padding:{x:30,y:12}});return n.setOrigin(.5),n.setInteractive({useHandCursor:!0}),n.on("pointerover",()=>{n.setScale(1.1),n.setStyle({backgroundColor:this.lightenColor(i,30),shadow:{blur:15,color:i,fill:!0}}),this.scene.tweens.add({targets:n,scale:1.1,duration:200,ease:"Back.easeOut"})}),n.on("pointerout",()=>{n.setStyle({backgroundColor:i,shadow:{blur:0,color:"#000000",fill:!1}}),this.scene.tweens.add({targets:n,scale:1,duration:200})}),n.on("pointerdown",()=>{this.scene.tweens.add({targets:n,scale:.95,duration:100,yoyo:!0,onComplete:r})}),n}createMainMenuButtons(e,t,s,i){const r=this.createButton(e,t,"Einzelspieler","#00aa00",i.onSingleplayer),n=this.createButton(e,t+s,"Mehrspieler","#e67e22",i.onMultiplayer),a=this.createButton(e,t+s*2,"Optionen","#0066cc",i.onOptions),l=this.createButton(e,t+s*3,"Credits","#666666",i.onCredits);return[r,n,a,l]}animateButtonsEntrance(e,t=800){e.forEach((s,i)=>{s.setAlpha(0),s.setY(s.y+50),this.scene.tweens.add({targets:s,alpha:1,y:s.y-50,duration:500,delay:t+i*150,ease:"Back.easeOut"})})}}class ur{constructor(e){this.scene=e,this.mapRegistry=ve.getInstance()}elements=[];mapRegistry;show(e,t,s,i){const r=e/2,n=t/2,a=this.scene.add.rectangle(0,0,e,t,0,.8);a.setOrigin(0),a.setInteractive();const l=this.mapRegistry.getAllMaps(),h=Math.min(700,200+l.length*220),u=this.scene.add.rectangle(r,n,h,400,1710638);u.setStrokeStyle(3,65280);const f=this.scene.add.text(r,n-150,"W√§hle eine Karte",{font:"bold 32px Arial",color:"#00ff00"});f.setOrigin(.5),this.elements=[a,u,f];const p=l.map((k,O)=>{const b=["#0088ff","#ff8800","#8800ff","#00ff88","#ff0088","#88ff00"];return{id:k.id,name:k.config.name,description:k.config.description,color:b[O%b.length]}}),w=180,C=220,I=r-(p.length-1)*C/2;p.forEach((k,O)=>{const b=I+O*C,D=n-20,A=this.scene.add.rectangle(b,D,w,120,2969622);A.setStrokeStyle(3,parseInt(k.color.replace("#","0x"))),A.setInteractive({useHandCursor:!0});const _=this.scene.add.text(b,D-10,k.name,{font:"bold 20px Arial",color:k.color});_.setOrigin(.5);const U=this.scene.add.text(b,D+20,k.description,{font:"14px Arial",color:"#cccccc",align:"center",wordWrap:{width:w-20}});U.setOrigin(.5),A.on("pointerover",()=>{A.setFillStyle(4022310),this.scene.tweens.add({targets:A,scaleX:1.05,scaleY:1.05,duration:200})}),A.on("pointerout",()=>{A.setFillStyle(2969622),this.scene.tweens.add({targets:A,scaleX:1,scaleY:1,duration:200})}),A.on("pointerdown",()=>{s(k.id)}),this.elements.push(A,_,U)});const v=this.scene.add.text(r,n+140,"Zur√ºck",{font:"bold 20px Arial",color:"#ffffff",backgroundColor:"#666666",padding:{x:20,y:8}});v.setOrigin(.5),v.setInteractive({useHandCursor:!0}),v.on("pointerover",()=>{v.setStyle({backgroundColor:"#888888"})}),v.on("pointerout",()=>{v.setStyle({backgroundColor:"#666666"})}),v.on("pointerdown",()=>{this.hide(),i()}),this.elements.push(v),this.elements.forEach((k,O)=>{"setAlpha"in k&&k.setAlpha(0),this.scene.tweens.add({targets:k,alpha:1,duration:300,delay:O*30})})}hide(){this.elements.forEach(e=>{this.scene.tweens.add({targets:e,alpha:0,duration:300,onComplete:()=>e.destroy()})}),this.elements=[]}}class pr{constructor(e){this.scene=e}elements=[];show(e,t,s){const i=e/2,r=t/2,n=this.scene.add.rectangle(0,0,e,t,0,.8);n.setOrigin(0),n.setInteractive();const a=this.scene.add.rectangle(i,r,500,300,1710638);a.setStrokeStyle(3,65280);const l=this.scene.add.text(i,r-100,"Credits",{font:"bold 32px Arial",color:"#00ff00"});l.setOrigin(.5);const h=this.scene.add.text(i,r-20,`Entwickelt mit Phaser 3

Game Engine: Phaser.io
Build Tool: Vite
Mobile: Capacitor

Ein Open Source Projekt`,{font:"18px Arial",color:"#ffffff",align:"center"});h.setOrigin(.5);const d=this.scene.add.text(i,r+110,"Schlie√üen",{font:"bold 20px Arial",color:"#ffffff",backgroundColor:"#00aa00",padding:{x:20,y:8}});d.setOrigin(.5),d.setInteractive({useHandCursor:!0}),d.on("pointerdown",()=>{this.hide(),s()}),this.elements=[n,a,l,h,d],this.elements.forEach(u=>{"setAlpha"in u&&u.setAlpha(0),this.scene.tweens.add({targets:u,alpha:1,duration:300})})}hide(){this.elements.forEach(e=>{this.scene.tweens.add({targets:e,alpha:0,duration:300,onComplete:()=>e.destroy()})}),this.elements=[]}}class fr extends Phaser.Scene{levelSelection;creditsOverlay;authManager;constructor(){super({key:"MainMenuScene"}),this.authManager=de.getInstance()}create(){const e=this.cameras.main.width,t=this.cameras.main.height;this.cameras.main.fadeIn(500);const s=new yi(this);s.createGradientBackground(e,t),s.createParticles(e,t,30),new hr(this).createAnimatedTitle(e/2,t/3,"OPEN TD","Tower Defense");const r=t/2+80,n=80,a=new dr(this),l=a.createMainMenuButtons(e/2,r,n,{onSingleplayer:()=>this.handleSingleplayer(),onMultiplayer:()=>this.handleMultiplayer(),onOptions:()=>this.handleOptions(),onCredits:()=>this.handleCredits()});a.animateButtonsEntrance(l,800);const h=this.add.text(e/2,t-80,"üéÆ Platziere strategisch T√ºrme und verteidige deine Basis!",{font:"18px Arial",color:"#888888"});h.setOrigin(.5),h.setAlpha(0),this.tweens.add({targets:h,alpha:1,duration:1e3,delay:1500}),this.add.text(e-10,t-10,"v1.0.0",{font:"14px Arial",color:"#444444"}).setOrigin(1,1),this.createUserInfo(e)}createUserInfo(e){const t=this.authManager.getCurrentUser();if(t){const s=this.add.graphics();s.fillStyle(0,.7),s.fillRoundedRect(e-250,10,240,80,10),s.lineStyle(2,43520,.8),s.strokeRoundedRect(e-250,10,240,80,10),this.add.text(e-130,25,t.username,{fontSize:"20px",fontFamily:"Arial",color:"#00ff00",fontStyle:"bold"}).setOrigin(.5,0),this.add.text(e-130,50,`Level ${t.level} | ${t.xp} XP`,{fontSize:"14px",color:"#ffffff"}).setOrigin(.5,0);const n=this.add.text(e-130,70,"üö™ Abmelden",{fontSize:"12px",color:"#ff6666"});n.setOrigin(.5,0),n.setInteractive({useHandCursor:!0}),n.on("pointerover",()=>{n.setStyle({color:"#ff0000"})}),n.on("pointerout",()=>{n.setStyle({color:"#ff6666"})}),n.on("pointerdown",()=>{this.authManager.logout(),this.cameras.main.fadeOut(300),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("LoginScene")})})}else this.add.text(e-20,20,"Gast-Modus",{fontSize:"16px",color:"#666666"}).setOrigin(1,0)}handleSingleplayer(){this.levelSelection=new ur(this),this.levelSelection.show(this.cameras.main.width,this.cameras.main.height,e=>{this.cameras.main.fadeOut(300),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("GameScene",{levelType:e})})},()=>{})}handleMultiplayer(){this.cameras.main.fadeOut(500),this.time.delayedCall(500,()=>{this.scene.start("MultiplayerScene")})}handleOptions(){this.scene.launch("OptionsScene"),this.scene.pause()}handleCredits(){this.creditsOverlay=new pr(this),this.creditsOverlay.show(this.cameras.main.width,this.cameras.main.height,()=>{})}}class Vt{constructor(e,t,s,i,r){this.scene=e,this.onChange=r,this.enabled=i,this.container=e.add.container(t,s),this.bg=e.add.rectangle(0,0,80,36,i?43520:6710886),this.bg.setStrokeStyle(2,16777215,.5),this.toggleCircle=e.add.circle(i?20:-20,0,14,16777215),this.label=e.add.text(0,0,i?"AN":"AUS",{font:"bold 16px Arial",color:"#000000"}),this.label.setOrigin(.5),this.container.add([this.bg,this.toggleCircle,this.label]),this.container.setSize(80,36),this.container.setInteractive(new Phaser.Geom.Rectangle(-40,-18,80,36),Phaser.Geom.Rectangle.Contains),this.container.on("pointerdown",()=>this.handleToggle())}container;bg;toggleCircle;label;enabled;setEnabled(e){this.enabled=e,this.bg.setFillStyle(this.enabled?43520:6710886),this.toggleCircle.x=this.enabled?20:-20,this.label.setText(this.enabled?"AN":"AUS")}handleToggle(){this.enabled=!this.enabled,this.bg.setFillStyle(this.enabled?43520:6710886),this.scene.tweens.add({targets:this.toggleCircle,x:this.enabled?20:-20,duration:300,ease:"Back.easeOut"}),this.label.setText(this.enabled?"AN":"AUS"),this.onChange(this.enabled)}getContainer(){return this.container}}class gr{constructor(e,t){this.scene=e,this.onChange=t,this.currentDifficulty="normal"}buttons=[];currentDifficulty;create(e,t,s){this.currentDifficulty=s;const i=this.scene.add.text(e-150,t+50,"Schwierigkeit:",{font:"24px Arial",color:"#ffffff"}),r=[{value:"easy",label:"Leicht",color:43520},{value:"normal",label:"Normal",color:26316},{value:"hard",label:"Schwer",color:13369344}];return r.forEach((n,a)=>{const l=this.scene.add.text(e-120+a*120,t+100,n.label,{font:"20px Arial",color:"#ffffff",backgroundColor:this.currentDifficulty===n.value?`#${n.color.toString(16).padStart(6,"0")}`:"#333333",padding:{x:15,y:8}});l.setOrigin(.5),l.setInteractive({useHandCursor:!0}),l.on("pointerover",()=>{this.currentDifficulty!==n.value&&l.setStyle({backgroundColor:"#555555"})}),l.on("pointerout",()=>{this.currentDifficulty!==n.value&&l.setStyle({backgroundColor:"#333333"})}),l.on("pointerdown",()=>{this.currentDifficulty=n.value,this.onChange(n.value),this.buttons.forEach((h,d)=>{const u=r[d];h.setStyle({backgroundColor:this.currentDifficulty===u.value?`#${u.color.toString(16).padStart(6,"0")}`:"#333333"})})}),this.buttons.push(l)}),{label:i,buttons:this.buttons}}getDifficultyInfo(){switch(this.currentDifficulty){case"easy":return"Weniger Gegner, mehr Startgold";case"normal":return"Ausbalanciertes Spielerlebnis";case"hard":return"Mehr Gegner, weniger Ressourcen";default:return""}}}class xe{static defaultSettings={soundEnabled:!0,musicEnabled:!0,difficulty:"normal",autoRestartOnError:!0};static save(e){se.getInstance().saveSettings(e)}static load(){const e=se.getInstance().loadSettings();if(e)try{return{...this.defaultSettings,...e}}catch(t){console.error("Failed to load settings:",t)}return{...this.defaultSettings}}static getSettings(){return this.load()}}class Ee{static instance;scene=null;music=null;soundEnabled=!1;musicEnabled=!1;assetsLoaded=!1;constructor(){}static getInstance(){return Ee.instance||(Ee.instance=new Ee),Ee.instance}init(e,t,s){this.scene=e;const i=E.getInstance();this.soundEnabled=i.isLoaded()?i.isSoundEnabled():t??!1,this.musicEnabled=i.isLoaded()?i.isMusicEnabled():s??!1,this.checkAndloadAssets()}checkAndloadAssets(){if(!this.scene||this.assetsLoaded)return!1;const e=E.getInstance();if(e.isLoaded()&&!e.isSoundEnabled()||!this.soundEnabled)return!1;const t=[["click","assets/sounds/click.mp3"],["music","assets/music/menu.mp3"],["tower_basic","assets/sounds/tower_basic.mp3"],["tower_fast","assets/sounds/tower_fast.mp3"],["tower_fire","assets/sounds/tower_fire.mp3"],["tower_frost","assets/sounds/tower_frost.mp3"],["tower_sniper","assets/sounds/tower_sniper.mp3"],["tower_splash","assets/sounds/tower_splash.mp3"],["tower_strong","assets/sounds/tower_strong.mp3"]];for(const[s,i]of t)this.scene.cache.audio.has(s)||this.scene.load.audio(s,tt(i));return this.scene.load.start(),this.assetsLoaded=!0,!0}playTower(e){if(!this.checkAndloadAssets())return;const t=E.getInstance();if(!this.soundEnabled||!this.scene||!this.scene.sound||t.isLoaded()&&!t.isSoundEnabled())return;const i={basic:"tower_basic",fast:"tower_fast",fire:"tower_fire",frost:"tower_frost",sniper:"tower_sniper",splash:"tower_splash",strong:"tower_strong"}[e]||"click";this.scene.sound.play(i,{volume:.5})}playClick(){if(!this.checkAndloadAssets())return;const e=E.getInstance();this.soundEnabled&&this.scene&&this.scene.sound&&(!e.isLoaded()||e.isSoundEnabled())&&this.scene.sound.play("click",{volume:.5})}playMusic(){if(!this.checkAndloadAssets())return;const e=E.getInstance();this.musicEnabled&&this.scene&&this.scene.sound&&(!e.isLoaded()||e.isMusicEnabled())&&(!this.music||!this.music.isPlaying)&&(this.music=this.scene.sound.add("music",{loop:!0,volume:.3}),this.music.play())}stopMusic(){this.music&&this.music.isPlaying&&this.music.stop()}setSoundEnabled(e){const t=E.getInstance();return e&&t.isLoaded()&&!t.isSoundEnabled()?!1:(this.soundEnabled=e,!0)}setMusicEnabled(e){const t=E.getInstance();return e&&t.isLoaded()&&!t.isMusicEnabled()?!1:(this.musicEnabled=e,e?this.playMusic():this.stopMusic(),!0)}}class ds extends Phaser.Scene{settings;auth;constructor(){super({key:"OptionsScene"}),this.settings=xe.load(),this.auth=de.getInstance()}create(){const e=Ee.getInstance(),t=this.cameras.main.width,s=this.cameras.main.height,i=this.add.rectangle(0,0,t,s,0,.85);i.setOrigin(0),i.setInteractive();const a=this.add.rectangle(t/2,s/2,600,500,1710638);a.setStrokeStyle(4,65280);const l=this.add.text(t/2,s/2-200,"Optionen",{font:"bold 48px Arial",color:"#00ff00"});l.setOrigin(.5);const h=this.add.text(t/2-150,s/2-100,"Sound:",{font:"24px Arial",color:"#ffffff"}),d=E.getInstance(),u=d.isLoaded()?d.isSoundEnabled():this.settings.soundEnabled,f=new Vt(this,t/2+100,s/2-100,u,H=>{this.settings.soundEnabled=H,xe.save(this.settings),e.setSoundEnabled(H)?H&&e.playClick():(f.setEnabled(!1),this.settings.soundEnabled=!1,xe.save(this.settings))}),p=this.add.text(t/2-150,s/2-30,"Musik:",{font:"24px Arial",color:"#ffffff"}),w=d.isLoaded()?d.isMusicEnabled():this.settings.musicEnabled,C=new Vt(this,t/2+100,s/2-30,w,H=>{this.settings.musicEnabled=H,xe.save(this.settings),e.setMusicEnabled(H)||(C.setEnabled(!1),this.settings.musicEnabled=!1,xe.save(this.settings))}),I=new gr(this,H=>{this.settings.difficulty=H,xe.save(this.settings),O.setText(I.getDifficultyInfo())}),{label:v,buttons:k}=I.create(t/2,s/2,this.settings.difficulty),O=this.add.text(t/2,s/2+150,I.getDifficultyInfo(),{font:"16px Arial",color:"#888888",align:"center"});O.setOrigin(.5);const b=this.add.text(t/2,s/2+200,"Zur√ºck",{font:"bold 24px Arial",color:"#ffffff",backgroundColor:"#00aa00",padding:{x:30,y:10}});b.setOrigin(.5),b.setInteractive({useHandCursor:!0}),b.on("pointerover",()=>{b.setScale(1.1)}),b.on("pointerout",()=>{b.setScale(1)}),b.on("pointerdown",()=>{this.scene.resume("MainMenuScene"),this.scene.stop()});const D=this.add.text(t/2,s/2+240,"Fehlerberichte anzeigen",{font:"bold 18px Arial",color:"#ffffff",backgroundColor:"#333333",padding:{x:8,y:8}});D.setOrigin(.5),D.setInteractive({useHandCursor:!0}),D.on("pointerdown",()=>{this.auth.isLoggedIn()?(this.scene.launch("AdminScene"),this.scene.pause()):alert("Bitte einloggen, um Fehlerberichte anzuzeigen.")});const A=[i,a,l,h,f.getContainer(),p,C.getContainer(),v,...k,O,b];A.push(D),A.forEach((H,z)=>{H.setAlpha(0),this.tweens.add({targets:H,alpha:1,duration:300,delay:z*30})}),e.init(this,this.settings.soundEnabled,this.settings.musicEnabled),this.settings.musicEnabled?e.playMusic():e.stopMusic();const _=this.add.text(t/2-150,s/2+60,"Auto-Restart bei Fehlern:",{font:"24px Arial",color:"#ffffff"}),U=new Vt(this,t/2+100,s/2+60,!!this.settings.autoRestartOnError,H=>{this.settings.autoRestartOnError=H,xe.save(this.settings)});A.splice(A.length-1,0,_,U.getContainer())}static getSettings(){return xe.getSettings()}}class mr{scene;goldText;livesText;waveText;xpText;levelText;roomCodeText;constructor(e,t,s,i,r,n,a){this.scene=e;const l=20;this.goldText=e.add.text(l,l,`Gold: ${t}`,{font:"24px Arial",color:"#ffd700"}),this.livesText=e.add.text(l,l+35,`Leben: ${s}`,{font:"24px Arial",color:"#ff0000"}),this.waveText=e.add.text(l,l+70,`Welle: ${i}`,{font:"24px Arial",color:"#00ff00"}),this.levelText=e.add.text(l,l+105,`Level: ${r}`,{font:"20px Arial",color:"#00ffff"}),this.xpText=e.add.text(l,l+135,`XP: ${n}/${a}`,{font:"18px Arial",color:"#aaffff"})}updateGold(e){this.goldText.setText(`Gold: ${e}`)}updateLives(e){this.livesText.setText(`Leben: ${e}`)}updateWave(e){this.waveText.setText(`Welle: ${e}`)}updateXP(e,t,s){this.levelText.setText(`Level: ${t}`),this.xpText.setText(`XP: ${e}/${s}`)}showRoomCode(e){const t=this.scene.cameras.main.width,s=20;this.roomCodeText=this.scene.add.text(t-s,s+140,`üéÆ Raum: ${e}`,{font:"bold 20px Arial",color:"#ffffff",backgroundColor:"#4a90e2",padding:{x:12,y:8}}),this.roomCodeText.setOrigin(1,0),this.roomCodeText.setInteractive({useHandCursor:!0}),this.roomCodeText.on("pointerdown",i=>{i.event.stopPropagation(),navigator.clipboard.writeText(e).then(()=>{const r=this.roomCodeText.text;this.roomCodeText.setText("‚úì Kopiert!"),this.roomCodeText.setStyle({backgroundColor:"#00aa00"}),this.scene.time.delayedCall(1500,()=>{this.roomCodeText&&(this.roomCodeText.setText(r),this.roomCodeText.setStyle({backgroundColor:"#4a90e2"}))})})}),this.roomCodeText.on("pointerover",()=>{this.roomCodeText.setStyle({backgroundColor:"#5aa0f2"})}),this.roomCodeText.on("pointerout",()=>{this.roomCodeText.setStyle({backgroundColor:"#4a90e2"})})}hideRoomCode(){this.roomCodeText&&(this.roomCodeText.destroy(),this.roomCodeText=void 0)}}class yr{scene;buttons=[];gold;researchManager;onTowerSelect;constructor(e,t,s,i){this.scene=e,this.gold=t,this.researchManager=s,this.onTowerSelect=i,this.createButtons()}createButtons(){const e=this.scene.cameras.main.height-80,t=20,s=120,i=E.getInstance().getConfig();[{type:"basic",label:i.towers.basic.name,cost:i.towers.basic.cost},{type:"fast",label:i.towers.fast.name,cost:i.towers.fast.cost},{type:"strong",label:i.towers.strong.name,cost:i.towers.strong.cost},{type:"splash",label:i.towers.splash.name,cost:i.towers.splash.cost},{type:"sniper",label:i.towers.sniper.name,cost:i.towers.sniper.cost},{type:"frost",label:i.towers.frost.name,cost:i.towers.frost.cost,requiresResearch:i.towers.frost.requiresResearch,researchId:"frost_tower"},{type:"fire",label:i.towers.fire.name,cost:i.towers.fire.cost,requiresResearch:i.towers.fire.requiresResearch,researchId:"fire_tower"}].forEach((n,a)=>{if(n.requiresResearch&&n.researchId&&!this.researchManager.isResearched(n.researchId))return;const l=this.scene.add.text(t+a*s,e,`${n.label}
${n.cost}G`,{font:"16px Arial",color:"#ffffff",backgroundColor:"#333333",padding:{x:10,y:5},align:"center"});l.setInteractive({useHandCursor:!0}),l.setData("towerType",n.type),l.setData("cost",n.cost),l.on("pointerdown",h=>{h.event.stopPropagation(),this.gold>=n.cost&&this.onTowerSelect(n.type,n.cost)}),this.buttons.push(l)})}updateGold(e){this.gold=e,this.updateStyles()}updateStyles(e){this.buttons.forEach(t=>{const s=t.getData("towerType"),i=t.getData("cost");s===e?t.setStyle({backgroundColor:"#00aa00"}):this.gold>=i?t.setStyle({backgroundColor:"#333333"}):t.setStyle({backgroundColor:"#333333"})})}recreate(){this.buttons.forEach(e=>e.destroy()),this.buttons=[],this.createButtons()}getButtons(){return this.buttons}}class wr{startButton;pauseButton;autoWaveButton;isPaused=!1;autoWaveEnabled=!1;constructor(e,t,s,i){const r=e.cameras.main.width,n=e.cameras.main.height,a=20;this.startButton=e.add.text(r/2,n/2,"Welle Starten",{font:"bold 32px Arial",color:"#ffffff",backgroundColor:"#00aa00",padding:{x:30,y:15}}),this.startButton.setOrigin(.5),this.startButton.setInteractive({useHandCursor:!0}),this.startButton.on("pointerover",()=>{this.startButton.setStyle({backgroundColor:"#00ff00"})}),this.startButton.on("pointerout",()=>{this.startButton.setStyle({backgroundColor:"#00aa00"})}),this.startButton.on("pointerdown",l=>{l.event.stopPropagation(),t()}),this.pauseButton=e.add.text(r-a,a,"‚è∏ Pause",{font:"bold 20px Arial",color:"#ffffff",backgroundColor:"#666666",padding:{x:15,y:8}}),this.pauseButton.setOrigin(1,0),this.pauseButton.setInteractive({useHandCursor:!0}),this.pauseButton.on("pointerover",()=>{this.pauseButton.setStyle({backgroundColor:"#888888"})}),this.pauseButton.on("pointerout",()=>{const l=this.isPaused?"#ff6600":"#666666";this.pauseButton.setStyle({backgroundColor:l})}),this.pauseButton.on("pointerdown",l=>{l.event.stopPropagation(),s()}),this.autoWaveButton=e.add.text(r-a,a+45,"‚ö° Auto-Welle: AUS",{font:"bold 18px Arial",color:"#ffffff",backgroundColor:"#444444",padding:{x:12,y:6}}),this.autoWaveButton.setOrigin(1,0),this.autoWaveButton.setInteractive({useHandCursor:!0}),this.autoWaveButton.on("pointerover",()=>{this.autoWaveButton.setStyle({backgroundColor:"#666666"})}),this.autoWaveButton.on("pointerout",()=>{const l=this.autoWaveEnabled?"#00aa00":"#444444";this.autoWaveButton.setStyle({backgroundColor:l})}),this.autoWaveButton.on("pointerdown",l=>{l.event.stopPropagation(),i()})}showStartButton(e="Welle Starten"){this.startButton.setText(e),this.startButton.setVisible(!0),this.startButton.setInteractive({useHandCursor:!0})}hideStartButton(){this.startButton.setVisible(!1),this.startButton.disableInteractive()}setPaused(e){this.isPaused=e,this.pauseButton.setText(e?"‚ñ∂ Weiter":"‚è∏ Pause"),this.pauseButton.setStyle({backgroundColor:e?"#ff6600":"#666666"})}setAutoWave(e){this.autoWaveEnabled=e,this.autoWaveButton.setText(e?"‚ö° Auto-Welle: AN":"‚ö° Auto-Welle: AUS"),this.autoWaveButton.setStyle({backgroundColor:e?"#00aa00":"#444444"})}getButtons(){return[this.startButton,this.pauseButton,this.autoWaveButton]}}class br{upgradeButton;sellButton;towerInfoText;gold;constructor(e,t,s,i){this.gold=t;const r=e.cameras.main.width,n=e.cameras.main.height;this.towerInfoText=e.add.text(r/2,n-220,"",{font:"20px Arial",color:"#ffffff",backgroundColor:"#333333",padding:{x:20,y:10},align:"center"}),this.towerInfoText.setOrigin(.5),this.towerInfoText.setVisible(!1),this.upgradeButton=e.add.text(r/2,n-160,`Upgrade-Turm
(W√§hle einen Turm)`,{font:"18px Arial",color:"#ffffff",backgroundColor:"#ff9900",padding:{x:15,y:10},align:"center"}),this.upgradeButton.setOrigin(.5),this.upgradeButton.setInteractive({useHandCursor:!0}),this.upgradeButton.setVisible(!1),this.upgradeButton.on("pointerover",()=>{this.upgradeButton.setStyle({backgroundColor:"#ffaa00"})}),this.upgradeButton.on("pointerout",()=>{this.upgradeButton.setStyle({backgroundColor:"#ff9900"})}),this.upgradeButton.on("pointerdown",a=>{a.event.stopPropagation(),s()}),this.sellButton=e.add.text(r/2+150,n-160,`Verkaufen
(90% zur√ºck)`,{font:"18px Arial",color:"#ffffff",backgroundColor:"#cc0000",padding:{x:15,y:10},align:"center"}),this.sellButton.setOrigin(.5),this.sellButton.setInteractive({useHandCursor:!0}),this.sellButton.setVisible(!1),this.sellButton.on("pointerover",()=>{this.sellButton.setStyle({backgroundColor:"#ff0000"})}),this.sellButton.on("pointerout",()=>{this.sellButton.setStyle({backgroundColor:"#cc0000"})}),this.sellButton.on("pointerdown",a=>{a.event.stopPropagation(),i()})}updateGold(e){this.gold=e}updateForTower(e){if(!e){this.upgradeButton.setVisible(!1),this.sellButton.setVisible(!1),this.towerInfoText.setVisible(!1);return}const t=e.getType(),s=this.getTowerDisplayName(t),i=e.getUpgradeLevel(),r=Math.round(e.getDamage()),n=Math.round(e.getRange());this.towerInfoText.setText(`${s} (Level ${i})
Schaden: ${r} | Reichweite: ${n}`),this.towerInfoText.setVisible(!0);const a=e.getSellValue();if(this.sellButton.setText(`Verkaufen
${a}G
(90% zur√ºck)`),this.sellButton.setVisible(!0),!e.canUpgrade()){this.upgradeButton.setVisible(!1);return}const l=e.getUpgradeCost();this.upgradeButton.setText(`Upgrade Turm
Level ${i} ‚Üí ${i+1}
Kosten: ${l}G`),this.upgradeButton.setVisible(!0),this.gold>=l?this.upgradeButton.setStyle({backgroundColor:"#ff9900"}):this.upgradeButton.setStyle({backgroundColor:"#666666"})}getButtons(){return[this.upgradeButton,this.sellButton]}getTowerDisplayName(e){return{basic:"Basis-Turm",fast:"Schnell-Turm",strong:"Stark-Turm",sniper:"Sniper-Turm",splash:"Splash-Turm",frost:"Frost-Turm",fire:"Feuer-Turm"}[e]||e}}class Sr{scene;button;notificationBadge;pulseTween;constructor(e,t){this.scene=e;const s=e.cameras.main.width,i=20;this.button=e.add.text(s-i,i+95,"üî¨ Forschung",{font:"bold 18px Arial",color:"#ffffff",backgroundColor:"#9900ff",padding:{x:12,y:6}}),this.button.setOrigin(1,0),this.button.setInteractive({useHandCursor:!0}),this.button.on("pointerover",()=>{this.button.setStyle({backgroundColor:"#bb44ff"})}),this.button.on("pointerout",()=>{this.button.setStyle({backgroundColor:"#9900ff"})}),this.button.on("pointerdown",r=>{r.event.stopPropagation(),this.hidePulse(),t()}),this.notificationBadge=e.add.graphics(),this.notificationBadge.setDepth(100),this.notificationBadge.setVisible(!1)}showPulse(){this.pulseTween&&this.pulseTween.stop();const s=this.scene.cameras.main.width-20-10,i=108;this.notificationBadge.clear(),this.notificationBadge.fillStyle(16711680,1),this.notificationBadge.fillCircle(s,i,8),this.notificationBadge.lineStyle(2,16777215,1),this.notificationBadge.strokeCircle(s,i,8),this.notificationBadge.setVisible(!0),this.pulseTween=this.scene.tweens.add({targets:this.button,scaleX:{from:1,to:1.1},scaleY:{from:1,to:1.1},duration:600,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.scene.tweens.add({targets:this.notificationBadge,alpha:{from:1,to:.3},duration:500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}hidePulse(){this.pulseTween&&(this.pulseTween.stop(),this.pulseTween=void 0),this.button.setScale(1),this.notificationBadge.setVisible(!1),this.notificationBadge.clear()}getButton(){return this.button}}class xr{scene;researchManager;container;gold;onGoldSpent;onResearchComplete;constructor(e,t,s,i,r){this.scene=e,this.researchManager=t,this.gold=s,this.onGoldSpent=i,this.onResearchComplete=r}updateGold(e){this.gold=e}isOpen(){return this.container!==void 0}toggle(){this.isOpen()?this.close():this.show()}show(){const e=this.scene.cameras.main.width,t=this.scene.cameras.main.height;this.container=this.scene.add.container(0,0),this.container.setDepth(1e3);const s=this.scene.add.rectangle(0,0,e,t,0,.8);s.setOrigin(0),s.setInteractive(),this.container.add(s);const i=600,r=500,n=this.scene.add.rectangle(e/2,t/2,i,r,2236962);this.container.add(n);const a=this.scene.add.text(e/2,t/2-r/2+40,"Forschung",{font:"bold 32px Arial",color:"#ffffff"});a.setOrigin(.5),this.container.add(a);const l=this.researchManager.getAvailableResearches(),h=t/2-r/2+100,d=100;if(l.forEach((f,p)=>{const w=h+p*d,C=this.scene.add.rectangle(e/2,w,i-60,d-10,3355443);this.container.add(C);const I=this.scene.add.text(e/2-250,w-20,f.name,{font:"bold 20px Arial",color:"#ffff00"});this.container.add(I);const v=this.scene.add.text(e/2-250,w+5,f.description,{font:"16px Arial",color:"#cccccc"});this.container.add(v);const k=this.scene.add.text(e/2-250,w+30,`Kosten: ${f.goldCost} Gold | ${f.xpRequired} XP`,{font:"14px Arial",color:"#aaaaaa"});this.container.add(k);const O=this.researchManager.canResearch(f.id,this.gold),b=this.scene.add.text(e/2+180,w,"Erforschen",{font:"bold 18px Arial",color:"#ffffff",backgroundColor:O?"#00aa00":"#666666",padding:{x:15,y:8}});b.setOrigin(.5),O&&(b.setInteractive({useHandCursor:!0}),b.on("pointerover",()=>{b.setStyle({backgroundColor:"#00ff00"})}),b.on("pointerout",()=>{b.setStyle({backgroundColor:"#00aa00"})}),b.on("pointerdown",D=>{D.event.stopPropagation(),this.handleResearch(f.id)})),this.container.add(b)}),l.length===0){const f=this.scene.add.text(e/2,t/2,"Keine Forschungen verf√ºgbar",{font:"20px Arial",color:"#888888"});f.setOrigin(.5),this.container.add(f);const p=this.scene.add.text(e/2,t/2+40,"Sammle mehr XP, um neue Forschungen freizuschalten!",{font:"16px Arial",color:"#666666"});p.setOrigin(.5),this.container.add(p)}const u=this.scene.add.text(e/2,t/2+r/2-40,"Schlie√üen",{font:"bold 20px Arial",color:"#ffffff",backgroundColor:"#ff0000",padding:{x:20,y:10}});u.setOrigin(.5),u.setInteractive({useHandCursor:!0}),u.on("pointerover",()=>{u.setStyle({backgroundColor:"#ff4444"})}),u.on("pointerout",()=>{u.setStyle({backgroundColor:"#ff0000"})}),u.on("pointerdown",f=>{f.event.stopPropagation(),this.close()}),this.container.add(u)}close(){this.container&&(this.container.destroy(),this.container=void 0)}handleResearch(e){const t=this.researchManager.getResearch(e);t&&this.researchManager.canResearch(e,this.gold)&&(this.researchManager.research(e),this.onGoldSpent(t.goldCost),this.onResearchComplete(e),this.close(),this.show())}}const{entries:wi,setPrototypeOf:Gs,isFrozen:vr,getPrototypeOf:kr,getOwnPropertyDescriptor:Tr}=Object;let{freeze:Z,seal:re,create:ts}=Object,{apply:ss,construct:is}=typeof Reflect<"u"&&Reflect;Z||(Z=function(e){return e});re||(re=function(e){return e});ss||(ss=function(e,t){for(var s=arguments.length,i=new Array(s>2?s-2:0),r=2;r<s;r++)i[r-2]=arguments[r];return e.apply(t,i)});is||(is=function(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];return new e(...s)});const gt=J(Array.prototype.forEach),Cr=J(Array.prototype.lastIndexOf),qs=J(Array.prototype.pop),Xe=J(Array.prototype.push),Rr=J(Array.prototype.splice),xt=J(String.prototype.toLowerCase),jt=J(String.prototype.toString),Xt=J(String.prototype.match),Ye=J(String.prototype.replace),Er=J(String.prototype.indexOf),_r=J(String.prototype.trim),oe=J(Object.prototype.hasOwnProperty),K=J(RegExp.prototype.test),Ke=Pr(TypeError);function J(o){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];return ss(o,e,s)}}function Pr(o){return function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return is(o,t)}}function T(o,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:xt;Gs&&Gs(o,null);let s=e.length;for(;s--;){let i=e[s];if(typeof i=="string"){const r=t(i);r!==i&&(vr(e)||(e[s]=r),i=r)}o[i]=!0}return o}function Mr(o){for(let e=0;e<o.length;e++)oe(o,e)||(o[e]=null);return o}function be(o){const e=ts(null);for(const[t,s]of wi(o))oe(o,t)&&(Array.isArray(s)?e[t]=Mr(s):s&&typeof s=="object"&&s.constructor===Object?e[t]=be(s):e[t]=s);return e}function Ze(o,e){for(;o!==null;){const s=Tr(o,e);if(s){if(s.get)return J(s.get);if(typeof s.value=="function")return J(s.value)}o=kr(o)}function t(){return null}return t}const Vs=Z(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),Yt=Z(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Kt=Z(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Ar=Z(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),Zt=Z(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),Ir=Z(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),js=Z(["#text"]),Xs=Z(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),Jt=Z(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Ys=Z(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),mt=Z(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Lr=re(/\{\{[\w\W]*|[\w\W]*\}\}/gm),Br=re(/<%[\w\W]*|[\w\W]*%>/gm),Or=re(/\$\{[\w\W]*/gm),Dr=re(/^data-[\-\w.\u00B7-\uFFFF]+$/),Ur=re(/^aria-[\-\w]+$/),bi=re(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Nr=re(/^(?:\w+script|data):/i),$r=re(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),Si=re(/^html$/i),Hr=re(/^[a-z][.\w]*(-[.\w]+)+$/i);var Ks=Object.freeze({__proto__:null,ARIA_ATTR:Ur,ATTR_WHITESPACE:$r,CUSTOM_ELEMENT:Hr,DATA_ATTR:Dr,DOCTYPE_NAME:Si,ERB_EXPR:Br,IS_ALLOWED_URI:bi,IS_SCRIPT_OR_DATA:Nr,MUSTACHE_EXPR:Lr,TMPLIT_EXPR:Or});const Je={element:1,text:3,progressingInstruction:7,comment:8,document:9},Wr=function(){return typeof window>"u"?null:window},Fr=function(e,t){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let s=null;const i="data-tt-policy-suffix";t&&t.hasAttribute(i)&&(s=t.getAttribute(i));const r="dompurify"+(s?"#"+s:"");try{return e.createPolicy(r,{createHTML(n){return n},createScriptURL(n){return n}})}catch{return console.warn("TrustedTypes policy "+r+" could not be created."),null}},Zs=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function xi(){let o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Wr();const e=S=>xi(S);if(e.version="3.3.0",e.removed=[],!o||!o.document||o.document.nodeType!==Je.document||!o.Element)return e.isSupported=!1,e;let{document:t}=o;const s=t,i=s.currentScript,{DocumentFragment:r,HTMLTemplateElement:n,Node:a,Element:l,NodeFilter:h,NamedNodeMap:d=o.NamedNodeMap||o.MozNamedAttrMap,HTMLFormElement:u,DOMParser:f,trustedTypes:p}=o,w=l.prototype,C=Ze(w,"cloneNode"),I=Ze(w,"remove"),v=Ze(w,"nextSibling"),k=Ze(w,"childNodes"),O=Ze(w,"parentNode");if(typeof n=="function"){const S=t.createElement("template");S.content&&S.content.ownerDocument&&(t=S.content.ownerDocument)}let b,D="";const{implementation:A,createNodeIterator:_,createDocumentFragment:U,getElementsByTagName:H}=t,{importNode:z}=s;let W=Zs();e.isSupported=typeof wi=="function"&&typeof O=="function"&&A&&A.createHTMLDocument!==void 0;const{MUSTACHE_EXPR:ee,ERB_EXPR:We,TMPLIT_EXPR:Fe,DATA_ATTR:Ge,ARIA_ATTR:nt,IS_SCRIPT_OR_DATA:ot,ATTR_WHITESPACE:at,CUSTOM_ELEMENT:qe}=Ks;let{IS_ALLOWED_URI:q}=Ks,P=null;const te=T({},[...Vs,...Yt,...Kt,...Zt,...js]);let N=null;const ne=T({},[...Xs,...Jt,...Ys,...mt]);let M=Object.seal(ts(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),ce=null,Se=null;const Me=Object.seal(ts(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}}));let Ss=!0,Bt=!0,xs=!1,vs=!0,Ae=!1,lt=!0,Ce=!1,Ot=!1,Dt=!1,Ie=!1,ct=!1,ht=!1,ks=!0,Ts=!1;const Hi="user-content-";let Ut=!0,Ve=!1,Le={},Be=null;const Cs=T({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let Rs=null;const Es=T({},["audio","video","img","source","image","track"]);let Nt=null;const _s=T({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),dt="http://www.w3.org/1998/Math/MathML",ut="http://www.w3.org/2000/svg",me="http://www.w3.org/1999/xhtml";let Oe=me,$t=!1,Ht=null;const Wi=T({},[dt,ut,me],jt);let pt=T({},["mi","mo","mn","ms","mtext"]),ft=T({},["annotation-xml"]);const Fi=T({},["title","style","font","a","script"]);let je=null;const Gi=["application/xhtml+xml","text/html"],qi="text/html";let V=null,De=null;const Vi=t.createElement("form"),Ps=function(c){return c instanceof RegExp||c instanceof Function},Wt=function(){let c=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(De&&De===c)){if((!c||typeof c!="object")&&(c={}),c=be(c),je=Gi.indexOf(c.PARSER_MEDIA_TYPE)===-1?qi:c.PARSER_MEDIA_TYPE,V=je==="application/xhtml+xml"?jt:xt,P=oe(c,"ALLOWED_TAGS")?T({},c.ALLOWED_TAGS,V):te,N=oe(c,"ALLOWED_ATTR")?T({},c.ALLOWED_ATTR,V):ne,Ht=oe(c,"ALLOWED_NAMESPACES")?T({},c.ALLOWED_NAMESPACES,jt):Wi,Nt=oe(c,"ADD_URI_SAFE_ATTR")?T(be(_s),c.ADD_URI_SAFE_ATTR,V):_s,Rs=oe(c,"ADD_DATA_URI_TAGS")?T(be(Es),c.ADD_DATA_URI_TAGS,V):Es,Be=oe(c,"FORBID_CONTENTS")?T({},c.FORBID_CONTENTS,V):Cs,ce=oe(c,"FORBID_TAGS")?T({},c.FORBID_TAGS,V):be({}),Se=oe(c,"FORBID_ATTR")?T({},c.FORBID_ATTR,V):be({}),Le=oe(c,"USE_PROFILES")?c.USE_PROFILES:!1,Ss=c.ALLOW_ARIA_ATTR!==!1,Bt=c.ALLOW_DATA_ATTR!==!1,xs=c.ALLOW_UNKNOWN_PROTOCOLS||!1,vs=c.ALLOW_SELF_CLOSE_IN_ATTR!==!1,Ae=c.SAFE_FOR_TEMPLATES||!1,lt=c.SAFE_FOR_XML!==!1,Ce=c.WHOLE_DOCUMENT||!1,Ie=c.RETURN_DOM||!1,ct=c.RETURN_DOM_FRAGMENT||!1,ht=c.RETURN_TRUSTED_TYPE||!1,Dt=c.FORCE_BODY||!1,ks=c.SANITIZE_DOM!==!1,Ts=c.SANITIZE_NAMED_PROPS||!1,Ut=c.KEEP_CONTENT!==!1,Ve=c.IN_PLACE||!1,q=c.ALLOWED_URI_REGEXP||bi,Oe=c.NAMESPACE||me,pt=c.MATHML_TEXT_INTEGRATION_POINTS||pt,ft=c.HTML_INTEGRATION_POINTS||ft,M=c.CUSTOM_ELEMENT_HANDLING||{},c.CUSTOM_ELEMENT_HANDLING&&Ps(c.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(M.tagNameCheck=c.CUSTOM_ELEMENT_HANDLING.tagNameCheck),c.CUSTOM_ELEMENT_HANDLING&&Ps(c.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(M.attributeNameCheck=c.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),c.CUSTOM_ELEMENT_HANDLING&&typeof c.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(M.allowCustomizedBuiltInElements=c.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Ae&&(Bt=!1),ct&&(Ie=!0),Le&&(P=T({},js),N=[],Le.html===!0&&(T(P,Vs),T(N,Xs)),Le.svg===!0&&(T(P,Yt),T(N,Jt),T(N,mt)),Le.svgFilters===!0&&(T(P,Kt),T(N,Jt),T(N,mt)),Le.mathMl===!0&&(T(P,Zt),T(N,Ys),T(N,mt))),c.ADD_TAGS&&(typeof c.ADD_TAGS=="function"?Me.tagCheck=c.ADD_TAGS:(P===te&&(P=be(P)),T(P,c.ADD_TAGS,V))),c.ADD_ATTR&&(typeof c.ADD_ATTR=="function"?Me.attributeCheck=c.ADD_ATTR:(N===ne&&(N=be(N)),T(N,c.ADD_ATTR,V))),c.ADD_URI_SAFE_ATTR&&T(Nt,c.ADD_URI_SAFE_ATTR,V),c.FORBID_CONTENTS&&(Be===Cs&&(Be=be(Be)),T(Be,c.FORBID_CONTENTS,V)),Ut&&(P["#text"]=!0),Ce&&T(P,["html","head","body"]),P.table&&(T(P,["tbody"]),delete ce.tbody),c.TRUSTED_TYPES_POLICY){if(typeof c.TRUSTED_TYPES_POLICY.createHTML!="function")throw Ke('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof c.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw Ke('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');b=c.TRUSTED_TYPES_POLICY,D=b.createHTML("")}else b===void 0&&(b=Fr(p,i)),b!==null&&typeof D=="string"&&(D=b.createHTML(""));Z&&Z(c),De=c}},Ms=T({},[...Yt,...Kt,...Ar]),As=T({},[...Zt,...Ir]),ji=function(c){let g=O(c);(!g||!g.tagName)&&(g={namespaceURI:Oe,tagName:"template"});const y=xt(c.tagName),$=xt(g.tagName);return Ht[c.namespaceURI]?c.namespaceURI===ut?g.namespaceURI===me?y==="svg":g.namespaceURI===dt?y==="svg"&&($==="annotation-xml"||pt[$]):!!Ms[y]:c.namespaceURI===dt?g.namespaceURI===me?y==="math":g.namespaceURI===ut?y==="math"&&ft[$]:!!As[y]:c.namespaceURI===me?g.namespaceURI===ut&&!ft[$]||g.namespaceURI===dt&&!pt[$]?!1:!As[y]&&(Fi[y]||!Ms[y]):!!(je==="application/xhtml+xml"&&Ht[c.namespaceURI]):!1},he=function(c){Xe(e.removed,{element:c});try{O(c).removeChild(c)}catch{I(c)}},Re=function(c,g){try{Xe(e.removed,{attribute:g.getAttributeNode(c),from:g})}catch{Xe(e.removed,{attribute:null,from:g})}if(g.removeAttribute(c),c==="is")if(Ie||ct)try{he(g)}catch{}else try{g.setAttribute(c,"")}catch{}},Is=function(c){let g=null,y=null;if(Dt)c="<remove></remove>"+c;else{const F=Xt(c,/^[\r\n\t ]+/);y=F&&F[0]}je==="application/xhtml+xml"&&Oe===me&&(c='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+c+"</body></html>");const $=b?b.createHTML(c):c;if(Oe===me)try{g=new f().parseFromString($,je)}catch{}if(!g||!g.documentElement){g=A.createDocument(Oe,"template",null);try{g.documentElement.innerHTML=$t?D:$}catch{}}const X=g.body||g.documentElement;return c&&y&&X.insertBefore(t.createTextNode(y),X.childNodes[0]||null),Oe===me?H.call(g,Ce?"html":"body")[0]:Ce?g.documentElement:X},Ls=function(c){return _.call(c.ownerDocument||c,c,h.SHOW_ELEMENT|h.SHOW_COMMENT|h.SHOW_TEXT|h.SHOW_PROCESSING_INSTRUCTION|h.SHOW_CDATA_SECTION,null)},Ft=function(c){return c instanceof u&&(typeof c.nodeName!="string"||typeof c.textContent!="string"||typeof c.removeChild!="function"||!(c.attributes instanceof d)||typeof c.removeAttribute!="function"||typeof c.setAttribute!="function"||typeof c.namespaceURI!="string"||typeof c.insertBefore!="function"||typeof c.hasChildNodes!="function")},Bs=function(c){return typeof a=="function"&&c instanceof a};function ye(S,c,g){gt(S,y=>{y.call(e,c,g,De)})}const Os=function(c){let g=null;if(ye(W.beforeSanitizeElements,c,null),Ft(c))return he(c),!0;const y=V(c.nodeName);if(ye(W.uponSanitizeElement,c,{tagName:y,allowedTags:P}),lt&&c.hasChildNodes()&&!Bs(c.firstElementChild)&&K(/<[/\w!]/g,c.innerHTML)&&K(/<[/\w!]/g,c.textContent)||c.nodeType===Je.progressingInstruction||lt&&c.nodeType===Je.comment&&K(/<[/\w]/g,c.data))return he(c),!0;if(!(Me.tagCheck instanceof Function&&Me.tagCheck(y))&&(!P[y]||ce[y])){if(!ce[y]&&Us(y)&&(M.tagNameCheck instanceof RegExp&&K(M.tagNameCheck,y)||M.tagNameCheck instanceof Function&&M.tagNameCheck(y)))return!1;if(Ut&&!Be[y]){const $=O(c)||c.parentNode,X=k(c)||c.childNodes;if(X&&$){const F=X.length;for(let Q=F-1;Q>=0;--Q){const we=C(X[Q],!0);we.__removalCount=(c.__removalCount||0)+1,$.insertBefore(we,v(c))}}}return he(c),!0}return c instanceof l&&!ji(c)||(y==="noscript"||y==="noembed"||y==="noframes")&&K(/<\/no(script|embed|frames)/i,c.innerHTML)?(he(c),!0):(Ae&&c.nodeType===Je.text&&(g=c.textContent,gt([ee,We,Fe],$=>{g=Ye(g,$," ")}),c.textContent!==g&&(Xe(e.removed,{element:c.cloneNode()}),c.textContent=g)),ye(W.afterSanitizeElements,c,null),!1)},Ds=function(c,g,y){if(ks&&(g==="id"||g==="name")&&(y in t||y in Vi))return!1;if(!(Bt&&!Se[g]&&K(Ge,g))){if(!(Ss&&K(nt,g))){if(!(Me.attributeCheck instanceof Function&&Me.attributeCheck(g,c))){if(!N[g]||Se[g]){if(!(Us(c)&&(M.tagNameCheck instanceof RegExp&&K(M.tagNameCheck,c)||M.tagNameCheck instanceof Function&&M.tagNameCheck(c))&&(M.attributeNameCheck instanceof RegExp&&K(M.attributeNameCheck,g)||M.attributeNameCheck instanceof Function&&M.attributeNameCheck(g,c))||g==="is"&&M.allowCustomizedBuiltInElements&&(M.tagNameCheck instanceof RegExp&&K(M.tagNameCheck,y)||M.tagNameCheck instanceof Function&&M.tagNameCheck(y))))return!1}else if(!Nt[g]){if(!K(q,Ye(y,at,""))){if(!((g==="src"||g==="xlink:href"||g==="href")&&c!=="script"&&Er(y,"data:")===0&&Rs[c])){if(!(xs&&!K(ot,Ye(y,at,"")))){if(y)return!1}}}}}}}return!0},Us=function(c){return c!=="annotation-xml"&&Xt(c,qe)},Ns=function(c){ye(W.beforeSanitizeAttributes,c,null);const{attributes:g}=c;if(!g||Ft(c))return;const y={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:N,forceKeepAttr:void 0};let $=g.length;for(;$--;){const X=g[$],{name:F,namespaceURI:Q,value:we}=X,Ue=V(F),Gt=we;let j=F==="value"?Gt:_r(Gt);if(y.attrName=Ue,y.attrValue=j,y.keepAttr=!0,y.forceKeepAttr=void 0,ye(W.uponSanitizeAttribute,c,y),j=y.attrValue,Ts&&(Ue==="id"||Ue==="name")&&(Re(F,c),j=Hi+j),lt&&K(/((--!?|])>)|<\/(style|title|textarea)/i,j)){Re(F,c);continue}if(Ue==="attributename"&&Xt(j,"href")){Re(F,c);continue}if(y.forceKeepAttr)continue;if(!y.keepAttr){Re(F,c);continue}if(!vs&&K(/\/>/i,j)){Re(F,c);continue}Ae&&gt([ee,We,Fe],Hs=>{j=Ye(j,Hs," ")});const $s=V(c.nodeName);if(!Ds($s,Ue,j)){Re(F,c);continue}if(b&&typeof p=="object"&&typeof p.getAttributeType=="function"&&!Q)switch(p.getAttributeType($s,Ue)){case"TrustedHTML":{j=b.createHTML(j);break}case"TrustedScriptURL":{j=b.createScriptURL(j);break}}if(j!==Gt)try{Q?c.setAttributeNS(Q,F,j):c.setAttribute(F,j),Ft(c)?he(c):qs(e.removed)}catch{Re(F,c)}}ye(W.afterSanitizeAttributes,c,null)},Xi=function S(c){let g=null;const y=Ls(c);for(ye(W.beforeSanitizeShadowDOM,c,null);g=y.nextNode();)ye(W.uponSanitizeShadowNode,g,null),Os(g),Ns(g),g.content instanceof r&&S(g.content);ye(W.afterSanitizeShadowDOM,c,null)};return e.sanitize=function(S){let c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},g=null,y=null,$=null,X=null;if($t=!S,$t&&(S="<!-->"),typeof S!="string"&&!Bs(S))if(typeof S.toString=="function"){if(S=S.toString(),typeof S!="string")throw Ke("dirty is not a string, aborting")}else throw Ke("toString is not a function");if(!e.isSupported)return S;if(Ot||Wt(c),e.removed=[],typeof S=="string"&&(Ve=!1),Ve){if(S.nodeName){const we=V(S.nodeName);if(!P[we]||ce[we])throw Ke("root node is forbidden and cannot be sanitized in-place")}}else if(S instanceof a)g=Is("<!---->"),y=g.ownerDocument.importNode(S,!0),y.nodeType===Je.element&&y.nodeName==="BODY"||y.nodeName==="HTML"?g=y:g.appendChild(y);else{if(!Ie&&!Ae&&!Ce&&S.indexOf("<")===-1)return b&&ht?b.createHTML(S):S;if(g=Is(S),!g)return Ie?null:ht?D:""}g&&Dt&&he(g.firstChild);const F=Ls(Ve?S:g);for(;$=F.nextNode();)Os($),Ns($),$.content instanceof r&&Xi($.content);if(Ve)return S;if(Ie){if(ct)for(X=U.call(g.ownerDocument);g.firstChild;)X.appendChild(g.firstChild);else X=g;return(N.shadowroot||N.shadowrootmode)&&(X=z.call(s,X,!0)),X}let Q=Ce?g.outerHTML:g.innerHTML;return Ce&&P["!doctype"]&&g.ownerDocument&&g.ownerDocument.doctype&&g.ownerDocument.doctype.name&&K(Si,g.ownerDocument.doctype.name)&&(Q="<!DOCTYPE "+g.ownerDocument.doctype.name+`>
`+Q),Ae&&gt([ee,We,Fe],we=>{Q=Ye(Q,we," ")}),b&&ht?b.createHTML(Q):Q},e.setConfig=function(){let S=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Wt(S),Ot=!0},e.clearConfig=function(){De=null,Ot=!1},e.isValidAttribute=function(S,c,g){De||Wt({});const y=V(S),$=V(c);return Ds(y,$,g)},e.addHook=function(S,c){typeof c=="function"&&Xe(W[S],c)},e.removeHook=function(S,c){if(c!==void 0){const g=Cr(W[S],c);return g===-1?void 0:Rr(W[S],g,1)[0]}return qs(W[S])},e.removeHooks=function(S){W[S]=[]},e.removeAllHooks=function(){W=Zs()},e}var Gr=xi();function us(){return{async:!1,baseUrl:null,breaks:!1,extensions:null,gfm:!0,headerIds:!0,headerPrefix:"",highlight:null,hooks:null,langPrefix:"language-",mangle:!0,pedantic:!1,renderer:null,sanitize:!1,sanitizer:null,silent:!1,smartypants:!1,tokenizer:null,walkTokens:null,xhtml:!1}}let Te=us();function vi(o){Te=o}const ki=/[&<>"']/,qr=new RegExp(ki.source,"g"),Ti=/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,Vr=new RegExp(Ti.source,"g"),jr={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Js=o=>jr[o];function Y(o,e){if(e){if(ki.test(o))return o.replace(qr,Js)}else if(Ti.test(o))return o.replace(Vr,Js);return o}const Xr=/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig;function Ci(o){return o.replace(Xr,(e,t)=>(t=t.toLowerCase(),t==="colon"?":":t.charAt(0)==="#"?t.charAt(1)==="x"?String.fromCharCode(parseInt(t.substring(2),16)):String.fromCharCode(+t.substring(1)):""))}const Yr=/(^|[^\[])\^/g;function B(o,e){o=typeof o=="string"?o:o.source,e=e||"";const t={replace:(s,i)=>(i=i.source||i,i=i.replace(Yr,"$1"),o=o.replace(s,i),t),getRegex:()=>new RegExp(o,e)};return t}const Kr=/[^\w:]/g,Zr=/^$|^[a-z][a-z0-9+.-]*:|^[?#]/i;function Qs(o,e,t){if(o){let s;try{s=decodeURIComponent(Ci(t)).replace(Kr,"").toLowerCase()}catch{return null}if(s.indexOf("javascript:")===0||s.indexOf("vbscript:")===0||s.indexOf("data:")===0)return null}e&&!Zr.test(t)&&(t=en(e,t));try{t=encodeURI(t).replace(/%25/g,"%")}catch{return null}return t}const yt={},Jr=/^[^:]+:\/*[^/]*$/,Qr=/^([^:]+:)[\s\S]*$/,zr=/^([^:]+:\/*[^/]*)[\s\S]*$/;function en(o,e){yt[" "+o]||(Jr.test(o)?yt[" "+o]=o+"/":yt[" "+o]=vt(o,"/",!0)),o=yt[" "+o];const t=o.indexOf(":")===-1;return e.substring(0,2)==="//"?t?e:o.replace(Qr,"$1")+e:e.charAt(0)==="/"?t?e:o.replace(zr,"$1")+e:o+e}const Pt={exec:function(){}};function zs(o,e){const t=o.replace(/\|/g,(r,n,a)=>{let l=!1,h=n;for(;--h>=0&&a[h]==="\\";)l=!l;return l?"|":" |"}),s=t.split(/ \|/);let i=0;if(s[0].trim()||s.shift(),s.length>0&&!s[s.length-1].trim()&&s.pop(),s.length>e)s.splice(e);else for(;s.length<e;)s.push("");for(;i<s.length;i++)s[i]=s[i].trim().replace(/\\\|/g,"|");return s}function vt(o,e,t){const s=o.length;if(s===0)return"";let i=0;for(;i<s;){const r=o.charAt(s-i-1);if(r===e&&!t)i++;else if(r!==e&&t)i++;else break}return o.slice(0,s-i)}function tn(o,e){if(o.indexOf(e[1])===-1)return-1;const t=o.length;let s=0,i=0;for(;i<t;i++)if(o[i]==="\\")i++;else if(o[i]===e[0])s++;else if(o[i]===e[1]&&(s--,s<0))return i;return-1}function sn(o,e){!o||o.silent||(e&&console.warn("marked(): callback is deprecated since version 5.0.0, should not be used and will be removed in the future. Read more here: https://marked.js.org/using_pro#async"),(o.sanitize||o.sanitizer)&&console.warn("marked(): sanitize and sanitizer parameters are deprecated since version 0.7.0, should not be used and will be removed in the future. Read more here: https://marked.js.org/#/USING_ADVANCED.md#options"),(o.highlight||o.langPrefix!=="language-")&&console.warn("marked(): highlight and langPrefix parameters are deprecated since version 5.0.0, should not be used and will be removed in the future. Instead use https://www.npmjs.com/package/marked-highlight."),o.mangle&&console.warn("marked(): mangle parameter is enabled by default, but is deprecated since version 5.0.0, and will be removed in the future. To clear this warning, install https://www.npmjs.com/package/marked-mangle, or disable by setting `{mangle: false}`."),o.baseUrl&&console.warn("marked(): baseUrl parameter is deprecated since version 5.0.0, should not be used and will be removed in the future. Instead use https://www.npmjs.com/package/marked-base-url."),o.smartypants&&console.warn("marked(): smartypants parameter is deprecated since version 5.0.0, should not be used and will be removed in the future. Instead use https://www.npmjs.com/package/marked-smartypants."),o.xhtml&&console.warn("marked(): xhtml parameter is deprecated since version 5.0.0, should not be used and will be removed in the future. Instead use https://www.npmjs.com/package/marked-xhtml."),(o.headerIds||o.headerPrefix)&&console.warn("marked(): headerIds and headerPrefix parameters enabled by default, but are deprecated since version 5.0.0, and will be removed in the future. To clear this warning, install  https://www.npmjs.com/package/marked-gfm-heading-id, or disable by setting `{headerIds: false}`."))}function ei(o,e,t,s){const i=e.href,r=e.title?Y(e.title):null,n=o[1].replace(/\\([\[\]])/g,"$1");if(o[0].charAt(0)!=="!"){s.state.inLink=!0;const a={type:"link",raw:t,href:i,title:r,text:n,tokens:s.inlineTokens(n)};return s.state.inLink=!1,a}return{type:"image",raw:t,href:i,title:r,text:Y(n)}}function rn(o,e){const t=o.match(/^(\s+)(?:```)/);if(t===null)return e;const s=t[1];return e.split(`
`).map(i=>{const r=i.match(/^\s+/);if(r===null)return i;const[n]=r;return n.length>=s.length?i.slice(s.length):i}).join(`
`)}class Mt{constructor(e){this.options=e||Te}space(e){const t=this.rules.block.newline.exec(e);if(t&&t[0].length>0)return{type:"space",raw:t[0]}}code(e){const t=this.rules.block.code.exec(e);if(t){const s=t[0].replace(/^ {1,4}/gm,"");return{type:"code",raw:t[0],codeBlockStyle:"indented",text:this.options.pedantic?s:vt(s,`
`)}}}fences(e){const t=this.rules.block.fences.exec(e);if(t){const s=t[0],i=rn(s,t[3]||"");return{type:"code",raw:s,lang:t[2]?t[2].trim().replace(this.rules.inline._escapes,"$1"):t[2],text:i}}}heading(e){const t=this.rules.block.heading.exec(e);if(t){let s=t[2].trim();if(/#$/.test(s)){const i=vt(s,"#");(this.options.pedantic||!i||/ $/.test(i))&&(s=i.trim())}return{type:"heading",raw:t[0],depth:t[1].length,text:s,tokens:this.lexer.inline(s)}}}hr(e){const t=this.rules.block.hr.exec(e);if(t)return{type:"hr",raw:t[0]}}blockquote(e){const t=this.rules.block.blockquote.exec(e);if(t){const s=t[0].replace(/^ *>[ \t]?/gm,""),i=this.lexer.state.top;this.lexer.state.top=!0;const r=this.lexer.blockTokens(s);return this.lexer.state.top=i,{type:"blockquote",raw:t[0],tokens:r,text:s}}}list(e){let t=this.rules.block.list.exec(e);if(t){let s,i,r,n,a,l,h,d,u,f,p,w,C=t[1].trim();const I=C.length>1,v={type:"list",raw:"",ordered:I,start:I?+C.slice(0,-1):"",loose:!1,items:[]};C=I?`\\d{1,9}\\${C.slice(-1)}`:`\\${C}`,this.options.pedantic&&(C=I?C:"[*+-]");const k=new RegExp(`^( {0,3}${C})((?:[	 ][^\\n]*)?(?:\\n|$))`);for(;e&&(w=!1,!(!(t=k.exec(e))||this.rules.block.hr.test(e)));){if(s=t[0],e=e.substring(s.length),d=t[2].split(`
`,1)[0].replace(/^\t+/,b=>" ".repeat(3*b.length)),u=e.split(`
`,1)[0],this.options.pedantic?(n=2,p=d.trimLeft()):(n=t[2].search(/[^ ]/),n=n>4?1:n,p=d.slice(n),n+=t[1].length),l=!1,!d&&/^ *$/.test(u)&&(s+=u+`
`,e=e.substring(u.length+1),w=!0),!w){const b=new RegExp(`^ {0,${Math.min(3,n-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),D=new RegExp(`^ {0,${Math.min(3,n-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),A=new RegExp(`^ {0,${Math.min(3,n-1)}}(?:\`\`\`|~~~)`),_=new RegExp(`^ {0,${Math.min(3,n-1)}}#`);for(;e&&(f=e.split(`
`,1)[0],u=f,this.options.pedantic&&(u=u.replace(/^ {1,4}(?=( {4})*[^ ])/g,"  ")),!(A.test(u)||_.test(u)||b.test(u)||D.test(e)));){if(u.search(/[^ ]/)>=n||!u.trim())p+=`
`+u.slice(n);else{if(l||d.search(/[^ ]/)>=4||A.test(d)||_.test(d)||D.test(d))break;p+=`
`+u}!l&&!u.trim()&&(l=!0),s+=f+`
`,e=e.substring(f.length+1),d=u.slice(n)}}v.loose||(h?v.loose=!0:/\n *\n *$/.test(s)&&(h=!0)),this.options.gfm&&(i=/^\[[ xX]\] /.exec(p),i&&(r=i[0]!=="[ ] ",p=p.replace(/^\[[ xX]\] +/,""))),v.items.push({type:"list_item",raw:s,task:!!i,checked:r,loose:!1,text:p}),v.raw+=s}v.items[v.items.length-1].raw=s.trimRight(),v.items[v.items.length-1].text=p.trimRight(),v.raw=v.raw.trimRight();const O=v.items.length;for(a=0;a<O;a++)if(this.lexer.state.top=!1,v.items[a].tokens=this.lexer.blockTokens(v.items[a].text,[]),!v.loose){const b=v.items[a].tokens.filter(A=>A.type==="space"),D=b.length>0&&b.some(A=>/\n.*\n/.test(A.raw));v.loose=D}if(v.loose)for(a=0;a<O;a++)v.items[a].loose=!0;return v}}html(e){const t=this.rules.block.html.exec(e);if(t){const s={type:"html",block:!0,raw:t[0],pre:!this.options.sanitizer&&(t[1]==="pre"||t[1]==="script"||t[1]==="style"),text:t[0]};if(this.options.sanitize){const i=this.options.sanitizer?this.options.sanitizer(t[0]):Y(t[0]);s.type="paragraph",s.text=i,s.tokens=this.lexer.inline(i)}return s}}def(e){const t=this.rules.block.def.exec(e);if(t){const s=t[1].toLowerCase().replace(/\s+/g," "),i=t[2]?t[2].replace(/^<(.*)>$/,"$1").replace(this.rules.inline._escapes,"$1"):"",r=t[3]?t[3].substring(1,t[3].length-1).replace(this.rules.inline._escapes,"$1"):t[3];return{type:"def",tag:s,raw:t[0],href:i,title:r}}}table(e){const t=this.rules.block.table.exec(e);if(t){const s={type:"table",header:zs(t[1]).map(i=>({text:i})),align:t[2].replace(/^ *|\| *$/g,"").split(/ *\| */),rows:t[3]&&t[3].trim()?t[3].replace(/\n[ \t]*$/,"").split(`
`):[]};if(s.header.length===s.align.length){s.raw=t[0];let i=s.align.length,r,n,a,l;for(r=0;r<i;r++)/^ *-+: *$/.test(s.align[r])?s.align[r]="right":/^ *:-+: *$/.test(s.align[r])?s.align[r]="center":/^ *:-+ *$/.test(s.align[r])?s.align[r]="left":s.align[r]=null;for(i=s.rows.length,r=0;r<i;r++)s.rows[r]=zs(s.rows[r],s.header.length).map(h=>({text:h}));for(i=s.header.length,n=0;n<i;n++)s.header[n].tokens=this.lexer.inline(s.header[n].text);for(i=s.rows.length,n=0;n<i;n++)for(l=s.rows[n],a=0;a<l.length;a++)l[a].tokens=this.lexer.inline(l[a].text);return s}}}lheading(e){const t=this.rules.block.lheading.exec(e);if(t)return{type:"heading",raw:t[0],depth:t[2].charAt(0)==="="?1:2,text:t[1],tokens:this.lexer.inline(t[1])}}paragraph(e){const t=this.rules.block.paragraph.exec(e);if(t){const s=t[1].charAt(t[1].length-1)===`
`?t[1].slice(0,-1):t[1];return{type:"paragraph",raw:t[0],text:s,tokens:this.lexer.inline(s)}}}text(e){const t=this.rules.block.text.exec(e);if(t)return{type:"text",raw:t[0],text:t[0],tokens:this.lexer.inline(t[0])}}escape(e){const t=this.rules.inline.escape.exec(e);if(t)return{type:"escape",raw:t[0],text:Y(t[1])}}tag(e){const t=this.rules.inline.tag.exec(e);if(t)return!this.lexer.state.inLink&&/^<a /i.test(t[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&/^<\/a>/i.test(t[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&/^<(pre|code|kbd|script)(\s|>)/i.test(t[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&/^<\/(pre|code|kbd|script)(\s|>)/i.test(t[0])&&(this.lexer.state.inRawBlock=!1),{type:this.options.sanitize?"text":"html",raw:t[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:this.options.sanitize?this.options.sanitizer?this.options.sanitizer(t[0]):Y(t[0]):t[0]}}link(e){const t=this.rules.inline.link.exec(e);if(t){const s=t[2].trim();if(!this.options.pedantic&&/^</.test(s)){if(!/>$/.test(s))return;const n=vt(s.slice(0,-1),"\\");if((s.length-n.length)%2===0)return}else{const n=tn(t[2],"()");if(n>-1){const l=(t[0].indexOf("!")===0?5:4)+t[1].length+n;t[2]=t[2].substring(0,n),t[0]=t[0].substring(0,l).trim(),t[3]=""}}let i=t[2],r="";if(this.options.pedantic){const n=/^([^'"]*[^\s])\s+(['"])(.*)\2/.exec(i);n&&(i=n[1],r=n[3])}else r=t[3]?t[3].slice(1,-1):"";return i=i.trim(),/^</.test(i)&&(this.options.pedantic&&!/>$/.test(s)?i=i.slice(1):i=i.slice(1,-1)),ei(t,{href:i&&i.replace(this.rules.inline._escapes,"$1"),title:r&&r.replace(this.rules.inline._escapes,"$1")},t[0],this.lexer)}}reflink(e,t){let s;if((s=this.rules.inline.reflink.exec(e))||(s=this.rules.inline.nolink.exec(e))){let i=(s[2]||s[1]).replace(/\s+/g," ");if(i=t[i.toLowerCase()],!i){const r=s[0].charAt(0);return{type:"text",raw:r,text:r}}return ei(s,i,s[0],this.lexer)}}emStrong(e,t,s=""){let i=this.rules.inline.emStrong.lDelim.exec(e);if(!i||i[3]&&s.match(/[\p{L}\p{N}]/u))return;if(!(i[1]||i[2]||"")||!s||this.rules.inline.punctuation.exec(s)){const n=i[0].length-1;let a,l,h=n,d=0;const u=i[0][0]==="*"?this.rules.inline.emStrong.rDelimAst:this.rules.inline.emStrong.rDelimUnd;for(u.lastIndex=0,t=t.slice(-1*e.length+n);(i=u.exec(t))!=null;){if(a=i[1]||i[2]||i[3]||i[4]||i[5]||i[6],!a)continue;if(l=a.length,i[3]||i[4]){h+=l;continue}else if((i[5]||i[6])&&n%3&&!((n+l)%3)){d+=l;continue}if(h-=l,h>0)continue;l=Math.min(l,l+h+d);const f=e.slice(0,n+i.index+l+1);if(Math.min(n,l)%2){const w=f.slice(1,-1);return{type:"em",raw:f,text:w,tokens:this.lexer.inlineTokens(w)}}const p=f.slice(2,-2);return{type:"strong",raw:f,text:p,tokens:this.lexer.inlineTokens(p)}}}}codespan(e){const t=this.rules.inline.code.exec(e);if(t){let s=t[2].replace(/\n/g," ");const i=/[^ ]/.test(s),r=/^ /.test(s)&&/ $/.test(s);return i&&r&&(s=s.substring(1,s.length-1)),s=Y(s,!0),{type:"codespan",raw:t[0],text:s}}}br(e){const t=this.rules.inline.br.exec(e);if(t)return{type:"br",raw:t[0]}}del(e){const t=this.rules.inline.del.exec(e);if(t)return{type:"del",raw:t[0],text:t[2],tokens:this.lexer.inlineTokens(t[2])}}autolink(e,t){const s=this.rules.inline.autolink.exec(e);if(s){let i,r;return s[2]==="@"?(i=Y(this.options.mangle?t(s[1]):s[1]),r="mailto:"+i):(i=Y(s[1]),r=i),{type:"link",raw:s[0],text:i,href:r,tokens:[{type:"text",raw:i,text:i}]}}}url(e,t){let s;if(s=this.rules.inline.url.exec(e)){let i,r;if(s[2]==="@")i=Y(this.options.mangle?t(s[0]):s[0]),r="mailto:"+i;else{let n;do n=s[0],s[0]=this.rules.inline._backpedal.exec(s[0])[0];while(n!==s[0]);i=Y(s[0]),s[1]==="www."?r="http://"+s[0]:r=s[0]}return{type:"link",raw:s[0],text:i,href:r,tokens:[{type:"text",raw:i,text:i}]}}}inlineText(e,t){const s=this.rules.inline.text.exec(e);if(s){let i;return this.lexer.state.inRawBlock?i=this.options.sanitize?this.options.sanitizer?this.options.sanitizer(s[0]):Y(s[0]):s[0]:i=Y(this.options.smartypants?t(s[0]):s[0]),{type:"text",raw:s[0],text:i}}}}const x={newline:/^(?: *(?:\n|$))+/,code:/^( {4}[^\n]+(?:\n(?: *(?:\n|$))*)?)+/,fences:/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,hr:/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,heading:/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,blockquote:/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/,list:/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/,html:"^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n *)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n *)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n *)+\\n|$))",def:/^ {0,3}\[(label)\]: *(?:\n *)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n *)?| *\n *)(title))? *(?:\n+|$)/,table:Pt,lheading:/^((?:(?!^bull ).|\n(?!\n|bull ))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,_paragraph:/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,text:/^[^\n]+/};x._label=/(?!\s*\])(?:\\.|[^\[\]\\])+/;x._title=/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/;x.def=B(x.def).replace("label",x._label).replace("title",x._title).getRegex();x.bullet=/(?:[*+-]|\d{1,9}[.)])/;x.listItemStart=B(/^( *)(bull) */).replace("bull",x.bullet).getRegex();x.list=B(x.list).replace(/bull/g,x.bullet).replace("hr","\\n+(?=\\1?(?:(?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$))").replace("def","\\n+(?="+x.def.source+")").getRegex();x._tag="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|section|source|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul";x._comment=/<!--(?!-?>)[\s\S]*?(?:-->|$)/;x.html=B(x.html,"i").replace("comment",x._comment).replace("tag",x._tag).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex();x.lheading=B(x.lheading).replace(/bull/g,x.bullet).getRegex();x.paragraph=B(x._paragraph).replace("hr",x.hr).replace("heading"," {0,3}#{1,6} ").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",x._tag).getRegex();x.blockquote=B(x.blockquote).replace("paragraph",x.paragraph).getRegex();x.normal={...x};x.gfm={...x.normal,table:"^ *([^\\n ].*\\|.*)\\n {0,3}(?:\\| *)?(:?-+:? *(?:\\| *:?-+:? *)*)(?:\\| *)?(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)"};x.gfm.table=B(x.gfm.table).replace("hr",x.hr).replace("heading"," {0,3}#{1,6} ").replace("blockquote"," {0,3}>").replace("code"," {4}[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",x._tag).getRegex();x.gfm.paragraph=B(x._paragraph).replace("hr",x.hr).replace("heading"," {0,3}#{1,6} ").replace("|lheading","").replace("table",x.gfm.table).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",x._tag).getRegex();x.pedantic={...x.normal,html:B(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",x._comment).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:Pt,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:B(x.normal._paragraph).replace("hr",x.hr).replace("heading",` *#{1,6} *[^
]`).replace("lheading",x.lheading).replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").getRegex()};const m={escape:/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,autolink:/^<(scheme:[^\s\x00-\x1f<>]*|email)>/,url:Pt,tag:"^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>",link:/^!?\[(label)\]\(\s*(href)(?:\s+(title))?\s*\)/,reflink:/^!?\[(label)\]\[(ref)\]/,nolink:/^!?\[(ref)\](?:\[\])?/,reflinkSearch:"reflink|nolink(?!\\()",emStrong:{lDelim:/^(?:\*+(?:((?!\*)[punct])|[^\s*]))|^_+(?:((?!_)[punct])|([^\s_]))/,rDelimAst:/^[^_*]*?__[^_*]*?\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\*)[punct](\*+)(?=[\s]|$)|[^punct\s](\*+)(?!\*)(?=[punct\s]|$)|(?!\*)[punct\s](\*+)(?=[^punct\s])|[\s](\*+)(?!\*)(?=[punct])|(?!\*)[punct](\*+)(?!\*)(?=[punct])|[^punct\s](\*+)(?=[^punct\s])/,rDelimUnd:/^[^_*]*?\*\*[^_*]*?_[^_*]*?(?=\*\*)|[^_]+(?=[^_])|(?!_)[punct](_+)(?=[\s]|$)|[^punct\s](_+)(?!_)(?=[punct\s]|$)|(?!_)[punct\s](_+)(?=[^punct\s])|[\s](_+)(?!_)(?=[punct])|(?!_)[punct](_+)(?!_)(?=[punct])/},code:/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,br:/^( {2,}|\\)\n(?!\s*$)/,del:Pt,text:/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,punctuation:/^((?![*_])[\spunctuation])/};m._punctuation="\\p{P}$+<=>`^|~";m.punctuation=B(m.punctuation,"u").replace(/punctuation/g,m._punctuation).getRegex();m.blockSkip=/\[[^[\]]*?\]\([^\(\)]*?\)|`[^`]*?`|<[^<>]*?>/g;m.anyPunctuation=/\\[punct]/g;m._escapes=/\\([punct])/g;m._comment=B(x._comment).replace("(?:-->|$)","-->").getRegex();m.emStrong.lDelim=B(m.emStrong.lDelim,"u").replace(/punct/g,m._punctuation).getRegex();m.emStrong.rDelimAst=B(m.emStrong.rDelimAst,"gu").replace(/punct/g,m._punctuation).getRegex();m.emStrong.rDelimUnd=B(m.emStrong.rDelimUnd,"gu").replace(/punct/g,m._punctuation).getRegex();m.anyPunctuation=B(m.anyPunctuation,"gu").replace(/punct/g,m._punctuation).getRegex();m._escapes=B(m._escapes,"gu").replace(/punct/g,m._punctuation).getRegex();m._scheme=/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/;m._email=/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/;m.autolink=B(m.autolink).replace("scheme",m._scheme).replace("email",m._email).getRegex();m._attribute=/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/;m.tag=B(m.tag).replace("comment",m._comment).replace("attribute",m._attribute).getRegex();m._label=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/;m._href=/<(?:\\.|[^\n<>\\])+>|[^\s\x00-\x1f]*/;m._title=/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/;m.link=B(m.link).replace("label",m._label).replace("href",m._href).replace("title",m._title).getRegex();m.reflink=B(m.reflink).replace("label",m._label).replace("ref",x._label).getRegex();m.nolink=B(m.nolink).replace("ref",x._label).getRegex();m.reflinkSearch=B(m.reflinkSearch,"g").replace("reflink",m.reflink).replace("nolink",m.nolink).getRegex();m.normal={...m};m.pedantic={...m.normal,strong:{start:/^__|\*\*/,middle:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,endAst:/\*\*(?!\*)/g,endUnd:/__(?!_)/g},em:{start:/^_|\*/,middle:/^()\*(?=\S)([\s\S]*?\S)\*(?!\*)|^_(?=\S)([\s\S]*?\S)_(?!_)/,endAst:/\*(?!\*)/g,endUnd:/_(?!_)/g},link:B(/^!?\[(label)\]\((.*?)\)/).replace("label",m._label).getRegex(),reflink:B(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",m._label).getRegex()};m.gfm={...m.normal,escape:B(m.escape).replace("])","~|])").getRegex(),_extended_email:/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/,url:/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])([\s\S]*?[^\s~])\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/};m.gfm.url=B(m.gfm.url,"i").replace("email",m.gfm._extended_email).getRegex();m.breaks={...m.gfm,br:B(m.br).replace("{2,}","*").getRegex(),text:B(m.gfm.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()};function nn(o){return o.replace(/---/g,"‚Äî").replace(/--/g,"‚Äì").replace(/(^|[-\u2014/(\[{"\s])'/g,"$1‚Äò").replace(/'/g,"‚Äô").replace(/(^|[-\u2014/(\[{\u2018\s])"/g,"$1‚Äú").replace(/"/g,"‚Äù").replace(/\.{3}/g,"‚Ä¶")}function ti(o){let e="",t,s;const i=o.length;for(t=0;t<i;t++)s=o.charCodeAt(t),Math.random()>.5&&(s="x"+s.toString(16)),e+="&#"+s+";";return e}class ue{constructor(e){this.tokens=[],this.tokens.links=Object.create(null),this.options=e||Te,this.options.tokenizer=this.options.tokenizer||new Mt,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};const t={block:x.normal,inline:m.normal};this.options.pedantic?(t.block=x.pedantic,t.inline=m.pedantic):this.options.gfm&&(t.block=x.gfm,this.options.breaks?t.inline=m.breaks:t.inline=m.gfm),this.tokenizer.rules=t}static get rules(){return{block:x,inline:m}}static lex(e,t){return new ue(t).lex(e)}static lexInline(e,t){return new ue(t).inlineTokens(e)}lex(e){e=e.replace(/\r\n|\r/g,`
`),this.blockTokens(e,this.tokens);let t;for(;t=this.inlineQueue.shift();)this.inlineTokens(t.src,t.tokens);return this.tokens}blockTokens(e,t=[]){this.options.pedantic?e=e.replace(/\t/g,"    ").replace(/^ +$/gm,""):e=e.replace(/^( *)(\t+)/gm,(a,l,h)=>l+"    ".repeat(h.length));let s,i,r,n;for(;e;)if(!(this.options.extensions&&this.options.extensions.block&&this.options.extensions.block.some(a=>(s=a.call({lexer:this},e,t))?(e=e.substring(s.raw.length),t.push(s),!0):!1))){if(s=this.tokenizer.space(e)){e=e.substring(s.raw.length),s.raw.length===1&&t.length>0?t[t.length-1].raw+=`
`:t.push(s);continue}if(s=this.tokenizer.code(e)){e=e.substring(s.raw.length),i=t[t.length-1],i&&(i.type==="paragraph"||i.type==="text")?(i.raw+=`
`+s.raw,i.text+=`
`+s.text,this.inlineQueue[this.inlineQueue.length-1].src=i.text):t.push(s);continue}if(s=this.tokenizer.fences(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.heading(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.hr(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.blockquote(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.list(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.html(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.def(e)){e=e.substring(s.raw.length),i=t[t.length-1],i&&(i.type==="paragraph"||i.type==="text")?(i.raw+=`
`+s.raw,i.text+=`
`+s.raw,this.inlineQueue[this.inlineQueue.length-1].src=i.text):this.tokens.links[s.tag]||(this.tokens.links[s.tag]={href:s.href,title:s.title});continue}if(s=this.tokenizer.table(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.lheading(e)){e=e.substring(s.raw.length),t.push(s);continue}if(r=e,this.options.extensions&&this.options.extensions.startBlock){let a=1/0;const l=e.slice(1);let h;this.options.extensions.startBlock.forEach(function(d){h=d.call({lexer:this},l),typeof h=="number"&&h>=0&&(a=Math.min(a,h))}),a<1/0&&a>=0&&(r=e.substring(0,a+1))}if(this.state.top&&(s=this.tokenizer.paragraph(r))){i=t[t.length-1],n&&i.type==="paragraph"?(i.raw+=`
`+s.raw,i.text+=`
`+s.text,this.inlineQueue.pop(),this.inlineQueue[this.inlineQueue.length-1].src=i.text):t.push(s),n=r.length!==e.length,e=e.substring(s.raw.length);continue}if(s=this.tokenizer.text(e)){e=e.substring(s.raw.length),i=t[t.length-1],i&&i.type==="text"?(i.raw+=`
`+s.raw,i.text+=`
`+s.text,this.inlineQueue.pop(),this.inlineQueue[this.inlineQueue.length-1].src=i.text):t.push(s);continue}if(e){const a="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(a);break}else throw new Error(a)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){let s,i,r,n=e,a,l,h;if(this.tokens.links){const d=Object.keys(this.tokens.links);if(d.length>0)for(;(a=this.tokenizer.rules.inline.reflinkSearch.exec(n))!=null;)d.includes(a[0].slice(a[0].lastIndexOf("[")+1,-1))&&(n=n.slice(0,a.index)+"["+"a".repeat(a[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(a=this.tokenizer.rules.inline.blockSkip.exec(n))!=null;)n=n.slice(0,a.index)+"["+"a".repeat(a[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);for(;(a=this.tokenizer.rules.inline.anyPunctuation.exec(n))!=null;)n=n.slice(0,a.index)+"++"+n.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);for(;e;)if(l||(h=""),l=!1,!(this.options.extensions&&this.options.extensions.inline&&this.options.extensions.inline.some(d=>(s=d.call({lexer:this},e,t))?(e=e.substring(s.raw.length),t.push(s),!0):!1))){if(s=this.tokenizer.escape(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.tag(e)){e=e.substring(s.raw.length),i=t[t.length-1],i&&s.type==="text"&&i.type==="text"?(i.raw+=s.raw,i.text+=s.text):t.push(s);continue}if(s=this.tokenizer.link(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(s.raw.length),i=t[t.length-1],i&&s.type==="text"&&i.type==="text"?(i.raw+=s.raw,i.text+=s.text):t.push(s);continue}if(s=this.tokenizer.emStrong(e,n,h)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.codespan(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.br(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.del(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.autolink(e,ti)){e=e.substring(s.raw.length),t.push(s);continue}if(!this.state.inLink&&(s=this.tokenizer.url(e,ti))){e=e.substring(s.raw.length),t.push(s);continue}if(r=e,this.options.extensions&&this.options.extensions.startInline){let d=1/0;const u=e.slice(1);let f;this.options.extensions.startInline.forEach(function(p){f=p.call({lexer:this},u),typeof f=="number"&&f>=0&&(d=Math.min(d,f))}),d<1/0&&d>=0&&(r=e.substring(0,d+1))}if(s=this.tokenizer.inlineText(r,nn)){e=e.substring(s.raw.length),s.raw.slice(-1)!=="_"&&(h=s.raw.slice(-1)),l=!0,i=t[t.length-1],i&&i.type==="text"?(i.raw+=s.raw,i.text+=s.text):t.push(s);continue}if(e){const d="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(d);break}else throw new Error(d)}}return t}}class At{constructor(e){this.options=e||Te}code(e,t,s){const i=(t||"").match(/\S*/)[0];if(this.options.highlight){const r=this.options.highlight(e,i);r!=null&&r!==e&&(s=!0,e=r)}return e=e.replace(/\n$/,"")+`
`,i?'<pre><code class="'+this.options.langPrefix+Y(i)+'">'+(s?e:Y(e,!0))+`</code></pre>
`:"<pre><code>"+(s?e:Y(e,!0))+`</code></pre>
`}blockquote(e){return`<blockquote>
${e}</blockquote>
`}html(e,t){return e}heading(e,t,s,i){if(this.options.headerIds){const r=this.options.headerPrefix+i.slug(s);return`<h${t} id="${r}">${e}</h${t}>
`}return`<h${t}>${e}</h${t}>
`}hr(){return this.options.xhtml?`<hr/>
`:`<hr>
`}list(e,t,s){const i=t?"ol":"ul",r=t&&s!==1?' start="'+s+'"':"";return"<"+i+r+`>
`+e+"</"+i+`>
`}listitem(e){return`<li>${e}</li>
`}checkbox(e){return"<input "+(e?'checked="" ':"")+'disabled="" type="checkbox"'+(this.options.xhtml?" /":"")+"> "}paragraph(e){return`<p>${e}</p>
`}table(e,t){return t&&(t=`<tbody>${t}</tbody>`),`<table>
<thead>
`+e+`</thead>
`+t+`</table>
`}tablerow(e){return`<tr>
${e}</tr>
`}tablecell(e,t){const s=t.header?"th":"td";return(t.align?`<${s} align="${t.align}">`:`<${s}>`)+e+`</${s}>
`}strong(e){return`<strong>${e}</strong>`}em(e){return`<em>${e}</em>`}codespan(e){return`<code>${e}</code>`}br(){return this.options.xhtml?"<br/>":"<br>"}del(e){return`<del>${e}</del>`}link(e,t,s){if(e=Qs(this.options.sanitize,this.options.baseUrl,e),e===null)return s;let i='<a href="'+e+'"';return t&&(i+=' title="'+t+'"'),i+=">"+s+"</a>",i}image(e,t,s){if(e=Qs(this.options.sanitize,this.options.baseUrl,e),e===null)return s;let i=`<img src="${e}" alt="${s}"`;return t&&(i+=` title="${t}"`),i+=this.options.xhtml?"/>":">",i}text(e){return e}}class ps{strong(e){return e}em(e){return e}codespan(e){return e}del(e){return e}html(e){return e}text(e){return e}link(e,t,s){return""+s}image(e,t,s){return""+s}br(){return""}}class fs{constructor(){this.seen={}}serialize(e){return e.toLowerCase().trim().replace(/<[!\/a-z].*?>/ig,"").replace(/[\u2000-\u206F\u2E00-\u2E7F\\'!"#$%&()*+,./:;<=>?@[\]^`{|}~]/g,"").replace(/\s/g,"-")}getNextSafeSlug(e,t){let s=e,i=0;if(this.seen.hasOwnProperty(s)){i=this.seen[e];do i++,s=e+"-"+i;while(this.seen.hasOwnProperty(s))}return t||(this.seen[e]=i,this.seen[s]=0),s}slug(e,t={}){const s=this.serialize(e);return this.getNextSafeSlug(s,t.dryrun)}}class pe{constructor(e){this.options=e||Te,this.options.renderer=this.options.renderer||new At,this.renderer=this.options.renderer,this.renderer.options=this.options,this.textRenderer=new ps,this.slugger=new fs}static parse(e,t){return new pe(t).parse(e)}static parseInline(e,t){return new pe(t).parseInline(e)}parse(e,t=!0){let s="",i,r,n,a,l,h,d,u,f,p,w,C,I,v,k,O,b,D,A;const _=e.length;for(i=0;i<_;i++){if(p=e[i],this.options.extensions&&this.options.extensions.renderers&&this.options.extensions.renderers[p.type]&&(A=this.options.extensions.renderers[p.type].call({parser:this},p),A!==!1||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(p.type))){s+=A||"";continue}switch(p.type){case"space":continue;case"hr":{s+=this.renderer.hr();continue}case"heading":{s+=this.renderer.heading(this.parseInline(p.tokens),p.depth,Ci(this.parseInline(p.tokens,this.textRenderer)),this.slugger);continue}case"code":{s+=this.renderer.code(p.text,p.lang,p.escaped);continue}case"table":{for(u="",d="",a=p.header.length,r=0;r<a;r++)d+=this.renderer.tablecell(this.parseInline(p.header[r].tokens),{header:!0,align:p.align[r]});for(u+=this.renderer.tablerow(d),f="",a=p.rows.length,r=0;r<a;r++){for(h=p.rows[r],d="",l=h.length,n=0;n<l;n++)d+=this.renderer.tablecell(this.parseInline(h[n].tokens),{header:!1,align:p.align[n]});f+=this.renderer.tablerow(d)}s+=this.renderer.table(u,f);continue}case"blockquote":{f=this.parse(p.tokens),s+=this.renderer.blockquote(f);continue}case"list":{for(w=p.ordered,C=p.start,I=p.loose,a=p.items.length,f="",r=0;r<a;r++)k=p.items[r],O=k.checked,b=k.task,v="",k.task&&(D=this.renderer.checkbox(O),I?k.tokens.length>0&&k.tokens[0].type==="paragraph"?(k.tokens[0].text=D+" "+k.tokens[0].text,k.tokens[0].tokens&&k.tokens[0].tokens.length>0&&k.tokens[0].tokens[0].type==="text"&&(k.tokens[0].tokens[0].text=D+" "+k.tokens[0].tokens[0].text)):k.tokens.unshift({type:"text",text:D}):v+=D),v+=this.parse(k.tokens,I),f+=this.renderer.listitem(v,b,O);s+=this.renderer.list(f,w,C);continue}case"html":{s+=this.renderer.html(p.text,p.block);continue}case"paragraph":{s+=this.renderer.paragraph(this.parseInline(p.tokens));continue}case"text":{for(f=p.tokens?this.parseInline(p.tokens):p.text;i+1<_&&e[i+1].type==="text";)p=e[++i],f+=`
`+(p.tokens?this.parseInline(p.tokens):p.text);s+=t?this.renderer.paragraph(f):f;continue}default:{const U='Token with "'+p.type+'" type was not found.';if(this.options.silent){console.error(U);return}else throw new Error(U)}}}return s}parseInline(e,t){t=t||this.renderer;let s="",i,r,n;const a=e.length;for(i=0;i<a;i++){if(r=e[i],this.options.extensions&&this.options.extensions.renderers&&this.options.extensions.renderers[r.type]&&(n=this.options.extensions.renderers[r.type].call({parser:this},r),n!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(r.type))){s+=n||"";continue}switch(r.type){case"escape":{s+=t.text(r.text);break}case"html":{s+=t.html(r.text);break}case"link":{s+=t.link(r.href,r.title,this.parseInline(r.tokens,t));break}case"image":{s+=t.image(r.href,r.title,r.text);break}case"strong":{s+=t.strong(this.parseInline(r.tokens,t));break}case"em":{s+=t.em(this.parseInline(r.tokens,t));break}case"codespan":{s+=t.codespan(r.text);break}case"br":{s+=t.br();break}case"del":{s+=t.del(this.parseInline(r.tokens,t));break}case"text":{s+=t.text(r.text);break}default:{const l='Token with "'+r.type+'" type was not found.';if(this.options.silent){console.error(l);return}else throw new Error(l)}}}return s}}class kt{constructor(e){this.options=e||Te}static passThroughHooks=new Set(["preprocess","postprocess"]);preprocess(e){return e}postprocess(e){return e}}class on{defaults=us();options=this.setOptions;parse=this.#e(ue.lex,pe.parse);parseInline=this.#e(ue.lexInline,pe.parseInline);Parser=pe;parser=pe.parse;Renderer=At;TextRenderer=ps;Lexer=ue;lexer=ue.lex;Tokenizer=Mt;Slugger=fs;Hooks=kt;constructor(...e){this.use(...e)}walkTokens(e,t){let s=[];for(const i of e)switch(s=s.concat(t.call(this,i)),i.type){case"table":{for(const r of i.header)s=s.concat(this.walkTokens(r.tokens,t));for(const r of i.rows)for(const n of r)s=s.concat(this.walkTokens(n.tokens,t));break}case"list":{s=s.concat(this.walkTokens(i.items,t));break}default:this.defaults.extensions&&this.defaults.extensions.childTokens&&this.defaults.extensions.childTokens[i.type]?this.defaults.extensions.childTokens[i.type].forEach(r=>{s=s.concat(this.walkTokens(i[r],t))}):i.tokens&&(s=s.concat(this.walkTokens(i.tokens,t)))}return s}use(...e){const t=this.defaults.extensions||{renderers:{},childTokens:{}};return e.forEach(s=>{const i={...s};if(i.async=this.defaults.async||i.async||!1,s.extensions&&(s.extensions.forEach(r=>{if(!r.name)throw new Error("extension name required");if(r.renderer){const n=t.renderers[r.name];n?t.renderers[r.name]=function(...a){let l=r.renderer.apply(this,a);return l===!1&&(l=n.apply(this,a)),l}:t.renderers[r.name]=r.renderer}if(r.tokenizer){if(!r.level||r.level!=="block"&&r.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");t[r.level]?t[r.level].unshift(r.tokenizer):t[r.level]=[r.tokenizer],r.start&&(r.level==="block"?t.startBlock?t.startBlock.push(r.start):t.startBlock=[r.start]:r.level==="inline"&&(t.startInline?t.startInline.push(r.start):t.startInline=[r.start]))}r.childTokens&&(t.childTokens[r.name]=r.childTokens)}),i.extensions=t),s.renderer){const r=this.defaults.renderer||new At(this.defaults);for(const n in s.renderer){const a=r[n];r[n]=(...l)=>{let h=s.renderer[n].apply(r,l);return h===!1&&(h=a.apply(r,l)),h}}i.renderer=r}if(s.tokenizer){const r=this.defaults.tokenizer||new Mt(this.defaults);for(const n in s.tokenizer){const a=r[n];r[n]=(...l)=>{let h=s.tokenizer[n].apply(r,l);return h===!1&&(h=a.apply(r,l)),h}}i.tokenizer=r}if(s.hooks){const r=this.defaults.hooks||new kt;for(const n in s.hooks){const a=r[n];kt.passThroughHooks.has(n)?r[n]=l=>{if(this.defaults.async)return Promise.resolve(s.hooks[n].call(r,l)).then(d=>a.call(r,d));const h=s.hooks[n].call(r,l);return a.call(r,h)}:r[n]=(...l)=>{let h=s.hooks[n].apply(r,l);return h===!1&&(h=a.apply(r,l)),h}}i.hooks=r}if(s.walkTokens){const r=this.defaults.walkTokens;i.walkTokens=function(n){let a=[];return a.push(s.walkTokens.call(this,n)),r&&(a=a.concat(r.call(this,n))),a}}this.defaults={...this.defaults,...i}}),this}setOptions(e){return this.defaults={...this.defaults,...e},this}#e(e,t){return(s,i,r)=>{typeof i=="function"&&(r=i,i=null);const n={...i};i={...this.defaults,...n};const a=this.#t(i.silent,i.async,r);if(typeof s>"u"||s===null)return a(new Error("marked(): input parameter is undefined or null"));if(typeof s!="string")return a(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(s)+", string expected"));if(sn(i,r),i.hooks&&(i.hooks.options=i),r){const l=i.highlight;let h;try{i.hooks&&(s=i.hooks.preprocess(s)),h=e(s,i)}catch(f){return a(f)}const d=f=>{let p;if(!f)try{i.walkTokens&&this.walkTokens(h,i.walkTokens),p=t(h,i),i.hooks&&(p=i.hooks.postprocess(p))}catch(w){f=w}return i.highlight=l,f?a(f):r(null,p)};if(!l||l.length<3||(delete i.highlight,!h.length))return d();let u=0;this.walkTokens(h,f=>{f.type==="code"&&(u++,setTimeout(()=>{l(f.text,f.lang,(p,w)=>{if(p)return d(p);w!=null&&w!==f.text&&(f.text=w,f.escaped=!0),u--,u===0&&d()})},0))}),u===0&&d();return}if(i.async)return Promise.resolve(i.hooks?i.hooks.preprocess(s):s).then(l=>e(l,i)).then(l=>i.walkTokens?Promise.all(this.walkTokens(l,i.walkTokens)).then(()=>l):l).then(l=>t(l,i)).then(l=>i.hooks?i.hooks.postprocess(l):l).catch(a);try{i.hooks&&(s=i.hooks.preprocess(s));const l=e(s,i);i.walkTokens&&this.walkTokens(l,i.walkTokens);let h=t(l,i);return i.hooks&&(h=i.hooks.postprocess(h)),h}catch(l){return a(l)}}}#t(e,t,s){return i=>{if(i.message+=`
Please report this to https://github.com/markedjs/marked.`,e){const r="<p>An error occurred:</p><pre>"+Y(i.message+"",!0)+"</pre>";if(t)return Promise.resolve(r);if(s){s(null,r);return}return r}if(t)return Promise.reject(i);if(s){s(i);return}throw i}}}const _e=new on(Te);function L(o,e,t){return _e.parse(o,e,t)}L.options=L.setOptions=function(o){return _e.setOptions(o),L.defaults=_e.defaults,vi(L.defaults),L};L.getDefaults=us;L.defaults=Te;L.use=function(...o){return _e.use(...o),L.defaults=_e.defaults,vi(L.defaults),L};L.walkTokens=function(o,e){return _e.walkTokens(o,e)};L.parseInline=_e.parseInline;L.Parser=pe;L.parser=pe.parse;L.Renderer=At;L.TextRenderer=ps;L.Lexer=ue;L.lexer=ue.lex;L.Tokenizer=Mt;L.Slugger=fs;L.Hooks=kt;L.parse=L;L.options;L.setOptions;L.use;L.walkTokens;L.parseInline;pe.parse;ue.lex;class an{scene;repoUrl;readmeUrl;container;buttonBg;overlayEl;confirmEl;buttonText;burgerGraphics;margin=12;size=44;constructor(e,t,s){this.scene=e,this.repoUrl=t,this.readmeUrl=s||"https://raw.githubusercontent.com/m-ko-de/open-td/main/README.md"}create(){const e=this.margin,t=this.size,s=this.scene.cameras.main;let i=s.width-e-t,r=s.height-e-t,n=i+t/2,a=r+t/2;this.buttonBg=this.scene.add.rectangle(n,a,t,t,2236962,.8),this.buttonBg.setStrokeStyle(2,16777215,.06),this.buttonBg.setOrigin(.5),this.buttonBg.setInteractive({useHandCursor:!0}),this.burgerGraphics=this.scene.add.graphics({x:i+10,y:r+12}),this.burgerGraphics.fillStyle(16777215,1),this.burgerGraphics.fillRect(0,0,24,3),this.burgerGraphics.fillRect(0,8,24,3),this.burgerGraphics.fillRect(0,16,24,3),this.buttonText=this.scene.add.text(i-8,a,"Men√º",{font:"12px Arial",color:"#ffffff"}),this.buttonText.setOrigin(1,.5),this.container=this.scene.add.container(0,0,[this.buttonBg,this.burgerGraphics,this.buttonText]),this.container.setDepth(1e3),this.buttonBg.on("pointerdown",()=>{this.openOverlay()}),this.scene.scale.on("resize",this.onResize,this)}onResize(e){try{const t=this.scene.cameras.main,s=this.margin,i=this.size,r=t.width-s-i,n=t.height-s-i,a=r+i/2,l=n+i/2;this.buttonBg&&this.buttonBg.setPosition(a,l),this.burgerGraphics&&this.burgerGraphics.setPosition(r+10,n+12),this.buttonText&&this.buttonText.setPosition(r-8,l)}catch{}}destroy(){try{this.container&&(this.container.removeAll(!0),this.container.destroy())}catch{}try{this.overlayEl&&(this.overlayEl.remove(),this.overlayEl=void 0)}catch{}try{this.scene.scale.off("resize",this.onResize,this)}catch{}}getButton(){return this.buttonBg}async openOverlay(){if(typeof document>"u"){this.showCanvasOverlay("Could not load README (no DOM in this environment)");return}if(!this.overlayEl){const e=document.getElementById("game-container")||document.body,t=document.createElement("div");t.id="opentd-ingame-menu-overlay",t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.right="0",t.style.bottom="0",t.style.zIndex="10000",t.style.background="rgba(0,0,0,0.85)",t.style.color="#fff",t.style.padding="18px",t.style.overflow="auto",t.style.fontFamily="Arial, sans-serif";const s=document.createElement("button");s.textContent="Schlie√üen",s.style.position="fixed",s.style.right="18px",s.style.top="18px",s.style.padding="8px 12px",s.style.cursor="pointer",s.onclick=()=>this.closeOverlay();const i=document.createElement("button");i.textContent="Quellcode",i.style.position="fixed",i.style.right="120px",i.style.top="18px",i.style.padding="8px 12px",i.style.cursor="pointer",i.onclick=()=>window.open(this.repoUrl,"_blank");const r=document.createElement("button");r.textContent="Neustarten",r.style.position="fixed",r.style.right="240px",r.style.top="18px",r.style.padding="8px 12px",r.style.cursor="pointer",r.onclick=()=>{this.showRestartConfirm()};const n=document.createElement("div");n.style.maxWidth="min(1100px, 95%)",n.style.margin="60px auto 40px auto",n.style.fontSize="14px",n.style.lineHeight="1.4",n.style.background="rgba(0,0,0,0.1)",n.style.padding="12px",n.style.borderRadius="8px",n.style.whiteSpace="pre-wrap",n.style.wordWrap="break-word",n.style.maxWidth="min(1100px, 95%)",n.style.margin="60px auto 40px auto",n.style.fontSize="14px",n.style.lineHeight="1.4",n.style.background="rgba(0,0,0,0.1)",n.style.padding="12px",n.style.borderRadius="8px",t.appendChild(s),t.appendChild(i),t.appendChild(r),t.appendChild(n),e.appendChild(t),this.overlayEl=t;try{const a=await fetch(this.readmeUrl);if(a.ok){const l=await a.text();try{const h=L(l),d=Gr.sanitize(h);n.innerHTML=d}catch{n.textContent=l}}else n.textContent="Could not load README content."}catch(a){n.textContent="Error fetching README: "+String(a)}}try{this.scene.scene.pause();try{this.scene.ui?.setPaused?.(!0)}catch{}}catch{}this.overlayEl.style.display="block"}showRestartConfirm(){if(!this.overlayEl||this.confirmEl)return;const e=document.createElement("div");e.style.position="fixed",e.style.left="0",e.style.top="0",e.style.right="0",e.style.bottom="0",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="10001";const t=document.createElement("div");t.style.background="#111",t.style.color="#fff",t.style.border="1px solid rgba(255,255,255,0.05)",t.style.padding="18px",t.style.borderRadius="8px",t.style.minWidth="320px",t.style.textAlign="center";const s=document.createElement("div");s.textContent="Neustarten? Alle nicht gespeicherten Daten gehen verloren.",s.style.marginBottom="12px";const i=document.createElement("button");i.textContent="Ja",i.style.marginRight="8px",i.style.padding="8px 12px",i.onclick=()=>{try{const n=window.restartGame;typeof n=="function"?n():window.location.reload()}catch(n){console.warn("Neustart fehlgeschlagen",n)}finally{this.removeConfirm()}};const r=document.createElement("button");r.textContent="Abbrechen",r.style.padding="8px 12px",r.onclick=()=>this.removeConfirm(),t.appendChild(s),t.appendChild(i),t.appendChild(r),e.appendChild(t),document.body.appendChild(e),this.confirmEl=e}removeConfirm(){if(this.confirmEl){try{this.confirmEl.remove()}catch{}this.confirmEl=void 0}}closeOverlay(){this.overlayEl&&(this.overlayEl.style.display="none");try{this.scene.scene.resume();try{this.scene.ui?.setPaused?.(!1)}catch{}}catch{}}showCanvasOverlay(e){const t=this.scene.cameras.main.width,s=this.scene.cameras.main.height,i=this.scene.add.rectangle(t/2,s/2,t-40,s-40,0,.9),r=this.scene.add.text(t/2,s/2,e,{font:"16px Arial",color:"#ffffff",align:"center",wordWrap:{width:t-80}});r.setOrigin(.5),i.setInteractive({useHandCursor:!0}),i.on("pointerdown",()=>{i.destroy(),r.destroy()})}}class ln{scene;gold;lives;wave;researchManager;statsDisplay;towerButtons;controlButtons;towerActionButtons;researchButton;researchOverlay;inGameMenu;constructor(e,t,s,i){this.scene=e,this.gold=t,this.lives=s,this.wave=0,this.researchManager=i}create(e,t,s,i,r,n,a,l){this.statsDisplay=new mr(this.scene,this.gold,this.lives,this.wave,this.researchManager.getLevel(),this.researchManager.getXP(),this.researchManager.getXPForNextLevel()),this.towerButtons=new yr(this.scene,this.gold,this.researchManager,t),this.controlButtons=new wr(this.scene,e,s,i),this.towerActionButtons=new br(this.scene,this.gold,a,l),this.researchButton=new Sr(this.scene,r),this.researchOverlay=new xr(this.scene,this.researchManager,this.gold,h=>{this.gold-=h,this.updateGold(this.gold)},h=>{(h==="frost_tower"||h==="fire_tower")&&this.towerButtons.recreate(),typeof n=="function"&&n(h)}),this.inGameMenu=new an(this.scene,"https://github.com/m-ko-de/open-td"),this.inGameMenu.create()}updateGold(e){this.gold=e,this.statsDisplay.updateGold(e),this.towerButtons.updateGold(e),this.towerActionButtons.updateGold(e),this.researchOverlay.updateGold(e)}updateLives(e){this.lives=e,this.statsDisplay.updateLives(e)}updateWave(e){this.wave=e,this.statsDisplay.updateWave(e)}updateXP(e,t){this.statsDisplay.updateXP(e,t,this.researchManager.getXPForNextLevel())}showStartButton(e="Welle Starten"){this.controlButtons.showStartButton(e)}hideStartButton(){this.controlButtons.hideStartButton()}updateButtonStyles(e){this.towerButtons.updateStyles(e)}updateUpgradeButton(e){this.towerActionButtons.updateForTower(e)}getButtons(){return[...this.towerButtons.getButtons(),...this.controlButtons.getButtons(),...this.towerActionButtons.getButtons(),this.researchButton.getButton(),this.inGameMenu?this.inGameMenu.getButton():null]}setPaused(e){this.controlButtons.setPaused(e)}setAutoWave(e){this.controlButtons.setAutoWave(e)}toggleResearchOverlay(){this.researchOverlay.toggle()}showResearchButtonPulse(){this.researchButton.showPulse()}hideResearchButtonPulse(){this.researchButton.hidePulse()}getGold(){return this.gold}getLives(){return this.lives}getWave(){return this.wave}showRoomCode(e){this.statsDisplay.showRoomCode(e)}hideRoomCode(){this.statsDisplay.hideRoomCode()}destroy(){try{this.inGameMenu?.destroy()}catch{}try{this.statsDisplay=null,this.towerButtons=null,this.controlButtons=null,this.towerActionButtons=null,this.researchButton=null,this.researchOverlay=null}catch{}}}class cn{sprite;follower;path;health;maxHealth;speed;baseSpeed;goldReward;xpReward;healthBar;slowEffect=0;slowDuration=0;constructor(e,t,s,i=1,r="normal",n=1){this.path=t,this.follower={t:0,vec:new Phaser.Math.Vector2};const a=this.getTypeStats(r,s,n,i);this.maxHealth=a.health,this.health=this.maxHealth;const h=E.getInstance().getConfig().enemies.baseSpeed;switch(this.baseSpeed=h*a.speedMultiplier,this.speed=this.baseSpeed,this.goldReward=a.gold,this.xpReward=a.xp,this.sprite=e.add.graphics(),r){case"fast":this.createGhostSprite(a.color,a.size);break;case"tank":this.createHeavyMonsterSprite(a.color,a.size);break;case"normal":default:this.createMonsterSprite(a.color,a.size);break}this.healthBar=e.add.graphics(),this.updatePosition(),this.updateHealthBar()}getTypeStats(e,t,s=1,i=1){const r=E.getInstance().getConfig(),n=r.enemies[e],a=r.enemies.healthScaling,l=Math.pow(a.waveMultiplier,Math.floor(t/a.waveInterval)),h=Math.pow(a.levelMultiplier,s-1);let d=1;if(i>1){const f=r.multiplayer;d=1+(i-1)*f.enemyScaling.healthPerPlayer}const u=l*h*d;return{health:Math.round(n.baseHealth*u),speedMultiplier:n.speedMultiplier,gold:n.baseGold+t*n.goldPerWave,xp:n.xpReward,color:parseInt(n.color),size:n.size}}createMonsterSprite(e,t){const s=Phaser.Display.Color.IntegerToColor(e),i=Phaser.Display.Color.GetColor(Math.min(255,Math.floor(s.red*1.3)),Math.min(255,Math.floor(s.green*1.3)),Math.min(255,Math.floor(s.blue*1.3))),r=Phaser.Display.Color.GetColor(Math.floor(s.red*.6),Math.floor(s.green*.6),Math.floor(s.blue*.6));this.sprite.fillStyle(0,.3),this.sprite.fillEllipse(0,t*1.2,t*1.3,t*.5),this.sprite.fillStyle(e,1),this.sprite.fillCircle(0,0,t),this.sprite.fillEllipse(0,t*.3,t*.9,t*.8),this.sprite.fillStyle(i,.7),this.sprite.fillCircle(-t*.3,-t*.4,t*.5),this.sprite.fillStyle(16776960,1),this.sprite.fillCircle(-t*.3,-t*.2,t*.35),this.sprite.fillCircle(t*.3,-t*.2,t*.35),this.sprite.fillStyle(16711680,1),this.sprite.fillCircle(-t*.3,-t*.15,t*.2),this.sprite.fillCircle(t*.3,-t*.15,t*.2),this.sprite.fillStyle(16777215,.8),this.sprite.fillCircle(-t*.25,-t*.25,t*.1),this.sprite.fillCircle(t*.35,-t*.25,t*.1),this.sprite.fillStyle(0,1),this.sprite.fillEllipse(0,t*.4,t*.5,t*.3),this.sprite.fillStyle(16777215,1),this.sprite.fillRect(-t*.2,t*.25,t*.15,t*.25),this.sprite.fillRect(t*.05,t*.25,t*.15,t*.25),this.sprite.fillStyle(r,1),this.sprite.beginPath(),this.sprite.moveTo(-t*.7,-t*.3),this.sprite.lineTo(-t*.5,-t*.8),this.sprite.lineTo(-t*.3,-t*.4),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(t*.7,-t*.3),this.sprite.lineTo(t*.5,-t*.8),this.sprite.lineTo(t*.3,-t*.4),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.lineStyle(2,0,1),this.sprite.strokeCircle(0,0,t)}createGhostSprite(e,t){this.sprite.fillStyle(0,.2),this.sprite.fillEllipse(0,t*1.2,t*1,t*.4),this.sprite.fillStyle(e,.8),this.sprite.beginPath(),this.sprite.arc(0,0,t,0,Math.PI,!0),this.sprite.lineTo(t*.6,t*.9),this.sprite.lineTo(t*.3,t*.6),this.sprite.lineTo(0,t*.9),this.sprite.lineTo(-t*.3,t*.6),this.sprite.lineTo(-t*.6,t*.9),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.fillStyle(16777215,.4),this.sprite.fillCircle(-t*.3,-t*.3,t*.6),this.sprite.fillStyle(0,1),this.sprite.fillCircle(-t*.3,-t*.1,t*.3),this.sprite.fillCircle(t*.3,-t*.1,t*.3),this.sprite.fillStyle(e,.6),this.sprite.fillCircle(-t*.3,-t*.1,t*.15),this.sprite.fillCircle(t*.3,-t*.1,t*.15),this.sprite.fillStyle(0,1),this.sprite.fillCircle(0,t*.3,t*.25),this.sprite.lineStyle(2,0,.6),this.sprite.strokeCircle(0,-t*.2,t*.9)}createHeavyMonsterSprite(e,t){const s=Phaser.Display.Color.IntegerToColor(e),i=Phaser.Display.Color.GetColor(Math.floor(s.red*.5),Math.floor(s.green*.5),Math.floor(s.blue*.5));this.sprite.fillStyle(0,.4),this.sprite.fillEllipse(0,t*1.3,t*1.6,t*.6),this.sprite.fillStyle(e,1),this.sprite.fillEllipse(0,t*.2,t*1.2,t*1),this.sprite.fillCircle(0,-t*.3,t*.9),this.sprite.fillStyle(i,1),this.sprite.fillRect(-t*.8,-t*.2,t*.3,t*.8),this.sprite.fillRect(t*.5,-t*.2,t*.3,t*.8),this.sprite.fillRect(-t*.4,t*.5,t*.8,t*.3),this.sprite.fillStyle(4473924,1),this.sprite.beginPath(),this.sprite.moveTo(-t*1,-t*.5),this.sprite.lineTo(-t*.8,-t*1),this.sprite.lineTo(-t*.6,-t*.5),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(t*1,-t*.5),this.sprite.lineTo(t*.8,-t*1),this.sprite.lineTo(t*.6,-t*.5),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.fillStyle(16711680,1),this.sprite.fillRect(-t*.45,-t*.4,t*.3,t*.15),this.sprite.fillRect(t*.15,-t*.4,t*.3,t*.15),this.sprite.fillStyle(16737792,.6),this.sprite.fillRect(-t*.5,-t*.45,t*.4,t*.25),this.sprite.fillRect(t*.1,-t*.45,t*.4,t*.25),this.sprite.fillStyle(15658734,1),this.sprite.beginPath(),this.sprite.moveTo(-t*.4,-t*.1),this.sprite.lineTo(-t*.5,t*.4),this.sprite.lineTo(-t*.3,t*.1),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(t*.4,-t*.1),this.sprite.lineTo(t*.5,t*.4),this.sprite.lineTo(t*.3,t*.1),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.lineStyle(3,0,1),this.sprite.strokeEllipse(0,t*.2,t*1.2,t*1),this.sprite.strokeCircle(0,-t*.3,t*.9)}update(e){this.slowDuration>0&&(this.slowDuration-=e,this.slowDuration<=0&&(this.slowEffect=0,this.speed=this.baseSpeed));const t=this;t.burnEffect&&(t.burnEffect.update()?t.burnIndicator&&(t.burnIndicator.clear(),t.burnIndicator.fillStyle(16737792,.6),t.burnIndicator.fillCircle(this.sprite.x,this.sprite.y,12)):(t.burnEffect=null,t.burnIndicator&&(t.burnIndicator.destroy(),t.burnIndicator=null))),this.follower.t+=this.speed*e,this.follower.t>=1&&(this.follower.t=1),this.updatePosition()}updatePosition(){this.path.getPoint(this.follower.t,this.follower.vec),this.sprite.x=this.follower.vec.x,this.sprite.y=this.follower.vec.y,this.updateHealthBar()}updateHealthBar(){this.healthBar.clear();const e=30,t=4,s=this.sprite.x-e/2,i=this.sprite.y-25;this.healthBar.fillStyle(0,.5),this.healthBar.fillRect(s,i,e,t);const r=this.health/this.maxHealth*e,n=this.health>this.maxHealth*.5?65280:16711680;this.healthBar.fillStyle(n,1),this.healthBar.fillRect(s,i,r,t)}takeDamage(e){this.health-=e,this.updateHealthBar(),this.health<=0&&(this.health=0)}isDead(){return this.health<=0}reachedEnd(){return this.follower.t>=1}getGoldReward(){return this.goldReward}getHealth(){return this.health}getXPReward(){return this.xpReward}getPosition(){return this.follower.vec}getProgress(){return this.follower.t}get x(){return this.follower.vec.x}get y(){return this.follower.vec.y}applySlow(e,t){e>this.slowEffect&&(this.slowEffect=e,this.slowDuration=t,this.speed=this.baseSpeed*(1-this.slowEffect))}destroy(){this.sprite.destroy(),this.healthBar.destroy();const e=this;e.burnIndicator&&(e.burnIndicator.destroy(),e.burnIndicator=null),e.burnEffect=null}}class hn extends cn{constructor(e,t,s,i=1,r=1){super(e,t,s,r,"normal",i);const n=E.getInstance().getConfig(),a=n.enemies.boss,l=n.enemies.healthScaling,h=Math.pow(l.waveMultiplier,Math.floor(s/l.waveInterval)),d=Math.pow(l.levelMultiplier,i-1);let u=1;if(r>1){const p=n.multiplayer;u=1+(r-1)*p.enemyScaling.healthPerPlayer}const f=h*d*u;this.maxHealth=Math.round(a.baseHealth*f),this.health=this.maxHealth,this.goldReward=a.baseGold+s*a.goldPerWave,this.xpReward=a.baseXp+s*a.xpPerWave,this.baseSpeed=this.baseSpeed*a.speedMultiplier,this.speed=this.baseSpeed,this.sprite.destroy(),this.sprite=e.add.graphics(),this.createBossSprite(),this.updatePosition(),this.updateHealthBar()}createBossSprite(){this.sprite.fillStyle(0,.5),this.sprite.fillEllipse(0,32*1.5,64,32*.8),this.sprite.fillStyle(6684825,1),this.sprite.fillEllipse(0,32*.5,32*1.5,32*1.3),this.sprite.fillStyle(7798954,1),this.sprite.fillCircle(0,-32*.2,32*1.1),this.sprite.fillStyle(8913100,1),this.sprite.fillCircle(0,-32*.8,32*.7),this.sprite.fillStyle(4456550,1),this.sprite.fillRect(-32*1.3,-32*.5,32*.6,32*1.2),this.sprite.fillRect(32*.7,-32*.5,32*.6,32*1.2),this.sprite.fillStyle(3355443,1);for(let t=-1;t<=1;t++)this.sprite.fillRect(t*32*.4-32*.3,-32*.1,32*.5,32*.15);this.sprite.fillStyle(2236962,1);for(let t=0;t<3;t++){const s=(t-1)*32*.3;this.sprite.beginPath(),this.sprite.moveTo(-32*1.5+s,-32*.3),this.sprite.lineTo(-32*1.3+s,-32*1.2),this.sprite.lineTo(-32*1.1+s,-32*.3),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(32*1.5-s,-32*.3),this.sprite.lineTo(32*1.3-s,-32*1.2),this.sprite.lineTo(32*1.1-s,-32*.3),this.sprite.closePath(),this.sprite.fillPath()}this.sprite.fillStyle(16755200,1),this.sprite.beginPath(),this.sprite.moveTo(-32*.6,-32*1.1),this.sprite.lineTo(-32*.4,-32*1.7),this.sprite.lineTo(-32*.2,-32),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(32*.6,-32*1.1),this.sprite.lineTo(32*.4,-32*1.7),this.sprite.lineTo(32*.2,-32),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(-32*.15,-32*1.2),this.sprite.lineTo(0,-32*1.9),this.sprite.lineTo(32*.15,-32*1.2),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.fillStyle(16711680,1),this.sprite.fillCircle(-32*.25,-32*.8,32*.25),this.sprite.fillCircle(32*.25,-32*.8,32*.25),this.sprite.fillStyle(16737792,.8),this.sprite.fillCircle(-32*.25,-32*.8,32*.35),this.sprite.fillCircle(32*.25,-32*.8,32*.35),this.sprite.fillStyle(16776960,.9),this.sprite.fillCircle(-32*.25,-32*.8,32*.15),this.sprite.fillCircle(32*.25,-32*.8,32*.15),this.sprite.fillStyle(16777215,1);for(let t=0;t<4;t++){const s=(t-1.5)*32*.25;this.sprite.beginPath(),this.sprite.moveTo(s-32*.08,-32*.3),this.sprite.lineTo(s,32*.2),this.sprite.lineTo(s+32*.08,-32*.3),this.sprite.closePath(),this.sprite.fillPath()}this.sprite.lineStyle(4,16711935,.3),this.sprite.strokeCircle(0,0,32*1.6),this.sprite.lineStyle(2,16711935,.5),this.sprite.strokeCircle(0,0,32*1.7),this.sprite.lineStyle(3,0,1),this.sprite.strokeCircle(0,0,32),this.sprite.lineStyle(2,16776960,.4),this.sprite.strokeCircle(0,0,32*1.1),this.sprite.lineStyle(1,16746496,.3),this.sprite.strokeCircle(0,0,32*1.2)}updateHealthBar(){this.healthBar.clear();const e=50,t=6,s=this.sprite.x-e/2,i=this.sprite.y-35;this.healthBar.fillStyle(0,.8),this.healthBar.fillRect(s,i,e,t);const r=this.health/this.maxHealth*e,n=this.health>this.maxHealth*.5?16737792:16711680;this.healthBar.fillStyle(n,1),this.healthBar.fillRect(s,i,r,t),this.healthBar.lineStyle(1,16776960,1),this.healthBar.strokeRect(s,i,e,t)}}class $e{sprite;scene;follower;path;health;maxHealth;speed;baseSpeed;goldReward;xpReward;healthBar;slowEffect=0;slowDuration=0;wave;playerCount;constructor(e,t,s,i=1,r=1){this.scene=e,this.path=t,this.wave=s,this.playerCount=i,this.follower={t:0,vec:new Phaser.Math.Vector2};const n=this.calculateStats(s,r,i);this.maxHealth=n.health,this.health=this.maxHealth;const l=E.getInstance().getConfig().enemies.baseSpeed;this.baseSpeed=l*n.speedMultiplier,this.speed=this.baseSpeed,this.goldReward=n.gold,this.xpReward=n.xp,this.sprite=e.add.graphics(),this.createSprite(n.color,n.size),this.healthBar=e.add.graphics(),this.updatePosition(),this.updateHealthBar()}onUpdate(e,t){}onTakeDamage(e){return e}onDeath(){return[]}calculateStats(e,t=1,s=1){const i=E.getInstance().getConfig(),r=this.getEnemyConfig(),n=i.enemies.healthScaling,a=Math.pow(n.waveMultiplier,Math.floor(e/n.waveInterval)),l=Math.pow(n.levelMultiplier,t-1);let h=1;if(s>1){const u=i.multiplayer;h=1+(s-1)*u.enemyScaling.healthPerPlayer}const d=a*l*h;return{health:Math.round(r.baseHealth*d),speedMultiplier:r.speedMultiplier,gold:r.baseGold+e*r.goldPerWave,xp:r.xpReward,color:parseInt(r.color),size:r.size}}update(e,t){this.slowDuration>0&&(this.slowDuration-=e,this.slowDuration<=0&&(this.slowEffect=0,this.speed=this.baseSpeed));const s=this;s.burnEffect&&(s.burnEffect.update()?s.burnIndicator&&(s.burnIndicator.clear(),s.burnIndicator.fillStyle(16737792,.6),s.burnIndicator.fillCircle(this.sprite.x,this.sprite.y,12)):(s.burnEffect=null,s.burnIndicator&&(s.burnIndicator.destroy(),s.burnIndicator=null))),this.onUpdate(e,t),this.follower.t+=this.speed*e,this.follower.t>=1&&(this.follower.t=1),this.updatePosition()}updatePosition(){this.path.getPoint(this.follower.t,this.follower.vec),this.sprite.x=this.follower.vec.x,this.sprite.y=this.follower.vec.y,this.updateHealthBar()}updateHealthBar(){this.healthBar.clear();const e=30,t=4,s=this.sprite.x-e/2,i=this.sprite.y-25;this.healthBar.fillStyle(0,.5),this.healthBar.fillRect(s,i,e,t);const r=this.health/this.maxHealth*e,n=this.health>this.maxHealth*.5?65280:16711680;this.healthBar.fillStyle(n,1),this.healthBar.fillRect(s,i,r,t)}takeDamage(e){const t=this.onTakeDamage(e);return this.health-=t,this.updateHealthBar(),this.showFloatingDamage(t),this.sprite.setAlpha&&this.sprite.setAlpha(.5),this.scene.tweens?.add&&this.scene.tweens.add({targets:this.sprite,alpha:1,duration:100,ease:"Power2"}),this.health<=0?(this.health=0,this.playDeathAnimation(),this.onDeath()):[]}showFloatingDamage(e){if(!this.scene.add.text||!this.scene.tweens?.add)return;const t=this.scene.add.text(this.sprite.x,this.sprite.y-20,Math.round(e).toString(),{fontSize:"16px",color:"#ff4444",fontStyle:"bold",stroke:"#000000",strokeThickness:3});t.setOrigin(.5),t.setDepth&&t.setDepth(100),this.scene.tweens.add({targets:t,y:t.y-30,alpha:0,duration:800,ease:"Power2",onComplete:()=>t.destroy()})}playDeathAnimation(){if(!this.scene.tweens?.add)return;const e=this.calculateStats(this.wave,1,this.playerCount);for(let t=0;t<15;t++){const s=this.scene.add.graphics(),i=2+Math.random()*4;s.fillStyle(e.color,.8),s.fillCircle(0,0,i),s.x=this.sprite.x,s.y=this.sprite.y,s.setDepth&&s.setDepth(95);const r=Math.random()*Math.PI*2,n=20+Math.random()*40;this.scene.tweens.add({targets:s,x:s.x+Math.cos(r)*n,y:s.y+Math.sin(r)*n,alpha:0,scale:.2,duration:400+Math.random()*400,ease:"Power2",onComplete:()=>s.destroy()})}this.sprite.clear(),this.sprite.fillStyle(16777215,.8),this.sprite.fillCircle(0,0,e.size),this.scene.tweens.add({targets:this.sprite,alpha:0,scale:1.5,duration:300,ease:"Power2"})}isDead(){return this.health<=0}reachedEnd(){return this.follower.t>=1}getGoldReward(){return this.goldReward}getHealth(){return this.health}getMaxHealth(){return this.maxHealth}getXPReward(){return this.xpReward}getPosition(){return this.follower.vec}getProgress(){return this.follower.t}get x(){return this.follower.vec.x}get y(){return this.follower.vec.y}applySlow(e,t){e>this.slowEffect&&(this.slowEffect=e,this.slowDuration=t,this.speed=this.baseSpeed*(1-this.slowEffect))}destroy(){this.sprite.destroy(),this.healthBar.destroy();const e=this;e.burnIndicator&&(e.burnIndicator.destroy(),e.burnIndicator=null),e.burnEffect=null}}class si extends $e{getEnemyConfig(){return E.getInstance().getConfig().enemies.normal}createSprite(e,t){const s=Phaser.Display.Color.IntegerToColor(e),i=Phaser.Display.Color.GetColor(Math.min(255,Math.floor(s.red*1.3)),Math.min(255,Math.floor(s.green*1.3)),Math.min(255,Math.floor(s.blue*1.3))),r=Phaser.Display.Color.GetColor(Math.floor(s.red*.6),Math.floor(s.green*.6),Math.floor(s.blue*.6));this.sprite.fillStyle(0,.3),this.sprite.fillEllipse(0,t*1.2,t*1.3,t*.5),this.sprite.fillStyle(e,1),this.sprite.fillCircle(0,0,t),this.sprite.fillEllipse(0,t*.3,t*.9,t*.8),this.sprite.fillStyle(i,.7),this.sprite.fillCircle(-t*.3,-t*.4,t*.5),this.sprite.fillStyle(16776960,1),this.sprite.fillCircle(-t*.3,-t*.2,t*.35),this.sprite.fillCircle(t*.3,-t*.2,t*.35),this.sprite.fillStyle(16711680,1),this.sprite.fillCircle(-t*.3,-t*.15,t*.2),this.sprite.fillCircle(t*.3,-t*.15,t*.2),this.sprite.fillStyle(16777215,.8),this.sprite.fillCircle(-t*.25,-t*.25,t*.1),this.sprite.fillCircle(t*.35,-t*.25,t*.1),this.sprite.fillStyle(0,1),this.sprite.fillEllipse(0,t*.4,t*.5,t*.3),this.sprite.fillStyle(16777215,1),this.sprite.fillRect(-t*.2,t*.25,t*.15,t*.25),this.sprite.fillRect(t*.05,t*.25,t*.15,t*.25),this.sprite.fillStyle(r,1),this.sprite.beginPath(),this.sprite.moveTo(-t*.7,-t*.3),this.sprite.lineTo(-t*.5,-t*.8),this.sprite.lineTo(-t*.3,-t*.4),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(t*.7,-t*.3),this.sprite.lineTo(t*.5,-t*.8),this.sprite.lineTo(t*.3,-t*.4),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.lineStyle(2,0,1),this.sprite.strokeCircle(0,0,t)}}class dn extends $e{getEnemyConfig(){return E.getInstance().getConfig().enemies.fast}createSprite(e,t){this.sprite.fillStyle(0,.2),this.sprite.fillEllipse(0,t*1.2,t*1,t*.4),this.sprite.fillStyle(e,.8),this.sprite.beginPath(),this.sprite.arc(0,0,t,0,Math.PI,!0),this.sprite.lineTo(t*.6,t*.9),this.sprite.lineTo(t*.3,t*.6),this.sprite.lineTo(0,t*.9),this.sprite.lineTo(-t*.3,t*.6),this.sprite.lineTo(-t*.6,t*.9),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.fillStyle(16777215,.4),this.sprite.fillCircle(-t*.3,-t*.3,t*.6),this.sprite.fillStyle(0,1),this.sprite.fillCircle(-t*.3,-t*.1,t*.3),this.sprite.fillCircle(t*.3,-t*.1,t*.3),this.sprite.fillStyle(e,.6),this.sprite.fillCircle(-t*.3,-t*.1,t*.15),this.sprite.fillCircle(t*.3,-t*.1,t*.15),this.sprite.fillStyle(0,1),this.sprite.fillCircle(0,t*.3,t*.25),this.sprite.lineStyle(2,0,.6),this.sprite.strokeCircle(0,-t*.2,t*.9)}}class un extends $e{getEnemyConfig(){return E.getInstance().getConfig().enemies.tank}createSprite(e,t){const s=Phaser.Display.Color.IntegerToColor(e),i=Phaser.Display.Color.GetColor(Math.floor(s.red*.5),Math.floor(s.green*.5),Math.floor(s.blue*.5));this.sprite.fillStyle(0,.4),this.sprite.fillEllipse(0,t*1.3,t*1.6,t*.6),this.sprite.fillStyle(e,1),this.sprite.fillEllipse(0,t*.2,t*1.2,t*1),this.sprite.fillCircle(0,-t*.3,t*.9),this.sprite.fillStyle(i,1),this.sprite.fillRect(-t*.8,-t*.2,t*.3,t*.8),this.sprite.fillRect(t*.5,-t*.2,t*.3,t*.8),this.sprite.fillRect(-t*.4,t*.5,t*.8,t*.3),this.sprite.fillStyle(4473924,1),this.sprite.beginPath(),this.sprite.moveTo(-t*1,-t*.5),this.sprite.lineTo(-t*.8,-t*1),this.sprite.lineTo(-t*.6,-t*.5),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(t*1,-t*.5),this.sprite.lineTo(t*.8,-t*1),this.sprite.lineTo(t*.6,-t*.5),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.fillStyle(16711680,1),this.sprite.fillRect(-t*.45,-t*.4,t*.3,t*.15),this.sprite.fillRect(t*.15,-t*.4,t*.3,t*.15),this.sprite.fillStyle(16737792,.6),this.sprite.fillRect(-t*.5,-t*.45,t*.4,t*.25),this.sprite.fillRect(t*.1,-t*.45,t*.4,t*.25),this.sprite.fillStyle(15658734,1),this.sprite.beginPath(),this.sprite.moveTo(-t*.4,-t*.1),this.sprite.lineTo(-t*.5,t*.4),this.sprite.lineTo(-t*.3,t*.1),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.beginPath(),this.sprite.moveTo(t*.4,-t*.1),this.sprite.lineTo(t*.5,t*.4),this.sprite.lineTo(t*.3,t*.1),this.sprite.closePath(),this.sprite.fillPath(),this.sprite.lineStyle(3,0,1),this.sprite.strokeEllipse(0,t*.2,t*1.2,t*1),this.sprite.strokeCircle(0,-t*.3,t*.9)}}class pn extends $e{shield;maxShield;shieldRegenDelay=3e3;lastDamageTime=0;shieldIndicator=null;constructor(e,t,s,i=1,r=1){super(e,t,s,i,r),this.maxShield=Math.round(this.maxHealth*.5),this.shield=this.maxShield,this.shieldIndicator=e.add.graphics(),this.updateShieldIndicator()}getEnemyConfig(){return{baseHealth:60,speedMultiplier:1,baseGold:12,goldPerWave:2,xpReward:12,color:"0x4dabf7",size:12}}createSprite(e,t){this.sprite.fillStyle(0,.3),this.sprite.fillEllipse(0,t*1.2,t*1.3,t*.5),this.sprite.fillStyle(e,1),this.sprite.fillCircle(0,0,t*.8),this.sprite.fillStyle(7651580,1),this.sprite.fillCircle(0,-t,t*.3),this.sprite.fillCircle(0,t,t*.3),this.sprite.fillCircle(-t,0,t*.3),this.sprite.fillCircle(t,0,t*.3),this.sprite.lineStyle(2,10868991,.8),this.sprite.beginPath(),this.sprite.moveTo(0,-t),this.sprite.lineTo(t,0),this.sprite.lineTo(0,t),this.sprite.lineTo(-t,0),this.sprite.closePath(),this.sprite.strokePath(),this.sprite.fillStyle(1667522,1),this.sprite.fillCircle(0,0,t*.4),this.sprite.fillStyle(16777215,.6),this.sprite.fillCircle(0,0,t*.2),this.sprite.lineStyle(2,820633,1),this.sprite.strokeCircle(0,0,t*.8)}onUpdate(e,t){const s=Date.now();this.shield<this.maxShield&&s-this.lastDamageTime>this.shieldRegenDelay&&(this.shield=Math.min(this.maxShield,this.shield+this.maxShield*.1*(e/1e3))),this.updateShieldIndicator()}onTakeDamage(e){if(this.lastDamageTime=Date.now(),this.shield>0){const t=Math.min(this.shield,e);this.shield-=t;const s=e-t;return this.shieldIndicator&&this.scene.tweens.add({targets:this.shieldIndicator,alpha:.3,duration:100,yoyo:!0}),s}return e}updateShieldIndicator(){if(this.shieldIndicator&&(this.shieldIndicator.clear(),this.shield>0)){const t=this.shield/this.maxShield;this.shieldIndicator.lineStyle(2,5090295,.6*t),this.shieldIndicator.strokeCircle(this.sprite.x,this.sprite.y,16);const s=[];for(let i=0;i<6;i++){const r=Math.PI/3*i-Math.PI/2,n=this.sprite.x+Math.cos(r)*16*t,a=this.sprite.y+Math.sin(r)*16*t;s.push(n,a)}this.shieldIndicator.fillStyle(5090295,.2*t),this.shieldIndicator.fillPoints(s,!0)}}updateHealthBar(){if(super.updateHealthBar(),this.shield>0){const s=this.sprite.x-15,i=this.sprite.y-30,r=this.shield/this.maxShield*30;this.healthBar.fillStyle(5090295,.8),this.healthBar.fillRect(s,i,r,3)}}destroy(){this.shieldIndicator&&(this.shieldIndicator.destroy(),this.shieldIndicator=null),super.destroy()}}class fn extends $e{damageReduction=.5;armorPlating=null;constructor(e,t,s,i=1,r=1){super(e,t,s,i,r),this.armorPlating=e.add.graphics(),this.updateArmorIndicator()}getEnemyConfig(){return{baseHealth:80,speedMultiplier:.7,baseGold:15,goldPerWave:3,xpReward:15,color:"0x868e96",size:14}}createSprite(e,t){this.sprite.fillStyle(0,.4),this.sprite.fillEllipse(0,t*1.3,t*1.4,t*.6),this.sprite.fillStyle(e,1),this.sprite.fillCircle(0,0,t);const s=4804695,i=11384253,r=3422784;this.sprite.fillStyle(s,1),this.sprite.fillRect(-t*.7,-t*.5,t*1.4,t),this.sprite.fillStyle(r,1);for(let n=-1;n<=1;n++)for(let a=-1;a<=1;a++)this.sprite.fillCircle(n*t*.5,a*t*.3,t*.1);this.sprite.fillStyle(s,1),this.sprite.fillRect(-t*1.1,-t*.7,t*.5,t*.8),this.sprite.fillRect(t*.6,-t*.7,t*.5,t*.8),this.sprite.fillStyle(i,.6),this.sprite.fillRect(-t*.6,-t*.4,t*.3,t*.2),this.sprite.fillRect(t*.3,-t*.4,t*.3,t*.2),this.sprite.fillStyle(16739179,1),this.sprite.fillRect(-t*.45,-t*.2,t*.3,t*.15),this.sprite.fillRect(t*.15,-t*.2,t*.3,t*.15),this.sprite.fillStyle(16746375,.5),this.sprite.fillRect(-t*.5,-t*.25,t*.4,t*.25),this.sprite.fillRect(t*.1,-t*.25,t*.4,t*.25),this.sprite.lineStyle(3,2172201,1),this.sprite.strokeCircle(0,0,t),this.sprite.strokeRect(-t*.7,-t*.5,t*1.4,t)}onTakeDamage(e){const t=e*(1-this.damageReduction);if(this.scene){const s=this.scene.add.graphics();s.fillStyle(16766011,1),s.fillCircle(this.sprite.x,this.sprite.y-10,3),this.scene.tweens.add({targets:s,alpha:0,y:s.y-20,duration:300,onComplete:()=>s.destroy()})}return t}updateArmorIndicator(){if(!this.armorPlating)return;this.armorPlating.clear();const e=this.sprite.x,t=this.sprite.y-22,s=4;this.armorPlating.fillStyle(8818326,.8),this.armorPlating.beginPath(),this.armorPlating.moveTo(e,t-s),this.armorPlating.lineTo(e-s,t),this.armorPlating.lineTo(e-s,t+s),this.armorPlating.lineTo(e+s,t+s),this.armorPlating.lineTo(e+s,t),this.armorPlating.closePath(),this.armorPlating.fillPath()}updatePosition(){super.updatePosition(),this.updateArmorIndicator()}destroy(){this.armorPlating&&(this.armorPlating.destroy(),this.armorPlating=null),super.destroy()}}class gn extends $e{healRadius=100;healAmount=5;healCooldown=1e3;lastHealTime=0;healIndicator=null;pulseAnimation=0;constructor(e,t,s,i=1,r=1){super(e,t,s,i,r),this.healIndicator=e.add.graphics()}getEnemyConfig(){return{baseHealth:40,speedMultiplier:.8,baseGold:20,goldPerWave:4,xpReward:20,color:"0x51cf66",size:11}}createSprite(e,t){this.sprite.fillStyle(0,.3),this.sprite.fillEllipse(0,t*1.2,t*1.3,t*.5),this.sprite.fillStyle(e,1),this.sprite.fillCircle(0,0,t),this.sprite.fillStyle(9234842,.7),this.sprite.fillCircle(-t*.3,-t*.3,t*.6);const s=16777215,i=t*.3,r=t*.8;this.sprite.fillStyle(s,1),this.sprite.fillRect(-i/2,-r/2,i,r),this.sprite.fillRect(-r/2,-i/2,r,i),this.sprite.fillStyle(16739179,1),this.sprite.fillRect(-i/4,-r/2.5,i/2,r/1.5),this.sprite.fillRect(-r/2.5,-i/4,r/1.5,i/2),this.sprite.fillStyle(3120708,1),this.sprite.fillCircle(-t*.4,-t*.1,t*.2),this.sprite.fillCircle(t*.4,-t*.1,t*.2),this.sprite.fillStyle(16777215,.8),this.sprite.fillCircle(-t*.35,-t*.15,t*.1),this.sprite.fillCircle(t*.45,-t*.15,t*.1),this.sprite.lineStyle(2,3120708,1),this.sprite.beginPath(),this.sprite.arc(0,t*.3,t*.4,0,Math.PI,!1),this.sprite.strokePath(),this.sprite.lineStyle(2,2853438,1),this.sprite.strokeCircle(0,0,t)}onUpdate(e,t){const s=Date.now();this.pulseAnimation+=e*.003,this.pulseAnimation>Math.PI*2&&(this.pulseAnimation-=Math.PI*2),this.updateHealIndicator(),s-this.lastHealTime>this.healCooldown&&t&&(this.lastHealTime=s,this.healNearbyAllies(t,e))}healNearbyAllies(e,t){let s=0;for(const i of e){if(i===this||i.isDead())continue;if(Phaser.Math.Distance.Between(this.x,this.y,i.x,i.y)<=this.healRadius){const n=i.getHealth(),a=i.getMaxHealth();if(n<a){const l=Math.min(this.healAmount,a-n);i.health=Math.min(a,n+l),i.updateHealthBar(),this.createHealParticle(i.x,i.y),s++}}}s>0&&this.createHealWave()}createHealParticle(e,t){if(!this.scene)return;const s=this.scene.add.graphics();s.fillStyle(5361510,.8),s.fillCircle(0,0,3),s.setPosition(this.sprite.x,this.sprite.y),this.scene.tweens.add({targets:s,x:e,y:t,alpha:0,duration:400,ease:"Cubic.Out",onComplete:()=>s.destroy()})}createHealWave(){if(!this.scene)return;const e=this.scene.add.graphics();e.lineStyle(2,5361510,.6),e.strokeCircle(this.sprite.x,this.sprite.y,5),this.scene.tweens.add({targets:e,alpha:0,duration:600,onUpdate:()=>{e.clear(),e.lineStyle(2,5361510,e.alpha*.6);const t=5+(1-e.alpha)*this.healRadius;e.strokeCircle(this.sprite.x,this.sprite.y,t)},onComplete:()=>e.destroy()})}updateHealIndicator(){if(!this.healIndicator)return;this.healIndicator.clear();const e=5+Math.sin(this.pulseAnimation)*2;this.healIndicator.lineStyle(1,5361510,.3+Math.sin(this.pulseAnimation)*.2),this.healIndicator.strokeCircle(this.sprite.x,this.sprite.y,this.healRadius*.3);const t=this.sprite.x,s=this.sprite.y-22;this.healIndicator.fillStyle(5361510,.8),this.healIndicator.fillRect(t-e,s-1,e*2,2),this.healIndicator.fillRect(t-1,s-e,2,e*2)}updatePosition(){super.updatePosition()}destroy(){this.healIndicator&&(this.healIndicator.destroy(),this.healIndicator=null),super.destroy()}}class ii{static createEnemy(e,t,s,i,r=1,n=1){switch(s){case"normal":return new si(e,t,i,r,n);case"fast":return new dn(e,t,i,r,n);case"tank":return new un(e,t,i,r,n);case"shielded":return new pn(e,t,i,r,n);case"armored":return new fn(e,t,i,r,n);case"healing":return new gn(e,t,i,r,n);default:return console.warn(`Unknown enemy type: ${s}, defaulting to normal`),new si(e,t,i,r,n)}}static getRandomType(e){if(e<=3)return Math.random()<.7?"normal":"fast";if(e<=7){const s=Math.random();return s<.5?"normal":s<.75?"fast":"tank"}if(e<=12){const s=Math.random();return s<.35?"normal":s<.6?"fast":s<.8?"tank":"shielded"}if(e<=18){const s=Math.random();return s<.25?"normal":s<.45?"fast":s<.65?"tank":s<.85?"shielded":"armored"}const t=Math.random();return t<.2?"normal":t<.35?"fast":t<.5?"tank":t<.65?"shielded":t<.8?"armored":"healing"}static getWaveComposition(e,t){const s=[];if(e%10===0){for(let i=0;i<t;i++)s.push("normal");return s}if(e%5===0&&e>5&&e>=19){const i=Math.min(2,Math.floor(t*.15));for(let r=0;r<i;r++)s.push("healing");for(let r=i;r<t;r++)s.push(Math.random()<.5?"tank":"armored");return s}for(let i=0;i<t;i++)s.push(this.getRandomType(e));return s}}class mn{scene;path;enemies=[];wave=0;isSpawning=!1;waveComplete=!1;playerLevel=1;playerCount=1;constructor(e,t,s="classic"){this.scene=e,this.path=t}setPlayerCount(e){this.playerCount=Math.max(1,e)}setPlayerLevel(e){this.playerLevel=e}startWave(){if(this.isSpawning)return;this.isSpawning=!0,this.waveComplete=!1,this.wave++;const e=E.getInstance().getConfig().waves;if(this.wave%e.bossInterval===0){let s=Math.max(1,Math.floor(this.wave/e.bossInterval));if(this.playerCount>1){const r=E.getInstance().getConfig().multiplayer,n=1+(this.playerCount-1)*r.enemyScaling.countPerPlayer;s=Math.max(1,Math.round(s*n))}const i=e.bossSpawnDelay;for(let r=0;r<s;r++)this.scene.time.delayedCall(r*i,()=>{const n=new hn(this.scene,this.path,this.wave,this.playerLevel,this.playerCount);this.enemies.push(n)});this.scene.time.delayedCall((s-1)*i+100,()=>{this.isSpawning=!1})}else{const s=ds.getSettings(),i=e.difficulty[s.difficulty]||e.difficulty.normal,r=i.baseEnemies,n=i.enemyMultiplier;let a=r+this.wave*n;if(this.playerCount>1){const d=E.getInstance().getConfig().multiplayer,u=1+(this.playerCount-1)*d.enemyScaling.countPerPlayer;a=Math.round(a*u)}const l=Math.max(e.spawnDelay.minimum,e.spawnDelay.base-this.wave*e.spawnDelay.reduction),h=ii.getWaveComposition(this.wave,a);for(let d=0;d<a;d++)this.scene.time.delayedCall(d*l,()=>{const u=h[d]||"normal",f=ii.createEnemy(this.scene,this.path,u,this.wave,this.playerCount,this.playerLevel);this.enemies.push(f)});this.scene.time.delayedCall((a-1)*l+100,()=>{this.isSpawning=!1})}}update(e,t,s,i){const r=[];this.enemies=this.enemies.filter(n=>{if(n.update(e,this.enemies),n.isDead()){t(n.getGoldReward(),n.getXPReward());const a=n.takeDamage(0);return r.push(...a),n.destroy(),!1}return n.reachedEnd()?(s(),n.destroy(),!1):!0}),this.enemies.push(...r),this.enemies.length===0&&this.wave>0&&!this.waveComplete&&!this.isSpawning&&(this.waveComplete=!0,i&&i(this.wave))}getEnemies(){return this.enemies}getWave(){return this.wave}isWaveComplete(){return this.waveComplete}isSpawningEnemies(){return this.isSpawning}resetWaveComplete(){this.waveComplete=!1}markWaveComplete(){this.waveComplete=!0}cleanup(){this.enemies.forEach(e=>e.destroy()),this.enemies=[]}}class Pe{id;towerType;sprite;scene;rangeCircle;showRange=!1;upgradeLevelText;x;y;range;damage;fireRate;baseDamage;baseFireRate;upgradeLevel=1;buildCost;totalInvested;lastFired=0;currentRotation=0;targetRotation=0;constructor(e,t,s,i,r){this.scene=e,this.x=t,this.y=s,this.towerType=i,this.buildCost=r,this.totalInvested=r;const n=E.getInstance().getTowerConfig(i);if(!n)throw new Error(`Tower config not found for type: ${i}`);this.range=n.range,this.baseDamage=n.damage,this.baseFireRate=n.fireRate,this.damage=this.baseDamage,this.fireRate=this.baseFireRate,this.createSprite(),this.upgradeLevelText=this.scene.add.text(this.x,this.y-30,"1",{fontSize:"14px",color:"#ffffff",backgroundColor:"#000000",padding:{x:4,y:2}}).setOrigin(.5).setDepth(100),this.rangeCircle=e.add.graphics(),this.updateRangeCircle(),this.sprite.setInteractive(new Phaser.Geom.Circle(0,0,20),Phaser.Geom.Circle.Contains),this.sprite.on("pointerover",()=>{this.showRange=!0,this.updateRangeCircle()}),this.sprite.on("pointerout",()=>{this.showRange=!1,this.updateRangeCircle()})}findTarget(e){let t=null,s=-1;if(!Array.isArray(e)||e.length===0)return null;for(const i of e){if(i.isDead())continue;if(Phaser.Math.Distance.Between(this.x,this.y,i.x,i.y)<=this.range){const n=this.calculateTargetValue(i);n>s&&(s=n,t=i)}}return t}calculateTargetValue(e){return e.getProgress()}update(e,t){if(Math.abs(this.targetRotation-this.currentRotation)>.01){const r=this.targetRotation-this.currentRotation;this.currentRotation+=r*.15,this.sprite.setRotation&&this.sprite.setRotation(this.currentRotation)}if(e-this.lastFired<this.fireRate)return null;const s=Array.isArray(t)?t:[],i=this.findTarget(s);if(i){this.targetRotation=Math.atan2(i.y-this.y,i.x-this.x)+Math.PI/2,this.createMuzzleFlash(),Ee.getInstance().playTower(this.towerType);const r=this.fireAtTarget(i,s);return this.lastFired=e,r}return null}createMuzzleFlash(){if(!this.scene.tweens?.add)return;const e=this.scene.add.graphics();e.fillStyle(16776960,.8),e.fillCircle(0,0,8),e.x=this.x,e.y=this.y-15,e.setDepth&&e.setDepth(99),this.scene.tweens.add({targets:e,alpha:0,scale:1.5,duration:150,ease:"Power2",onComplete:()=>e.destroy()});for(let t=0;t<3;t++){const s=this.scene.add.graphics();s.fillStyle(16746496,.6),s.fillCircle(0,0,3),s.x=this.x,s.y=this.y-15,s.setDepth&&s.setDepth(99);const i=Math.random()*Math.PI*2,r=20+Math.random()*30;this.scene.tweens.add({targets:s,x:s.x+Math.cos(i)*r,y:s.y+Math.sin(i)*r,alpha:0,scale:.5,duration:200+Math.random()*200,ease:"Power2",onComplete:()=>s.destroy()})}}upgrade(){const e=this.getUpgradeCost();return this.upgradeLevel++,this.totalInvested+=e,this.damage=Math.round(this.baseDamage*Math.pow(1.2,this.upgradeLevel-1)),this.fireRate=Math.round(this.baseFireRate*Math.pow(.9,this.upgradeLevel-1)),this.upgradeLevelText.setText(this.upgradeLevel.toString()),e}applyDamageMultiplier(e){this.baseDamage=Math.round(this.baseDamage*e),this.damage=Math.round(this.damage*e)}applyRangeMultiplier(e){this.range=Math.round(this.range*e)}canUpgrade(){return this.upgradeLevel<5}getUpgradeCost(){return Math.round(this.buildCost*Math.pow(1.5,this.upgradeLevel-1))}getSellValue(){return Math.round(this.totalInvested*.7)}updateRangeCircle(){this.rangeCircle.clear(),this.showRange&&(this.rangeCircle.lineStyle(2,16777215,.5),this.rangeCircle.strokeCircle(this.x,this.y,this.range),this.rangeCircle.fillStyle(16777215,.1),this.rangeCircle.fillCircle(this.x,this.y,this.range))}setShowRange(e){this.showRange=e,this.updateRangeCircle()}destroy(){this.sprite.destroy(),this.rangeCircle.destroy(),this.upgradeLevelText.destroy()}getSprite(){return this.sprite}getRange(){return this.range}getDamage(){return this.damage}getUpgradeLevel(){return this.upgradeLevel}getType(){return this.towerType}getTotalInvested(){return this.totalInvested}}class rt{sprite;scene;target;damage;speed=.3;x;y;rotation=0;hasHit=!1;isFrost=!1;slowAmount=0;slowDuration=0;splashRadius=0;allEnemies=[];trailParticles=[];constructor(e,t,s,i,r,n=!1,a=0,l=0,h=0,d=[]){if(this.scene=e,this.x=t,this.y=s,this.target=i,this.damage=r,this.isFrost=n,this.slowAmount=a,this.slowDuration=l,this.splashRadius=h,this.allEnemies=d,this.sprite=e.add.graphics(),n){this.sprite.fillStyle(8978431,.3),this.sprite.fillCircle(0,0,8),this.sprite.fillStyle(65535,.6),this.sprite.fillCircle(0,0,6),this.sprite.fillStyle(16777215,1),this.sprite.fillCircle(0,0,4),this.sprite.lineStyle(2,16777215,.8);for(let u=0;u<6;u++){const f=u/6*Math.PI*2,p=Math.cos(f)*6,w=Math.sin(f)*6;this.sprite.lineBetween(0,0,p,w)}}else this.sprite.fillStyle(16746496,.3),this.sprite.fillCircle(0,0,10),this.sprite.fillStyle(16755200,.6),this.sprite.fillCircle(0,0,7),this.sprite.fillStyle(16776960,1),this.sprite.beginPath?(this.sprite.beginPath(),this.sprite.moveTo(8,0),this.sprite.lineTo(-4,-4),this.sprite.lineTo(-2,0),this.sprite.lineTo(-4,4),this.sprite.closePath(),this.sprite.fillPath()):this.sprite.fillCircle(0,0,5),this.sprite.fillStyle(16777215,.9),this.sprite.fillCircle(0,0,3),this.sprite.fillStyle(16777215,.6),this.sprite.fillCircle(4,0,2);this.sprite.x=t,this.sprite.y=s}update(e){if(this.hasHit||this.target.isDead()){this.hasHit=!0;return}const t=this.target.x,s=this.target.y,i=Math.atan2(s-this.y,t-this.x);this.rotation=i;const r=Math.cos(i)*this.speed*e,n=Math.sin(i)*this.speed*e;if(this.x+=r,this.y+=n,this.sprite.x=this.x,this.sprite.y=this.y,this.sprite.setRotation&&this.sprite.setRotation(this.rotation),Math.random()<.6&&this.scene.tweens?.add){const l=this.scene.add.graphics(),h=this.isFrost?65535:16755200,d=this.isFrost?4:5;l.fillStyle(h,.6),l.fillCircle(0,0,d),l.fillStyle(h,.3),l.fillCircle(0,0,d*1.5),l.x=this.x,l.y=this.y,l.setRotation&&l.setRotation(this.rotation),l.setDepth&&l.setDepth(90),this.trailParticles.push(l),this.scene.tweens.add({targets:l,alpha:0,scaleX:.3,scaleY:.8,duration:400,ease:"Power2",onComplete:()=>{const u=this.trailParticles.indexOf(l);u>-1&&this.trailParticles.splice(u,1),l.destroy()}})}Phaser.Math.Distance.Between(this.x,this.y,t,s)<10&&(this.target.takeDamage(this.damage),this.isFrost&&this.target.applySlow(this.slowAmount,this.slowDuration),this.splashRadius>0&&this.applySplashDamage(this.x,this.y),this.hasHit=!0)}applySplashDamage(e,t){if(this.scene.cameras?.main?.shake&&this.scene.cameras.main.shake(150,.003),this.scene.tweens?.add){const s=this.scene.add.graphics();s.fillStyle(16746496,.8),s.fillCircle(0,0,this.splashRadius*.6),s.fillStyle(16737792,.6),s.fillCircle(0,0,this.splashRadius),s.lineStyle(3,16755200,.9),s.strokeCircle(0,0,this.splashRadius),s.x=e,s.y=t,this.scene.tweens.add({targets:s,alpha:0,scale:1.5,duration:400,ease:"Power2",onComplete:()=>s.destroy()});for(let i=0;i<12;i++){const r=this.scene.add.graphics(),n=3+Math.random()*4;r.fillStyle(i%2===0?16737792:16746496,.8),r.fillCircle(0,0,n),r.x=e,r.y=t,r.setDepth&&r.setDepth(98);const a=i/12*Math.PI*2+Math.random()*.3,l=this.splashRadius*(.8+Math.random()*.6);this.scene.tweens.add({targets:r,x:e+Math.cos(a)*l,y:t+Math.sin(a)*l,alpha:0,scale:.3,duration:300+Math.random()*300,ease:"Power2",onComplete:()=>r.destroy()})}}for(const s of this.allEnemies){if(s===this.target||s.isDead())continue;Phaser.Math.Distance.Between(e,t,s.x,s.y)<=this.splashRadius&&s.takeDamage(this.damage)}}shouldDestroy(){return this.hasHit||this.target.isDead()}destroy(){this.sprite.destroy();for(const e of this.trailParticles)e.destroy();this.trailParticles=[]}}class ri extends Pe{constructor(e,t,s,i){super(e,t,s,"basic",i)}createSprite(){this.sprite=this.scene.add.graphics(),this.sprite.fillStyle(4868682,1),this.sprite.fillRoundedRect(-18,10,36,8,2),this.sprite.fillStyle(255,1),this.sprite.fillRoundedRect(-12,-8,24,18,3),this.sprite.fillStyle(153,1),this.sprite.fillRect(8,-8,4,18),this.sprite.fillStyle(2763306,1),this.sprite.fillRoundedRect(-8,-15,16,7,2),this.sprite.fillStyle(3815994,1),this.sprite.fillRect(-3,-18,6,8),this.sprite.fillStyle(16776960,.8),this.sprite.fillCircle(0,0,4),this.sprite.lineStyle(1,16777215,.6),this.sprite.strokeCircle(0,0,4),this.sprite.fillStyle(6710886,1),[-8,8].forEach(e=>{[-4,4].forEach(t=>{this.sprite.fillCircle(e,t,1.5)})}),this.sprite.lineStyle(2,16777215,.3),this.sprite.strokeRoundedRect(-12,-8,24,18,3),this.sprite.x=this.x,this.sprite.y=this.y}fireAtTarget(e,t){return new rt(this.scene,this.x,this.y,e,this.damage,!1)}}class yn extends Pe{constructor(e,t,s,i){super(e,t,s,"fast",i)}createSprite(){this.sprite=this.scene.add.graphics(),this.sprite.fillStyle(3815994,1),this.sprite.fillRoundedRect(-18,10,36,8,2),this.sprite.fillStyle(5597999,1),this.sprite.fillRoundedRect(-14,-6,28,16,2),this.sprite.fillStyle(4017951,1),this.sprite.fillRect(10,-6,4,16),this.sprite.fillStyle(9139029,1),this.sprite.fillRoundedRect(-16,0,6,8,1),this.sprite.lineStyle(1,0,.5),this.sprite.strokeRoundedRect(-16,0,6,8,1),this.sprite.fillStyle(2763306,1),this.sprite.fillRect(-3,-18,2,14),this.sprite.fillRect(1,-18,2,14),this.sprite.fillStyle(16737792,.3),this.sprite.fillCircle(-2,-18,3),this.sprite.fillCircle(2,-18,3),this.sprite.fillStyle(2763306,1),this.sprite.fillRect(-2,-6,4,6),this.sprite.fillStyle(65280,.6),this.sprite.fillCircle(-10,-2,2),this.sprite.fillCircle(10,-2,2),this.sprite.fillStyle(6710886,1),[-10,10].forEach(e=>{this.sprite.fillCircle(e,4,1.5)}),this.sprite.fillStyle(1710618,1),this.sprite.fillRoundedRect(8,-2,4,6,1),this.sprite.x=this.x,this.sprite.y=this.y}fireAtTarget(e,t){return new rt(this.scene,this.x,this.y,e,this.damage,!1)}}class wn extends Pe{constructor(e,t,s,i){super(e,t,s,"strong",i)}createSprite(){this.sprite=this.scene.add.graphics(),this.sprite.fillStyle(4868682,1),this.sprite.fillRoundedRect(-18,10,36,8,2),this.sprite.fillStyle(16711935,1),this.sprite.fillRoundedRect(-12,-8,24,18,3),this.sprite.fillStyle(11141290,1),this.sprite.fillRect(8,-8,4,18),this.sprite.fillStyle(2763306,1),this.sprite.fillRoundedRect(-8,-15,16,7,2),this.sprite.fillStyle(3815994,1),this.sprite.fillRect(-3,-18,6,8),this.sprite.fillStyle(16776960,.8),this.sprite.fillCircle(0,0,4),this.sprite.lineStyle(1,16777215,.6),this.sprite.strokeCircle(0,0,4),this.sprite.fillStyle(6710886,1),[-8,8].forEach(e=>{[-4,4].forEach(t=>{this.sprite.fillCircle(e,t,1.5)})}),this.sprite.lineStyle(2,16777215,.3),this.sprite.strokeRoundedRect(-12,-8,24,18,3),this.sprite.x=this.x,this.sprite.y=this.y}fireAtTarget(e,t){return new rt(this.scene,this.x,this.y,e,this.damage,!1)}}class bn extends Pe{constructor(e,t,s,i){super(e,t,s,"frost",i)}createSprite(){this.sprite=this.scene.add.graphics(),this.sprite.fillStyle(4868682,1),this.sprite.fillRoundedRect(-18,10,36,8,2),this.sprite.fillStyle(56831,1),this.sprite.fillRoundedRect(-12,-8,24,18,3),this.sprite.fillStyle(39355,1),this.sprite.fillRect(8,-8,4,18),this.sprite.fillStyle(2763306,1),this.sprite.fillRoundedRect(-8,-15,16,7,2),this.sprite.fillStyle(3815994,1),this.sprite.fillRect(-3,-18,6,8),this.sprite.fillStyle(16776960,.8),this.sprite.fillCircle(0,0,4),this.sprite.lineStyle(1,16777215,.6),this.sprite.strokeCircle(0,0,4),this.sprite.fillStyle(6710886,1),[-8,8].forEach(e=>{[-4,4].forEach(t=>{this.sprite.fillCircle(e,t,1.5)})}),this.sprite.lineStyle(2,16777215,.3),this.sprite.strokeRoundedRect(-12,-8,24,18,3),this.sprite.x=this.x,this.sprite.y=this.y}fireAtTarget(e,t){return new rt(this.scene,this.x,this.y,e,this.damage,!0)}}class Sn{enemy;damagePerSecond;duration;startTime;lastDamageTick;constructor(e,t,s){this.enemy=e,this.damagePerSecond=t,this.duration=s,this.startTime=Date.now(),this.lastDamageTick=this.startTime}update(){const e=Date.now();return e-this.startTime>=this.duration?!1:(e-this.lastDamageTick>=1e3&&(this.enemy.takeDamage(this.damagePerSecond),this.lastDamageTick=e),!0)}getTimeRemaining(){const e=Date.now()-this.startTime;return Math.max(0,this.duration-e)}getDamagePerSecond(){return this.damagePerSecond}refresh(){this.startTime=Date.now(),this.lastDamageTick=this.startTime}}class xn extends Pe{burnDamagePerSecond;burnDuration;constructor(e,t,s,i){super(e,t,s,"fire",i);const r=E.getInstance().getConfig().towers.fire;this.burnDamagePerSecond=r.burnDamagePerSecond||5,this.burnDuration=r.burnDuration||5e3}createSprite(){this.sprite=this.scene.add.graphics(),this.sprite.fillStyle(4868682,1),this.sprite.fillRoundedRect(-18,10,36,8,2),this.sprite.fillStyle(16737792,1),this.sprite.fillRoundedRect(-12,-8,24,18,3),this.sprite.fillStyle(13386752,1),this.sprite.fillRect(8,-8,4,18),this.sprite.fillStyle(2763306,1),this.sprite.fillRoundedRect(-8,-15,16,7,2),this.sprite.fillStyle(3815994,1),this.sprite.fillRect(-3,-18,6,8),this.sprite.fillStyle(16729088,.8),this.sprite.fillCircle(0,0,4),this.sprite.lineStyle(1,16755200,.8),this.sprite.strokeCircle(0,0,4),this.sprite.fillStyle(6710886,1),[-8,8].forEach(e=>{[-4,4].forEach(t=>{this.sprite.fillCircle(e,t,1.5)})}),this.sprite.lineStyle(2,16746496,.5),this.sprite.strokeRoundedRect(-12,-8,24,18,3),this.sprite.x=this.x,this.sprite.y=this.y}fireAtTarget(e,t){if(e.isDead())return null;this.applyBurn(e);const s=this.scene.add.graphics();return s.fillStyle(16737792,.8),s.fillCircle(this.x,this.y,8),this.scene.tweens.add({targets:s,alpha:0,scale:2,duration:300,onComplete:()=>s.destroy()}),null}applyBurn(e){new Sn(e,this.burnDamagePerSecond,this.burnDuration)}upgrade(){const e=super.upgrade();return this.burnDamagePerSecond=Math.round(this.burnDamagePerSecond*1.3),e}}class vn extends Pe{splashRadius;constructor(e,t,s,i){super(e,t,s,"splash",i);const r=E.getInstance().getConfig().towers.splash;this.splashRadius=r.splashRadius||50}createSprite(){this.sprite=this.scene.add.graphics(),this.sprite.fillStyle(4868682,1),this.sprite.fillRoundedRect(-20,10,40,8,2),this.sprite.fillStyle(9139029,1),this.sprite.fillEllipse(0,0,28,24),this.sprite.fillStyle(7033669,1),this.sprite.fillEllipse(6,0,10,24),this.sprite.fillStyle(2763306,1),this.sprite.fillEllipse(0,-12,16,8),this.sprite.fillStyle(16737792,1),this.sprite.fillTriangle(-8,4,0,-4,8,4),this.sprite.lineStyle(2,0,.8),this.sprite.strokeEllipse(0,0,28,24),this.sprite.fillStyle(6710886,1),[-10,10].forEach(e=>{this.sprite.fillCircle(e,8,2)}),this.sprite.x=this.x,this.sprite.y=this.y}fireAtTarget(e,t){return e.isDead()?null:new rt(this.scene,this.x,this.y,e,this.damage,!1,0,0,this.splashRadius,t)}upgrade(){const e=super.upgrade();return this.splashRadius=Math.round(this.splashRadius*1.1),e}}class kn extends Pe{armorPenetration;constructor(e,t,s,i){super(e,t,s,"sniper",i);const r=E.getInstance().getConfig().towers.sniper;this.armorPenetration=r.armorPenetration||.5}createSprite(){this.sprite=this.scene.add.graphics(),this.sprite.fillStyle(3815994,1),this.sprite.fillRoundedRect(-18,10,36,8,2),this.sprite.fillStyle(2969375,1),this.sprite.fillRoundedRect(-10,-6,20,16,2),this.sprite.fillStyle(1710618,1),this.sprite.fillRect(-4,-14,8,8),this.sprite.fillStyle(4474111,.7),this.sprite.fillCircle(0,-10,4),this.sprite.lineStyle(1,16777215,.5),this.sprite.strokeCircle(0,-10,4),this.sprite.fillStyle(2763306,1),this.sprite.fillRect(-2,-24,4,12),this.sprite.fillStyle(1710618,1),this.sprite.fillCircle(0,-24,3),this.sprite.lineStyle(1,16711680,.6),this.sprite.beginPath(),this.sprite.moveTo(-6,0),this.sprite.lineTo(6,0),this.sprite.moveTo(0,-6),this.sprite.lineTo(0,6),this.sprite.strokePath(),this.sprite.fillStyle(3815994,1),this.sprite.fillRect(-12,8,3,4),this.sprite.fillRect(9,8,3,4),this.sprite.x=this.x,this.sprite.y=this.y}calculateTargetValue(e){return e.getHealth()}fireAtTarget(e,t){if(e.isDead())return null;const s=this.damage*(1+this.armorPenetration);e.takeDamage(s);const i=this.scene.add.graphics();i.lineStyle(2,16776960,.8),i.beginPath(),i.moveTo(this.x,this.y),i.lineTo(e.x,e.y),i.strokePath();const r=this.scene.add.graphics();return r.fillStyle(16776960,.9),r.fillCircle(this.x,this.y-20,6),this.scene.tweens.add({targets:[i,r],alpha:0,duration:150,onComplete:()=>{i.destroy(),r.destroy()}}),null}upgrade(){const e=super.upgrade();return this.armorPenetration=Math.min(.9,this.armorPenetration+.1),e}}class ni{static createTower(e,t,s,i,r){switch(i){case"basic":return new ri(e,t,s,r);case"fast":return new yn(e,t,s,r);case"strong":return new wn(e,t,s,r);case"frost":return new bn(e,t,s,r);case"fire":return new xn(e,t,s,r);case"splash":return new vn(e,t,s,r);case"sniper":return new kn(e,t,s,r);default:return console.warn(`Unknown tower type: ${i}, creating basic tower`),new ri(e,t,s,r)}}}class Tn{scene;path;towers=[];preview=null;selectedType=null;selectedCost=0;selectedTower=null;placementDistance=45;constructor(e,t,s=45){this.scene=e,this.path=t,this.placementDistance=s,this.scene.input.on("pointerdown",i=>{this.handleTowerClick(i)})}selectTower(e,t){this.selectedType===e?(this.selectedType=null,this.selectedCost=0,this.clearPreview()):(this.selectedType=e,this.selectedCost=t)}deselectTower(){this.selectedType=null,this.selectedCost=0,this.clearPreview()}updatePreview(e){if(!this.selectedType){this.clearPreview();return}this.preview||(this.preview=this.scene.add.graphics()),this.preview.clear();const s=this.isValidPosition(e.x,e.y)?65280:16711680,i=.5;this.preview.fillStyle(s,i),this.preview.fillRect(e.x-15,e.y-15,30,30),this.preview.lineStyle(2,16777215,i),this.preview.strokeRect(e.x-15,e.y-15,30,30);const r=this.getTowerRange(this.selectedType);this.preview.lineStyle(2,s,i*.5),this.preview.strokeCircle(e.x,e.y,r)}tryPlaceTower(e,t,s){if(!this.selectedType||s<this.selectedCost)return{success:!1,cost:0};if(!this.isValidPosition(e,t))return{success:!1,cost:0};const i=ni.createTower(this.scene,e,t,this.selectedType,this.selectedCost);this.towers.push(i);const r=this.selectedCost;return this.selectedType=null,this.selectedCost=0,this.clearPreview(),{success:!0,cost:r}}update(e,t){const s=[];return this.towers.forEach(i=>{const r=i.update(e,Array.isArray(t)?t:[]);r&&s.push(r)}),s}isValidPosition(e,t){const s=this.path.getPoints(100);for(const i of s)if(Phaser.Math.Distance.Between(e,t,i.x,i.y)<this.placementDistance)return!1;for(const i of this.towers)if(Phaser.Math.Distance.Between(e,t,i.x,i.y)<65)return!1;return!0}getTowerRange(e){switch(e){case"fast":return 120;case"strong":return 180;case"frost":return 140;case"splash":return 120;case"sniper":return 250;default:return 150}}clearPreview(){this.preview&&(this.preview.destroy(),this.preview=null)}getSelectedType(){return this.selectedType}addTowerFromServer(e,t,s,i,r){const a=E.getInstance().getConfig().towers[s],l=a?a.cost:0,h=ni.createTower(this.scene,e,t,s,l);r&&(h.id=r);for(let d=1;d<i;d++)h.upgrade();this.towers.push(h)}applyDamageMultiplierToAll(e){for(const t of this.towers)t.applyDamageMultiplier&&t.applyDamageMultiplier(e)}applyRangeMultiplierToAll(e){for(const t of this.towers)t.applyRangeMultiplier&&t.applyRangeMultiplier(e)}handleTowerClick(e){if(!this.selectedType){for(const t of this.towers)if(Phaser.Math.Distance.Between(e.x,e.y,t.x,t.y)<25){this.selectedTower=t;return}this.selectedTower=null}}tryUpgradeTower(e){if(!this.selectedTower||!this.selectedTower.canUpgrade())return{success:!1,cost:0};const t=this.selectedTower.getUpgradeCost();return e<t?{success:!1,cost:0}:(this.selectedTower.upgrade(),{success:!0,cost:t})}trySellTower(){if(!this.selectedTower)return{success:!1,refund:0};const e=this.selectedTower.getSellValue(),t=this.towers.indexOf(this.selectedTower);return t>-1&&this.towers.splice(t,1),this.selectedTower.destroy(),this.selectedTower=null,{success:!0,refund:e}}getSelectedTower(){return this.selectedTower}upgradeTowerById(e,t){const s=this.towers.find(i=>i.id===e);if(s)for(console.log(`üîß Upgrading tower ${e} to level ${t}`);s.getUpgradeLevel()<t&&s.canUpgrade();)s.upgrade();else console.error(`‚ùå Tower ${e} not found for upgrade`),console.log("Available towers:",this.towers.map(i=>({id:i.id,x:i.x,y:i.y})))}sellTowerById(e){const t=this.towers.find(s=>s.id===e);if(t){const s=this.towers.indexOf(t);s>-1&&this.towers.splice(s,1),t.destroy()}}cleanup(){this.towers.forEach(e=>e.destroy()),this.towers=[],this.clearPreview(),this.selectedTower=null}}class oi{scene;path;mapConfig;mapName;mapRegistry;placedDecorations=[];constructor(e,t="classic"){this.scene=e,this.mapName=t,this.mapRegistry=ve.getInstance()}async loadMap(){const e=this.mapRegistry.getMap(this.mapName);if(!e)throw new Error(`Map not found in registry: ${this.mapName}`);this.mapConfig=e}create(){if(!this.mapConfig)throw new Error("Map not loaded. Call loadMap() first.");const e=this.scene.cameras.main.width,t=this.scene.cameras.main.height;this.createBackground(e,t),this.createPathFromWaypoints(e,t),this.addTerrainDecorations(e,t),this.drawPathWithDepth(),this.addVegetationDecorations(e,t)}createPathFromWaypoints(e,t){const s=this.mapConfig.path.waypoints;if(s.length===0)throw new Error("No waypoints defined in map");const i=this.convertWaypoint(s[0],e,t);this.path=new Phaser.Curves.Path(i.x,i.y);for(let r=1;r<s.length;r++){const n=this.convertWaypoint(s[r],e,t);this.path.lineTo(n.x,n.y)}}convertWaypoint(e,t,s){let i=e.x,r=e.y;return i<0&&(i=t+i),r<0&&(r=s+r),typeof r=="number"&&r>0&&r<=1&&(r=s*r),typeof i=="number"&&i>0&&i<=1&&(i=t*i),{x:i,y:r}}createBackground(e,t){const s=this.scene.add.graphics(),i=this.mapConfig.background,r=t*i.skyHeight;for(let h=0;h<r;h++){const d=h/r,u=Phaser.Display.Color.Interpolate.ColorWithColor(Phaser.Display.Color.HexStringToColor(i.skyColorTop),Phaser.Display.Color.HexStringToColor(i.skyColorBottom),100,d*100);s.fillStyle(Phaser.Display.Color.GetColor(u.r,u.g,u.b),1),s.fillRect(0,h,e,2)}const a=Phaser.Display.Color.HexStringToColor(i.grassColor).color,l=40;for(let h=0;h<e;h+=l)for(let d=r;d<t;d+=l){const u=(Math.random()-.5)*20,f=Phaser.Display.Color.ValueToColor(a);f.darken(u),s.fillStyle(f.color,1);const p=l+Math.random()*10,w=l+Math.random()*10;s.fillRect(h,d,p,w)}for(let h=0;h<80;h++){const d=Math.random()*e,u=r+Math.random()*(t-r),f=3+Math.random()*4;s.fillStyle(1728282,.2+Math.random()*.2),s.fillCircle(d,u,f)}}addTerrainDecorations(e,t){const s=this.mapConfig.decorations;s.water&&s.water.forEach(i=>{const r=i.x*e,n=i.y*t,a=Math.max(i.width,i.height)/2;this.canPlaceDecoration(r,n,a,i.safeDistance)&&(this.drawSteampunkWater(r,n,i.width,i.height),this.registerDecoration(r,n,a))}),s.mountains&&s.mountains.forEach(i=>{const r=i.x*e,n=i.y*t,a=Phaser.Display.Color.HexStringToColor(i.color),l=Math.max(i.width,i.height)/2;this.canPlaceDecoration(r,n,l,i.safeDistance)&&(this.drawMountain(r,n,i.width,i.height,a.color),this.registerDecoration(r,n,l))}),s.gears&&s.gears.forEach(i=>{const r=i.x*e,n=i.y*t,a=Phaser.Display.Color.HexStringToColor(i.color);this.canPlaceDecoration(r,n,i.radius,i.safeDistance)&&(this.drawSteampunkGear(r,n,i.radius,a.color),this.registerDecoration(r,n,i.radius))}),s.pipes&&s.pipes.forEach(i=>{const r=i.x*e,n=i.y*t,a=30;this.canPlaceDecoration(r,n,a,i.safeDistance)&&(this.drawSteampunkPipes(r,n),this.registerDecoration(r,n,a))})}addVegetationDecorations(e,t){const s=this.mapConfig.decorations;s.trees&&s.trees.forEach(i=>{const r=i.x*e,n=i.y*t,a=Phaser.Display.Color.HexStringToColor(i.color),l=i.size*.6;this.canPlaceDecoration(r,n,l,i.safeDistance)&&(this.drawComicTree(r,n,i.size,a.color),this.registerDecoration(r,n,l))}),s.bushes&&s.bushes.forEach(i=>{const r=i.x*e,n=i.y*t,a=Phaser.Display.Color.HexStringToColor(i.color),l=i.size*.8;this.canPlaceDecoration(r,n,l,i.safeDistance)&&(this.drawBush(r,n,i.size,a.color),this.registerDecoration(r,n,l))}),s.lamps&&s.lamps.forEach(i=>{const r=i.x*e,n=i.y*t,a=20;this.canPlaceDecoration(r,n,a,i.safeDistance)&&(this.drawSteampunkLamp(r,n),this.registerDecoration(r,n,a))})}isOnPath(e,t,s){const i=this.path.getPoints(100);for(const r of i)if(Phaser.Math.Distance.Between(e,t,r.x,r.y)<s)return!0;return!1}canPlaceDecoration(e,t,s,i){if(this.isOnPath(e,t,i))return!1;for(const r of this.placedDecorations){const n=Phaser.Math.Distance.Between(e,t,r.x,r.y),a=s+r.radius+10;if(n<a)return!1}return!0}registerDecoration(e,t,s){this.placedDecorations.push({x:e,y:t,radius:s})}drawPathWithDepth(){const e=this.scene.add.graphics(),t=this.path.getPoints(200);for(let s=0;s<t.length-1;s++){const i=t[s],r=t[s+1],n=r.x-i.x,a=r.y-i.y,l=Math.sqrt(n*n+a*a);if(l===0)continue;const h=-a/l,d=n/l,u=22,f=Math.sin(s*.3)*2,p=u+f;e.fillStyle(7036239,1),e.fillTriangle(i.x-h*p,i.y-d*p,i.x+h*p,i.y+d*p,r.x-h*p,r.y-d*p),e.fillTriangle(r.x+h*p,r.y+d*p,r.x-h*p,r.y-d*p,i.x+h*p,i.y+d*p)}e.lineStyle(2,4864554,.4);for(let s=0;s<t.length-1;s++){const i=t[s],r=t[Math.min(s+1,t.length-1)].x-i.x,n=t[Math.min(s+1,t.length-1)].y-i.y,a=Math.sqrt(r*r+n*n);if(a===0)continue;const l=-n/a,h=r/a,d=24;e.beginPath(),e.moveTo(i.x-l*d,i.y-h*d),e.lineTo(t[Math.min(s+1,t.length-1)].x-l*d,t[Math.min(s+1,t.length-1)].y-h*d),e.strokePath(),e.beginPath(),e.moveTo(i.x+l*d,i.y+h*d),e.lineTo(t[Math.min(s+1,t.length-1)].x+l*d,t[Math.min(s+1,t.length-1)].y+h*d),e.strokePath()}for(let s=0;s<t.length;s+=5){const i=t[s];if(Math.random()>.6){const r=(Math.random()-.5)*30,n=(Math.random()-.5)*30,a=3+Math.random()*4;e.fillStyle(9075306,.5+Math.random()*.3),e.fillCircle(i.x+r,i.y+n,a),e.fillStyle(11184810,.3),e.fillCircle(i.x+r-1,i.y+n-1,a*.4)}if(Math.random()>.8){e.lineStyle(1,5917242,.3);const r=5+Math.random()*10,n=Math.random()*Math.PI*2;e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(i.x+Math.cos(n)*r,i.y+Math.sin(n)*r),e.strokePath()}}for(let s=0;s<t.length;s+=8){const i=t[s],r=Math.min(s+1,t.length-1),n=t[r].x-i.x,a=t[r].y-i.y,l=Math.sqrt(n*n+a*a);if(l===0)continue;const h=-a/l,d=n/l;for(const u of[-1,1]){const f=26+Math.random()*8,p=i.x+h*f*u,w=i.y+d*f*u,C=3+Math.floor(Math.random()*3);for(let I=0;I<C;I++){const v=(Math.random()-.5)*.4,k=4+Math.random()*4,O=p+(Math.random()-.5)*3,b=w+(Math.random()-.5)*3;e.lineStyle(1,2969622,.6+Math.random()*.2),e.beginPath(),e.moveTo(O,b),e.lineTo(O+Math.sin(v)*2,b-k),e.strokePath()}}}}drawSteampunkWater(e,t,s,i){const r=this.scene.add.graphics();r.fillStyle(4620980,.7),r.fillEllipse(e,t,s,i),r.lineStyle(3,9139029,1),r.strokeEllipse(e,t,s,i);for(let n=0;n<8;n++){const a=n/8*Math.PI*2,l=e+Math.cos(a)*(s/2),h=t+Math.sin(a)*(i/2);r.fillStyle(6908265,1),r.fillCircle(l,h,3)}}drawMountain(e,t,s,i,r){const n=this.scene.add.graphics();n.fillStyle(r,1),n.beginPath(),n.moveTo(e-s/2,t+i/2),n.lineTo(e-s/4,t-i/4),n.lineTo(e,t-i/2),n.lineTo(e+s/4,t-i/4),n.lineTo(e+s/2,t+i/2),n.closePath(),n.fillPath(),n.fillStyle(16775930,1),n.beginPath(),n.moveTo(e-s/8,t-i/4),n.lineTo(e,t-i/2),n.lineTo(e+s/8,t-i/4),n.closePath(),n.fillPath(),n.lineStyle(3,0,1),n.beginPath(),n.moveTo(e-s/2,t+i/2),n.lineTo(e,t-i/2),n.lineTo(e+s/2,t+i/2),n.strokePath()}drawSteampunkGear(e,t,s,i){const r=this.scene.add.graphics();r.fillStyle(i,1),r.fillCircle(e,t,s),r.fillStyle(i,1);const n=8;for(let a=0;a<n;a++){const l=a/n*Math.PI*2,h=e+Math.cos(l)*s,d=t+Math.sin(l)*s;r.fillRect(h-3,d-5,6,10)}r.fillStyle(3355443,1),r.fillCircle(e,t,s*.4),r.fillStyle(6908265,1);for(let a=0;a<4;a++){const l=a/4*Math.PI*2+Math.PI/4,h=e+Math.cos(l)*s*.6,d=t+Math.sin(l)*s*.6;r.fillCircle(h,d,3)}r.lineStyle(2,0,1),r.strokeCircle(e,t,s)}drawSteampunkPipes(e,t){const s=this.scene.add.graphics();s.fillStyle(9139029,1),s.fillRect(e-8,t-60,16,120);for(let i=0;i<3;i++){const r=t-40+i*40;s.lineStyle(2,6636321,1),s.lineTo(e-8,r),s.lineTo(e+8,r),s.strokePath(),s.fillStyle(6908265,1),s.fillCircle(e-6,r,2),s.fillCircle(e+6,r,2)}s.fillStyle(13467442,1),s.fillCircle(e+15,t,8),s.lineStyle(3,6636321,1),s.lineTo(e+8,t),s.lineTo(e+22,t),s.strokePath()}drawComicTree(e,t,s,i){const r=this.scene.add.graphics();r.fillStyle(6636321,1),r.fillRect(e-s*.15,t,s*.3,s*.8),r.lineStyle(2,0,1),r.strokeRect(e-s*.15,t,s*.3,s*.8),r.fillStyle(i,1),r.fillCircle(e,t-s*.2,s*.5),r.fillCircle(e-s*.3,t,s*.4),r.fillCircle(e+s*.3,t,s*.4),r.lineStyle(2,0,1),r.strokeCircle(e,t-s*.2,s*.5),r.strokeCircle(e-s*.3,t,s*.4),r.strokeCircle(e+s*.3,t,s*.4),r.fillStyle(16777215,.3),r.fillCircle(e-s*.1,t-s*.3,s*.15)}drawBush(e,t,s,i){const r=this.scene.add.graphics();r.fillStyle(i,1),r.fillCircle(e,t,s),r.fillCircle(e-s*.5,t+s*.2,s*.7),r.fillCircle(e+s*.5,t+s*.2,s*.7),r.lineStyle(2,0,1),r.strokeCircle(e,t,s),r.strokeCircle(e-s*.5,t+s*.2,s*.7),r.strokeCircle(e+s*.5,t+s*.2,s*.7),r.fillStyle(16777215,.2),r.fillCircle(e-s*.2,t-s*.2,s*.3)}drawSteampunkLamp(e,t){const s=this.scene.add.graphics();s.fillStyle(9139029,1),s.fillRect(e-4,t,8,80);for(let i=0;i<4;i++){const r=t+i*20;s.fillStyle(6908265,1),s.fillCircle(e-4,r,2),s.fillCircle(e+4,r,2)}s.fillStyle(13467442,1),s.fillRect(e-12,t-20,24,20),s.fillStyle(16777113,.8),s.fillRect(e-8,t-16,16,12),s.fillStyle(9139029,1),s.beginPath(),s.moveTo(e-14,t-20),s.lineTo(e,t-28),s.lineTo(e+14,t-20),s.closePath(),s.fillPath(),s.lineStyle(2,0,1),s.strokeRect(e-12,t-20,24,20),s.strokeRect(e-4,t,8,80)}getPath(){return this.path}getMapConfig(){return this.mapConfig}getPlacementDistance(){const e=this.mapConfig?.path?.placementDistance;return typeof e=="number"?e:45}}class Cn{xp=0;level=1;researches;constructor(){this.researches=new Map,this.initializeResearches(),this.checkUnlocks()}initializeResearches(){this.researches.set("basic_tower_upgrade",{id:"basic_tower_upgrade",name:"Basis-Turm Upgrade",description:"Verbessert Basis-T√ºrme: +20% Schaden, +10% Reichweite",goldCost:150,xpRequired:0,unlocked:!0,researched:!1}),this.researches.set("frost_tower",{id:"frost_tower",name:"Frost-Turm",description:"Schaltet den Frost-Turm frei, der Gegner verlangsamt",goldCost:300,xpRequired:0,unlocked:!1,researched:!1}),this.researches.set("fire_tower",{id:"fire_tower",name:"Feuer-Turm",description:"Schaltet den Feuer-Turm frei, der Gegner verbrennt (8 Schaden/Sek f√ºr 5 Sek)",goldCost:350,xpRequired:0,unlocked:!1,researched:!1}),this.researches.set("tower_damage_1",{id:"tower_damage_1",name:"Verst√§rkter Schaden I",description:"+10% Schaden f√ºr alle T√ºrme",goldCost:200,xpRequired:0,unlocked:!1,researched:!1}),this.researches.set("tower_range_1",{id:"tower_range_1",name:"Erweiterte Reichweite I",description:"+10% Reichweite f√ºr alle T√ºrme",goldCost:200,xpRequired:0,unlocked:!1,researched:!1})}addXP(e){this.xp+=e;let t=!1;const s=[];for(;this.xp>=this.getXPForLevel(this.level+1);){this.level++,t=!0;const i=this.checkUnlocks();s.push(...i)}return t?{levelUp:!0,newLevel:this.level,newResearchUnlocked:s}:{levelUp:!1,newLevel:this.level,newResearchUnlocked:[]}}getXPForLevel(e){return e*100}checkUnlocks(){const e=[];if(console.log("Checking unlocks, current level:",this.level),this.level>=3){const t=this.researches.get("frost_tower");console.log("Frost tower before unlock:",t?.unlocked),t&&!t.unlocked&&(t.unlocked=!0,e.push(t.name),console.log("Frost tower unlocked!"))}if(this.level>=4){const t=this.researches.get("fire_tower");t&&!t.unlocked&&(t.unlocked=!0,e.push(t.name));const s=this.researches.get("tower_damage_1");s&&!s.unlocked&&(s.unlocked=!0,e.push(s.name));const i=this.researches.get("tower_range_1");i&&!i.unlocked&&(i.unlocked=!0,e.push(i.name))}return e}canResearch(e,t){const s=this.researches.get(e);return s?s.unlocked&&!s.researched&&t>=s.goldCost:!1}research(e){const t=this.researches.get(e);return!t||!t.unlocked||t.researched?!1:(t.researched=!0,!0)}isResearched(e){const t=this.researches.get(e);return t?t.researched:!1}getAvailableResearches(){const e=Array.from(this.researches.values()).filter(t=>t.unlocked&&!t.researched);return console.log("Available researches:",e.map(t=>({name:t.name,unlocked:t.unlocked,researched:t.researched}))),console.log("Current level:",this.level,"XP:",this.xp),e}getResearch(e){return this.researches.get(e)}getXP(){return this.xp}getLevel(){return this.level}getXPForNextLevel(){return this.getXPForLevel(this.level+1)}getXPProgress(){const e=this.level>1?this.getXPForLevel(this.level):0,t=this.getXPForLevel(this.level+1),s=this.xp-e,i=t-e;return s/i}}class Rn{projectiles=[];addProjectile(e){this.projectiles.push(e)}update(e){for(const t of this.projectiles)t.update(e);this.projectiles=this.projectiles.filter(t=>t.shouldDestroy()?(t.destroy(),!1):!0)}getCount(){return this.projectiles.length}clear(){for(const e of this.projectiles)e.destroy();this.projectiles=[]}}class En{constructor(e){this.scene=e}showLevelUp(e){const t=this.scene.cameras.main.width,s=this.scene.cameras.main.height,i=this.scene.add.container(t/2,s/3),r=this.scene.add.rectangle(0,0,300,100,0,.8),n=this.scene.add.text(0,-20,"Level Up!",{font:"bold 32px Arial",color:"#ffff00"}).setOrigin(.5),a=this.scene.add.text(0,20,`Level ${e}`,{font:"24px Arial",color:"#ffffff"}).setOrigin(.5);i.add([r,n,a]),i.setDepth(1e3),this.scene.tweens.add({targets:i,alpha:{from:1,to:0},y:s/3-50,duration:2e3,ease:"Power2",onComplete:()=>i.destroy()})}showTowerUpgrade(){const e=this.scene.cameras.main.width,t=this.scene.cameras.main.height,s=this.scene.add.container(e/2,t/2),i=this.scene.add.rectangle(0,0,250,80,0,.8),r=this.scene.add.text(0,0,"Turm Verbessert!",{font:"bold 28px Arial",color:"#ff9900"}).setOrigin(.5);s.add([i,r]),s.setDepth(1e3),this.scene.tweens.add({targets:s,alpha:{from:1,to:0},y:t/2-50,duration:1500,ease:"Power2",onComplete:()=>s.destroy()})}showTowerSold(e){const t=this.scene.cameras.main.width,s=this.scene.cameras.main.height,i=this.scene.add.container(t/2,s/2),r=this.scene.add.rectangle(0,0,280,100,0,.8),n=this.scene.add.text(0,-15,"Turm Verkauft!",{font:"bold 28px Arial",color:"#cc0000"}).setOrigin(.5),a=this.scene.add.text(0,20,`+${e} Gold`,{font:"22px Arial",color:"#ffff00"}).setOrigin(.5);i.add([r,n,a]),i.setDepth(1e3),this.scene.tweens.add({targets:i,alpha:{from:1,to:0},y:s/2-50,duration:1500,ease:"Power2",onComplete:()=>i.destroy()})}showResearchUnlocked(e){const t=this.scene.cameras.main.width,s=this.scene.cameras.main.height,i=this.scene.add.container(t/2,s/2),r=this.scene.add.rectangle(0,0,400,120,0,.9);r.setStrokeStyle(3,10027263,1);const n=this.scene.add.text(0,-30,"üî¨",{font:"bold 40px Arial"}).setOrigin(.5),a=this.scene.add.text(0,10,"Neue Forschung verf√ºgbar!",{font:"bold 24px Arial",color:"#ff00ff"}).setOrigin(.5),l=this.scene.add.text(0,40,e,{font:"20px Arial",color:"#ffff00"}).setOrigin(.5);i.add([r,n,a,l]),i.setDepth(1001),i.setScale(.5),this.scene.tweens.add({targets:i,scale:{from:.5,to:1},duration:300,ease:"Back.easeOut"}),this.scene.tweens.add({targets:r,scaleX:{from:1,to:1.05},scaleY:{from:1,to:1.05},duration:800,yoyo:!0,repeat:2}),this.scene.tweens.add({targets:i,alpha:{from:1,to:0},y:s/2-80,delay:3e3,duration:1e3,ease:"Power2",onComplete:()=>i.destroy()})}}class _n{constructor(e,t,s){this.researchManager=e,this.ui=t,this.onLevelUp=s}awardXP(e,t){const s=this.researchManager.addXP(e);this.ui.updateXP(this.researchManager.getXP(),this.researchManager.getLevel()),t&&t.setPlayerLevel(this.researchManager.getLevel()),s.levelUp&&this.onLevelUp(s.newLevel,s.newResearchUnlocked)}checkAvailableResearches(e){const t=this.researchManager.getAvailableResearches();return t.length===0?!1:t.some(i=>this.researchManager.canResearch(i.id,e))||t.length>0}}class Pn{constructor(e,t,s,i,r){this.waveManager=e,this.xpHandler=t,this.onGoldChange=s,this.onLifeLost=i,this.onWaveComplete=r}handleEnemyKilled(e,t){this.onGoldChange(e),this.xpHandler.awardXP(t,this.waveManager)}handleEnemyEscaped(){this.onLifeLost()}handleWaveCompleted(e){const t=50+e*10,s=(20+e*5)*2;this.onGoldChange(t),this.xpHandler.awardXP(s,this.waveManager),this.onWaveComplete(e)}}class Mn{constructor(e,t,s,i){this.towerManager=e,this.ui=t,this.onGoldChange=s,this.onNotification=i}selectTower(e,t){this.towerManager.selectTower(e,t),this.ui.updateButtonStyles(this.towerManager.getSelectedType()||void 0)}tryPlaceTower(e,t,s){const i=this.towerManager.tryPlaceTower(e,t,s);return i.success?(this.onGoldChange(-i.cost),this.ui.updateButtonStyles(),!0):!1}tryUpgradeTower(e){const t=this.towerManager.tryUpgradeTower(e);return t.success?(this.onGoldChange(-t.cost),this.onNotification("upgrade"),!0):!1}trySellTower(){const e=this.towerManager.trySellTower();return e.success?(this.onGoldChange(e.refund),this.onNotification("sell",e.refund),!0):!1}getSelectedTower(){return this.towerManager.getSelectedTower()}deselectTower(){this.towerManager.deselectTower()}}const ge=Object.create(null);ge.open="0";ge.close="1";ge.ping="2";ge.pong="3";ge.message="4";ge.upgrade="5";ge.noop="6";const Tt=Object.create(null);Object.keys(ge).forEach(o=>{Tt[ge[o]]=o});const rs={type:"error",data:"parser error"},Ri=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",Ei=typeof ArrayBuffer=="function",_i=o=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(o):o&&o.buffer instanceof ArrayBuffer,gs=({type:o,data:e},t,s)=>Ri&&e instanceof Blob?t?s(e):ai(e,s):Ei&&(e instanceof ArrayBuffer||_i(e))?t?s(e):ai(new Blob([e]),s):s(ge[o]+(e||"")),ai=(o,e)=>{const t=new FileReader;return t.onload=function(){const s=t.result.split(",")[1];e("b"+(s||""))},t.readAsDataURL(o)};function li(o){return o instanceof Uint8Array?o:o instanceof ArrayBuffer?new Uint8Array(o):new Uint8Array(o.buffer,o.byteOffset,o.byteLength)}let Qt;function An(o,e){if(Ri&&o.data instanceof Blob)return o.data.arrayBuffer().then(li).then(e);if(Ei&&(o.data instanceof ArrayBuffer||_i(o.data)))return e(li(o.data));gs(o,!1,t=>{Qt||(Qt=new TextEncoder),e(Qt.encode(t))})}const ci="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",ze=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let o=0;o<ci.length;o++)ze[ci.charCodeAt(o)]=o;const In=o=>{let e=o.length*.75,t=o.length,s,i=0,r,n,a,l;o[o.length-1]==="="&&(e--,o[o.length-2]==="="&&e--);const h=new ArrayBuffer(e),d=new Uint8Array(h);for(s=0;s<t;s+=4)r=ze[o.charCodeAt(s)],n=ze[o.charCodeAt(s+1)],a=ze[o.charCodeAt(s+2)],l=ze[o.charCodeAt(s+3)],d[i++]=r<<2|n>>4,d[i++]=(n&15)<<4|a>>2,d[i++]=(a&3)<<6|l&63;return h},Ln=typeof ArrayBuffer=="function",ms=(o,e)=>{if(typeof o!="string")return{type:"message",data:Pi(o,e)};const t=o.charAt(0);return t==="b"?{type:"message",data:Bn(o.substring(1),e)}:Tt[t]?o.length>1?{type:Tt[t],data:o.substring(1)}:{type:Tt[t]}:rs},Bn=(o,e)=>{if(Ln){const t=In(o);return Pi(t,e)}else return{base64:!0,data:o}},Pi=(o,e)=>{switch(e){case"blob":return o instanceof Blob?o:new Blob([o]);case"arraybuffer":default:return o instanceof ArrayBuffer?o:o.buffer}},Mi="",On=(o,e)=>{const t=o.length,s=new Array(t);let i=0;o.forEach((r,n)=>{gs(r,!1,a=>{s[n]=a,++i===t&&e(s.join(Mi))})})},Dn=(o,e)=>{const t=o.split(Mi),s=[];for(let i=0;i<t.length;i++){const r=ms(t[i],e);if(s.push(r),r.type==="error")break}return s};function Un(){return new TransformStream({transform(o,e){An(o,t=>{const s=t.length;let i;if(s<126)i=new Uint8Array(1),new DataView(i.buffer).setUint8(0,s);else if(s<65536){i=new Uint8Array(3);const r=new DataView(i.buffer);r.setUint8(0,126),r.setUint16(1,s)}else{i=new Uint8Array(9);const r=new DataView(i.buffer);r.setUint8(0,127),r.setBigUint64(1,BigInt(s))}o.data&&typeof o.data!="string"&&(i[0]|=128),e.enqueue(i),e.enqueue(t)})}})}let zt;function wt(o){return o.reduce((e,t)=>e+t.length,0)}function bt(o,e){if(o[0].length===e)return o.shift();const t=new Uint8Array(e);let s=0;for(let i=0;i<e;i++)t[i]=o[0][s++],s===o[0].length&&(o.shift(),s=0);return o.length&&s<o[0].length&&(o[0]=o[0].slice(s)),t}function Nn(o,e){zt||(zt=new TextDecoder);const t=[];let s=0,i=-1,r=!1;return new TransformStream({transform(n,a){for(t.push(n);;){if(s===0){if(wt(t)<1)break;const l=bt(t,1);r=(l[0]&128)===128,i=l[0]&127,i<126?s=3:i===126?s=1:s=2}else if(s===1){if(wt(t)<2)break;const l=bt(t,2);i=new DataView(l.buffer,l.byteOffset,l.length).getUint16(0),s=3}else if(s===2){if(wt(t)<8)break;const l=bt(t,8),h=new DataView(l.buffer,l.byteOffset,l.length),d=h.getUint32(0);if(d>Math.pow(2,21)-1){a.enqueue(rs);break}i=d*Math.pow(2,32)+h.getUint32(4),s=3}else{if(wt(t)<i)break;const l=bt(t,i);a.enqueue(ms(r?l:zt.decode(l),e)),s=0}if(i===0||i>o){a.enqueue(rs);break}}}})}const Ai=4;function G(o){if(o)return $n(o)}function $n(o){for(var e in G.prototype)o[e]=G.prototype[e];return o}G.prototype.on=G.prototype.addEventListener=function(o,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+o]=this._callbacks["$"+o]||[]).push(e),this};G.prototype.once=function(o,e){function t(){this.off(o,t),e.apply(this,arguments)}return t.fn=e,this.on(o,t),this};G.prototype.off=G.prototype.removeListener=G.prototype.removeAllListeners=G.prototype.removeEventListener=function(o,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+o];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+o],this;for(var s,i=0;i<t.length;i++)if(s=t[i],s===e||s.fn===e){t.splice(i,1);break}return t.length===0&&delete this._callbacks["$"+o],this};G.prototype.emit=function(o){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+o],s=1;s<arguments.length;s++)e[s-1]=arguments[s];if(t){t=t.slice(0);for(var s=0,i=t.length;s<i;++s)t[s].apply(this,e)}return this};G.prototype.emitReserved=G.prototype.emit;G.prototype.listeners=function(o){return this._callbacks=this._callbacks||{},this._callbacks["$"+o]||[]};G.prototype.hasListeners=function(o){return!!this.listeners(o).length};const It=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0),ie=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),Hn="arraybuffer";function Ii(o,...e){return e.reduce((t,s)=>(o.hasOwnProperty(s)&&(t[s]=o[s]),t),{})}const Wn=ie.setTimeout,Fn=ie.clearTimeout;function Lt(o,e){e.useNativeTimers?(o.setTimeoutFn=Wn.bind(ie),o.clearTimeoutFn=Fn.bind(ie)):(o.setTimeoutFn=ie.setTimeout.bind(ie),o.clearTimeoutFn=ie.clearTimeout.bind(ie))}const Gn=1.33;function qn(o){return typeof o=="string"?Vn(o):Math.ceil((o.byteLength||o.size)*Gn)}function Vn(o){let e=0,t=0;for(let s=0,i=o.length;s<i;s++)e=o.charCodeAt(s),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(s++,t+=4);return t}function Li(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function jn(o){let e="";for(let t in o)o.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(o[t]));return e}function Xn(o){let e={},t=o.split("&");for(let s=0,i=t.length;s<i;s++){let r=t[s].split("=");e[decodeURIComponent(r[0])]=decodeURIComponent(r[1])}return e}class Yn extends Error{constructor(e,t,s){super(e),this.description=t,this.context=s,this.type="TransportError"}}class ys extends G{constructor(e){super(),this.writable=!1,Lt(this,e),this.opts=e,this.query=e.query,this.socket=e.socket,this.supportsBinary=!e.forceBase64}onError(e,t,s){return super.emitReserved("error",new Yn(e,t,s)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=ms(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){const t=jn(e);return t.length?"?"+t:""}}class Kn extends ys{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this._polling||!this.writable){let s=0;this._polling&&(s++,this.once("pollComplete",function(){--s||t()})),this.writable||(s++,this.once("drain",function(){--s||t()}))}else t()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){const t=s=>{if(this.readyState==="opening"&&s.type==="open"&&this.onOpen(),s.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(s)};Dn(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,On(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return this.opts.timestampRequests!==!1&&(t[this.opts.timestampParam]=Li()),!this.supportsBinary&&!t.sid&&(t.b64=1),this.createUri(e,t)}}let Bi=!1;try{Bi=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const Zn=Bi;function Jn(){}class Qn extends Kn{constructor(e){if(super(e),typeof location<"u"){const t=location.protocol==="https:";let s=location.port;s||(s=t?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||s!==e.port}}doWrite(e,t){const s=this.request({method:"POST",data:e});s.on("success",t),s.on("error",(i,r)=>{this.onError("xhr post error",i,r)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,s)=>{this.onError("xhr poll error",t,s)}),this.pollXhr=e}}class fe extends G{constructor(e,t,s){super(),this.createRequest=e,Lt(this,s),this._opts=s,this._method=s.method||"GET",this._uri=t,this._data=s.data!==void 0?s.data:null,this._create()}_create(){var e;const t=Ii(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this._opts.xd;const s=this._xhr=this.createRequest(t);try{s.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){s.setDisableHeaderCheck&&s.setDisableHeaderCheck(!0);for(let i in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(i)&&s.setRequestHeader(i,this._opts.extraHeaders[i])}}catch{}if(this._method==="POST")try{s.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{s.setRequestHeader("Accept","*/*")}catch{}(e=this._opts.cookieJar)===null||e===void 0||e.addCookies(s),"withCredentials"in s&&(s.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(s.timeout=this._opts.requestTimeout),s.onreadystatechange=()=>{var i;s.readyState===3&&((i=this._opts.cookieJar)===null||i===void 0||i.parseCookies(s.getResponseHeader("set-cookie"))),s.readyState===4&&(s.status===200||s.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof s.status=="number"?s.status:0)},0))},s.send(this._data)}catch(i){this.setTimeoutFn(()=>{this._onError(i)},0);return}typeof document<"u"&&(this._index=fe.requestsCount++,fe.requests[this._index]=this)}_onError(e){this.emitReserved("error",e,this._xhr),this._cleanup(!0)}_cleanup(e){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=Jn,e)try{this._xhr.abort()}catch{}typeof document<"u"&&delete fe.requests[this._index],this._xhr=null}}_onLoad(){const e=this._xhr.responseText;e!==null&&(this.emitReserved("data",e),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}fe.requestsCount=0;fe.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",hi);else if(typeof addEventListener=="function"){const o="onpagehide"in ie?"pagehide":"unload";addEventListener(o,hi,!1)}}function hi(){for(let o in fe.requests)fe.requests.hasOwnProperty(o)&&fe.requests[o].abort()}const zn=(function(){const o=Oi({xdomain:!1});return o&&o.responseType!==null})();class eo extends Qn{constructor(e){super(e);const t=e&&e.forceBase64;this.supportsBinary=zn&&!t}request(e={}){return Object.assign(e,{xd:this.xd},this.opts),new fe(Oi,this.uri(),e)}}function Oi(o){const e=o.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||Zn))return new XMLHttpRequest}catch{}if(!e)try{return new ie[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const Di=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class to extends ys{get name(){return"websocket"}doOpen(){const e=this.uri(),t=this.opts.protocols,s=Di?{}:Ii(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(s.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(e,t,s)}catch(i){return this.emitReserved("error",i)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const s=e[t],i=t===e.length-1;gs(s,this.supportsBinary,r=>{try{this.doWrite(s,r)}catch{}i&&It(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=Li()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}}const es=ie.WebSocket||ie.MozWebSocket;class so extends to{createSocket(e,t,s){return Di?new es(e,t,s):t?new es(e,t):new es(e)}doWrite(e,t){this.ws.send(t)}}class io extends ys{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(e){return this.emitReserved("error",e)}this._transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(e=>{const t=Nn(Number.MAX_SAFE_INTEGER,this.socket.binaryType),s=e.readable.pipeThrough(t).getReader(),i=Un();i.readable.pipeTo(e.writable),this._writer=i.writable.getWriter();const r=()=>{s.read().then(({done:a,value:l})=>{a||(this.onPacket(l),r())}).catch(a=>{})};r();const n={type:"open"};this.query.sid&&(n.data=`{"sid":"${this.query.sid}"}`),this._writer.write(n).then(()=>this.onOpen())})})}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const s=e[t],i=t===e.length-1;this._writer.write(s).then(()=>{i&&It(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this._transport)===null||e===void 0||e.close()}}const ro={websocket:so,webtransport:io,polling:eo},no=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,oo=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function ns(o){if(o.length>8e3)throw"URI too long";const e=o,t=o.indexOf("["),s=o.indexOf("]");t!=-1&&s!=-1&&(o=o.substring(0,t)+o.substring(t,s).replace(/:/g,";")+o.substring(s,o.length));let i=no.exec(o||""),r={},n=14;for(;n--;)r[oo[n]]=i[n]||"";return t!=-1&&s!=-1&&(r.source=e,r.host=r.host.substring(1,r.host.length-1).replace(/;/g,":"),r.authority=r.authority.replace("[","").replace("]","").replace(/;/g,":"),r.ipv6uri=!0),r.pathNames=ao(r,r.path),r.queryKey=lo(r,r.query),r}function ao(o,e){const t=/\/{2,9}/g,s=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&s.splice(0,1),e.slice(-1)=="/"&&s.splice(s.length-1,1),s}function lo(o,e){const t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(s,i,r){i&&(t[i]=r)}),t}const os=typeof addEventListener=="function"&&typeof removeEventListener=="function",Ct=[];os&&addEventListener("offline",()=>{Ct.forEach(o=>o())},!1);class ke extends G{constructor(e,t){if(super(),this.binaryType=Hn,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,e&&typeof e=="object"&&(t=e,e=null),e){const s=ns(e);t.hostname=s.host,t.secure=s.protocol==="https"||s.protocol==="wss",t.port=s.port,s.query&&(t.query=s.query)}else t.host&&(t.hostname=ns(t.host).host);Lt(this,t),this.secure=t.secure!=null?t.secure:typeof location<"u"&&location.protocol==="https:",t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=t.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},t.transports.forEach(s=>{const i=s.prototype.name;this.transports.push(i),this._transportsByName[i]=s}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Xn(this.opts.query)),os&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},Ct.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=Ai,t.transport=e,this.id&&(t.sid=this.id);const s=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new this._transportsByName[e](s)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const e=this.opts.rememberUpgrade&&ke.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const t=this.createTransport(e);t.open(),this.setTransport(t)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",t=>this._onClose("transport close",t))}onOpen(){this.readyState="open",ke.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const t=new Error("server error");t.code=e.data,this._onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data);break}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this._pingInterval=e.pingInterval,this._pingTimeout=e.pingTimeout,this._maxPayload=e.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const e=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+e,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},e),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this._getWritablePackets();this.transport.send(e),this._prevBufferLen=e.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let s=0;s<this.writeBuffer.length;s++){const i=this.writeBuffer[s].data;if(i&&(t+=qn(i)),s>0&&t>this._maxPayload)return this.writeBuffer.slice(0,s);t+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const e=Date.now()>this._pingTimeoutTime;return e&&(this._pingTimeoutTime=0,It(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),e}write(e,t,s){return this._sendPacket("message",e,t,s),this}send(e,t,s){return this._sendPacket("message",e,t,s),this}_sendPacket(e,t,s,i){if(typeof t=="function"&&(i=t,t=void 0),typeof s=="function"&&(i=s,s=null),this.readyState==="closing"||this.readyState==="closed")return;s=s||{},s.compress=s.compress!==!1;const r={type:e,data:t,options:s};this.emitReserved("packetCreate",r),this.writeBuffer.push(r),i&&this.once("flush",i),this.flush()}close(){const e=()=>{this._onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},s=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?s():e()}):this.upgrading?s():e()),this}_onError(e){if(ke.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",e),this._onClose("transport error",e)}_onClose(e,t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),os&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const s=Ct.indexOf(this._offlineEventListener);s!==-1&&Ct.splice(s,1)}this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this._prevBufferLen=0}}}ke.protocol=Ai;class co extends ke{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let e=0;e<this._upgrades.length;e++)this._probe(this._upgrades[e])}_probe(e){let t=this.createTransport(e),s=!1;ke.priorWebsocketSuccess=!1;const i=()=>{s||(t.send([{type:"ping",data:"probe"}]),t.once("packet",u=>{if(!s)if(u.type==="pong"&&u.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;ke.priorWebsocketSuccess=t.name==="websocket",this.transport.pause(()=>{s||this.readyState!=="closed"&&(d(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())})}else{const f=new Error("probe error");f.transport=t.name,this.emitReserved("upgradeError",f)}}))};function r(){s||(s=!0,d(),t.close(),t=null)}const n=u=>{const f=new Error("probe error: "+u);f.transport=t.name,r(),this.emitReserved("upgradeError",f)};function a(){n("transport closed")}function l(){n("socket closed")}function h(u){t&&u.name!==t.name&&r()}const d=()=>{t.removeListener("open",i),t.removeListener("error",n),t.removeListener("close",a),this.off("close",l),this.off("upgrading",h)};t.once("open",i),t.once("error",n),t.once("close",a),this.once("close",l),this.once("upgrading",h),this._upgrades.indexOf("webtransport")!==-1&&e!=="webtransport"?this.setTimeoutFn(()=>{s||t.open()},200):t.open()}onHandshake(e){this._upgrades=this._filterUpgrades(e.upgrades),super.onHandshake(e)}_filterUpgrades(e){const t=[];for(let s=0;s<e.length;s++)~this.transports.indexOf(e[s])&&t.push(e[s]);return t}}let ho=class extends co{constructor(e,t={}){const s=typeof e=="object"?e:t;(!s.transports||s.transports&&typeof s.transports[0]=="string")&&(s.transports=(s.transports||["polling","websocket","webtransport"]).map(i=>ro[i]).filter(i=>!!i)),super(e,s)}};function uo(o,e="",t){let s=o;t=t||typeof location<"u"&&location,o==null&&(o=t.protocol+"//"+t.host),typeof o=="string"&&(o.charAt(0)==="/"&&(o.charAt(1)==="/"?o=t.protocol+o:o=t.host+o),/^(https?|wss?):\/\//.test(o)||(typeof t<"u"?o=t.protocol+"//"+o:o="https://"+o),s=ns(o)),s.port||(/^(http|ws)$/.test(s.protocol)?s.port="80":/^(http|ws)s$/.test(s.protocol)&&(s.port="443")),s.path=s.path||"/";const r=s.host.indexOf(":")!==-1?"["+s.host+"]":s.host;return s.id=s.protocol+"://"+r+":"+s.port+e,s.href=s.protocol+"://"+r+(t&&t.port===s.port?"":":"+s.port),s}const po=typeof ArrayBuffer=="function",fo=o=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(o):o.buffer instanceof ArrayBuffer,Ui=Object.prototype.toString,go=typeof Blob=="function"||typeof Blob<"u"&&Ui.call(Blob)==="[object BlobConstructor]",mo=typeof File=="function"||typeof File<"u"&&Ui.call(File)==="[object FileConstructor]";function ws(o){return po&&(o instanceof ArrayBuffer||fo(o))||go&&o instanceof Blob||mo&&o instanceof File}function Rt(o,e){if(!o||typeof o!="object")return!1;if(Array.isArray(o)){for(let t=0,s=o.length;t<s;t++)if(Rt(o[t]))return!0;return!1}if(ws(o))return!0;if(o.toJSON&&typeof o.toJSON=="function"&&arguments.length===1)return Rt(o.toJSON(),!0);for(const t in o)if(Object.prototype.hasOwnProperty.call(o,t)&&Rt(o[t]))return!0;return!1}function yo(o){const e=[],t=o.data,s=o;return s.data=as(t,e),s.attachments=e.length,{packet:s,buffers:e}}function as(o,e){if(!o)return o;if(ws(o)){const t={_placeholder:!0,num:e.length};return e.push(o),t}else if(Array.isArray(o)){const t=new Array(o.length);for(let s=0;s<o.length;s++)t[s]=as(o[s],e);return t}else if(typeof o=="object"&&!(o instanceof Date)){const t={};for(const s in o)Object.prototype.hasOwnProperty.call(o,s)&&(t[s]=as(o[s],e));return t}return o}function wo(o,e){return o.data=ls(o.data,e),delete o.attachments,o}function ls(o,e){if(!o)return o;if(o&&o._placeholder===!0){if(typeof o.num=="number"&&o.num>=0&&o.num<e.length)return e[o.num];throw new Error("illegal attachments")}else if(Array.isArray(o))for(let t=0;t<o.length;t++)o[t]=ls(o[t],e);else if(typeof o=="object")for(const t in o)Object.prototype.hasOwnProperty.call(o,t)&&(o[t]=ls(o[t],e));return o}const bo=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],So=5;var R;(function(o){o[o.CONNECT=0]="CONNECT",o[o.DISCONNECT=1]="DISCONNECT",o[o.EVENT=2]="EVENT",o[o.ACK=3]="ACK",o[o.CONNECT_ERROR=4]="CONNECT_ERROR",o[o.BINARY_EVENT=5]="BINARY_EVENT",o[o.BINARY_ACK=6]="BINARY_ACK"})(R||(R={}));class xo{constructor(e){this.replacer=e}encode(e){return(e.type===R.EVENT||e.type===R.ACK)&&Rt(e)?this.encodeAsBinary({type:e.type===R.EVENT?R.BINARY_EVENT:R.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===R.BINARY_EVENT||e.type===R.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=yo(e),s=this.encodeAsString(t.packet),i=t.buffers;return i.unshift(s),i}}function di(o){return Object.prototype.toString.call(o)==="[object Object]"}class bs extends G{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const s=t.type===R.BINARY_EVENT;s||t.type===R.BINARY_ACK?(t.type=s?R.EVENT:R.ACK,this.reconstructor=new vo(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(ws(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0;const s={type:Number(e.charAt(0))};if(R[s.type]===void 0)throw new Error("unknown packet type "+s.type);if(s.type===R.BINARY_EVENT||s.type===R.BINARY_ACK){const r=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);const n=e.substring(r,t);if(n!=Number(n)||e.charAt(t)!=="-")throw new Error("Illegal attachments");s.attachments=Number(n)}if(e.charAt(t+1)==="/"){const r=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););s.nsp=e.substring(r,t)}else s.nsp="/";const i=e.charAt(t+1);if(i!==""&&Number(i)==i){const r=t+1;for(;++t;){const n=e.charAt(t);if(n==null||Number(n)!=n){--t;break}if(t===e.length)break}s.id=Number(e.substring(r,t+1))}if(e.charAt(++t)){const r=this.tryParse(e.substr(t));if(bs.isPayloadValid(s.type,r))s.data=r;else throw new Error("invalid payload")}return s}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,t){switch(e){case R.CONNECT:return di(t);case R.DISCONNECT:return t===void 0;case R.CONNECT_ERROR:return typeof t=="string"||di(t);case R.EVENT:case R.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&bo.indexOf(t[0])===-1);case R.ACK:case R.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class vo{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const t=wo(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const ko=Object.freeze(Object.defineProperty({__proto__:null,Decoder:bs,Encoder:xo,get PacketType(){return R},protocol:So},Symbol.toStringTag,{value:"Module"}));function ae(o,e,t){return o.on(e,t),function(){o.off(e,t)}}const To=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Ni extends G{constructor(e,t,s){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,s&&s.auth&&(this.auth=s.auth),this._opts=Object.assign({},s),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[ae(e,"open",this.onopen.bind(this)),ae(e,"packet",this.onpacket.bind(this)),ae(e,"error",this.onerror.bind(this)),ae(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){var s,i,r;if(To.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;const n={type:R.EVENT,data:t};if(n.options={},n.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){const d=this.ids++,u=t.pop();this._registerAckCallback(d,u),n.id=d}const a=(i=(s=this.io.engine)===null||s===void 0?void 0:s.transport)===null||i===void 0?void 0:i.writable,l=this.connected&&!(!((r=this.io.engine)===null||r===void 0)&&r._hasPingExpired());return this.flags.volatile&&!a||(l?(this.notifyOutgoingListeners(n),this.packet(n)):this.sendBuffer.push(n)),this.flags={},this}_registerAckCallback(e,t){var s;const i=(s=this.flags.timeout)!==null&&s!==void 0?s:this._opts.ackTimeout;if(i===void 0){this.acks[e]=t;return}const r=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let a=0;a<this.sendBuffer.length;a++)this.sendBuffer[a].id===e&&this.sendBuffer.splice(a,1);t.call(this,new Error("operation has timed out"))},i),n=(...a)=>{this.io.clearTimeoutFn(r),t.apply(this,a)};n.withError=!0,this.acks[e]=n}emitWithAck(e,...t){return new Promise((s,i)=>{const r=(n,a)=>n?i(n):s(a);r.withError=!0,t.push(r),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());const s={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((i,...r)=>s!==this._queue[0]?void 0:(i!==null?s.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(i)):(this._queue.shift(),t&&t(null,...r)),s.pending=!1,this._drainQueue())),this._queue.push(s),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:R.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(s=>String(s.id)===e)){const s=this.acks[e];delete this.acks[e],s.withError&&s.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case R.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case R.EVENT:case R.BINARY_EVENT:this.onevent(e);break;case R.ACK:case R.BINARY_ACK:this.onack(e);break;case R.DISCONNECT:this.ondisconnect();break;case R.CONNECT_ERROR:this.destroy();const s=new Error(e.data.message);s.data=e.data.data,this.emitReserved("connect_error",s);break}}onevent(e){const t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const s of t)s.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let s=!1;return function(...i){s||(s=!0,t.packet({type:R.ACK,id:e,data:i}))}}onack(e){const t=this.acks[e.id];typeof t=="function"&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:R.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let s=0;s<t.length;s++)if(e===t[s])return t.splice(s,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let s=0;s<t.length;s++)if(e===t[s])return t.splice(s,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const s of t)s.apply(this,e.data)}}}function He(o){o=o||{},this.ms=o.min||100,this.max=o.max||1e4,this.factor=o.factor||2,this.jitter=o.jitter>0&&o.jitter<=1?o.jitter:0,this.attempts=0}He.prototype.duration=function(){var o=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*o);o=(Math.floor(e*10)&1)==0?o-t:o+t}return Math.min(o,this.max)|0};He.prototype.reset=function(){this.attempts=0};He.prototype.setMin=function(o){this.ms=o};He.prototype.setMax=function(o){this.max=o};He.prototype.setJitter=function(o){this.jitter=o};class cs extends G{constructor(e,t){var s;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,Lt(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((s=t.randomizationFactor)!==null&&s!==void 0?s:.5),this.backoff=new He({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;const i=t.parser||ko;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,e||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new ho(this.uri,this.opts);const t=this.engine,s=this;this._readyState="opening",this.skipReconnect=!1;const i=ae(t,"open",function(){s.onopen(),e&&e()}),r=a=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",a),e?e(a):this.maybeReconnectOnOpen()},n=ae(t,"error",r);if(this._timeout!==!1){const a=this._timeout,l=this.setTimeoutFn(()=>{i(),r(new Error("timeout")),t.close()},a);this.opts.autoUnref&&l.unref(),this.subs.push(()=>{this.clearTimeoutFn(l)})}return this.subs.push(i),this.subs.push(n),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(ae(e,"ping",this.onping.bind(this)),ae(e,"data",this.ondata.bind(this)),ae(e,"error",this.onerror.bind(this)),ae(e,"close",this.onclose.bind(this)),ae(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){It(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let s=this.nsps[e];return s?this._autoConnect&&!s.active&&s.connect():(s=new Ni(this,e,t),this.nsps[e]=s),s}_destroy(e){const t=Object.keys(this.nsps);for(const s of t)if(this.nsps[s].active)return;this._close()}_packet(e){const t=this.encoder.encode(e);for(let s=0;s<t.length;s++)this.engine.write(t[s],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(e,t){var s;this.cleanup(),(s=this.engine)===null||s===void 0||s.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const s=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(i=>{i?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",i)):e.onreconnect()}))},t);this.opts.autoUnref&&s.unref(),this.subs.push(()=>{this.clearTimeoutFn(s)})}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const Qe={};function Et(o,e){typeof o=="object"&&(e=o,o=void 0),e=e||{};const t=uo(o,e.path||"/socket.io"),s=t.source,i=t.id,r=t.path,n=Qe[i]&&r in Qe[i].nsps,a=e.forceNew||e["force new connection"]||e.multiplex===!1||n;let l;return a?l=new cs(s,e):(Qe[i]||(Qe[i]=new cs(s,e)),l=Qe[i]),t.query&&!e.query&&(e.query=t.queryKey),l.socket(t.path,e)}Object.assign(Et,{Manager:cs,Socket:Ni,io:Et,connect:Et});class le{static instance;socket=null;connected=!1;currentRoom=null;isHost=!1;eventHandlers=new Map;constructor(){}static getInstance(){return le.instance||(le.instance=new le),le.instance}connect(e){return new Promise((t,s)=>{if(this.connected&&this.socket){t();return}this.socket=Et(e,{transports:["websocket"],reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:5}),this.socket.on("connect",()=>{console.log("‚úÖ Connected to game server"),this.connected=!0,this.setupSocketListeners(),t()}),this.socket.on("connect_error",i=>{console.error("‚ùå Connection error:",i),s(i)}),this.socket.on("disconnect",()=>{console.log("‚ùå Disconnected from server"),this.connected=!1,this.trigger("disconnect")})})}setupSocketListeners(){this.socket&&(this.onSocket("room:created",e=>{this.currentRoom=e,this.trigger("room:created",e)}),this.onSocket("room:joined",e=>{this.currentRoom=e.code,this.isHost=e.isHost,this.trigger("room:joined",e)}),["room:playerJoined","room:playerLeft","room:playerReady"].forEach(e=>{this.onSocket(e,t=>this.trigger(e,t))}),this.onSocket("room:error",e=>this.trigger("room:error",e)),this.onSocket("game:started",()=>this.trigger("game:started")),this.onSocket("game:stateUpdate",e=>this.trigger("game:stateUpdate",e)),this.onSocket("game:towerPlaced",e=>this.trigger("game:towerPlaced",e)),this.onSocket("game:towerUpgraded",(e,t)=>this.trigger("game:towerUpgraded",{towerId:e,level:t})),this.onSocket("game:towerSold",(e,t)=>this.trigger("game:towerSold",{towerId:e,refund:t})),this.onSocket("game:enemySpawned",e=>this.trigger("game:enemySpawned",e)),this.onSocket("game:enemyDied",(e,t,s)=>this.trigger("game:enemyDied",{enemyId:e,gold:t,xp:s})),this.onSocket("game:waveStarted",e=>this.trigger("game:waveStarted",e)),this.onSocket("game:waveCompleted",(e,t)=>this.trigger("game:waveCompleted",{wave:e,bonus:t})),this.onSocket("game:levelUp",e=>this.trigger("game:levelUp",e)),this.onSocket("game:over",e=>this.trigger("game:over",e)))}onSocket(e,t){this.socket&&this.socket.on(e,(...s)=>t(...s))}on(e,t){this.eventHandlers.has(e)||this.eventHandlers.set(e,[]),this.eventHandlers.get(e).push(t)}off(e,t){const s=this.eventHandlers.get(e);if(s){const i=s.indexOf(t);i>-1&&s.splice(i,1)}}trigger(e,t){const s=this.eventHandlers.get(e);s&&s.forEach(i=>i(t))}createRoom(e){return new Promise((t,s)=>{if(!this.socket){s(new Error("Not connected to server"));return}this.socket.emit("room:create",e,i=>{i.success&&i.code?t(i.code):s(new Error(i.error||"Failed to create room"))})})}joinRoom(e,t){return new Promise((s,i)=>{if(!this.socket){i(new Error("Not connected to server"));return}this.socket.emit("room:join",e,t,r=>{r.success?s():i(new Error(r.error||"Failed to join room"))})})}leaveRoom(){this.socket&&(this.socket.emit("room:leave"),this.currentRoom=null,this.isHost=!1)}setReady(e){this.socket&&this.socket.emit("room:ready",e)}startGame(){this.socket&&this.isHost&&this.socket.emit("room:startGame")}saveData(e,t){this.socket&&this.socket.emit("storage:saveData",{key:e,value:t})}loadData(e,t){this.socket&&this.socket.emit("storage:loadData",e,t)}placeTower(e,t,s){this.socket?(console.log(`üì§ Sending tower placement: type=${e}, x=${t}, y=${s}`),this.socket.emit("game:placeTower",{type:e,x:t,y:s})):console.log("‚ùå Cannot place tower: socket not connected")}upgradeTower(e){this.socket&&this.socket.emit("game:upgradeTower",e)}sellTower(e){this.socket&&this.socket.emit("game:sellTower",e)}startWave(){this.socket&&this.socket.emit("game:startWave")}unlockResearch(e){this.socket&&this.socket.emit("game:researchUnlock",e)}isConnected(){return this.connected}getCurrentRoom(){return this.currentRoom}getIsHost(){return this.isHost}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null,this.connected=!1,this.currentRoom=null,this.isHost=!1,this.eventHandlers.clear())}}class Co{scene;networkManager;onStateUpdate;constructor(e,t){this.scene=e,this.networkManager=le.getInstance(),this.onStateUpdate=t,this.setupListeners()}setupListeners(){this.networkManager.on("game:stateUpdate",e=>{this.handleStateUpdate(e)}),this.networkManager.on("game:over",e=>{this.handleGameOver(e)})}handleStateUpdate(e){this.onStateUpdate(e)}handleGameOver(e){console.log(`Game Over! ${e?"Victory!":"Defeat!"}`),this.scene.events.emit("gameOver",e)}cleanup(){this.networkManager.off("game:stateUpdate",this.handleStateUpdate),this.networkManager.off("game:over",this.handleGameOver)}}class Ro{networkManager;onTowerPlaced;onTowerUpgraded;onTowerSold;constructor(e,t,s){this.networkManager=le.getInstance(),this.onTowerPlaced=e,this.onTowerUpgraded=t,this.onTowerSold=s,this.setupListeners()}setupListeners(){this.networkManager.on("game:towerPlaced",e=>{this.onTowerPlaced(e)}),this.networkManager.on("game:towerUpgraded",e=>{this.onTowerUpgraded(e.towerId,e.level)}),this.networkManager.on("game:towerSold",e=>{this.onTowerSold(e.towerId,e.refund)})}requestPlaceTower(e,t,s){this.networkManager.placeTower(e,t,s)}requestUpgradeTower(e){this.networkManager.upgradeTower(e)}requestSellTower(e){this.networkManager.sellTower(e)}cleanup(){}}class Eo{networkManager;onEnemySpawned;onEnemyDied;constructor(e,t){this.networkManager=le.getInstance(),this.onEnemySpawned=e,this.onEnemyDied=t,this.setupListeners()}setupListeners(){this.networkManager.on("game:enemySpawned",e=>{this.onEnemySpawned(e)}),this.networkManager.on("game:enemyDied",e=>{this.onEnemyDied(e.enemyId,e.gold,e.xp)})}cleanup(){}}class _o{networkManager;onWaveStarted;onWaveCompleted;constructor(e,t){this.networkManager=le.getInstance(),this.onWaveStarted=e,this.onWaveCompleted=t,this.setupListeners()}setupListeners(){this.networkManager.on("game:waveStarted",e=>{this.onWaveStarted(e)}),this.networkManager.on("game:waveCompleted",e=>{this.onWaveCompleted(e.wave,e.bonus)}),this.networkManager.on("game:levelUp",e=>{console.log(`Level Up! Now level ${e}`)})}requestStartWave(){this.networkManager.startWave()}cleanup(){}}class Po{networkManager;gameStateSync;towerSync;enemySync;waveSync;isMultiplayer;constructor(e,t){this.networkManager=le.getInstance(),this.isMultiplayer=this.networkManager.isConnected()&&this.networkManager.getCurrentRoom()!==null,this.isMultiplayer&&(this.gameStateSync=new Co(e,t.onStateUpdate),this.towerSync=new Ro(t.onTowerPlaced,t.onTowerUpgraded,t.onTowerSold),this.enemySync=new Eo(t.onEnemySpawned,t.onEnemyDied),this.waveSync=new _o(t.onWaveStarted,t.onWaveCompleted))}isInMultiplayerMode(){return this.isMultiplayer}placeTower(e,t,s){this.isMultiplayer&&this.towerSync&&this.towerSync.requestPlaceTower(e,t,s)}upgradeTower(e){this.isMultiplayer&&this.towerSync&&this.towerSync.requestUpgradeTower(e)}sellTower(e){this.isMultiplayer&&this.towerSync&&this.towerSync.requestSellTower(e)}startWave(){this.isMultiplayer&&this.waveSync&&this.waveSync.requestStartWave()}unlockResearch(e){this.isMultiplayer&&this.networkManager.unlockResearch(e)}cleanup(){this.isMultiplayer&&(this.gameStateSync?.cleanup(),this.towerSync?.cleanup(),this.enemySync?.cleanup(),this.waveSync?.cleanup())}}class Mo{constructor(e,t,s,i,r,n,a,l){this.scene=e,this.waveManager=t,this.towerManager=s,this.ui=i,this.xpHandler=r,this.onStateUpdate=n,this.onGoldChange=a,this.onGameStarted=l}coordinator;setup(){this.coordinator=new Po(this.scene,{onStateUpdate:e=>this.handleStateUpdate(e),onTowerPlaced:e=>this.handleTowerPlaced(e),onTowerUpgraded:(e,t)=>this.handleTowerUpgraded(e,t),onTowerSold:(e,t)=>this.handleTowerSold(e,t),onEnemySpawned:e=>this.handleEnemySpawned(e),onEnemyDied:(e,t,s)=>this.handleEnemyDied(e,t,s),onWaveStarted:e=>this.handleWaveStarted(e),onWaveCompleted:(e,t)=>this.handleWaveCompleted(e,t)}),this.scene.events.on("gameOver",e=>{e||this.scene.events.emit("triggerGameOver")})}startWave(){this.coordinator?.startWave()}placeTower(e,t,s){console.log(`üéØ Requesting tower placement: ${e} at (${t}, ${s})`),this.coordinator?.placeTower(e,t,s)}upgradeTower(e){console.log(`üîß Requesting tower upgrade: ${e}`),this.coordinator?.upgradeTower(e)}sellTower(e){this.coordinator?.sellTower(e)}handleStateUpdate(e){this.onStateUpdate(e.gold,e.lives),this.ui.updateWave(e.wave),this.ui.updateXP(e.xp,e.playerLevel),this.waveManager.setPlayerLevel(e.playerLevel),this.waveManager.setPlayerCount(e.playerCount)}handleTowerPlaced(e){console.log(`‚úÖ Tower placed by server: ${e.type} at (${e.x}, ${e.y}), level ${e.level}, id=${e.id}`),this.towerManager.addTowerFromServer(e.x,e.y,e.type,e.level,e.id)}handleTowerUpgraded(e,t){console.log(`‚úÖ Tower ${e} upgraded to level ${t} by server`),this.towerManager.upgradeTowerById(e,t)}handleTowerSold(e,t){console.log(`üí∞ Tower ${e} sold for ${t} gold by server`),this.towerManager.sellTowerById(e)}handleEnemySpawned(e){console.log(`Enemy spawned: ${e.type} (${e.id})`)}handleEnemyDied(e,t,s){console.log(`üíÄ Enemy ${e} died. Rewarded: ${t} gold, ${s} xp`),this.onGoldChange(t),this.xpHandler.awardXP(s,this.waveManager)}handleWaveStarted(e){console.log(`Wave ${e} started`),this.onGameStarted(),this.ui.hideStartButton(),this.ui.updateWave(e),this.waveManager.resetWaveComplete(),this.waveManager.startWave()}handleWaveCompleted(e,t){console.log(`üéâ Wave ${e} completed. Bonus: ${t} gold`),this.onGoldChange(t);const s=(20+e*5)*2;this.xpHandler.awardXP(s,this.waveManager),this.waveManager.markWaveComplete(),this.ui.showStartButton()}}class Ao{constructor(e){this.scene=e}show(e,t){const s=this.scene.cameras.main.width,i=this.scene.cameras.main.height;this.scene.add.rectangle(0,0,s,i,0,.7).setOrigin(0),this.scene.add.text(s/2,i/2-50,"Game Over",{font:"bold 64px Arial",color:"#ff0000"}).setOrigin(.5),this.scene.add.text(s/2,i/2+20,`Du hast Welle ${e} erreicht!`,{font:"32px Arial",color:"#ffffff"}).setOrigin(.5);const a=this.scene.add.text(s/2,i/2+100,"Neustart",{font:"28px Arial",color:"#ffffff",backgroundColor:"#333333",padding:{x:20,y:10}});a.setOrigin(.5),a.setInteractive({useHandCursor:!0}),a.on("pointerover",()=>{a.setStyle({backgroundColor:"#555555"})}),a.on("pointerout",()=>{a.setStyle({backgroundColor:"#333333"})}),a.on("pointerdown",l=>{l.event.stopPropagation(),t()})}}class Io extends Phaser.Scene{ui;waveManager;towerManager;mapManager;researchManager;projectileManager;notifications;xpHandler;waveHandler;towerHandler;multiplayerHandler;gameOverScreen;gameStarted=!1;isReady=!1;gold=0;lives=0;isPaused=!1;autoWaveEnabled=!1;autoWaveTimer;config=E.getInstance().getConfig();levelType="classic";isMultiplayer=!1;roomCode;constructor(){super({key:"GameScene"})}init(e){const t=ds.getSettings(),s=this.config.game;if(this.isMultiplayer=e.multiplayer||!1,this.roomCode=e.roomCode,this.levelType=e.levelType||"classic",this.gold=s.startGold,this.lives=s.startLives,!this.isMultiplayer)switch(t.difficulty){case"easy":this.gold=s.startGold*2,this.lives=Math.round(s.startLives*1.5);break;case"normal":this.gold=s.startGold,this.lives=s.startLives;break;case"hard":this.gold=Math.round(s.startGold*.75),this.lives=Math.round(s.startLives*.75);break}this.gameStarted=!1,this.isReady=!1}async create(){this.mapManager=new oi(this,this.levelType);try{await this.mapManager.loadMap(),this.mapManager.create()}catch(e){console.error("Failed to load map:",e),this.mapManager=new oi(this,"classic"),await this.mapManager.loadMap(),this.mapManager.create()}this.waveManager=new mn(this,this.mapManager.getPath(),this.levelType),this.towerManager=new Tn(this,this.mapManager.getPath(),this.mapManager.getPlacementDistance()),this.researchManager=new Cn,this.projectileManager=new Rn,this.notifications=new En(this),this.gameOverScreen=new Ao(this),this.ui=new ln(this,this.gold,this.lives,this.researchManager),this.xpHandler=new _n(this.researchManager,this.ui,(e,t)=>{this.notifications.showLevelUp(e),t.forEach(s=>{this.notifications.showResearchUnlocked(s)}),this.ui.showResearchButtonPulse()}),this.waveHandler=new Pn(this.waveManager,this.xpHandler,e=>this.changeGold(e),()=>this.handleLifeLost(),()=>this.checkResearchAvailability()),this.towerHandler=new Mn(this.towerManager,this.ui,e=>this.changeGold(e),(e,t)=>{e==="upgrade"?this.notifications.showTowerUpgrade():e==="sell"&&t&&this.notifications.showTowerSold(t)}),this.isMultiplayer&&(this.multiplayerHandler=new Mo(this,this.waveManager,this.towerManager,this.ui,this.xpHandler,(e,t)=>{this.gold=e,this.lives=t,this.ui.updateGold(e),this.ui.updateLives(t)},e=>{this.gold+=e,this.ui.updateGold(this.gold)},()=>{this.gameStarted=!0}),this.multiplayerHandler.setup(),this.events.on("triggerGameOver",()=>this.gameOver())),this.ui.create(()=>this.handleStartWave(),(e,t)=>this.handleTowerSelect(e,t),()=>this.handlePauseToggle(),()=>this.handleAutoWaveToggle(),()=>this.handleResearchToggle(),e=>{e==="tower_damage_1"?this.towerManager.applyDamageMultiplierToAll(1.1):e==="tower_range_1"&&this.towerManager.applyRangeMultiplierToAll(1.1)},()=>this.handleUpgradeTower(),()=>this.handleSellTower()),this.isMultiplayer&&this.roomCode&&this.ui.showRoomCode(this.roomCode),this.checkAndShowResearchNotification(),this.input.on("pointerdown",e=>{this.handlePointerDown(e)}),this.input.on("pointermove",e=>{this.towerManager.updatePreview(e)}),this.isReady=!0,this.events.on("shutdown",()=>{try{this.ui?.destroy()}catch{}})}update(e,t){if(!this.isReady||this.isPaused)return;const s=this.towerManager.getSelectedTower();this.ui.updateUpgradeButton(s),this.waveManager.update(t,(r,n)=>this.waveHandler.handleEnemyKilled(r,n),()=>this.waveHandler.handleEnemyEscaped(),r=>this.waveHandler.handleWaveCompleted(r)),this.towerManager.update(e,this.waveManager.getEnemies()).forEach(r=>this.projectileManager.addProjectile(r)),this.projectileManager.update(t),this.waveManager.isWaveComplete()&&this.gameStarted&&(this.autoWaveEnabled?this.autoWaveTimer||(this.autoWaveTimer=this.time.delayedCall(5e3,()=>{this.handleStartWave(),this.autoWaveTimer=void 0})):this.ui.showStartButton("N√§chste Welle"))}handleStartWave(){if(this.isMultiplayer&&this.multiplayerHandler){this.multiplayerHandler.startWave();return}this.waveManager.isSpawningEnemies()||(this.gameStarted||(this.gameStarted=!0),this.autoWaveTimer&&(this.autoWaveTimer.destroy(),this.autoWaveTimer=void 0),this.waveManager.resetWaveComplete(),this.ui.hideStartButton(),this.waveManager.startWave(),this.ui.updateWave(this.waveManager.getWave()))}handleTowerSelect(e,t){this.towerHandler.selectTower(e,t)}handleUpgradeTower(){if(this.isMultiplayer&&this.multiplayerHandler){const e=this.towerHandler.getSelectedTower();if(e){const t=e.id;if(!t){console.error("‚ùå Selected tower has no ID! Cannot upgrade in multiplayer.");return}console.log(`üéØ Upgrade button clicked for tower: ${t}`),this.multiplayerHandler.upgradeTower(t)}else console.error("‚ùå No tower selected for upgrade");return}this.towerHandler.tryUpgradeTower(this.gold)}handleSellTower(){if(this.isMultiplayer&&this.multiplayerHandler){const e=this.towerHandler.getSelectedTower();if(e){const t=e.id||"unknown";this.multiplayerHandler.sellTower(t)}return}this.towerHandler.trySellTower()}handlePauseToggle(){this.isPaused=!this.isPaused,this.isPaused?this.physics.pause():this.physics.resume(),this.ui.setPaused(this.isPaused)}handleAutoWaveToggle(){this.autoWaveEnabled=!this.autoWaveEnabled,this.ui.setAutoWave(this.autoWaveEnabled),this.autoWaveEnabled&&this.waveManager.isWaveComplete()&&!this.autoWaveTimer&&(this.autoWaveTimer=this.time.delayedCall(5e3,()=>{this.handleStartWave(),this.autoWaveTimer=void 0})),!this.autoWaveEnabled&&this.autoWaveTimer&&(this.autoWaveTimer.destroy(),this.autoWaveTimer=void 0,this.ui.showStartButton("N√§chste Welle"))}handleResearchToggle(){this.ui.toggleResearchOverlay()}changeGold(e){this.gold+=e,this.ui.updateGold(this.gold)}handleLifeLost(){this.lives--,this.ui.updateLives(this.lives),this.lives<=0&&this.gameOver()}checkAndShowResearchNotification(){this.xpHandler.checkAvailableResearches(this.gold)&&this.ui.showResearchButtonPulse()}checkResearchAvailability(){this.xpHandler.checkAvailableResearches(this.gold)&&this.ui.showResearchButtonPulse()}handlePointerDown(e){if(!this.ui.getButtons().some(i=>i.visible?i.getBounds().contains(e.x,e.y):!1)){if(this.isMultiplayer&&this.multiplayerHandler){const i=this.towerManager.getSelectedType();i&&(console.log(`üéØ Requesting tower placement: ${i} at (${e.x}, ${e.y})`),this.multiplayerHandler.placeTower(i,e.x,e.y),this.towerHandler.deselectTower());return}this.towerHandler.tryPlaceTower(e.x,e.y,this.gold)}}gameOver(){this.physics.pause(),this.waveManager.cleanup(),this.towerManager.cleanup(),this.time.removeAllEvents(),this.input.off("pointerdown"),this.input.off("pointermove"),this.gameOverScreen.show(this.waveManager.getWave(),()=>this.scene.restart())}}class Lo{constructor(e){this.scene=e}playerListText=null;show(e,t,s,i,r,n,a){const h=this.scene.add.graphics();h.fillStyle(2899536,1),h.fillRoundedRect(e-300,130,600,100,10),h.lineStyle(3,2600544,1),h.strokeRoundedRect(e-300,130,600,100,10),this.scene.add.text(e,155,"Raum-Code:",{fontSize:"20px",color:"#bdc3c7"}).setOrigin(.5),this.scene.add.text(e,190,t,{fontSize:"36px",color:"#27ae60",fontStyle:"bold"}).setOrigin(.5);const d=260,u=this.scene.add.graphics();u.fillStyle(2899536,1),u.fillRoundedRect(e-300,d,600,220,10),u.lineStyle(2,3426654,1),u.strokeRoundedRect(e-300,d,600,220,10),this.scene.add.text(e,d+25,"üë• Spieler",{fontSize:"24px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.playerListText=this.scene.add.text(e,d+70,"Lade Spielerliste...",{fontSize:"20px",color:"#ecf0f1",align:"center",lineSpacing:12}).setOrigin(.5,0);const f=520,p=s?e-160:e,w=this.scene.add.text(p,f,i?"‚úì Bereit":"Bereit?",{fontSize:"24px",color:"#ffffff",backgroundColor:i?"#27ae60":"#95a5a6",padding:{x:35,y:15}}).setOrigin(.5).setInteractive();if(w.on("pointerdown",r),w.on("pointerover",()=>{w.setBackgroundColor(i?"#229954":"#7f8c8d")}),w.on("pointerout",()=>{w.setBackgroundColor(i?"#27ae60":"#95a5a6")}),s){const I=this.scene.add.text(e+160,f,"Starten",{fontSize:"24px",color:"#ffffff",backgroundColor:"#f39c12",padding:{x:35,y:15}}).setOrigin(.5).setInteractive();I.on("pointerdown",n),I.on("pointerover",()=>I.setBackgroundColor("#e67e22")),I.on("pointerout",()=>I.setBackgroundColor("#f39c12"))}const C=this.scene.add.text(e,f+80,"‚Üê Verlassen",{fontSize:"20px",color:"#ffffff",backgroundColor:"#e74c3c",padding:{x:30,y:12}}).setOrigin(.5).setInteractive();return C.on("pointerdown",a),C.on("pointerover",()=>C.setBackgroundColor("#c0392b")),C.on("pointerout",()=>C.setBackgroundColor("#e74c3c")),{playerListText:this.playerListText,readyButton:w}}updatePlayerList(e){if(!this.playerListText)return;if(e.size===0){this.playerListText.setText("Keine Spieler im Raum");return}const t=Array.from(e.values()).map(s=>{const i=s.ready?"‚úì":"‚óã",r=s.isHost?" üëë":"";return`${i} ${s.name}${r}`}).join(`
`);this.playerListText.setText(t)}}class st{static create(e,t,s,i,r){const n=document.createElement("input");return n.type="text",n.placeholder=r,n.autocomplete="on",n.style.position="absolute",n.style.left=`${e}px`,n.style.top=`${t}px`,n.style.width=`${s}px`,n.style.height=`${i}px`,n.style.fontSize="18px",n.style.padding="10px 15px",n.style.border="2px solid #3498db",n.style.borderRadius="8px",n.style.backgroundColor="#34495e",n.style.color="#ecf0f1",n.style.boxSizing="border-box",n.style.textAlign="center",n.style.fontFamily="Arial, sans-serif",n.style.outline="none",n.style.transition="all 0.3s",n.addEventListener("focus",()=>{n.style.border="2px solid #3498db",n.style.backgroundColor="#2c3e50"}),n.addEventListener("blur",()=>{n.style.border="2px solid #3498db",n.style.backgroundColor="#34495e"}),document.body.appendChild(n),n}static removeAll(e){e.forEach(t=>{t&&t.parentNode&&t.parentNode.removeChild(t)})}}class Bo{constructor(e){this.scene=e}playerNameInput=null;show(e,t,s){const i=this.scene.add.graphics();i.fillStyle(2899536,1),i.fillRoundedRect(e-250,t,500,200,10),i.lineStyle(2,3426654,1),i.strokeRoundedRect(e-250,t,500,200,10),this.scene.add.text(e,t+25,"üéÆ Neuen Raum Erstellen",{fontSize:"26px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.scene.add.text(e,t+50,"Spielername:",{fontSize:"18px",color:"#ecf0f1"}).setOrigin(.5),this.playerNameInput=st.create(e-120,t+140,440,45,"Dein Name");const r=se.getInstance().getLocal("playerName");r&&(this.playerNameInput.value=r);const n=this.scene.add.text(e,t+160,"Raum Erstellen",{fontSize:"22px",color:"#ffffff",backgroundColor:"#27ae60",padding:{x:40,y:12}}).setOrigin(.5).setInteractive();return n.on("pointerdown",()=>{const a=this.playerNameInput?.value.trim()||"";s(a)}),n.on("pointerover",()=>n.setBackgroundColor("#229954")),n.on("pointerout",()=>n.setBackgroundColor("#27ae60")),this.playerNameInput}cleanup(){this.playerNameInput&&(st.removeAll([this.playerNameInput]),this.playerNameInput=null)}}class Oo{constructor(e){this.scene=e}playerNameInput=null;roomCodeInput=null;show(e,t,s){const i=this.scene.add.graphics();i.fillStyle(2899536,1),i.fillRoundedRect(e-250,t,500,240,10),i.lineStyle(2,3426654,1),i.strokeRoundedRect(e-250,t,500,240,10),this.scene.add.text(e,t+25,"üö™ Raum Beitreten",{fontSize:"26px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.scene.add.text(e,t+60,"Spielername:",{fontSize:"18px",color:"#ecf0f1"}).setOrigin(.5),this.playerNameInput=st.create(e-120,t+160,440,45,"Dein Name");const r=se.getInstance().getLocal("playerName");r&&(this.playerNameInput.value=r),this.scene.add.text(e,t+100,"Raum-Code: (z.B. bear-lamp)",{fontSize:"18px",color:"#ecf0f1"}).setOrigin(.5),this.roomCodeInput=st.create(e-110,t+260,440,45,"Raum-Code eingeben");const n=this.scene.add.text(e,t+200,"Beitreten",{fontSize:"22px",color:"#ffffff",backgroundColor:"#3498db",padding:{x:40,y:12}}).setOrigin(.5).setInteractive();return n.on("pointerdown",()=>{const a=this.playerNameInput?.value.trim()||"",l=this.roomCodeInput?.value.trim().toLowerCase()||"";s(a,l)}),n.on("pointerover",()=>n.setBackgroundColor("#2980b9")),n.on("pointerout",()=>n.setBackgroundColor("#3498db")),{playerNameInput:this.playerNameInput,roomCodeInput:this.roomCodeInput}}cleanup(){const e=[];this.playerNameInput&&e.push(this.playerNameInput),this.roomCodeInput&&e.push(this.roomCodeInput),e.length>0&&st.removeAll(e),this.playerNameInput=null,this.roomCodeInput=null}}class Do{constructor(e,t,s,i,r,n,a,l){this.networkManager=e,this.onRoomJoined=t,this.onPlayerJoined=s,this.onPlayerReady=i,this.onPlayerLeft=r,this.onGameStarted=n,this.onError=a,this.onDisconnect=l}setup(){this.networkManager.on("room:joined",e=>{this.onRoomJoined(e.code,e.players)}),this.networkManager.on("room:playerJoined",e=>{this.onPlayerJoined(e)}),this.networkManager.on("room:playerReady",e=>{this.onPlayerReady(e.playerId,e.isReady,e.name)}),this.networkManager.on("room:playerLeft",e=>{this.onPlayerLeft(e,"Spieler")}),this.networkManager.on("room:error",e=>{this.onError(e)}),this.networkManager.on("game:started",()=>{this.onGameStarted(this.networkManager.getCurrentRoom()||"")}),this.networkManager.on("disconnect",()=>{this.onDisconnect()})}}class Uo{constructor(e,t,s,i){this.networkManager=e,this.onSuccess=t,this.onError=s,this.onLoading=i}async createRoom(e){if(!this.validatePlayerName(e))return null;se.getInstance().setLocal("playerName",e),this.onLoading("Erstelle Raum...");try{const t=await this.networkManager.createRoom(e);return this.onSuccess(`Raum erstellt: ${t}`),t}catch(t){return this.onError(`Fehler: ${t.message}`),null}}async joinRoom(e,t){if(!this.validatePlayerName(e)||!this.validateRoomCode(t))return!1;se.getInstance().setLocal("playerName",e),this.onLoading("Trete Raum bei...");try{return await this.networkManager.joinRoom(t,e),this.onSuccess(`Raum beigetreten: ${t}`),!0}catch(s){return this.onError(`Fehler: ${s.message}`),!1}}leaveRoom(){this.networkManager.leaveRoom()}setReady(e){this.networkManager.setReady(e)}startGame(){return console.log("Starting game..."),this.networkManager.startGame(),!0}validateGameStart(e){const t=Array.from(e.values()),s=t.every(i=>i.isReady||i.isHost);return console.log("Players:",t.map(i=>({name:i.name,isHost:i.isHost,isReady:i.isReady}))),console.log("All ready?",s),s?e.size<1?{canStart:!1,message:"Mindestens 1 Spieler ben√∂tigt!"}:{canStart:!0}:{canStart:!1,message:"Nicht alle Spieler sind bereit!"}}validatePlayerName(e){return e?e.length<2||e.length>20?(this.onError("Name muss 2-20 Zeichen lang sein!"),!1):!0:(this.onError("Bitte gib einen Namen ein!"),!1)}validateRoomCode(e){return e?/^[a-z]{2,4}-[a-z]{2,4}$/.test(e)?!0:(this.onError("Raum-Code Format: wort-wort (z.B. bear-lamp)"),!1):(this.onError("Bitte gib einen Raum-Code ein!"),!1)}}class No extends et.Scene{networkManager;config;roomLobbyUI;roomCreationUI;roomJoinUI;networkEventSetup;roomActionHandler;statusText=null;readyButton=null;players=new Map;isReady=!1;currentRoomCode=null;constructor(){super({key:"MultiplayerScene"}),this.networkManager=le.getInstance()}init(){this.cleanupComponents()}create(){this.config=E.getInstance().getConfig();const e=this.cameras.main.centerX;this.add.text(e,50,"Multiplayer Lobby",{fontSize:"48px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.networkManager.isConnected()?this.showLobbyUI():this.connectToServer()}async connectToServer(){const e=this.cameras.main.centerX,t=this.cameras.main.centerY,s=this.add.text(e,t,"Verbinde mit Server...",{fontSize:"24px",color:"#ffff00"}).setOrigin(.5);try{const i=`http://localhost:${this.config.multiplayer.serverPort}`;await this.networkManager.connect(i),s.destroy(),this.showLobbyUI()}catch{s.setText(`‚ùå Server nicht erreichbar!

Starte Server mit: pnpm server`),s.setColor("#ff0000");const r=this.add.text(e,t+100,"< Zur√ºck zum Men√º",{fontSize:"24px",color:"#ffffff",backgroundColor:"#333333",padding:{x:20,y:10}}).setOrigin(.5).setInteractive();r.on("pointerdown",()=>{this.cleanupComponents(),this.scene.start("MainMenuScene")}),r.on("pointerover",()=>{r.setBackgroundColor("#555555")}),r.on("pointerout",()=>{r.setBackgroundColor("#333333")})}}showLobbyUI(){const e=this.cameras.main.width,t=this.cameras.main.height,s=e/2;if(this.networkManager.getCurrentRoom()){this.showRoomUI();return}this.roomActionHandler=new Uo(this.networkManager,r=>this.showStatus(r,"#2ecc71"),r=>this.showStatus(r,"#e74c3c"),r=>this.showStatus(r,"#ffff00"));const i=this.add.text(30,30,"‚óÄ Zur√ºck",{fontSize:"20px",color:"#ffffff",backgroundColor:"#333333",padding:{x:15,y:10}}).setInteractive();i.on("pointerdown",()=>{this.networkManager.disconnect(),this.scene.start("MainMenuScene")}),i.on("pointerover",()=>i.setBackgroundColor("#555555")),i.on("pointerout",()=>i.setBackgroundColor("#333333")),this.roomCreationUI=new Bo(this),this.roomCreationUI.show(s,150,async r=>{const n=await this.roomActionHandler.createRoom(r);n&&(this.currentRoomCode=n)}),this.add.text(s,380,"oder",{fontSize:"18px",color:"#7f8c8d",fontStyle:"italic"}).setOrigin(.5),this.roomJoinUI=new Oo(this),this.roomJoinUI.show(s,420,async(r,n)=>{await this.roomActionHandler.joinRoom(r,n)&&(this.currentRoomCode=n)}),this.statusText=this.add.text(s,t-40,"",{fontSize:"18px",color:"#e74c3c",align:"center",fontStyle:"bold"}).setOrigin(.5),this.setupNetworkListeners()}showRoomUI(){this.cleanupComponents(),this.children.removeAll();const e=this.cameras.main.width,t=this.cameras.main.height,s=e/2;this.add.text(s,50,"Multiplayer Lobby",{fontSize:"48px",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5),this.roomLobbyUI=new Lo(this);const{readyButton:i}=this.roomLobbyUI.show(s,this.currentRoomCode||"",this.networkManager.getIsHost(),this.isReady,()=>this.toggleReady(),()=>this.handleStartGame(),()=>this.handleLeaveRoom());this.readyButton=i,this.statusText=this.add.text(s,t-40,"",{fontSize:"18px",color:"#e74c3c",align:"center",fontStyle:"bold"}).setOrigin(.5),this.updatePlayerList()}setupNetworkListeners(){this.networkEventSetup=new Do(this.networkManager,(e,t)=>{this.currentRoomCode=e,this.players.clear(),t.forEach(s=>{this.players.set(s.id,s)}),this.showRoomUI()},e=>{this.players.set(e.id,e),this.updatePlayerList(),this.showStatus(`${e.name} ist beigetreten!`,"#2ecc71")},(e,t,s)=>{const i=this.players.get(e);i&&(i.isReady=t,this.updatePlayerList(),console.log(`Player ${s} ready status: ${t}`))},(e,t)=>{this.players.delete(e),this.updatePlayerList(),this.showStatus(`${t} hat den Raum verlassen.`,"#e74c3c")},e=>{this.showStatus("Spiel startet...","#2ecc71"),this.time.delayedCall(1e3,()=>{this.cleanupComponents(),this.scene.start("GameScene",{multiplayer:!0,roomCode:this.currentRoomCode})})},e=>{this.showStatus(`Fehler: ${e}`,"#e74c3c")},()=>{this.showStatus("Verbindung zum Server verloren!","#e74c3c"),this.time.delayedCall(3e3,()=>{this.cleanupComponents(),this.scene.start("MainMenuScene")})}),this.networkEventSetup.setup()}handleLeaveRoom(){this.roomActionHandler?.leaveRoom(),this.players.clear(),this.currentRoomCode=null,this.isReady=!1,this.cleanupComponents(),this.children.removeAll(),this.create()}toggleReady(){this.isReady=!this.isReady,console.log("Toggle ready:",this.isReady),this.roomActionHandler?.setReady(this.isReady),this.readyButton&&(this.readyButton.setText(this.isReady?"‚úì Bereit":"Bereit?"),this.readyButton.setBackgroundColor(this.isReady?"#27ae60":"#95a5a6"))}handleStartGame(){if(!this.roomActionHandler)return;const e=this.roomActionHandler.validateGameStart(this.players);if(!e.canStart){this.showStatus(e.message,"#e74c3c");return}this.roomActionHandler.startGame()}updatePlayerList(){this.roomLobbyUI&&this.roomLobbyUI.updatePlayerList(this.players)}showStatus(e,t){this.statusText&&(this.statusText.setText(e),this.statusText.setColor(t))}cleanupComponents(){this.roomCreationUI&&(this.roomCreationUI.cleanup(),this.roomCreationUI=void 0),this.roomJoinUI&&(this.roomJoinUI.cleanup(),this.roomJoinUI=void 0),this.roomLobbyUI=void 0}shutdown(){this.cleanupComponents()}}class $o extends Phaser.Scene{auth;constructor(){super({key:"AdminScene"}),this.auth=de.getInstance()}create(){const e=this.cameras.main.width;this.add.text(e/2,40,"Fehlerberichte",{font:"bold 32px Arial",color:"#ffffff"}).setOrigin(.5);const s=this.add.text(20,20,"‚Üê Zur√ºck",{font:"18px Arial",color:"#ffffff"});s.setInteractive({useHandCursor:!0}),s.on("pointerdown",()=>{this.scene.resume("MainMenuScene"),this.scene.stop()}),this.add.text(e/2,120,"Lade Fehlerberichte...",{font:"16px Arial",color:"#cccccc"}).setOrigin(.5),this.fetchAndRenderReports(160)}async fetchAndRenderReports(e){try{const t=this.auth.getAuthToken();if(!t){this.add.text(this.cameras.main.width/2,e,"Nicht eingeloggt. Keine Berichte.",{color:"#ff6666"}).setOrigin(.5);return}const s=await fetch("/telemetry/errors",{headers:{Authorization:`Bearer ${t}`}});if(!s.ok)return this.add.text(this.cameras.main.width/2,e,"Fehler beim Laden",{color:"#ff6666"}).setOrigin(.5);const r=(await s.json()).reports||[];if(r.length===0){this.add.text(this.cameras.main.width/2,e,"Keine Berichte gefunden",{color:"#888888"}).setOrigin(.5);return}let n=e;for(const a of r.slice().reverse()){const l=a.message||a.extra&&a.extra.message||"no message",h=a.receivedAt||a.timestamp||"",d=this.add.text(40,n,`${h} ‚Äî ${l}`,{font:"14px Arial",color:"#ffffff",wordWrap:{width:this.cameras.main.width-80}});n+=d.getBounds().height+8}}catch(t){console.error("Failed to fetch reports",t),this.add.text(this.cameras.main.width/2,e,"Fehler beim Laden",{color:"#ff6666"}).setOrigin(.5)}}}class Ho{persistence=se.getInstance();installed=!1;constructor(){}async report(e,t){try{const s={message:e?.message||String(e)||"Unknown error",stack:e?.stack||null,url:typeof window<"u"&&window.location&&window.location.href||"unknown",timestamp:new Date().toISOString(),userAgent:typeof navigator<"u"?navigator.userAgent:"unknown",extra:t},r=de.getInstance().getAuthToken();await this.persistence.saveErrorReport(s,r||void 0),console.error("Global error captured and persisted:",s)}catch(s){console.error("ErrorReporter failed while reporting an error:",s)}}installGlobalHandlers(e){if(this.installed)return;this.installed=!0;const t=e?.onRestart;let s=0,i=null;const r=()=>{try{if(!(this.persistence.loadSettings()?.autoRestartOnError??!0)){console.warn("Auto-restart disabled in settings; skipping restart.");return}}catch{}const n=Date.now();i||(i=n),i&&n-i>3e4&&(s=0,i=n),s+=1;const a=e?.maxRestarts??3;if(s>a){console.error("Too many restart attempts, will not restart again automatically.");return}try{typeof t=="function"?t():typeof window<"u"&&window.location.reload()}catch(l){console.error("Failed to restart game via restart function:",l)}};typeof window<"u"&&(window.addEventListener("error",n=>{try{const a=n.error||{message:n.message};this.report(a,{filename:n.filename,lineno:n.lineno,colno:n.colno})}catch(a){console.error("Error inside global error handler:",a)}r()}),window.addEventListener("unhandledrejection",n=>{try{const a=n.reason||{message:"Unhandled rejection"};this.report(a,{reason:n.reason})}catch(a){console.error("Error inside unhandledrejection handler:",a)}r()}))}}const Wo=new Ho,Fo={type:et.AUTO,parent:"game-container",backgroundColor:"#2d2d2d",scale:{mode:et.Scale.FIT,autoCenter:et.Scale.CENTER_BOTH,width:1280,height:720},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scene:[lr,cr,fr,Io,ds,No,$o]};let _t=null,ui=0,St=0;async function hs(){try{await E.getInstance().load(),_t=new et.Game(Fo),Go(),Wo.installGlobalHandlers({onRestart:$i})}catch(o){console.error("Failed to initialize game:",o),document.body.innerHTML='<div style="color: white; text-align: center; padding: 50px;">Failed to load game configuration. Please refresh the page.</div>'}}function pi(){try{const o="open-td-error-overlay";let e=document.getElementById(o);e||(e=document.createElement("div"),e.id=o,e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.right="0",e.style.bottom="0",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.background="rgba(0,0,0,0.7)",e.style.color="#fff",e.style.zIndex="99999",e.style.fontSize="18px",e.style.padding="20px",e.textContent="An error occurred. Restarting the game automatically...",document.body.appendChild(e))}catch(o){console.error("Failed to show restart overlay",o)}}function Go(){try{const e=document.getElementById("open-td-error-overlay");e&&e.remove()}catch(o){console.error("Failed to remove restart overlay",o)}}async function $i(){try{const o=Date.now();if(o-ui>3e4&&(St=0),ui=o,St+=1,St>3){console.error("Too many restarts attempted ‚Äî aborting automatic restart."),pi();return}if(pi(),console.warn("Restarting Phaser game (attempt "+St+")"),_t){try{_t.destroy(!0,!1)}catch(e){console.error("Failed to destroy Phaser game instance during restart:",e)}_t=null}await new Promise(e=>setTimeout(e,400)),hs()}catch(o){console.error("Failed to restart game:",o)}}try{typeof window<"u"&&(window.restartGame=$i)}catch{}it.isNativePlatform()?document.addEventListener("deviceready",()=>{hs()}):window.addEventListener("load",()=>{hs()});
